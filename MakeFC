#	Makefile
#
#  Lost? Type 'make help -f MakeFC' from the directory where you see this file
#
# Copyright (c) 2002, California Institute of Technology.  ALL RIGHTS RESERVED.
# U.S. Government Sponsorship under NASA Contract NAS7-1407 is acknowledged.

# ---------------------- The name of this file (is the right-hand-side below)
MakeFName = MakeFC
# If the right-hand-side is not Makefile
# then to make mls with this file you must instead  of bare "make" use
#     make -f $(MakeFName)

# The name of this file must be used in each of $(SUBDIRS)
# i.e., if you are calling make with a different Makefile name,
#        say: make -f MakeFC
# then (re)name the Makefiles in /l2 /lib etc. also MakeFC

# "$Id$"

# ------------------- Automatic internalcleanup
# We use COPY_NUMBER to keep track of the number of times
# the functional targets update or depends are "built", i.e. performed
# every tenth time an internalcleanup is automatically performed

SCRIPTS = scripts
# This is how big COPY_NUMBER may grow before being reset
# ---> and triggering internalcleanup <---
# (formerly 10)
MAX_COPIES = 1
ONE = 1

# This keeps track of the number of times MakeFC -> Makefile
USE_internal_copynum = no

ifeq ($(USE_internal_copynum),yes)
	COPY_NUMBER = 1
else
	COPY_NUMBER := $(shell echo srclib/Make.dep.* | wc -w)
endif

NEXT_COPY := $(shell expr $(COPY_NUMBER) + 1)

# ---------------------- Paths to special directories
# This is where this Makefile is located
# Also beginning path for all relative paths defined below; e.g. CONFDIR
# This assumes therefore that you have summoned this via
#    cd $(MLSHOME)
#    make
# otherwise the following definition will fail
# You might try something like
#    make -f mlspgs/Makefile MLSHOME=$HOME/mlspgs
# but this has not been tested.
# Anyway, why would you want to
# make things more difficult?
MLSHOME := $(shell pwd)

# where to store .configure; 
# also where to install mls programs by default
CONFDIR=.

ifdef MLSINSTALLDIR
   INSTALLDIR=$(MLSINSTALLDIR)
else
   INSTALLDIR=$(CONFDIR)/bin/$(MLSCONFG)
endif

# --------------- scripts help
# util is the subdirectory
# where the following utility scripts 
# (necessary to build the mls software) are stored
#   Script                        Function
#   batch_hcnvrt.sh        Convert a group of hdfeos2 files to hdfeos5
#                            using heconvert
#   build_f90_in_misc.sh   Build a c or Fortran program
#   f90GhostFiles.pl       Used by ghostbuster.sh   
#   f90makedep.pl          Used by makemakedep.sh
#   ghostbuster.sh         Deletes orphaned .o, .mod files from deceased sources
#   l2cfmaker.sh           "Compiler" for building l2cf
#   makemakedep.sh         Calculates dependencies   
#   mkdir_cascade.sh       Creates a directory, and any yet uncreated parents
#   mlsconfigure           Configures Makefiles for building mlks software
#   mlsprog.sh             sh wrapper to assure exit condition is "1" if probs
#   reecho.sh              Filter list of args to remove bogus ones
#   uptodate.make          Ensure that custom machine files are up-to-date
#   which_fftw.sh          Construct correct fftw link lines for level 3
#
#  More info on some of these scripts is available via
#  Command                      for help on 
#  make help--convert           batch_hcnvrt.sh and heconvert
#  make help--depends           makemakedep.sh
#  make help--ghostbuster       ghostbuster.sh
#  make help--mlsconfigure      mlsconfigure
#  make help--reecho            reecho.sh
# --------------- End scripts help

MLSBIN=util

# where the platforms directory is w.r.t. each of SUBDIRS:
# "." means for l2 it is l2/platforms
# also where each uniquely-named sub-sub will be created:
# "." means for l2 it is l2/NAG.Linux
PLATFORMS = .

# This is the default name of the configure file
# It may be overridden for multiple platforms, special options, etc.
ifdef HOSTMLSCFILE
   MLSCFILE=$(HOSTMLSCFILE)
else
   MLSCFILE=.configure
endif

# This will set our MLS platform, compiler. etc.
# w/o complaining if it does nor exist yet
-include $(CONFDIR)/$(MLSCFILE)

# All the implicit pattern-matching involving suffixes
# will be done in the uniquely-named sub-directories, not here--so
.SUFFIXES:

SHELL = /bin/sh

# --------------- MakeFC help
# Usage: make target SETTING=value
# Special 1st time usage (assuming no .configure file)
#    make -f MakeFC update

# --------------- Target definitions
#            (code sub-directories of mlspgs excluding util, sandbox)
# $LEVELS        -- automatic; built when target is not specified
#                   (for current value see below)
# .configure     -- automatic (if not yet found; prerequisite for everything else)
#                    (its name by default; actual value stored in MLSCFILE)
# $OTHER_SUBDIRS -- not automatic
# all            -- all the sub-directories: $LEVELS + $OTHER_SUBDIRS + lib
# subdirs        -- same as all
# lib            -- libmls.a; a prerequisite for the others
# blas           -- libmlspack.a; another prerequisite for the others and for lib

#                           (functional)
# clean          -- deletes only *.o, *.mod from sub-subs
# configure      -- runs mlsconfigure to (re)set compiler, platform, paths
#                   (invoked automatically if .configure not found)
# configure_fopts  
#                -- (re)set default FOPTS and LDOPTS
# configure_full -- does same as running all of above three
# configure_help -- same as help--mlsconfigure
# configure_pvm  -- (re)set PVM and FFTW paths
# configure_subdirs
#                -- also (re)creates uniquely-named sub-sub-directories
#                   within mlspgs sub-directories with customized Makefiles
#                   where *.o, *.mod, lib*.a, mlsl*, etc. built
# depends        -- runs makemakedep.sh to calculate dependencies
# disthelp       -- prints README.MakeFC--a long file
# firsthelp      -- prints BEFORE.mls--lists prerequisites for mls software
# ghostbuster    -- removes orphaned .o, .mod files from uniquely-named ssds
#                   also deletes haunted library files
# help           -- prints some orientation on available help
# help--brief    -- prints some brief info on how to build the mls software
# help--convert  -- prints some info on converting from hdfeos2 to hdfeos5
# help--depends  -- prints some info on the makemakedep.sh script
# help--fopts    -- prints how to set compiler and linker options
# help--ghostbuster
#                -- prints some info on the ghostbuster.sh script
# help--Makefile -- prints some info on this Makefile
# help--mlsconfigure
#                -- prints some info on the mlsconfigure script
# help--platform -- prints how to configure make for your platform
# help--pvm      -- prints how to set paths for some optional libraries
# help--reecho   -- prints some info on the reecho.sh script
# help--scripts  -- prints some info on the scripts used by this Makefile
# help--toolkit  -- prints how to set paths for the mandatory libraries
# install        -- mv programs mlsl* from sub-subs to INSTALLDIR
#                    also create shell scripts in INSTALLDIR for each program
# makefile       -- allows you to summon this custom Makefile with shorter
#                    "make" rather than laborious "make -f $(MakeFName)"
# mostlyclean    -- deletes uniquely-named sub-sub-directories
# update         -- replaces customized Makefiles with latest versions
#                    also recalculates dependenencies, removes orphaned .o, .mod
#
# The following targets refer to programs whose sources are in the 
# util directory. You may or may not be interested in building and running them.
# CondenseLeakLog-- build and install this prog
# end_stmts      -- build and install this prog
# f90tex         -- build and install this prog
# h5cat          -- build and install this prog
# h5subset       -- build and install this prog
# heconvert      -- build and install this prog
# hl             -- build and install this prog
# init_gen       -- build and install this prog
# utctotai       -- build and install this lib
#
#    The following are useful if you stored multiple configurations
#     besides current one
# clean_config   -- deletes configurations named using MLSCONFG on command-line
#                    e.g., make clean_config MLSCONFG=NAG.Sun
# distclean      -- deletes every configuration
#
#     The following are useful for distributing all or portions of the archive
#    If the target is entered exactly as shown below, the
#    resulting archive will be an uncompressed .tar file; but with:
#    a "z" suffix, e.g. "tarz" -- use gzip to compress -> .tgz
#    a "g" suffix, e.g. "targ" -- assume GNU tar compress -> .tgz
#    (Unfortunately, this currently works only under linux version of tar)
#
# disttar        -- creates an archive of whole mlspgs
# tar            -- creates archive of mlspgs suitable for SIPS
#                  (see EVERYTHING variable)
# substar        -- creates separate archives of subdirs; then tar them
#                   (also util, notes and srclib are tarred up in this case)

# --------------- SETTING definitions
# FOPTS              Override default compiler option; note that you must
#                    use only legal options
# LDOPTS             Override default (blank) loader option; note that you must
#                    use only legal options
# PVM_ROOT           Path to the root of the pvm libraries; note that they
#                    must then be named \$PVM_ROOT/\$PVM_ARCH/lib*.a;
# PVM_ARCH           (see above)
# FFTW_ROOT          Path to the FFTW library; required for mlsl3
#
# BLAS               Path to an external blas library; note that the library
#                    by default is named \$BLAS/libblas.a
# LIB_BLAS           Alternate name x if blas lib named \$BLAS/libx.a
# LAPACK             Path to an external lapack library; note that the library
#                    by default is named \$LAPACK/liblapack.a
# LIB_LAPACK         Alternate name x if lapack lib named \$LAPACK/libx.a
# The following cannot be set by configure_full
# TAR                Overrides name of tar command; e.g. path to GNU tar 
#                    in case your tar won't gzip for targets *targ
# FAFTER             Appears at the end of each line invoking the compiler
#                    e.g., for post-processing to highlight warnings and errors
#                    make FAFTER='2>&1 | hl'  # see util/hl.c for the source    
# LAFTER             Appears at the end of the very long link statement
# FC                 Overrides the name by which the Fortran compiler is called
# CC                 Overrides the name by which the c compiler is called
# INSTALLDIR         Destination where install moves mlsl1, etc.
# MLSCFILE           Overrides the name of the .configure file
# NOCLEANING         Don't rebuild everything on any change to .configure
#                    if non-blank
# NOHUNTING          Stop make from hunting if non-blank
# EXTRA_PATHS        Extra directories to be searched for .h, .f9h, or .mod
#                    files while compiling
#
# --------------- End MakeFC help

#             internal targets
# Note that the above list of targets is supplemented by
# internal targets. They are not usually explicitly
# named on the make line (though it is legal to do so, of course)

# internalsaymake    Copy or link MakeFC to Makefile (so you can just say make)
# internalcleanup    Remove old Make.dep.nn files
# internaladd_copy   Print notice that (previous value) of COPY_NUMBER increment
# internaldepends    Recalculates dependencies
# internalupdate     Updates the Makefile in each MLSCONFG; then internaldepends
# internalreset_copy Resets COPY_NUMBER to 0
# internalmftests    internalsaymake just for directories under tests

#----------------------------------------------------------
# LEVELS is the list of automatic targets; i.e.
# they will be built when no target is specified
# by entering

# make
#
#          Default levels

LEVELS = l1 l2 l3 l3m
#----------------------------------------------------------

#-----------------------

# OTHER_SUBDIRS are *not* built automatically:
# you must either name them individually, or use the "all" target
OTHER_SUBDIRS = fwdmdl cloudfwdm he5lib
#         All the subdirectories

#You may build all the subdirectories via the "all" target; i.e.,
#by entering

# make all

SUBDIRS = blas lib $(LEVELS) $(OTHER_SUBDIRS)

# This isn't really everything, just everything the SIPS might need
# so it will be bundled up by tar
# Note that it does *not* include the Toolkit nor PVM nor FFTW 
# because they are outside mlspgs
EVERYTHING = $(SUBDIRS)  srclib\
   util sids tables notes tests\
   $(MakeFName) README.$(MakeFName) BEFORE.mls
     
# This is in case tar doesn't summon GNU tar, you may still use it via
# something like
#    make tar TAR=/usr/local/gnu/bin/tar
TAR=tar

# These are all the configurations that will be removed by distclean
# EVERY_MLSCONFG = LF95.Linux  NAG.Linux  NAG.SGI  NAG.Sun  Unknown.None  Sun.Sun
# Instead of hard-coding, as customized name are now possible for MLSCONFG
# we will let reecho.sh find the ones we'll use
REECHO=$(MLSBIN)/reecho.sh
EVERY_MLSCONFG = $(shell ${REECHO} -d -dirn lib/machines -excl CVS)

# The next 2 may be commented out if you're absolutely sure you won't need them
tests_sub_dirs := $(shell echo tests/*)
sids_l1boa := sids/l1boa
  
# This determines the command which MakeFC transmits to each of the
# SUBDIRS when you invoke it with "make update":
# likely candidates are "depends" or "depends ghostbuster"
SUBDIRS_UPDATE = depends ghostbuster

# This determines the command by which MakeFC looks like Makefile
# Choose either "link" or "copy"; warning--link has caused cvs probs
# so recommend leaving it copy
LOOKS_LIKE_MakeFC = copy

ifeq ($(LOOKS_LIKE_MakeFC),copy)
	LOOKS_LIKE_line = cp MakeFC Makefile
else
	LOOKS_LIKE_line = ln -s MakeFC Makefile
endif

# utctotai lib sources
UTCDIR=utctotai
# If we can't count on the toolkit routines, sadly then
# we must supply some of the PGS_TD stuff ourselves
ifndef PGSTK
  utctotai_sources = \
 $(UTCDIR)/PGS_SMF1.c $(UTCDIR)/PGS_SMF.h $(UTCDIR)/PGS_TD_timeCheck.c \
 $(UTCDIR)/PGS_TD_TAIjdtoTAI.c $(UTCDIR)/PGS_TD_UTCtoUTCjd.c \
 $(UTCDIR)/mls_bindFORTRAN.c $(UTCDIR)/mls_LeapSec.c $(UTCDIR)/mls_UTCtoTAI.c \
 $(UTCDIR)/mls_UTCjdtoTAIjd.c \
 test.f90
else
  utctotai_sources = \
 $(UTCDIR)/PGS_SMF.h \
 $(UTCDIR)/mls_bindFORTRAN.c $(UTCDIR)/mls_LeapSec.c $(UTCDIR)/mls_UTCtoTAI.c \
 $(UTCDIR)/mls_UTCjdtoTAIjd.c \
 test.f90
endif
#----------------------- Build instructions

# Automatic targets

levels:
	 @for dir in blas lib $(LEVELS); do \
	  $(MAKE) -f $(MakeFName) -C $$dir; \
	done

$(CONFDIR)/$(MLSCFILE):
	$(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -cf "$(MLSCFILE)" -p "$(MLSPLAT)" -pv -fl
	$(MAKE) -f $(MakeFName) internalsaymake internalmftests

# Targets that must be named explicitly

$(LEVELS):
	$(MAKE) -f $(MakeFName) -C $@

$(OTHER_SUBDIRS):
	$(MAKE) -f $(MakeFName) -C $@

all subdirs:
	 @for dir in $(SUBDIRS); do \
	  $(MAKE) -f $(MakeFName) -C $$dir; \
	done

lib:
	$(MAKE) -f $(MakeFName) -C $@

blas:
	$(MAKE) -f $(MakeFName) -C $@

#              (functional targets)
#              summoned by "make command"
mostlyclean:
	@echo "Cleaning $(SUBDIRS)"; \
	 for dir in $(SUBDIRS); do \
	  $(MAKE) -f $(MakeFName) -C $$dir mostlyclean; \
	done
	@echo "Cleaning $(tests_sub_dirs)"; \
	 for dir in $(tests_sub_dirs) $(sids_l1boa); do \
	  $(MAKE) -f $(MakeFName) -C $$dir mostlyclean; \
	done
	@$(MAKE) -f $(MakeFName) internalcleanup ; \

clean:
	@echo "Cleaning objects from $(SUBDIRS)"; \
	 for dir in $(SUBDIRS); do \
	  $(MAKE) -f $(MakeFName) -C $$dir clean; \
	done
	@$(MAKE) -f $(MakeFName) internalcleanup ; \

configure:
	$(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -cf "$(MLSCFILE)" -p "$(MLSPLAT)"
	@$(MAKE) -f $(MakeFName) update

configure_pvm:
	$(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -cf "$(MLSCFILE)" -p "$(MLSPLAT)" -nc -pv
	@$(MAKE) -f $(MakeFName) update

configure_fopts:
	$(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -cf "$(MLSCFILE)" -p "$(MLSPLAT)" -nc -fl
	@$(MAKE) -f $(MakeFName) update

configure_full:
	$(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -cf "$(MLSCFILE)" -p "$(MLSPLAT)" -pv -fl
	@$(MAKE) -f $(MakeFName) update

configure_help help--mlsconfigure:
	@$(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -cf "$(MLSCFILE)" -p "$(MLSPLAT)" -help--mlsconfigure

configure_subdirs:
	@echo "Configuring $(SUBDIRS)"; \
	 for dir in $(SUBDIRS); do \
		cd $$dir ; \
		../$(MLSBIN)/mlsconfigure -dc "../$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -cf "$(MLSCFILE)" -p "$(MLSPLAT)" -nc; \
		cd .. ; \
	done

depends:
	@if [ $(COPY_NUMBER) -lt $(MAX_COPIES) ] ; then \
		$(MAKE) -f $(MakeFName) internaladd_copy ; \
	else  \
		echo "Resetting copy number from  $(COPY_NUMBER) to 1"; \
		$(MAKE) -f $(MakeFName) internalcleanup ; \
	fi
	@$(MAKE) -f $(MakeFName) internaldepends

help--Makefile:
	@sed -n '/'$(MakeFName)' help/,/End '$(MakeFName)' help/ p' $(CONFDIR)/MakeFC \
		| sed -n 's/^..//p' | sed '1 d; $$ d'

help--scripts:
	@sed -n '/'$(SCRIPTS)' help/,/End '$(SCRIPTS)' help/ p' $(CONFDIR)/MakeFC \
		| sed -n 's/^..//p' | sed '1 d; $$ d'

disthelp:
	$(CONFDIR)/README.MakeFC

firsthelp:
	$(CONFDIR)/BEFORE.mls

help:
	@$(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -cf "$(MLSCFILE)" -p "$(MLSPLAT)" -help

help--brief:
	@$(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -cf "$(MLSCFILE)" -p "$(MLSPLAT)" -help--brief

help--convert:
	@$(MLSBIN)/batch_hcnvrt.sh -help

help--depends:
	@$(MLSBIN)/makemakedep.sh -help

help--fopts:
	@$(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -cf "$(MLSCFILE)" -p "$(MLSPLAT)" -help--fopts

help--ghostbuster:
	@$(MLSBIN)/ghostbuster.sh -help

help--platform:
	@$(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -cf "$(MLSCFILE)" -p "$(MLSPLAT)" -help--platform

help--pvm:
	@$(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -cf "$(MLSCFILE)" -p "$(MLSPLAT)" -help--pvm

help--reecho:
	@$(MLSBIN)/reecho.sh -help

help--toolkit:
	@$(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -cf "$(MLSCFILE)" -p "$(MLSPLAT)" -help--toolkit

# install the mls programs from $(LEVELS) into $(INSTALLDIR)
install:
	@echo "Installing programs from $(LEVELS) into $(INSTALLDIR)"; \
	if [ ! -d $(INSTALLDIR) ] ; then \
	   $(MLSBIN)/mkdir_cascade.sh $(INSTALLDIR) ; \
	fi ; \
	for dir in $(LEVELS); do \
	case "$$dir" in \
	"l3") \
			if [ -f $$dir/$(MLSCONFG)/mlsl3d ] ; then \
	         mv $$dir/$(MLSCONFG)/mlsl3d $(INSTALLDIR) ; \
            rm -f $(INSTALLDIR)/mlsl3d.sh ; \
	         sed "s=mlsxxyyzz=mlsl3d=; s=mlsbbiinn=$(INSTALLDIR)=; \
              s=mlshhoommee=$(MLSHOME)=; s=mlseexxttrraa==" \
              $(MLSBIN)/mlsprog.sh > $(INSTALLDIR)/mlsl3d.sh ; \
            chmod a+x $(INSTALLDIR)/mlsl3d.sh ; \
			fi ; \
		;; \
	*) \
			if [ -f $$dir/$(MLSCONFG)/mls$$dir ] ; then \
      	  mv $$dir/$(MLSCONFG)/mls$$dir $(INSTALLDIR) ; \
            rm -f $(INSTALLDIR)/mls$$dir.sh ; \
	         sed "s=mlsxxyyzz=mls$$dir=; s=mlsbbiinn=$(INSTALLDIR)=; \
              s=mlshhoommee=$(MLSHOME)=; s=mlseexxttrraa==" \
              $(MLSBIN)/mlsprog.sh > $(INSTALLDIR)/mls$$dir.sh ; \
            chmod a+x $(INSTALLDIR)/mls$$dir.sh ; \
			fi ; \
		;; \
	esac ; \
	done

# unshar the sources for the executables (heconvert so far)
$(MLSBIN)/convert.c $(MLSBIN)/HE5_HdfEosDef.h: $(MLSBIN)/heconvert.shar
	@cd $(MLSBIN); \
   /bin/sh heconvert.shar

# unshar the sources for the utctotai lib
$(utctotai_sources): $(MLSBIN)/utctotai.shar
	@if [ ! -d $(UTCDIR) ]; then \
     mkdir $(UTCDIR); \
	fi ; \
	cp $(MLSBIN)/utctotai.shar $(UTCDIR); \
	cd $(UTCDIR); \
	/bin/sh utctotai.shar

# build and install some of the executables out of util
CondenseLeakLog: $(CONFDIR)/$(MLSCFILE) $(MLSBIN)/CondenseLeakLog.f90
	$(MLSBIN)/build_f90_in_misc.sh -d $(INSTALLDIR) -t ./tests \
   -c $(MLSCONFG) -p $@ -M $(MAKE) \
	-C $(MLSCFILE) $(MLSBIN)/$@.f90

#convert_spectroscopy: $(CONFDIR)/$(MLSCFILE) $(MLSBIN)/convert_spectroscopy.f90
#	$(MLSBIN)/build_f90_in_misc.sh -d $(INSTALLDIR) -t ./tests \
#   -m lib -c $(MLSCONFG) -p $@ $(MLSBIN)/$@.f90

end_stmts: $(CONFDIR)/$(MLSCFILE) $(MLSBIN)/end_stmts.f90
	$(MLSBIN)/build_f90_in_misc.sh -d $(INSTALLDIR) -t ./tests \
   -c $(MLSCONFG) -p $@ -M $(MAKE) \
	-C $(MLSCFILE) $(MLSBIN)/$@.f90

f90tex: $(CONFDIR)/$(MLSCFILE) $(MLSBIN)/f90tex.f90
	$(MLSBIN)/build_f90_in_misc.sh -d $(INSTALLDIR) -t ./tests \
   -c $(MLSCONFG) -p $@ -M $(MAKE) \
	-C $(MLSCFILE) $(MLSBIN)/$@.f90

heconvert: $(CONFDIR)/$(MLSCFILE) $(MLSBIN)/convert.c $(MLSBIN)/HE5_HdfEosDef.h
	@case "$(HDF5)" in \
	"") \
		echo "Sorry--you must define HDF5 before building heconvert" ; \
		echo "Try make configure" ; \
		exit 2 ; \
		;; \
	*) \
	   $(MLSBIN)/build_f90_in_misc.sh -d $(INSTALLDIR) -t ./tests \
      -c $(MLSCONFG) -p $@ -M $(MAKE) \
	   -C $(MLSCFILE) $(MLSBIN)/convert.c \
      -I $(MLSBIN) \
      -I $(HDFEOS5)/../../include \
      -I $(HDFEOS)/../../include \
      -I $(HDF)/../include -I $(HDF5)/../include -I $(HDF5)/../src \
		;; \
	esac 
   
#EXTRA_PATHS="-I /software/SRC/TOOLKIT-5.2.7.3v1.00/hdfeos5.0/include/ -I /software/SRC/TOOLKIT-5.2.7.3v1.00/hdfeos/include -I /software/SRC/TOOLKIT-5.2.7.3v1.00/hdf/linux/HDF4.1r3/include -I /software/SRC/TOOLKIT-5.2.7.3v1.00/hdf5/linux/hdf5-1.4.1/include/ -I /software/SRC/TOOLKIT-5.2.7.3v1.00/hdf5/linux/hdf5-1.4.1/src"

init_gen: $(CONFDIR)/$(MLSCFILE) $(MLSBIN)/init_gen.f90
	$(MLSBIN)/build_f90_in_misc.sh -d $(INSTALLDIR) -t ./tests \
   -c $(MLSCONFG) -p $@ -M $(MAKE) \
	-C $(MLSCFILE) $(MLSBIN)/$@.f90

h5subset: $(CONFDIR)/$(MLSCFILE) $(MLSBIN)/h5subset.c
	@case "$(HDF5)" in \
	"") \
		echo "Sorry--you must define HDF5 before building h5subset" ; \
		echo "Try make configure" ; \
		exit 2 ; \
		;; \
	*) \
	   $(MLSBIN)/build_f90_in_misc.sh -d $(INSTALLDIR) -t ./tests \
      -c $(MLSCONFG) -p $@ -M $(MAKE) \
	   -C $(MLSCFILE) \
      -i "-I $(HDF5)/../include" \
      $(MLSBIN)/$@.c \
		;; \
	esac 

h5cat: $(CONFDIR)/$(MLSCFILE) $(MLSBIN)/h5cat.c
	@case "$(HDF5)" in \
	"") \
		echo "Sorry--you must define HDF5 before building h5cat" ; \
		echo "Try make configure" ; \
		exit 2 ; \
		;; \
	*) \
	   $(MLSBIN)/build_f90_in_misc.sh -d $(INSTALLDIR) -t ./tests \
      -c $(MLSCONFG) -p $@ -M $(MAKE) \
	   -C $(MLSCFILE) \
      -i "-I $(HDF5)/../include" \
      $(MLSBIN)/$@.c \
		;; \
	esac 

hl: $(CONFDIR)/$(MLSCFILE) $(MLSBIN)/hl.c
	   $(MLSBIN)/build_f90_in_misc.sh -d $(INSTALLDIR) -t ./tests \
      -c $(MLSCONFG) -p $@ -M $(MAKE) \
	   -C $(MLSCFILE) $(MLSBIN)/$@.c

utctotai: $(CONFDIR)/$(MLSCFILE) $(utctotai_sources)
		$(MLSBIN)/build_f90_in_misc.sh -d $(INSTALLDIR) -t ./tests \
		-c $(MLSCONFG) -p $@ -M $(MAKE) -T lib -ni\
		-C $(MLSCFILE) $(utctotai_sources)
		mv ./tests/misc/$(MLSCONFG)/libmisc.a $(INSTALLDIR)/libutctotai.a
# allow user to forego "-f MakeFC" nonsense
makefile:
	@if [ $(COPY_NUMBER) -lt $(MAX_COPIES) ] ; then \
		$(MAKE) -f $(MakeFName) internaladd_copy ; \
	else  \
		echo "Resetting copy number from  $(COPY_NUMBER) to 1"; \
		$(MAKE) -f $(MakeFName) internalcleanup ; \
	fi
	@$(MAKE) -f $(MakeFName) internalsaymake

update:
	@if [ $(COPY_NUMBER) -lt $(MAX_COPIES) ] ; then \
		$(MAKE) -f $(MakeFName) internaladd_copy ; \
	else  \
		echo "Resetting copy number from  $(COPY_NUMBER) to 1"; \
		$(MAKE) -f $(MakeFName) internalcleanup ; \
	fi
	@$(MAKE) -f $(MakeFName) internalupdate

# Useful for cleaning multiple configurations

clean_config_test:
	@echo "Cleaning $(SUBDIRS) according to configuration $(MLSCONFG)"; \
	 mv $(CONFDIR)/$(MLSCFILE) $(CONFDIR)/temp.configure; \
	 echo "MLSCONFG=$(MLSCONFG)" > $(CONFDIR)/$(MLSCFILE); \
	 echo "$(MAKE) -f $(MakeFName) mostlyclean"; \
    if [ ! -d "lib/machines/$(MLSCONFG)/CVS" ] ; then \
	   echo "rm -f -r lib/machines/$(MLSCONFG)" ; \
	 fi ; \
	 mv $(CONFDIR)/temp.configure $(CONFDIR)/$(MLSCFILE)

clean_config:
	@echo "Cleaning $(SUBDIRS) according to configuration $(MLSCONFG)"; \
	 mv $(CONFDIR)/$(MLSCFILE) $(CONFDIR)/temp.configure; \
	 echo "MLSCONFG=$(MLSCONFG)" > $(CONFDIR)/$(MLSCFILE); \
	 $(MAKE) -f $(MakeFName) mostlyclean; \
    if [ ! -d "lib/machines/$(MLSCONFG)/CVS" ] ; then \
	   rm -f -r lib/machines/$(MLSCONFG) ; \
	 fi ; \
	 mv $(CONFDIR)/temp.configure $(CONFDIR)/$(MLSCFILE)

distclean:
	@echo "Cleaning configurations $(EVERY_MLSCONFG)"; \
	 for dir in $(EVERY_MLSCONFG); do \
	  $(MAKE) -f $(MakeFName) clean_config MLSCONFG=$$dir; \
	done
	@$(MAKE) -f $(MakeFName) internalcleanup

#For preparing source distributions

disttar:
	@echo "tar-ing the mlspgs distribution"; \
        rm -f ../mlspgs.tar; \
	$(TAR) hcvf ../mlspgs.tar * --exclude $(CONFDIR)/$(MLSCFILE)\
	--exclude CVS\
	--exclude Make.dep\* --exclude [cfl]\*/NAG.\* --exclude [cfl]\*/LF95.\* \
	--exclude tests/[cflm]\*/NAG.\* --exclude tests/[cflm]\*/LF95.\* \
	--exclude mlsl[0-9]

disttarz: disttar ../mlspgs.tar
	@echo "... then gzipping it"; \
	cd ..; rm -f mlspgs.tgz; gzip mlspgs.tar; mv mlspgs.tar.gz mlspgs.tgz

disttarg:
	@echo "tar-ing the mlspgs distribution with GNUtar -z option"; \
        rm -f ../mlspgs.tgz; \
	$(TAR) hcvzf ../mlspgs.tgz * --exclude $(CONFDIR)/$(MLSCFILE) \
	--exclude CVS\
	--exclude Make.dep\* --exclude [cfl]\*/NAG.\* --exclude [cfl]\*/LF95.\* \
	--exclude tests/[cflm]\*/NAG.\* --exclude tests/[cflm]\*/LF95.\* \
	--exclude mlsl[0-9]

tar:
	@echo "tar-ing mlspgs for sips"; \
        rm -f ../mlspgs_sips.tar; \
	$(TAR) hcvf ../mlspgs_sips.tar $(EVERYTHING) --exclude CVS\
	--exclude Make.dep\* --exclude [cfl]\*/NAG.\* --exclude [cfl]\*/LF95.\* \
	--exclude tests/[cflm]\*/NAG.\* --exclude tests/[cflm]\*/LF95.\* 

tarz: tar ../mlspgs_sips.tar
	@echo "... then gzipping it"; cd ..; rm -f mlspgs_sips.tgz; \
	gzip mlspgs_sips.tar; mv mlspgs_sips.tar.gz mlspgs_sips.tgz

targ:
	@echo "tar-ing mlspgs for sips"; \
        rm -f ../mlspgs_sips.tgz; \
	$(TAR) hcvzf ../mlspgs_sips.tgz $(EVERYTHING) --exclude CVS \
	--exclude Make.dep\* --exclude [cfl]\*/NAG.\* --exclude [cfl]\*/LF95.\* \
	--exclude tests/[cflm]\*/NAG.\* --exclude tests/[cflm]\*/LF95.\* 

substars:
	@echo "tar-ing $(SUBDIRS)"; \
	 for dir in $(SUBDIRS); do \
	  $(MAKE) -f $(MakeFName) -C $$dir tar; \
	done; \
	echo "tar-ing srclib"; \
        rm -f srclib.tar; \
	$(TAR) hcvf srclib.tar srclib --exclude CVS --exclude Make.dep\*; \
	echo "tar-ing util"; \
        rm -f util.tar; \
	$(TAR) hcvf util.tar util --exclude CVS ; \
	echo "tar-ing notes"; \
        rm -f notes.tar; \
	$(TAR) hcvf notes.tar notes --exclude CVS ; \
	echo "tar-ing *.tar"; \
	rm -f mlspgs_subs.tar

substar: substars
	@echo "... then tarring them";\
	rm -f ../mlspgs_subs.tar ;\
	$(TAR) -cvf ../mlspgs_subs.tar *.tar

substarz: substar ../mlspgs_subs.tar
	@echo "... then gzipping it"; cd ..; rm -f mlspgs_subs.tgz; \
	gzip mlspgs_subs.tar; mv mlspgs_subs.tar.gz mlspgs_subs.tgz

substarg: substars
	@echo "... then GNUtarring them"; \
	rm -f ../mlspgs_subs.tgz ;\
	$(TAR) -cvzf ../mlspgs_subs.tgz *.tar
	
# For internal use

internaladd_copy:
	@echo "MakeFC copy number $(COPY_NUMBER) incremented by 1"

# Automatically called to keep number of files Make.dep.nn under MAX_COPIES
internalcleanup:
	@echo "Automatic housekeeping in ./ $(SUBDIRS) srclib"; \
	 for dir in $(SUBDIRS) srclib; do \
	  cd $$dir; \
		if [ -f Makefile.dep ] ; then \
			rm -f Make.dep.* ;\
		fi ; \
	  cd ..; \
	done
	@echo "Automatic housekeeping in $(tests_sub_dirs)"; \
	 for dir in $(tests_sub_dirs) $(sids_l1boa); do \
	 	if [ -d $$dir ] ; then \
	  		cd $$dir; \
			if [ -f Makefile.dep ] ; then \
			rm -f Make.dep.* ;\
			fi ; \
	 		cd ../..; \
		fi; \
	done
	$(MAKE) -f $(MakeFName) internalreset_copy ; \

ghostbuster:
	@echo "Busting ghosts for $(SUBDIRS)"; \
	 for dir in $(SUBDIRS); do \
	  $(MAKE) -f $(MakeFName) -C $$dir ghostbuster; \
	done

internaldepends:
	@echo "Making dependencies for $(SUBDIRS)"; \
	 for dir in $(SUBDIRS); do \
	  $(MAKE) -f $(MakeFName) -C $$dir $(SUBDIRS_UPDATE); \
	done; \
	echo "Making dependencies for srclib"; \
        cd srclib; \
        ../$(MLSBIN)/makemakedep.sh ../lib ../l2; \
        sed 's/OBJS =/srclib_objs =/' Makefile.dep > temp.dep; \
        mv temp.dep Makefile.dep

internalsaymake:
	@echo "Copying or linking MakeFC to Makefile in ./ $(SUBDIRS)"; \
	if [ -f Makefile ] ; then \
		rm -f Makefile.old ;\
		mv Makefile Makefile.old ;\
	fi ; \
	$(LOOKS_LIKE_line)
	 @for dir in $(SUBDIRS); do \
	  cd $$dir; \
		if [ -f Makefile ] ; then \
			rm -f Makefile.old ;\
			mv Makefile Makefile.old ;\
		fi ; \
		$(LOOKS_LIKE_line) ;\
	  cd ..; \
	done

internalupdate: internalsaymake
	@echo "Updating the Makefile in $(SUBDIRS)"; \
    m_option="-machine" ; \
	 for dir in $(SUBDIRS); do \
		cd $$dir ; \
		../$(MLSBIN)/mlsconfigure -dc "../$(CONFDIR)" -pc "$(PLATFORMS)" \
         -cf "$(MLSCFILE)" -nc -nd $$m_option; \
		cd .. ; \
      m_option="" ; \
	done
#	@$(MAKE) -f $(MakeFName) ghostbuster
	@$(MAKE) -f $(MakeFName) internaldepends
	@$(MAKE) -f $(MakeFName) internalmftests

internalreset_copy:
	@echo "MakeFC copy number reset from $(COPY_NUMBER) to 0"

internalmftests:
	@echo "Copying or linking MakeFC to Makefile in $(tests_sub_dirs)"; \
	echo "(and updating the Makefile in each $(MLSCONFG) )"; \
	 for dir in $(tests_sub_dirs); do \
	 	if [ -d $$dir ] ; then \
	  		cd $$dir; \
			if [ -f Makefile ] ; then \
				rm -f Makefile.old ;\
				mv Makefile Makefile.old ;\
			fi ; \
			if [ -f MakeFC ] ; then \
				$(LOOKS_LIKE_line) ;\
			fi ; \
		../../$(MLSBIN)/mlsconfigure -dc "../../$(CONFDIR)" -pc "$(PLATFORMS)" \
         -cf "$(MLSCFILE)" -nc -nd; \
	 		cd ../..; \
		fi; \
	done; \
	if [ -d "$(sids_l1boa)" ] ; then \
     cd "$(sids_l1boa)"; \
     $(MAKE) -f $(MakeFName) update; \
   fi

show_copy:
	@echo "MakeFC copy number $(COPY_NUMBER)"

#----------------------- Bare target dependenciess

$(LEVELS): lib

ifdef HDFVERSIONS
   $(LEVELS): he5lib
endif

$(OTHER_SUBDIRS): lib

lib: blas

all: $(SUBDIRS)

subdirs: $(SUBDIRS)

l2: fwdmdl cloudfwdm

l3m: l3

install: $(LEVELS)

update:

.PHONY: configure depends subdirs clean mostlyclean clean_config distclean\
  tar substar disttar tarz substarz distarz targ substarg distarg substars\
  all install levels configure_subdirs makefile update\
  configure_pvm configure_fopts configure_full configure_help help disthelp\
  firsthelp help--brief help--convert help--depends help--fopts\
  help--ghostbuster help--mlsconfigure help--Makefile help--platform help--pvm\
  help--reecho help--scripts help--toolkit \
  internalcleanup internaldepends internalmftests internalsaymake \
  internaladd_copy internalreset_copy internalupdate\
  show_copy ghostbuster\
  $(SUBDIRS)

#---------------------------------------------------------------
# $Log$
# Revision 1.66  2002/04/18 20:16:30  pwagner
# Tiny changes in comments
#
# Revision 1.65  2002/02/21 21:55:42  pwagner
# Sets to blank extra options in install
#
# Revision 1.64  2002/02/12 18:37:24  pwagner
# Repaired builds for util executables; added h5cat
#
# Revision 1.63  2002/02/06 00:47:43  pwagner
# Adds check for up-to-date machine files during update
#
# Revision 1.62  2002/01/29 00:46:47  pwagner
# Builds he5lib when HDFVERSIONS defined
#
# Revision 1.61  2002/01/22 21:44:26  pwagner
# Added commands to build heconvert
#
# Revision 1.60  2002/01/10 01:25:08  pwagner
# Added he5lib to OTHER_SUBDIRS
#
# Revision 1.59  2001/11/17 00:21:41  pwagner
# Individual help now available on platform, toolkit, pvm, and fopts
#
# Revision 1.58  2001/11/15 00:15:56  pwagner
# Now builds blas/libmlspack.a explicitly
#
# Revision 1.57  2001/11/09 23:56:53  pwagner
# Fixed problem with help--Makefile
#
# Revision 1.56  2001/11/09 21:47:08  pwagner
# EVERY_MLSCONFG now calculated--allows for custom-named configs
#
# Revision 1.55  2001/11/08 00:39:14  pwagner
# New help system; mention of NOCLEANING where appropriate
#
# Revision 1.54  2001/11/06 00:21:34  pwagner
# Set MAX_COPIES to 1; make help brought up to date
#
# Revision 1.53  2001/10/18 16:43:37  pwagner
# Removed target convert_spectroscopy anticipating its removal from util
#
# Revision 1.52  2001/10/10 23:29:14  pwagner
# Fixed bug when upfating sids
#
# Revision 1.51  2001/10/10 23:24:51  pwagner
# sids/l1boa added to list of extra directories to be updated
#
# Revision 1.50  2001/10/04 22:24:49  pwagner
# Limit suffix-based rules to (MLSCONFG)
#
# Revision 1.49  2001/09/07 18:12:29  pwagner
# Tweaked the tar command
#
# Revision 1.48  2001/08/17 23:16:54  pwagner
# Fixed bug in build commands for h5subset
#
# Revision 1.47  2001/08/16 00:11:34  pwagner
# Added hl to list of new targets
#
# Revision 1.46  2001/08/15 20:59:27  pwagner
# util programs now installed in INSTALLDIR
#
# Revision 1.45  2001/08/14 23:56:40  pwagner
# Added builds for all util/.f90 and util/.c
#
# Revision 1.44  2001/08/14 22:39:59  pwagner
# There was no mkdir_cascade
#
# Revision 1.43  2001/08/11 00:10:33  pwagner
# More housekeeping
#
# Revision 1.42  2001/08/10 17:43:40  pwagner
# Fixed -h(elp) option; general housekeeping
#
# Revision 1.41  2001/08/07 20:59:03  pwagner
# install now creates script versions; defines MLSHOME
#
# Revision 1.40  2001/07/26 23:09:25  pwagner
# Added MLSINSTALLDIR, INSTALLDIR as destination for install
#
# Revision 1.39  2001/07/25 22:48:20  pwagner
# fixed install target; general housekeeping
#
# Revision 1.38  2001/07/20 00:03:17  pwagner
# Added l3m to LEVELS
#
# Revision 1.37  2001/06/01 20:11:50  pwagner
# Fixed configure_full
#
# Revision 1.36  2001/05/31 23:26:57  pwagner
# Ended role of l2_NEEDS_fwdmdl; cloudfwdm prereq of l2
#
# Revision 1.35  2001/05/30 17:39:18  pwagner
# Added cloudfwdm to OTHER_SUBDIRS
#
# Revision 1.34  2001/05/24 17:14:01  pwagner
# Added notes to EVERYTHING to be tarred up
#
# Revision 1.33  2001/05/14 23:58:42  pwagner
# default .configure name now set by environment
#
# Revision 1.32  2001/05/14 17:37:14  pwagner
# .configure now a variable file name
#
# Revision 1.31  2001/05/01 18:31:07  pwagner
# Automatically update after any configure
#
# Revision 1.30  2001/04/18 22:20:25  pwagner
# Removed dependence of tar on clean_all
#
# Revision 1.29  2001/03/23 21:40:41  pwagner
# Stopped using internal_copy_number
#
# Revision 1.28  2001/03/23 17:12:39  pwagner
# Realized mistake--cvs will corrupt this version
#
# Revision 1.27  2001/03/23 00:39:49  pwagner
# Added internal targets, copy number, etc.
#
# Revision 1.26  2001/03/17 00:56:25  pwagner
# Added new help; makefilesintests
#
# Revision 1.25  2001/03/12 22:46:57  pwagner
# Revised clean, tar; automatic symlink to Makefile
#
# Revision 1.24  2001/03/09 00:18:40  pwagner
# CVS excluded from tar_sips
#
# Revision 1.23  2001/03/08 23:26:41  pwagner
# The effect of no .configure is to configure_full
#
# Revision 1.22  2001/03/08 21:08:01  pwagner
# Tweaked EVERYTHING
#
# Revision 1.21  2001/03/08 20:59:53  pwagner
# Added TAR=... option
#
# Revision 1.20  2001/03/08 00:53:21  pwagner
# l2_NEEDS_fwdmdl now set by default
#
# Revision 1.19  2001/03/05 21:53:26  pwagner
# fwdmdl prerequisite to l2 if l2_NEEDS_fwdmdl
#
# Revision 1.18  2001/03/02 01:06:19  pwagner
# lib part of automatic targets
#
# Revision 1.17  2001/02/27 18:13:37  pwagner
# New help configure_help targets; tweaks to all, subdirs targets
#
# Revision 1.16  2001/02/26 00:28:09  pwagner
# configure_pvm and configure_fopts targets added
#
# Revision 1.15  2001/02/10 00:06:47  pwagner
# update now a target of make -f MakeFC; replaces customized Makefiles with latest versions
#
# Revision 1.14  2001/02/09 21:46:43  pwagner
# Eliminated l2pc from other_subdirs
#
# Revision 1.13  2001/01/23 19:16:26  pwagner
# #-ed out loop over subdirs when configuring
#
# Revision 1.12  2001/01/16 21:31:18  pwagner
# clean_all option added
#
# Revision 1.11  2001/01/13 00:42:09  pwagner
# Mentions mlspgs_sips.tgz and mlspgs_subs.tar
#
# Revision 1.10  2001/01/12 00:30:18  pwagner
# Added tar_sips and install options
#
# Revision 1.9  2001/01/10 23:45:33  pwagner
# General housekeeping
#
# Revision 1.8  2001/01/05 22:55:15  pwagner
# Added all option to build all
#
# Revision 1.7  2000/11/28 00:49:59  pwagner
# configure now configures subdirs
#
# Revision 1.6  2000/11/15 18:22:10  pwagner
# Now can make all of l1 l2 l3
#
# Revision 1.5  2000/11/06 23:26:58  pwagner
# Calculates srclib dependency
#
# Revision 1.4  2000/11/02 23:23:45  pwagner
# clean_objs option now available
#
# Revision 1.3  2000/10/24 21:08:22  pwagner
# Added tar option
#
# Revision 1.2  2000/10/23 17:16:34  pwagner
# Remove extra echo commands
#
# Revision 1.1  2000/10/18 21:57:35  pwagner
# First commit
#
