#	Makefile
# Copyright (c) 1999, California Institute of Technology.  ALL RIGHTS RESERVED.
# U.S. Government Sponsorship under NASA Contract NAS7-1407 is acknowledged.

# Details and a general explanation of how to use this file can be found
# by entering
#	README.name_of_this_file
#    (where of course for name_of_this_file use the name of this file)

# ---------------------- The name of this file (is the right-hand-side below)
MakeFName = MakeFC
# If the right-hand-side is not Makefile
# then to make mls with this file you must instead  of bare "make" use
#     make -f $(MakeFName)

# The name of this file must be used in each of $(SUBDIRS)
# i.e., if you are calling make with a different Makefile name,
#        say: make -f MakeFC
# then (re)name the Makefiles in /l2 /lib etc. also MakeFC

# "$Id$"

# ---------------------- Paths to special directories
# where to store .configure; also where to install mls programs
CONFDIR=.

# where configure and makemakedep.sh are stored
MLSBIN=util

# where the platforms directory is w.r.t. each of SUBDIRS:
# "." means for l2 it is l2/platforms
# also where each uniquely-named sub-sub will be created:
# "." means for l2 it is l2/NAG.Linux
PLATFORMS = .

# This will set our MLS platform, compiler. etc.
# w/o complaining if it does not exist yet
-include $(CONFDIR)/.configure

SHELL = /bin/sh

#--------------- Target definitions
#            (code sub-directories of mlspgs excluding util, sandbox)
# $LEVELS        -- automatic; built when target is not specified
# .configure     -- automatic (if not yet extant; prerequisite for everything else)
# $OTHER_SUBDIRS -- not automatic
# all            -- all the sub-directories: l1, l2, l3, lib, fwdmdl
# subdirs        -- same as all
# lib            -- libmls.a; a prerequisite for the others

#                           (functional)
# mostlyclean    -- deletes uniquely-named sub-sub-directories
# clean          -- deletes only *.o, *.mod from sub-subs
# configure      -- runs mlsconfigure to (re)set compiler, platform, paths
#                   (invoked automatically if .configure not found)
# configure_pvm  -- (re)set PVM and FFTW paths
# configure_fopts  -- (re)set default FOPTS and LDOPTS
# configure_full  -- does same as running all of above three
# configure_help -- prints some info on how to configure the build
# configure_subdirs
#                  also (re)creates uniquely-named sub-sub-directories
#                  within mlspgs sub-directories with customized Makefiles
#                  where *.o, *.mod, lib*.a, mlsl*, etc. built
# depends        -- runs makemakedep.sh to calculate dependencies
# help           -- prints some info on how to build the mls software
# install        -- mv programs mlsl* from sub-subs to CONFDIR
# makefile       -- allows you to summon this custom Makefile with shorter
#                    "make" rather than "make -f $(MakeFName)"
# update         -- replaces customized Makefiles with latest versions
#                    also recalculates dependenencies
#
#    The following are useful if you stored multiple configurations
#     besides current one
# clean_config   -- deletes the sub-subs "name"d in MLSCONFG="name" on command-line
#                    e.g., make -f MakeFC clean_config MLSCONFG=NAG.Sun
# distclean      -- deletes every configuration
#
#     The following are useful for distributing all or portions of the archive
#    If the target is entered exactly as shown below, the
#    resulting archive will be an uncompressed .tar file; but with:
#    a "z" suffix, e.g. "tarz" -- use gzip to compress -> .tgz
#    a "g" suffix, e.g. "targ" -- assume GNU tar compress -> .tgz
#
# disttar        -- creates an archive of whole mlspgs
# tar            -- creates archive of mlspgs suitable for SIPS
#                  (see EVERYTHING variable)
# substar        -- creates separate archives of subdirs; then tar them
#                   (also util and srclib are tarred up in this case)

#----------------------------------------------------------
# LEVELS is the list of automatic targets; i.e.
# they will be built when no target is specified
# by entering

# make -f MakeFC
#
#          Default levels
#You may choose whether "make -f MakeFC' defaults to making
#only l2 or all of l1 l2 and l3
#by commenting out exactly one of the following assignments
#(the prerequisite lib will always be made if necessary, however)

#comment out the following to make only l2
LEVELS = l1 l2 l3

#comment out the following to make l1, l2, and l3
#LEVELS = l2
#----------------------------------------------------------

#-----------------------

# OTHER_SUBDIRS are *not* built automatically:
# you must either name them individually, or use the "all" target
OTHER_SUBDIRS = fwdmdl
#         All the subdirectories

#You may build all the subdirectories via the "all" target; i.e.,
#by entering

# make -f MakeFC all

SUBDIRS = lib $(LEVELS) $(OTHER_SUBDIRS)

# This isn't really everything, just everything the SIPS might need
# so it will be bundled up by tar
# Note that it does *not* include the Toolkit nor PVM nor FFTW 
# because they are outside mlspgs
EVERYTHING = $(SUBDIRS) util blas srclib pcf idllib sids tables\
   $(MakeFName) README.$(MakeFName) BEFORE.mls
     
# This is in case tar doesn't summon GNU tar, you may still use it via
# something like
#    make -f MakeFC tar_sips TAR=/usr/local/gnu/bin/tar
TAR=tar

# These are all the configurations that will be removed by clean_all
EVERY_MLSCONFG = LF95.Linux  NAG.Linux  NAG.SGI  NAG.Sun  Unknown.None

#----------------------- Build instructions

# Automatic targets

levels:
	 @for dir in lib $(LEVELS); do \
	  $(MAKE) -f $(MakeFName) -C $$dir; \
	done

$(CONFDIR)/.configure:
	$(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -p "$(MLSPLAT)" -pv -fl
# equivalent to the following:
#		$(MAKE) -f $(MakeFName) configure_full
# (except w/o the infinite regress)
#	$(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
#          -c "$(MLSF95)" -p "$(MLSPLAT)"
#	$(MAKE) -f $(MakeFName) configure_subdirs
#	@echo "Configuring $(SUBDIRS)"; \
#	 for dir in $(SUBDIRS); do \
#		cd $$dir ; \
#		../$(MLSBIN)/mlsconfigure -dc "../$(CONFDIR)" -pc "$(PLATFORMS)" \
#          -c "$(MLSF95)" -p "$(MLSPLAT)" -nc; \
#		cd .. ; \
#	done
	if [ -f Makefile ] ; then \
		rm -f Makefile.old ;\
		mv Makefile Makefile.old ;\
	fi ; \
	ln -s MakeFC Makefile
	 @for dir in $(SUBDIRS); do \
	  cd $$dir; \
		if [ -f Makefile ] ; then \
			rm -f Makefile.old ;\
			mv Makefile Makefile.old ;\
		fi ; \
		ln -s MakeFC Makefile ;\
	  cd ..; \
	done

# Targets that must be named explicitly

$(LEVELS):
	$(MAKE) -f $(MakeFName) -C $@

$(OTHER_SUBDIRS):
	$(MAKE) -f $(MakeFName) -C $@

all subdirs:
	 @for dir in $(SUBDIRS); do \
	  $(MAKE) -f $(MakeFName) -C $$dir; \
	done

lib:
	$(MAKE) -f $(MakeFName) -C $@

#              (functional)

mostlyclean:
	@echo "Cleaning $(SUBDIRS)"; \
	 for dir in $(SUBDIRS); do \
	  $(MAKE) -f $(MakeFName) -C $$dir mostlyclean; \
	done

clean:
	@echo "Cleaning objects from $(SUBDIRS)"; \
	 for dir in $(SUBDIRS); do \
	  $(MAKE) -f $(MakeFName) -C $$dir clean; \
	done

configure:
	$(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -p "$(MLSPLAT)"
#	$(MAKE) -f $(MakeFName) configure_subdirs
#	 for dir in $(SUBDIRS); do \
#		cd $$dir ; \
#		../$(MLSBIN)/mlsconfigure -dc "../$(CONFDIR)" -pc "$(PLATFORMS)" \
#          -c "$(MLSF95)" -p "$(MLSPLAT)" -nc; \
#		cd .. ; \
#	done

configure_pvm:
	$(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -p "$(MLSPLAT)" -nc -pv

configure_fopts:
	$(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -p "$(MLSPLAT)" -nc -fl

configure_full:
	echo $(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -p "$(MLSPLAT)" -pv -fl

configure_help:
	$(MLSBIN)/mlsconfigure -dc "$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -p "$(MLSPLAT)" -help

configure_subdirs:
	@echo "Configuring $(SUBDIRS)"; \
	 for dir in $(SUBDIRS); do \
		cd $$dir ; \
		../$(MLSBIN)/mlsconfigure -dc "../$(CONFDIR)" -pc "$(PLATFORMS)" \
          -c "$(MLSF95)" -p "$(MLSPLAT)" -nc; \
		cd .. ; \
	done

depends:
	@echo "Making dependencies for $(SUBDIRS)"; \
	 for dir in $(SUBDIRS); do \
	  $(MAKE) -f $(MakeFName) -C $$dir depends; \
	done; \
	echo "Making dependencies for srclib"; \
        cd srclib; \
        ../$(MLSBIN)/makemakedep.sh ../lib ../l2; \
        sed 's/OBJS =/srclib_objs =/' Makefile.dep > temp.dep; \
        mv temp.dep Makefile.dep

help:
	$(CONFDIR)/README.MakeFC

install:
	@echo "Installing programs from $(LEVELS) into $(CONFDIR)"; \
	 for dir in $(LEVELS); do \
	  mv $$dir/$(MLSCONFG)/mls$$dir $(CONFDIR) ; \
	done

makefile:
	if [ -f Makefile ] ; then \
		rm -f Makefile.old ;\
		mv Makefile Makefile.old ;\
	fi ; \
	ln -s MakeFC Makefile
	 @for dir in $(SUBDIRS); do \
	  cd $$dir; \
		if [ -f Makefile ] ; then \
			rm -f Makefile.old ;\
			mv Makefile Makefile.old ;\
		fi ; \
		ln -s MakeFC Makefile ;\
	  cd ..; \
	done

update:
	@echo "Updating the Makefile in $(SUBDIRS)"; \
	 for dir in $(SUBDIRS); do \
		cd $$dir ; \
		../$(MLSBIN)/mlsconfigure -dc "../$(CONFDIR)" -pc "$(PLATFORMS)" \
          -nc -nd; \
		cd .. ; \
	done

# Useful for cleaning multiple configurations

clean_config:
	@echo "Cleaning $(SUBDIRS) according to configuration $(MLSCONFG)"; \
	 mv $(CONFDIR)/.configure $(CONFDIR)/temp.configure; \
	 echo "MLSCONFG=$(MLSCONFG)" > $(CONFDIR)/.configure; \
	 $(MAKE) -f $(MakeFName) mostlyclean; \
	 mv $(CONFDIR)/temp.configure $(CONFDIR)/.configure

distclean:
	@echo "Cleaning configurations $(EVERY_MLSCONFG)"; \
	 for dir in $(EVERY_MLSCONFG); do \
	  $(MAKE) -f $(MakeFName) clean_config MLSCONFG=$$dir; \
	done

#For preparing source distributions

disttar:
	@echo "tar-ing the mlspgs distribution"; \
        rm -f ../mlspgs.tar; \
	$(TAR) hcvf ../mlspgs.tar * --exclude $(CONFDIR)/.configure\
	--exclude CVS\
	--exclude Make.dep\* --exclude [fl]\*/NAG.\* --exclude [fl]\*/LF95.\* \
	--exclude mlsl[0-9]

disttarz: disttar ../mlspgs.tar
	@echo "... then gzipping it"; \
	cd ..; rm -f mlspgs.tgz; gzip mlspgs.tar; mv mlspgs.tar.gz mlspgs.tgz

disttarg:
	@echo "tar-ing the mlspgs distribution with GNUtar -z option"; \
        rm -f ../mlspgs.tgz; \
	$(TAR) hcvzf ../mlspgs.tgz * --exclude $(CONFDIR)/.configure \
	--exclude CVS\
	--exclude Make.dep\* --exclude [fl]\*/NAG.\* --exclude [fl]\*/LF95.\* \
	--exclude mlsl[0-9]

tar:
	@echo "tar-ing mlspgs for sips"; \
        rm -f ../mlspgs_sips.tar; \
	$(TAR) hcvf ../mlspgs_sips.tar $(EVERYTHING) --exclude CVS\
	--exclude Make.dep\* --exclude [fl]\*/NAG.\* --exclude [fl]\*/LF95.\*

tarz: tar ../mlspgs_sips.tar
	@echo "... then gzipping it"; cd ..; rm -f mlspgs_sips.tgz; \
	gzip mlspgs_sips.tar; mv mlspgs_sips.tar.gz mlspgs_sips.tgz

targ:
	@echo "tar-ing mlspgs for sips"; \
        rm -f ../mlspgs_sips.tgz; \
	$(TAR) hcvzf ../mlspgs_sips.tgz $(EVERYTHING) --exclude CVS \
	--exclude Make.dep\* --exclude [fl]\*/NAG.\* --exclude [fl]\*/LF95.\*

substars:
	@echo "tar-ing $(SUBDIRS)"; \
	 for dir in $(SUBDIRS); do \
	  $(MAKE) -f $(MakeFName) -C $$dir tar; \
	done; \
	echo "tar-ing srclib"; \
        rm -f srclib.tar; \
	$(TAR) hcvf srclib.tar srclib --exclude CVS --exclude Make.dep\*; \
	echo "tar-ing util"; \
        rm -f util.tar; \
	$(TAR) hcvf util.tar util --exclude CVS ; \
	echo "tar-ing *.tar"; \
	rm -f mlspgs_subs.tar

substar: substars
	@echo "... then tarring them";\
	rm -f ../mlspgs_subs.tar ;\
	$(TAR) -cvf ../mlspgs_subs.tar *.tar

substarz: substar ../mlspgs_subs.tar
	@echo "... then gzipping it"; cd ..; rm -f mlspgs_subs.tgz; \
	gzip mlspgs_subs.tar; mv mlspgs_subs.tar.gz mlspgs_subs.tgz

substarg: substars
	@echo "... then GNUtarring them"; \
	rm -f ../mlspgs_subs.tgz ;\
	$(TAR) -cvzf ../mlspgs_subs.tgz *.tar
	
#----------------------- Bare target dependenciess

$(LEVELS): lib

$(OTHER_SUBDIRS): lib

all: $(SUBDIRS)

subdirs: $(SUBDIRS)

# In the long run just evict the stuff that assumes l2_NEEDS_fwdmdl is undefined
l2_NEEDS_fwdmdl = true

# This makes fwdmdl a prerequisite for l2 -- *if* l2_NEEDS_fwdmdl defined
ifdef l2_NEEDS_fwdmdl
l2: fwdmdl
endif

# This requires rm-ing uniquely-named sub-subs before archiving
tar tar_subs tar_sips: clean_all

install: all

update: depends

.PHONY: configure depends subdirs clean mostlyclean clean_config distclean\
  tar substar disttar tarz substarz distarz targ substarg distarg substars\
  all install levels configure_subdirs makefile update\
  configure_pvm configure_fopts configure_full configure_help help\
  $(SUBDIRS)

#---------------------------------------------------------------
# $Log$
# Revision 1.24  2001/03/09 00:18:40  pwagner
# CVS excluded from tar_sips
#
# Revision 1.23  2001/03/08 23:26:41  pwagner
# The effect of no .configure is to configure_full
#
# Revision 1.22  2001/03/08 21:08:01  pwagner
# Tweaked EVERYTHING
#
# Revision 1.21  2001/03/08 20:59:53  pwagner
# Added TAR=... option
#
# Revision 1.20  2001/03/08 00:53:21  pwagner
# l2_NEEDS_fwdmdl now set by default
#
# Revision 1.19  2001/03/05 21:53:26  pwagner
# fwdmdl prerequisite to l2 if l2_NEEDS_fwdmdl
#
# Revision 1.18  2001/03/02 01:06:19  pwagner
# lib part of automatic targets
#
# Revision 1.17  2001/02/27 18:13:37  pwagner
# New help configure_help targets; tweaks to all, subdirs targets
#
# Revision 1.16  2001/02/26 00:28:09  pwagner
# configure_pvm and configure_fopts targets added
#
# Revision 1.15  2001/02/10 00:06:47  pwagner
# update now a target of make -f MakeFC; replaces customized Makefiles with latest versions
#
# Revision 1.14  2001/02/09 21:46:43  pwagner
# Eliminated l2pc from other_subdirs
#
# Revision 1.13  2001/01/23 19:16:26  pwagner
# #-ed out loop over subdirs when configuring
#
# Revision 1.12  2001/01/16 21:31:18  pwagner
# clean_all option added
#
# Revision 1.11  2001/01/13 00:42:09  pwagner
# Mentions mlspgs_sips.tgz and mlspgs_subs.tar
#
# Revision 1.10  2001/01/12 00:30:18  pwagner
# Added tar_sips and install options
#
# Revision 1.9  2001/01/10 23:45:33  pwagner
# General housekeeping
#
# Revision 1.8  2001/01/05 22:55:15  pwagner
# Added all option to build all
#
# Revision 1.7  2000/11/28 00:49:59  pwagner
# configure now configures subdirs
#
# Revision 1.6  2000/11/15 18:22:10  pwagner
# Now can make all of l1 l2 l3
#
# Revision 1.5  2000/11/06 23:26:58  pwagner
# Calculates srclib dependency
#
# Revision 1.4  2000/11/02 23:23:45  pwagner
# clean_objs option now available
#
# Revision 1.3  2000/10/24 21:08:22  pwagner
# Added tar option
#
# Revision 1.2  2000/10/23 17:16:34  pwagner
# Remove extra echo commands
#
# Revision 1.1  2000/10/18 21:57:35  pwagner
# First commit
#
