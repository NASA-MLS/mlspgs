head	1.9;
access;
symbols
	v5-02-NRT-19:1.9
	v6-00:1.9
	v5-02-NRT-18:1.9
	v5-02:1.8
	v5-01-NRT-17:1.9
	v5-01-NRT-16:1.9
	v5-01-NRT-15:1.9
	v5-01-NRT-14:1.9
	neuralnetworks-1-0:1.9.0.4
	cfm-single-freq-0-1:1.9.0.2
	v5-01:1.8
	v5-00:1.8
	v4-23-TA133:1.5.0.6
	mus-emls-1-70:1.5.0.4
	rel-1-0-englocks-work:1.5.0.2;
locks; strict;
comment	@% @;


1.9
date	2020.05.20.20.56.19;	author vsnyder;	state Exp;
branches;
next	1.8;

1.8
date	2019.09.04.00.22.00;	author vsnyder;	state Exp;
branches;
next	1.7;

1.7
date	2019.08.29.01.26.39;	author vsnyder;	state Exp;
branches;
next	1.6;

1.6
date	2019.08.27.01.22.42;	author vsnyder;	state Exp;
branches;
next	1.5;

1.5
date	2017.10.31.18.16.44;	author vsnyder;	state Exp;
branches;
next	1.4;

1.4
date	2017.10.16.17.30.22;	author pwagner;	state Exp;
branches;
next	1.3;

1.3
date	2017.06.08.18.39.12;	author vsnyder;	state Exp;
branches;
next	1.2;

1.2
date	2017.06.08.01.27.55;	author vsnyder;	state Exp;
branches;
next	1.1;

1.1
date	2017.06.07.19.32.37;	author vsnyder;	state Exp;
branches;
next	;


desc
@@


1.9
log
@Correct some typos. Clarified discussion of "correct" vs. "wrong" trapezoid.
@
text
@\makeatletter\let\ifGm@@compatii\relax\makeatother
\documentclass[landscape]{beamer}

\usepackage{amsmath}
\usepackage{graphicx}

% \ifx\pdfoutput\undefined
%   \pdfoutput=0
%   \usepackage{hyperref}
%   \hypersetup{%
%     hypertex,%
%     plainpages,%
%     hyperindex=true,%
%     hypertexnames=false%
%   }
%   % Specify the driver for the color package
%   \ExecuteOptions{dvips}
%   %\ExecuteOptions{xdvi}
% \else
%   \ifnum\pdfoutput>0
%     \usepackage{hyperref}
%     \hypersetup{%
%       pdftex,%
%       plainpages,%
%       hyperindex=true,%
%       pdfpagelabels,%
%       hypertexnames=false,%
%       colorlinks=true,%
%       linktocpage=true,%
%     }
%     % Specify the driver for the color package
%     \ExecuteOptions{pdftex}
%   \else
%     \usepackage{hyperref}
%     \hypersetup{%
%       hypertex,%
%       plainpages,%
%       hyperindex=true,%
%       hypertexnames=false%
%     }
%     % Specify the driver for the color package
%     \ExecuteOptions{dvips}
%     %\ExecuteOptions{xdvi}
%   \fi
% \fi
% 
% \hyperbaseurl{}
% \newcommand\hr[1]{\href{#1.dvi}{dvi}, \href{#1.pdf}{pdf}}
% \newcommand\h[1]{#1 (\hr{#1})}

\newcommand{\newframe}[2][]{\begin{frame}\frametitle{\hfill #2 \hfil}}
\renewcommand{\d}{\text{d}}

\title{Radiative Transfer Equation \\
in the Full Forward Model}
\subtitle{wvs-139r4}

\author{Van Snyder}

\date{20 May 2020}

\titlegraphic{\includegraphics[width=1.0in]{eos_mls_logo_onpink}}

\begin{document}

\begin{frame}
  \titlepage
\end{frame}

% -----------------------------------------------------------------------------

\newframe{Radiative Transfer Equation}

The clear-sky non-scattering radiative-transfer equation for one frequency
is

\begin{equation}\label{one}
\frac{\d I(s,\mathbf{x})}{\d s} + \alpha(s,\mathbf{x})\, I(s,\mathbf{x}) =
 \alpha(s,\mathbf{x})\, B(T(s)) \,,
\end{equation}

where $I$ is radiative intensity (more simply radiance), $\mathbf{x}$ is
the state vector, $s$ is path length, $\alpha(s,\mathbf{x})$ is the
absorption cross section,

\begin{equation*}
B(T(s)) = \frac{h \nu}k \left( \exp \left(\frac{h \nu}{k T(s)} \right)
 - 1 \right)^{-1}
\end{equation*}

is the Planck black-body radiation function in brightness-temperature
units, $\nu$ is frequency, $h$ is Planck's constant, $k$ is Boltzmann's
constant, and $T(s) \in \mathbf{x}(s)$ is temperature.

\end{frame}

% -----------------------------------------------------------------------------

\newframe{Radiative Transfer Equation}

The solution to Equation (\ref{one}) can be written
%
\begin{equation}\label{two}
I(s_m,\mathbf{x}) = I(s_0,\mathbf{x})\, \mathcal{T}(s_m) +
 \int_{s_0}^{s_m} \mathcal{T}(s) \,
  \alpha(s,\mathbf{x})\, B(T(s)) \, \d s \,,
\end{equation}
%
where $s_0$ is deep space, $s_m$ is the instrument
position,
%
\begin{equation*}\begin{split}
\mathcal{T}(s) = \,& \exp \left( - \int_{s_0}^s \alpha(\sigma,\mathbf{x}) \,
 \d \sigma \right), \\
\alpha(s,\mathbf{x}(s)) = \,& \sum_{k} f^k(s)\, \beta^k(s,T(s)) \,,
\end{split}\end{equation*}

$f^k(s) \in \mathbf{x}(s)$ is the mixing ratio of the $k^\text{th}$
chemical species, and $\beta^k(s,T(s))$ is the absorption coefficient for
that species.

\end{frame}

% -----------------------------------------------------------------------------

\newframe{Radiative Transfer Equation}

In the Full Forward Model, Equation (\ref{two}) is transformed by observing
that

\begin{equation*}
\frac{\d \mathcal{T}(s)}{\d s} = -\alpha(s)\, \mathcal{T}(s)
\end{equation*}

giving

\begin{equation*}
I(s_m,\mathbf{x}) = I(s_0,\mathbf{x})\, \mathcal{T}(s_m) -
 \int_{s_0}^{s_m} B(T(s)) \, \frac{\d \mathcal{T}(s)}{\d s} \, \d s
\end{equation*}

which is then integrated by parts giving

\begin{equation}\label{three}
I(s_m,\mathbf{x}) = \left( I(s_0,\mathbf{x}) - B(s_m) \right) \,
 \mathcal{T}(s_m) +
  \int_{s_0}^{s_m} \mathcal{T}(s) \frac{\d B(T(s))}{\d s} \, \d s \,.
\end{equation}

These transformations do not appear to be necessary; they eliminate one
multiply in the evaluation of the integrand in Equation (\ref{two}), which
is replaced by two subtractions, one of which approximates $\frac{\d
B(T(s))}{\d s}$ inaccurately.

\end{frame}

% -----------------------------------------------------------------------------

\newframe{Derivatives of the Radiative Transfer Equation (1)}

To solve for $\mathbf{x}$ using a Newton method (see wvs-050), derivatives
of $I(s_m,\mathbf{x})$ with respect to $\mathbf{x}$ are needed.  These can
be gotten by differentiating Equation (\ref{one}) with respect to elements
of $\mathbf{x}(s)$, which after re-arranging becomes

\begin{equation}\label{four}
\frac{\d I_{x^\mu}(s)}{\d s} + \alpha(s,\mathbf{x}(s))\,
 I_{x^\mu}(s) = R(s,\mathbf{x}(s)) \,,
\end{equation}

where

\begin{equation*}
I_{x^\mu}(s) = \frac{\partial I(s,\mathbf{x}(s))}{\partial x^\mu(s)} \,,
\end{equation*}

$x^\mu(s) \in \mathbf{x}(s)$ (either $f^k(s)$ or $T(s)$), and

\begin{equation}\label{R}
R(s,\mathbf{x}(s)) =
 \frac{\partial \alpha(s,\mathbf{x}(s))}{\partial x^\mu(s)}
 \left( B(T(s)) - I(s,\mathbf{x}) \right) +
 \alpha(s,\mathbf{x}(s)) \frac{\partial B(T(s))}{\partial x^\mu(s)} \,.
\end{equation}

\end{frame}

% -----------------------------------------------------------------------------

\newframe{Derivatives of the Radiative Transfer Equation (2)}

$B(T(s))$ depends upon frequency and temperature, but not any mixing ratio.
Its derivatives are
%
\begin{equation*}\begin{split}
\frac{\text{d} B(T(s))}{\text{d} T(s)} = \,&
 \frac{B(T(s))}{T(s)^2} \left( \frac{h\nu}k + B(T(s)) \right)\, \text{and}
 \\
\frac{\partial B(T(s))}{\partial f^k} = \,& 0\,.
\end{split}\end{equation*}
%
Remember that  $\alpha(s,\mathbf{x}(s)) = \sum_{k} f^k(s)\,
\beta^k(s,T(s))$, observe that $\beta^k(s,\mathbf{T}(s))$ usually does not
depend upon $f^k(s)$, and $f^k(s)$ does not depend upon temperature. 
Therefore
%
\begin{equation*}
\frac{\partial \alpha(s,\mathbf{x}(s))}{\partial f^k(s)} =
\beta^k(s,T(s)) \text{ and }
\frac{\partial \alpha(s,\mathbf{x}(s))}{\partial T(s)} =
\sum_{k} f^k(s) \frac{\partial \beta^k(s,T(s))}{\partial T(s)}
\end{equation*}
%
(see wvs-018 concerning temperature derivatives).

\end{frame}

% -----------------------------------------------------------------------------

\newframe{Derivatives of the Radiative Transfer Equation(3)}

Equation (\ref{four}) is of the same form as Equation (\ref{one}), with
$I(s,\mathbf{x})$ replaced by $I_{x^\mu}(s)$, and $\alpha(s,\mathbf{x})\,
B(T(s))$ in the right-hand side replaced by $R(s,\mathbf{x})$.  The
solution is therefore of the same form as Equation (\ref{two}), with
$\alpha(s,\mathbf{x})\, B(T(s))$ replaced by $R(s,\mathbf{x})$,
\emph{viz}.

\begin{equation}\begin{split}\label{five}
I_{x^\mu}(s_m) = \,&
 I_{x^\mu}(s_0) \,
  \mathcal{T}(s_m) +
  \int_{s_0}^{s_m} \mathcal{T}(s) \, R(s,\mathbf{x}(s)) \, \d s \\
= \,&
 \int_{s_0}^{s_m} \mathcal{T}(s) \, R(s,\mathbf{x}(s)) \, \d s \,, \\
\end{split}\end{equation}

the last equality because the derivative of radiance at the deep-space
starting point, $s_0$, with respect to any state-vector element $x^\mu$,
is zero.

\end{frame}

% -----------------------------------------------------------------------------

\newframe{Derivatives of the Radiative Transfer Equation (4)}

We wrote $\mathbf{x}(s)$ instead of $\mathbf{x}$ to emphasize that these
derivatives are with respect to state vector quantities \emph{on the
integration path}.  The Newton method needs derivatives with respect to
state vector elements \emph{in solution profiles}, which are calculated
using the chain rule, \emph{viz}.
%
\begin{equation*}
\frac{\partial \cdot}{\partial x^\mu_j} =
\frac{\partial \cdot}{\partial x^\mu(s)}
\frac{\partial x^\mu(s)}{\partial x^\mu_j} =
\frac{\partial \cdot}{\partial x^\mu(s)} \, \eta^\mu_j(s)\,,
\end{equation*}
%
where $x^\mu_j$ is the $j^\text{th}$ element of the $\mu^\text{th}$
solution profile state vector quantity (either $f^k$ or $T$), and
$\eta^\mu_j(s)$ is the interpolation coefficient from the geolocation of
$x^\mu_j$ to the integration path at $s$.

\vspace*{4pt}
Equations (\ref{three}) and (\ref{five}) are discretized, with steps at
$s_i$. Because we use bilinear interpolation from ($\phi \times \zeta$) to
$s_i$, the $i^\text{th}$ row of the matrix of elements $\eta^\mu_j(s_i)$
has only four nonzeroes for each $\mu$, and the number of nonzeroes in the
$j^\text{th}$ column for the $\mu^\text{th}$ species is $\leq 7$ because
$s_i$ is on a constant-$\zeta$ surface and quadrature (described below)
uses values on those surfaces, or at most three points each in
$(\zeta_{i-1},\zeta_i)$ and $(\zeta_i,\zeta_{i+1})$.

\end{frame}

% -----------------------------------------------------------------------------

\newframe{Derivatives in the Full Forward Model (1)}

The Full Forward Model evaluates $I_{f^\mu}(s_m)$ by differentiating
Equation (\ref{two}) w.r.t. $f^\mu_j$, \emph{viz}.

\begin{equation}\begin{split}\label{I_f}
\frac{\partial I(s_m)}{\partial f^\mu_j} = \,&
 -I(s_0)\, \mathcal{T}(s_m)
  \int_{s_0}^{s_m} \beta^\mu(\sigma)\, \eta^\mu_j \d \sigma + \\
&
 \int_{s_0}^{s_m} \mathcal{T}(s)\, B(s)
  \left( \beta^\mu(s)\, \eta^\mu_j(s) -
         \alpha(s) \int_s^{s_m} \beta^\mu(\sigma)\, \eta^\mu_j(\sigma)
          \d \sigma \right) \d s \,, \\
\end{split}\end{equation}

which leads to an expression different from Equation (\ref{five}), but
which is necessarily equivalent as can be shown (with some difficulty --
see
% \h{wvs-093} and \h{wvs-100}%
wvs-093 and wvs-100%
) by integrating by parts.

\vspace*{5pt}

The forward model also evaluates $I_{T_j}(s_m)$ by differentiating
Equation (\ref{two}) w.r.t.\ $T_j$, producing an expression even more
complicated than Equation (\ref{I_f}).

\end{frame}

% -----------------------------------------------------------------------------

\newframe{Derivatives in the Full Forward Model (2)}

The original advantage of differentiating Equation (\ref{two}) rather than
solving Equation(\ref{four}), giving Equation (\ref{five}), is that
$I(s,\mathbf{x})$ is not averaged over all frequencies within a channel
(as specified by the pointing-frequency grid), and the average then
retained at each $\zeta_i$.  Rather, only $I(s_m,\mathbf{x})$ is retained
for all frequencies, and then averaged (see wvs-063, ``Pointing loop'').

\vspace*{5pt}

(Remember that in Equation (\ref{R}), $R(s,\mathbf{x}(s))$ depends upon
$I(s,\mathbf{x})$.  To compute frequency-averaged derivatives using
Equation (\ref{five}) would require to retain the frequency-averaged
$I(s_i,\mathbf{x})$, not just the frequency-averaged $I(s_m,\mathbf{x})$.)

\vspace*{5pt}

To combine results for line-by-line (LBL) quantities with those for
pre-frequency-averaged (PFA) quantities (see wvs-027), however,
$I(s_i,\mathbf{x})$ for LBL quantities is averaged over those frequencies
and retained for each channel, which would allow the simpler expression in
Equation (\ref{five}) to be used.  Frequency averaging at all $s_i$ would
be only a tiny bit slower than only at $s_m$.

\end{frame}

% -----------------------------------------------------------------------------

\newframe{Transmissivity in the Full Forward Model}

The Full Forward Model evaluates $\mathcal{T}(s)$ as the exponential of a
sum of a sequence of integrals, with $\zeta = -\log_{10} P$ where $P$ is
pressure, as the independent variable:

\begin{equation}\label{six}
\mathcal{T}(\zeta_n) =
 \exp \left( - \sum_{i=1}^n \int_{\zeta_{i-1}}^{\zeta_i}
 \alpha(\zeta,\mathbf{x}) \,
 \frac{\d s}{\d h} \frac{\d h}{\d \zeta} \, \d \zeta \right)
\end{equation}

where $\zeta_i = \zeta(s_i) = -\log_{10} P(s_i)$.

\vspace*{5pt}

Each integral is approximated by a quadrature.  The integrand is evaluated
at $\zeta_{i-1}$ and $\zeta_i$.  An estimate of the error in a trapezoidal
approximation of the integral is formed.  If the error is not too large
(according to a parameter in the {\tt l2cf}), the trapezoidal estimate is
used.

\vspace*{5pt}

If the error is too large, the integrand is evaluated at the abscissae of
the three-point Gauss-Legendre quadrature formula.

\end{frame}

% -----------------------------------------------------------------------------

\newframe{Path length in the Full Forward Model (1)}

For limb viewing, without considering refraction directly,

\begin{equation*}
s = \sqrt{h^2 - h_t^2}\,,
\end{equation*}

where $h_t$ is the geocentric tangent point height, and $h$ is the height
at the point a distance $s$ from the tangent point.

\begin{centering}
\includegraphics[scale=0.5]{wvs-139-1}\\
\end{centering}

\end{frame}

% -----------------------------------------------------------------------------

\newframe{Path length in the Full Forward Model (1)}

Thereby

\begin{equation}\label{sqrt}
\frac{\d s}{\d h} = \frac{h}{\sqrt{h^2 - h_t^2}} \,.
\end{equation}

Therefore, the integrand in Equation (\ref{six}) has a square-root
singularity at the tangent point.  Using either a Taylor series or a
binomial expansion, one sees that a square-root singularity cannot be
represented by a finite polynomial.

\vspace*{5pt}
In the neighborhood of the singularity, $\frac{\d s}{\d h}$ cannot be
accurately approximated by a polynomial of any finite order, and in
particular not by a polynomial that the quadrature formula would integrate
exactly.

\vspace*{5pt}
The exponential function is also not a finite polynomial, but because it
does not have a singularity, it can be approximately well, over a short
interval, by a polynomial.

\end{frame}

% -----------------------------------------------------------------------------

\newframe{Full Forward Model -- Singularity at the Tangent}

Using a rectangular quadrature for the integral in Equation (\ref{six}),

\begin{equation*}\begin{split}
\int_{\zeta_{i-1}}^{\zeta_i} \alpha(\zeta,\mathbf{x})
 \frac{\d s}{\d h} \frac{\d h}{\d \zeta} \, \d \zeta \approx \,&
\alpha(\zeta_{i-1},\mathbf{x}) \int_{\zeta_{i-1}}^{\zeta_i} 
 \frac{\d s}{\d h} \frac{\d h}{\d \zeta} \, \d \zeta \\
 \equiv Q_{i-1} = \,&
 \alpha(\zeta_{i-1},\mathbf{x})\, \delta s_{i-1 \rightarrow i} \,, \\
\end{split}\end{equation*}

where $\delta s_{i-1 \rightarrow i} = s_i - s_{i-1}$, that integral can be
written

\begin{equation*}
\int_{\zeta_{i-1}}^{\zeta_i} \alpha(\zeta,\mathbf{x})
 \frac{\d s}{\d h} \frac{\d h}{\d \zeta} \, \d \zeta =
 Q_{i-1} + \int_{\zeta_{i-1}}^{\zeta_i}
  \left ( \alpha(\zeta,\mathbf{x}) - \alpha(\zeta_{i-1},\mathbf{x}) \right)
 \frac{\d s}{\d h} \frac{\d h}{\d \zeta} \, \d \zeta \,,
\end{equation*}

which cancels the singularity at the tangent point (but not in other
integrals), provided $\left ( \alpha(\zeta,\mathbf{x}) -
\alpha(\zeta_{i-1},\mathbf{x}) \right) \rightarrow 0$ as $\zeta
\rightarrow \zeta_{i-1}$ faster than $\sqrt{h^2-h_t^2} \rightarrow 0$ as
$h \rightarrow h_t$.

\end{frame}

% -----------------------------------------------------------------------------

\newframe{Full Forward Model -- Radiative Transfer Integral (1)}

If the error estimate for the integral is small enough, a trapezoidal
approximation is constructed using either
%
\begin{equation*}
\int_{s_{i-1}}^{s_i} \alpha(\zeta,\mathbf{x})\, \d s \approx
  \frac12 \left ( \alpha(\zeta_{i-1},\mathbf{x}) +
                          \alpha(\zeta_i,\mathbf{x}) \right)
                          \, \delta s_{i-1 \rightarrow i}
\end{equation*}

or
%
\begin{equation*}
\int_{s_{i-1}}^{s_i} \alpha(\zeta,\mathbf{x})\, \d s \approx
  \frac12 \left ( \alpha(\zeta_{i-1},\mathbf{x}) +
                          \alpha(\zeta_i,\mathbf{x}) \right)
                          \, \frac{\d s_{i-1}}{\d h}
                             \frac{\d h_{i-1}}{\d\zeta}
                             ( \zeta_i - \zeta_{i-1} )
\end{equation*}

depending upon the setting of {\tt trapezoid} in the forward model
configuration in the {\tt l2cf} to {\tt correct} or {\tt wrong},
respectively, wherein
%
\begin{equation*}
\frac{\d s_{i-1}}{\d h} \frac{\d h_{i-1}}{\d\zeta}
         ( \zeta_i - \zeta_{i-1} ) \approx \int_{\zeta_{i-1}}^{\zeta_i}
 \frac{\d s}{\d h} \frac{\d h}{\d\zeta}\, \d \zeta
\end{equation*}

is a rectangular quadrature approximation to $\delta s_{i-1 \rightarrow
i}$.

\end{frame}

% -----------------------------------------------------------------------------

\newframe{Full Forward Model -- Radiative Transfer Integral (2)}

If the error estimate for the integral is not small enough, a 3-point
Gauss-Legendre approximation is constructed using
%
\begin{equation}\begin{split}\label{nine}
\int_{\zeta_{i-1}}^{\zeta_i} & \alpha(\zeta,\mathbf{x})
 \frac{\d s}{\d h} \frac{d h}{\d \zeta} \, \d \zeta \approx
Q_{i-1} + \\
 \,&
( \zeta_i - \zeta_{i-1} ) \,
 \sum_{n=1}^3 w_{in} \left ( \alpha(\zeta_{in},\mathbf{x}) -
 \alpha(\zeta_{i-1},\mathbf{x}) \right)
\end{split}\end{equation}

where $w_{in} = \omega_n \frac{\d s(\zeta_{in})}{\d h} \frac{\d
h(\zeta_{in})}{\d \zeta}$, $\omega_n$ is the weight for the $n^\text{th}$
Gauss-Legendre point, and $\zeta_{in}$ is the abscissa for that point
within the range $\zeta_{i-1} \rightarrow \zeta_i$.

\end{frame}

% -----------------------------------------------------------------------------

\newframe{Full Forward Model -- Radiative Transfer Integral (3)}

Although this strategy provides acceptable accuracy, it creates tremendous
mischief throughout the rest of the forward model by attempting to
optimize the calculation.  It has led to a complicated system of flags and
indices, especially to calculate derivatives.
\vspace*{0.1in}

An alternative strategy is to compute $\alpha(\zeta_{in},\mathbf{x})$ from
first principles if the error estimate is not small enough, and use
interpolation to $\zeta_{in}$ from $\alpha(\zeta_{i-1},\mathbf{x})$ and
$\alpha(\zeta_i,\mathbf{x})$ if it is small enough.  Then always use the
approximation in Equation (\ref{nine}) rather than trying to save a tiny
bit of computation by choosing whether to use the trapezoidal quadrature
or the Gauss-Legendre quadrature. \vspace*{0.1in}

This might well be faster by replacing a branch within the path loop with
a subtract, a multiply to interpolate $\alpha$ to $\zeta_{in}$, and
multiplying by $w_{in}$.  It would definitely be simpler, especially in
the case of computing derivatives, by eliminating numerous flags and
indices.  Notice that $w_{in}$ is calculated once for each path, then used
for every frequency, and for both the radiance and every derivative
evaluated at each frequency.

\end{frame}

% -----------------------------------------------------------------------------

\end{document}

% $Id: wvs-139.tex,v 1.8 2019/09/04 00:22:00 vsnyder Exp $

% $Log: wvs-139.tex,v $
% Revision 1.8  2019/09/04 00:22:00  vsnyder
% Corrected derivative w.r.t. state-vector elements on page 8, added page 9,
% embellished former page 9 (now page 10), improved discussion of singularity
% on page 12 (now page 13), improved alternative integration strategy
% description on page 15 (now page 16).
%
% Revision 1.7  2019/08/29 01:26:39  vsnyder
% Clarify stuff, correct inconsistent notations
%
% Revision 1.6  2019/08/27 01:22:42  vsnyder
% Minor improvements and typo corrections
%
% Revision 1.5  2017/10/31 18:16:44  vsnyder
% Add a graphic, some cannonball polishing
%
% Revision 1.4  2017/10/16 17:30:22  pwagner
% This modification was needed; dont know why
%
% Revision 1.3  2017/06/08 18:39:12  vsnyder
% Remove hyperlink stuff because Paul can't build with it included
%
% Revision 1.2  2017/06/08 01:27:55  vsnyder
% Update after presentation
%
@


1.8
log
@Corrected derivative w.r.t. state-vector elements on page 8, added page 9,
embellished former page 9 (now page 10), improved discussion of singularity
on page 12 (now page 13), improved alternative integration strategy
description on page 15 (now page 16).
@
text
@d56 1
a56 1
\subtitle{wvs-139r3}
d60 1
a60 1
\date{3 September 2019}
d264 1
a264 1
$x^\mu_j$ to the integration path.
d274 1
a274 1
$(\zeta_{i-1},\zeta)$ and $(\zeta_i,\zeta_{i+1})$.
d280 1
a280 1
\newframe{Full Forward Model}
d313 1
a313 1
\newframe{Full Forward Model}
d342 1
a342 1
\newframe{Full Forward Model}
d374 1
a374 1
\newframe{Full Forward Model}
d393 1
a393 1
\newframe{Full Forward Model}
d421 1
a421 1
\newframe{Full Forward Model}
d455 1
a455 1
\newframe{Full Forward Model}
d458 8
a465 1
approximation is constructed using
d467 5
a471 6
\begin{equation}\begin{split}\label{eight}
\int_{s_{i-1}}^{s_i} \alpha(\zeta,\mathbf{x})\, \d s \approx \,&
Q_{i-1} + \frac12 \left ( \alpha(\zeta_i,\mathbf{x}) -
                          \alpha(\zeta_{i-1},\mathbf{x}) \right)
                          \, \delta s_{i-1 \rightarrow i} \\
= \,& \frac12 \left ( \alpha(\zeta_{i-1},\mathbf{x}) +
d473 23
a495 2
                          \, \delta s_{i-1 \rightarrow i} \,. \\
\end{split}\end{equation}
d506 1
a506 1
 \sum_{n=1,3} w_{in} \left ( \alpha(\zeta_{in},\mathbf{x}) -
d519 1
a519 1
\newframe{Full Forward Model}
a546 17
\newframe{Full Forward Model}

The Full Forward Model evaluates the trapezoidal quadrature in Equation
(\ref{eight}) less accurately than necessary.  It uses the first
right-hand side in Equation (\ref{eight}) instead of the second.  Further,
instead of using $\delta s_{i-1 \rightarrow i}$, which is available, it
uses a rectangular quadrature approximation

\begin{equation*}
\delta s_{i-1 \rightarrow i} = \int_{\zeta_{i-1}}^{\zeta_i}
 \frac{\d s}{\d h} \frac{\d h}{\d\zeta}\, \d \zeta
 \approx \frac{\d s_{i-1}}{\d h} \frac{\d h_{i-1}}{\d\zeta}
         ( \zeta_i - \zeta_{i-1} ) \,.
\end{equation*}

\end{frame}

d549 1
a549 1
% $Id: wvs-139.tex,v 1.7 2019/08/29 01:26:39 vsnyder Exp $
d552 6
@


1.7
log
@Clarify stuff, correct inconsistent notations
@
text
@d56 1
a56 1
\subtitle{wvs-139r2}
d60 1
a60 1
\date{26 August 2019}
d179 1
a179 1
\begin{equation*}
d184 1
a184 1
\end{equation*}
d252 1
a252 1
using the chain rule, \emph{viz}
d256 1
a256 1
\frac{\partial \cdot}{\partial x^\mu_j}
d270 5
a274 4
has only four nonzeroes for each $\mu$, and the number of nonzeroes in
column$^\mu_j$ is $\leq 7$ because $s_i$ is on a constant-$\zeta$ surface
and quadrature (described below) uses values on those surfaces, or at most
three points between.
d282 17
a298 4
The Full Forward Model evaluates $I_{x^\mu}$ by differentiating Equation
(\ref{two}), which leads to an expression different from Equation
(\ref{five}), but which is necessarily equivalent as can be shown (with
some difficulty -- see
a301 1
\vspace*{0.1in}
d303 28
a330 2
The original advantage of this approach is that $I(s,\mathbf{x})$ is not
retained for each frequency; rather only $I(s_m,\mathbf{x})$ is retained. 
d333 4
a336 2
$I(s,\mathbf{x})$ is retained for LBL quantities, which would allow the
simpler expression in Equation (\ref{five}) to be used.
d357 1
a357 1
\vspace*{0.1in}
d361 5
a365 2
approximation of the integral is formed.  If the error is not too large,
the trapezoidal estimate is used. \vspace*{0.1in}
d402 3
a404 3
singularity at the tangent point.  A square-root singularity in an
integrand exceeds the algebraic order of a quadrature formula, thereby
reducing its accuracy, so it should be removed.
d407 4
a410 3
To see that the singularity exceeds the algebraic order of a quadrature
formula, observe that the Taylor-series (or binomial) expansion of
Equation (\ref{sqrt}) is an infinite series, not a finite polynomial.
d513 2
a514 2
for every frequency, and both the radiance and every derivative evaluated
at each frequency.
d539 1
a539 1
% $Id: wvs-139.tex,v 1.6 2019/08/27 01:22:42 vsnyder Exp $
d542 3
@


1.6
log
@Minor improvements and typo corrections
@
text
@d56 1
a56 1
\subtitle{wvs-139r1}
d79 1
a79 1
 \alpha(s,\mathbf{x})\, B(T(s))
d82 3
a84 1
where $\mathbf{x}$ is the state vector.  The solution can be written
d86 17
d106 1
a106 1
  \alpha(s,\mathbf{x})\, B(T(s)) \, \d s
d108 3
a110 2

where
a112 2
B(T(s)) = \,& \frac{h \nu}k \left( \exp \left(\frac{h \nu}{k T(s)} \right)
 - 1 \right)^{-1} \\
d114 2
a115 1
 \d \sigma \right) \,,
d118 3
a120 1
$s_0$ is deep space, and $s_m$ is the instrument position.
d144 1
a144 1
\begin{equation*}
d148 1
a148 1
\end{equation*}
d152 2
a153 1
is replaced by a subtract to approximate $\frac{\d B(T(s))}{\d s}$.
d159 1
a159 1
\newframe{Derivatives of the Radiative Transfer Equation}
d161 4
a164 4
To solve for $\mathbf{x}$ using a Newton method, derivatives of
$I(s_m,\mathbf{x})$ with respect to $\mathbf{x}$ are needed.  These can be
gotten by differentiating Equation (\ref{one}) with respect to elements of
$\mathbf{x}(s)$:
d166 3
a168 3
\begin{equation}\label{three}
\frac{\d I^\prime_k(s)}{\d s} + \alpha(s,\mathbf{x}(s))\, I^\prime_k(s) =
 R(s,\mathbf{x}(s))
d174 1
a174 1
I^\prime_k(s) = \frac{\partial I(s,\mathbf{x}(s))}{\partial x_k(s)}
d177 1
a177 1
and
d181 1
a181 1
 \frac{\partial \alpha(s,\mathbf{x}(s))}{\partial x_k(s)}
d183 1
a183 1
 \alpha(s,\mathbf{x}(s)) \frac{\partial B(T(s))}{\partial x_k(s)} \,.
d190 1
a190 1
\newframe{Derivatives of the Radiative Transfer Equation}
d193 14
a206 20
It satisfies the differential equation

\begin{equation*}
\frac{\text{d} B(T(s))}{\text{d} T(s)} =
 \frac{B(T(s))}{T(s)^2} \left( \frac{h\nu}k + B(T(s)) \right)\,.
\end{equation*}

\begin{equation*}
\frac{\partial B(T(s))}{\partial x^k(s)} = 0 \text{ if }
 x^k(s) \text{ is not } T(s)\,.
\end{equation*}

\begin{equation*}
\alpha(s,\mathbf{x}(s)) = \sum_{k\neq T} f^k(s)\, \beta^k(s,T(s)) \,.
\end{equation*}

$\beta^k(s,\mathbf{x}^k(s))$ usually does not depend upon the mixing ratio.
$f^k(s) \in \mathbf{x}(s)$ is the mixing ratio of the $k^\text{th}$
species, and mixing ratios do not depend upon temperature.  Therefore

d211 1
a211 1
\sum_{k \neq T} f^k(s) \frac{\partial \beta^k(s,T(s))}{\partial T(s)}
d213 2
d220 1
a220 1
\newframe{Derivatives of the Radiative Transfer Equation}
d222 10
a231 10
Equation (\ref{three}) is of the same form as Equation (\ref{one}), with
$I(s,\mathbf{x})$ replaced by $I^\prime_k(s) = \frac{\partial
I(s_m,\mathbf{x})}{\partial x_k}$ and $\alpha(s,\mathbf{x})\, B(T(s))$
replaced by $R(s,\mathbf{x})$.  The solution is therefore of the same form
as Equation (\ref{two}), with $\alpha(s,\mathbf{x})\, B(T(s))$ replaced by
$R(s,\mathbf{x})$, \emph{viz}.

\begin{equation}\begin{split}\label{four}
\frac{\partial I(s_m,\mathbf{x}(s))}{\partial x_k(s)} = \,&
 \left.\frac{\partial I(s,\mathbf{x}(s))}{\partial x_k(s)} \right|_{s=s_0} \,
d235 1
a235 1
 \int_{s_0}^{s_m} \mathcal{T}(s) \, R(s,\mathbf{x}(s)) \, \d s \\
d238 3
a240 2
because the derivative of radiance at the deep-space starting point,
$s_0$, with respect to any state-vector element, is zero.
d246 1
a246 1
\newframe{Derivatives of the Radiative Transfer Equation}
d249 5
a253 5
derivatives are with respect to state vector quantities on the
integration path.  We calculate derivatives with respect to state vector
elements in solution profiles, which are needed for the Newton method,
using the chain rule

d255 4
a258 4
\frac{\partial \cdot}{\partial x^k_i} =
\frac{\partial \cdot}{\partial \mathbf{x}^k(s)}
\frac{\partial \mathbf{x}^k(s)}{\partial x^k_i} =
\frac{\partial \cdot}{\partial \mathbf{x}^k(s)} \, \eta^k_i(s)
d260 14
a273 4

where $x^k_i$ is the $i^\text{th}$ element of the $k^\text{th}$ solution
profile state vector quantity and $\eta^k_i(s)$ is the interpolation
coefficient from its geolocation to the integration path.
d281 3
a283 4
The Full Forward Model evaluates
$\frac{\partial I(s_m,\mathbf{x})}{\partial x^k}$ by differentiating
Equation (\ref{two}), which leads to an expression different from Equation
(\ref{four}), but which is necessarily equivalent as can be shown (with
d285 2
a286 2
% \h{wvs-100}%
wvs-100%
d291 5
a295 3
retained for each frequency; rather only $I(s_m,\mathbf{x})$ is retained.  For
PFA models, however,  $I(s,\mathbf{x})$ is retained, which would allow the
simpler expression in Equation (\ref{four}) to be used.
d304 2
a305 2
sequence of integrals, with $\zeta = -\log_{10} P$ where $P$ is pressure, as the
independent variable:
d307 1
a307 1
\begin{equation}\label{five}
d314 2
a315 1
where $\zeta_0 = \zeta_{s_0}$ and $\zeta_n = \zeta_{s_n}$.
d332 1
a332 1
For limb viewing, without considering refraction directly
d335 1
a335 1
s = \sqrt{h^2 - h_t^2}
d339 1
a339 1
at the point a disance $s$ from the tangent point.
d357 1
a357 1
Therefore, the integrand in Equation (\ref{five}) has a square-root
d364 7
a370 2
formula, observe that the Taylor-series expansion of Equation (\ref{sqrt})
is an infinite series, not a finite polynomial.
d378 1
a378 1
Using a rectangular quadrature for the integral in Equation (\ref{five})
d386 1
a386 1
 \alpha(\zeta_{i-1},\mathbf{x}) ( s_i - s_{i-1} ) \\
d389 2
a390 1
that integral can be written
d397 1
a397 1
 \frac{\d s}{\d h} \frac{\d h}{\d \zeta} \, \d \zeta
d400 2
a401 1
which cancels the singularity provided $\left ( \alpha(\zeta,\mathbf{x}) -
d415 1
a415 1
\begin{equation*}\begin{split}
d419 1
a419 1
                          \, ( s_i - s_{i-1} ) \\
d422 2
a423 2
                          \, ( s_i - s_{i-1} ) \\
\end{split}\end{equation*}
d428 1
a428 1
\begin{equation}\begin{split}\label{six}
d459 1
a459 1
approximation in Equation (\ref{six}) rather than trying to save a tiny
d473 19
d494 1
a494 1
% $Id: wvs-139.tex,v 1.5 2017/10/31 18:16:44 vsnyder Exp $
d497 3
@


1.5
log
@Add a graphic, some cannonball polishing
@
text
@d56 1
d60 3
a62 1
\date{7 June 2017}
d187 1
a187 1
$\beta^k(s,\mathbf{x}^k(s))$ usually does not depend upon the mixing ratio
d310 3
a312 1
\includegraphics{wvs-139-1}
d322 1
a322 1
\begin{equation*}
d324 1
a324 1
\end{equation*}
d331 5
d437 1
a437 1
% $Id: wvs-139.tex,v 1.4 2017/10/16 17:30:22 pwagner Exp $
d440 3
@


1.4
log
@This modification was needed; dont know why
@
text
@d5 1
d185 2
a186 2
$f^k(s) \in \mathbf{x}(s)$ of the $k^\text{th}$ species, and mixing ratios do
not depend upon temperature.  Therefore
d233 3
a235 3
\frac{\partial \cdot}{\partial \mathbf{x}^k_i} =
\frac{\partial \cdot}{\partial \mathbf{x}_k(s)}
\frac{\partial \mathbf{x}^k(s)}{\partial \mathbf{x}^k_i} =
d239 3
a241 3
where $\mathbf{x}^k_i$ is the $i^\text{th}$ element of the $k^\text{th}$
solution profile state vector quantity and $\eta^k_i(s)$ is the
interpolation coefficient from its geolocation to the integration path.
d281 1
a281 1
where $\zeta_0 = \zeta_{s_0}$ and $\zeta_n = \zeta_{s_m}$.
d305 11
a315 1
at the point a disance $s$ from the tangent point.  Thereby
d427 1
a427 1
% $Id: wvs-139.tex,v 1.3 2017/06/08 18:39:12 vsnyder Exp $
d430 3
@


1.3
log
@Remove hyperlink stuff because Paul can't build with it included
@
text
@d1 1
d416 1
a416 1
% $Id: wvs-139.tex,v 1.2 2017/06/08 01:27:55 vsnyder Exp $
d419 3
@


1.2
log
@Update after presentation
@
text
@d5 43
a47 43
\ifx\pdfoutput\undefined
  \pdfoutput=0
  \usepackage{hyperref}
  \hypersetup{%
    hypertex,%
    plainpages,%
    hyperindex=true,%
    hypertexnames=false%
  }
  % Specify the driver for the color package
  \ExecuteOptions{dvips}
  %\ExecuteOptions{xdvi}
\else
  \ifnum\pdfoutput>0
    \usepackage{hyperref}
    \hypersetup{%
      pdftex,%
      plainpages,%
      hyperindex=true,%
      pdfpagelabels,%
      hypertexnames=false,%
      colorlinks=true,%
      linktocpage=true,%
    }
    % Specify the driver for the color package
    \ExecuteOptions{pdftex}
  \else
    \usepackage{hyperref}
    \hypersetup{%
      hypertex,%
      plainpages,%
      hyperindex=true,%
      hypertexnames=false%
    }
    % Specify the driver for the color package
    \ExecuteOptions{dvips}
    %\ExecuteOptions{xdvi}
  \fi
\fi

\hyperbaseurl{}
\newcommand\hr[1]{\href{#1.dvi}{dvi}, \href{#1.pdf}{pdf}}
\newcommand\h[1]{#1 (\hr{#1})}
d251 4
a254 1
some difficulty -- see \h{wvs-100}) by integrating by parts.
d415 1
a415 1
% $Id: wvs-138.tex,v 1.1 2017/06/05 20:55:13 vsnyder Exp $
d417 4
a420 1
% $Log: wvs-138.tex,v $
@


1.1
log
@Initial commit
@
text
@d5 44
d74 1
a74 1
 \alpha(s,\mathbf{x})\, B(s,T)
d82 1
a82 1
  \alpha(s,\mathbf{x})\, B(s,T) \, \d s
d86 5
a90 3

\begin{equation*}
\mathcal{T}(s) = \exp \left( - \int_{s_0}^s \alpha(\sigma,\mathbf{x}) \,
d92 1
a92 1
\end{equation*}
d113 1
a113 1
 \int_{s_0}^{s_m} B(s,T) \, \frac{\d \mathcal{T}(s)}{\d s} \, \d s
d121 1
a121 1
  \int_{s_0}^{s_m} \mathcal{T}(s) \frac{\d B(s,T)}{\d s} \, \d s \,.
d126 1
a126 1
is replaced by a subtract to approximate $\frac{\d B(s,T)}{\d s}$.
d140 1
a140 3
\frac{\d}{\d s} \frac{\partial I(s_m,\mathbf{x}(s))}{\partial x_k(s)} +
 \alpha(s,\mathbf{x}(s))\,
 \frac{\partial I(s_m,\mathbf{x}(s))}{\partial x_k(s)} =
d147 6
d155 2
a156 2
 \left( B(s,T) - I(s,\mathbf{x}) \right) +
 \alpha(s,\mathbf{x}(s)) \frac{\partial B(s,T(s))}{\partial x_k(s)}
d159 8
a166 1
with
d169 22
a190 2
\frac{\partial B(s,T(s))}{\partial x_k(s)} = 0 \text{ if }
 x_k(s) \text{ is not } T(s)\,.
d200 5
a204 5
$I(s,\mathbf{x})$ replaced by $\frac{\partial I(s_m,\mathbf{x})}{\partial x_k}$
and $\alpha(s,\mathbf{x})\, B(s,T)$ replaced by $R(s,\mathbf{x})$.  The
solution is therefore of the same form as Equation (\ref{two}), with
$\alpha(s,\mathbf{x})\, B(s,T)$ replaced by $R(s,\mathbf{x})$,
\emph{viz}
d224 2
a225 2
We wrote $\mathbf{x}(s)$ instead of $\mathbf{x}$ to emphasize that
these derivatives are with respect to state vector quantities on the
d227 2
a228 1
elements in solution profiles using the chain rule
d231 1
a231 1
\frac{\partial \cdot}{\partial \mathbf{x}_{ki}} =
d233 2
a234 2
\frac{\partial \mathbf{x}_k(s)}{\partial \mathbf{x}_{ki}} =
\eta_{ki}(s)
d237 2
a238 2
where $\mathbf{x}_{ki}$ is the $i^\text{th}$ element of the $k^\text{th}$
solution profile state vector quantity and $\eta_{ki}(s)$ is the
d248 1
a248 1
$\frac{\partial I(s_m,\mathbf{x})}{\partial x_k}$ by differentiating
d251 1
a251 1
some difficulty) by integrating by parts.
d265 3
a267 3
The Full Forward Model evaluates $\mathcal{T}(s)$ as a sequence
of integrals, with $\zeta = -\log_{10} P$ where $P$ is pressure as the
independent variable
d308 2
a309 2
integrand reduces the algebraic order of a quadrature formula, so it
should be removed.
d324 1
a324 2
 \equiv Q_{i-1} = \alpha(\zeta_{i-1},\mathbf{x}) \,
 \delta s_{i-1 \rightarrow i} = \,&
d350 1
a350 1
estimate is constructed using
d353 1
a353 1
\int_{\zeta_{i-1}}^{\zeta_i} \alpha(\zeta,\mathbf{x}) \approx \,&
d356 1
a356 1
                          \, \delta s_{i-1 \rightarrow i} \\
d359 1
a359 1
                          \, \delta s_{i-1 \rightarrow i} \\
d364 8
a371 5

\begin{equation}\label{six}
\int_{\zeta_{i-1}}^{\zeta_i} \alpha(\zeta,\mathbf{x}) \approx
Q_{i-1} + \delta s_{i-1 \rightarrow i} \,
 \sum_{n=1,3} \omega_n \left ( \alpha(\zeta_{in},\mathbf{x}) -
d373 1
a373 1
\end{equation}
d375 4
a378 3
where $\omega_n$ is the weight for the $n^\text{th}$ Gauss-Legendre point,
and $\zeta_{in}$ is the abscissa for that point within the range $\zeta_{i-1}
\rightarrow \zeta_i$.
d401 6
a406 4
a subtract and two multiples (one to interpolate $\alpha$ to $\zeta_{in}$
and the other to multiply by $\omega_n$).  It would definitely be simpler,
especially in the case of computing derivatives, by eliminating numerous
flags and indices.
d411 4
@

