head	1.5;
access;
symbols
	v5-02-NRT-19:1.5
	v6-00:1.5
	v5-02-NRT-18:1.5
	v5-02:1.5
	v5-01-NRT-17:1.5
	v5-01-NRT-16:1.5
	v5-01-NRT-15:1.5
	v5-01-NRT-14:1.5
	neuralnetworks-1-0:1.5.0.12
	cfm-single-freq-0-1:1.5.0.10
	v5-01:1.5
	v5-00:1.5
	v4-23-TA133:1.5.0.8
	mus-emls-1-70:1.5.0.6
	rel-1-0-englocks-work:1.5.0.4
	VUMLS1-00:1.5
	VPL1-00:1.5
	V4-22-NRT-08:1.5
	VAM1-00:1.5
	V4-21:1.5.0.2
	V4-13:1.5
	V4-12:1.5
	V4-11:1.5
	V4-10:1.5
	V3-43:1.1
	M4-00:1.5
	V3-41:1.1
	V3-40-PlusGM57:1.1.0.2
	V3-33:1.2
	V3-31:1.2
	V3-30-NRT-05:1.2
	cfm-01-00:1.1
	V3-30:1.1
	V3-20:1.1
	V3-10:1.1;
locks; strict;
comment	@% @;


1.5
date	2012.09.19.19.08.15;	author vsnyder;	state Exp;
branches;
next	1.4;

1.4
date	2012.09.19.19.04.59;	author vsnyder;	state Exp;
branches;
next	1.3;

1.3
date	2011.08.26.23.44.33;	author vsnyder;	state Exp;
branches;
next	1.2;

1.2
date	2010.08.11.00.38.59;	author vsnyder;	state Exp;
branches;
next	1.1;

1.1
date	2008.06.11.20.14.51;	author vsnyder;	state Exp;
branches;
next	;


desc
@@


1.5
log
@Improve more hyperlinks
@
text
@\documentclass[11pt]{article}
\usepackage{alltt}
\usepackage[fleqn]{amsmath}
\usepackage{floatflt}
\usepackage{graphicx}
\usepackage{longtable}

\textwidth 6.5in
\oddsidemargin -0.25in
%\evensidemargin -0.5in
\topmargin -0.5in
\textheight 9in

\newcommand{\docname}{\bf wvs-026r6}
\newcommand{\docdate}{19 September 2012}

\ifx\pdfoutput\undefined
  \pdfoutput=0
  \usepackage[hypertex,plainpages,hyperindex=true]{hyperref}
  \hypersetup{%
    hypertexnames=false%
  }
  % Specify the driver for the color package
  \ExecuteOptions{dvips}
  %\ExecuteOptions{xdvi}
\else
  \ifnum\pdfoutput>0
    \usepackage[pdftex,plainpages,hyperindex=true,pdfpagelabels]{hyperref}
    \hypersetup{%
      hypertexnames=false,%
      colorlinks=true,%
      linktocpage=true,%
    }
    % Specify the driver for the color package
    \ExecuteOptions{pdftex}
  \else
    \usepackage[hypertex,plainpages,hyperindex=true]{hyperref}
    \hypersetup{%
      hypertexnames=false%
    }
    % Specify the driver for the color package
    \ExecuteOptions{dvips}
    %\ExecuteOptions{xdvi}
  \fi
\fi

\hyperbaseurl{}
\newcommand\hr[1]{\href{#1.dvi}{dvi}, \href{#1.pdf}{pdf}}
\newcommand\h[1]{#1 (\hr{#1})}

\begin{document}

%\tracingcommands=1
\newlength{\hW} % heading box width
\newlength{\pW} % page number field width
\settowidth{\hW}{\docname}
\settowidth{\pW}{Page \pageref{lastpage}\ of \pageref{lastpage}}
\ifdim \pW > \hW \setlength{\hW}{\pW} \fi
\makeatletter
\def\@@biblabel#1{#1.}
\newcommand{\ps@@twolines}{%
  \renewcommand{\@@oddhead}{%
    \docdate\hfill\parbox[t]{\hW}{{\docname}\newline
                          Page \thepage\ of \pageref{lastpage}}}%
\renewcommand{\@@evenhead}{}%
\renewcommand{\@@oddfoot}{}%
\renewcommand{\@@evenfoot}{}%
}%
\makeatother
\pagestyle{twolines}

\vspace{-10pt}
\begin{tabbing}
\phantom{References: }\= \\
To: \>Bill, Nathaniel, Mike\\
Subject: \>Simplifying assumption to combine line-by-line and PFA\\
From: \>Van Snyder\\
Reference: \>\h{wvs-024}, \h{wvs-025}\\
\end{tabbing}

\parindent 0pt \parskip 3pt
\vspace{-20pt}

\section{Introduction}

Recall from \h{wvs-024} the equations to combine PFA and line-by-line
radiances for a particular channel $c$

\begin{equation}\label{combined}
I_c = \int \text{d}\nu\, \phi_c(\nu)
      \int \text{d} \zeta \frac{\partial B(\nu,T(\zeta))}{\partial \zeta}
      \tau(\zeta,\nu)
 \approx \sum_{n=1}^{N_f} \phi_{nc} \Delta \nu_{nc}
               \sum_{i=1}^{N_p} \Delta B_{ic} \tau^s_{in} \tau^w_{ic}
\end{equation}

and to combine PFA and line-by-line derivatives for that channel

\begin{equation}\label{final}
\frac{\partial I_c}{\partial x_k}
\approx \sum_{n=1}^{N_f} \phi_{nc} \Delta \nu_{nc} \sum_{i=1}^{N_p}
 \left(
  \frac{\partial \Delta B_{ic}}{\partial x_k} -
  \Delta B_{ic}
   \sum_{j=1}^i \left( \frac{\partial \delta^s_{jn}}{\partial x_k} +
                      \frac{\partial \delta^w_{jc}}{\partial x_k}
                \right)
  \right) \tau^s_{in} \tau^w_{ic}\,.
\end{equation}

This isn't precisely representative because the outer sums are actually
applications of the Newton 3/8 quadrature rule, and the inner sums are
evaluated on a different frequency grid from the outer sums (the pointing
frequency grid), and then interpolated to the grid used for the outer sums.

The forward model actually computes ``raw'' radiances and derivatives on the
pointing frequency grid

\begin{equation}\begin{split}\label{raw}
R_n =\,& \sum_{i=1}^{N_p} \Delta B_{in} \tau^s_{in} \tau^w_{ic} \\
\frac{\partial R_n}{\partial x_k} =\,&
\sum_{i=1}^{N_p}
 \left(
  \frac{\partial \Delta B_{in}}{\partial x_k} +
  \Delta B_{ic} \left( \frac{\partial \tau^s_{in}}{\partial x_k} \tau^w_{ic} +
                       \tau^s_{in} \frac{\partial \tau^w_{in}}{\partial x_k}
                \right)
 \right) \\
=\,&
\sum_{i=1}^{N_p}
 \left(
  \frac{\partial \Delta B_{in}}{\partial x_k} -
  \Delta B_{ic}
   \sum_{j=1}^i \left( \frac{\partial \delta^s_{jn}}{\partial x_k} +
                      \frac{\partial \delta^w_{jc}}{\partial x_k}
                \right)
  \right) \tau^s_{in} \tau^w_{ic}\,.
\end{split}\end{equation}

It then interpolates these results to the filter function grid and integrates
the product of these results and the filter function using the Newton 3/8 rule:

\begin{equation}\begin{split}
I_c =\,& \sum_{n=1}^{N_f} w_n \phi_{nc} \Delta \nu_{nc} \hat R_n\\
\frac{\partial I_c}{\partial x_k} =\,&
 \sum_{n=1}^{N_f} w_n \phi_{nc} \Delta \nu_{nc}
  \frac{\partial \hat R_n}{\partial x_k}
\end{split}\end{equation}

where $w_n$ is a weight for the Newton 3/8 rule, the hat indicates quantities
interpolated from the pointing frequency grid to the filter function grid, and
$n$ now ranges over the filter grid instead of the pointing frequency grid.

The term $\frac{\partial \delta^s_{jn}}{\partial x_k}$ is a three-dimensional
array that could, in the worst case, require 6 GB of storage per species.  To
reduce this requirement, it is proposed to revise the scheme for combining PFA
and line-by-line radiances and derivatives.

\section{Simplifying assumption for combining line-by-line and PFA
derivatives}

Expand the sum for $\frac{\partial R_n}{\partial x_k}$ in Equation (\ref{raw}):

\begin{equation}\label{expand}
\begin{split}
\frac{\partial R_n}{\partial x_k} =\,& \sum_{i=1}^{N_p}
 \left(
  \frac{\partial \Delta B_{in}}{\partial x_k} -
  \Delta B_{in}
   \sum_{j=1}^i \left( \frac{\partial \delta^s_{jn}}{\partial x_k} +
                      \frac{\partial \delta^w_{jc}}{\partial x_k}
                \right)
  \right) \tau^s_{in} \tau^w_{ic} = \\
&\sum_{i=1}^{N_p}
 \left(
  \frac{\partial \Delta B_{in}}{\partial x_k} -
  \Delta B_{in}
   \sum_{j=1}^i\frac{\partial \delta^s_{jn}}{\partial x_k}
  \right) \tau^s_{in} \tau^w_{ic} -
\sum_{i=1}^{N_p} \Delta B_{ic} \sum_{j=1}^i
 \frac{\partial \delta^w_{jc}}{\partial x_k} \tau^s_{in} \tau^w_{ic}\,.
\end{split}
\end{equation}

If the PFA calculations are done first the $\frac{\partial
\delta^s_{jn}}{\partial x_k}$ quantity need not be represented by an array that
has a frequency dimension:  The first term in the right-hand side can be
evaluated separately for each frequency, as is done in the non-PFA case.  This
requires to store the much smaller array that represents the $\frac{\partial
\delta^w_{jc}}{\partial x_k}$ quantity for use in the second term in the
right-hand side.

By using some representative average value $\overline{\tau^w_c}$ instead
of $\tau^w_{ic}$ in the first term, we have

\begin{equation}\begin{split}\label{simple}
\frac{\partial I_c}{\partial x_k}
\approx\,& \overline{\tau^w_c} \sum_{n=1}^{N_f} \phi_{nc} \Delta \nu_{nc} \sum_{i=1}^{N_p}
 \left(
  \frac{\partial \Delta B_{in}}{\partial x_k} -
  \Delta B_{in}
   \sum_{j=1}^i \frac{\partial \delta^s_{jn}}{\partial x_k}
  \right) \tau^s_{in}\\
  \,& -
 \sum_{n=1}^{N_f} \phi_{nc} \Delta \nu_{nc} \sum_{i=1}^{N_p}
  \Delta B_{ic} \sum_{j=1}^i\frac{\partial \delta^w_{jc}}{\partial x_k}
   \tau^s_{in} \tau^w_{ic}\,.
\end{split}\end{equation}

The first term is simply the line-by-line derivative multiplied by
$\overline{\tau^w_c}$.  As is done in the non-PFA case, the $\frac{\partial
\delta^s_{jn}}{\partial x_k}$ quantity can be computed and discarded for each
frequency in the pointing grid; it need not be saved for use during frequency
averaging.  This still requires that the PFA calculation be done first, and
that $\frac{\partial \delta^w_{jc}}{\partial x_k}$ be saved for use in the
second term.

A further simplification is to approximate $\overline{\tau^w_c} \approx 1$. 
This allows PFA calculations to be done after line-by-line calculations, and
therefore allows $\frac{\partial \delta^w_{jc}}{\partial x_k}$ not to have a
channel dimension.  As is the case for $\frac{\partial \delta^s_{jn}}{\partial
x_k}$ it can be calculated separately for each channel and then discarded.

This introduces a minor inconsistency between the radiance and its derivatives. 
Experiments will show whether this confuses the nonlinear solver.

As explained in \h{wvs-025}, it is possible to eliminate the frequency
dimension altogether from array quantities other than the pointing
frequency grids themselves, while preserving the fidelity of the
approximations.

The frequency-averaged radiance due to strong lines, in each channel at each
point along the path, is

\begin{equation}\label{rad}
\overline{I^s_{ic}} =
 \sum_{n=1}^{N_f} \phi_{nc} \Delta \nu_{nc} \Delta B_{in} \tau^s_{in}
 \approx
 \Delta B_{ic} \sum_{n=1}^{N_f} \phi_{nc} \Delta \nu_{nc}
  \tau^s_{in}\,.
\end{equation}

Since the frequency variation within a channel is very small compared to the
channel center frequency,  $\Delta B_{ic}$ is very nearly $\Delta B_{in}$, and
this is therefore a good approximation.

Exchanging the order of summation in the second term in Equation (\ref{simple})
and substituting $\overline{I^s_{ic}}$,

\begin{equation}\label{deriv}
\frac{\partial I_c}{\partial x_k}
\approx \sum_{n=1}^{N_f} \phi_{nc} \Delta \nu_{nc} \sum_{i=1}^{N_p}
 \left(
  \frac{\partial \Delta B_{in}}{\partial x_k} -
  \Delta B_{in}
   \sum_{j=1}^i \frac{\partial \delta^s_{jn}}{\partial x_k}
  \right) \tau^s_{in}
 -
 \sum_{i=1}^{N_p} \overline{I^s_{ic}} \tau^w_{ic}
  \sum_{j=1}^i\frac{\partial \delta^w_{jc}}{\partial x_k}\,.
\end{equation}

The first term is now simply the line-by-line derivative, and the second term
is a PFA correction.  The inner sum within the second term can be evaluated
within the frequency loop, thereby not needing to provide a $c$ dimension for
$\frac{\partial \delta^w_{jc}}{\partial x_k}$.

Observe in Equation (\ref{deriv}) that when $x_k$ is a mixing ratio,
$\frac{\partial \Delta B_{in}}{\partial x_k} = 0$.  Further, there are no
molecules that are both PFA and LBL, so either $\frac{\partial
\delta^s_{jn}}{\partial x_k} = 0$ or $\frac{\partial \delta^w_{jc}}{\partial
x_k} = 0$.  The only time that Equation (\ref{deriv}) actually ``combines''
derivatives is when $x_k = T$.

The frequency-averaged radiance, including the contribution from PFA (weak)
lines can be gotten by exchanging the order of summation in Equation
(\ref{combined}) and substituting $\overline{I^s_{ic}}$ from Equation
(\ref{rad}):

\begin{equation}
I_c \approx \sum_{i=1}^{N_p} \overline{I^s_{ic}} \tau^w_{ic}\,.
\end{equation}

When PFA is not used, channel radiances can be gotten by assuming $\tau^w_{ic} =
1$, that is, simply by summing $\overline{I_{ic}}$ for each channel.

\label{lastpage}
\end{document}
% $Id: wvs-026.tex,v 1.4 2012/09/19 19:04:59 vsnyder Exp $
@


1.4
log
@Improve hyperlinks
@
text
@d14 1
a14 1
\newcommand{\docname}{\bf wvs-026r5}
d227 4
a230 3
As explained in wvs-025, it is possible to eliminate the frequency dimension
altogether from array quantities other than the pointing frequency grids
themselves, while preserving the fidelity of the approximations.
d289 1
a289 1
% $Id: wvs-026.tex,v 1.3 2011/08/26 23:44:33 vsnyder Exp $
@


1.3
log
@Improve definition of "Raw" radiances
@
text
@d2 5
a6 1
\usepackage[fleqn]{amsmath}\textwidth 6.25in
d8 1
d12 1
a12 1
\textheight 9.00in
d14 36
a49 2
\newcommand{\docname}{\bf wvs-026r4}
\newcommand{\docdate}{26 August 2011}
d78 1
a78 1
Reference: \>wvs-024r2, wvs-025\\
d86 2
a87 2
Recall from wvs-024r2 the equations to combine PFA and line-by-line radiances
for a particular channel $c$
d288 1
a288 1
% $Id: wvs-026.tex,v 1.2 2010/08/11 00:38:59 vsnyder Exp $
@


1.2
log
@Further explanation of combining derivatives
@
text
@d9 2
a10 2
\newcommand{\docname}{\bf wvs-026r3}
\newcommand{\docdate}{10 August 2010}
d52 2
a53 1
      \int \text{d} z\, \Delta B(z,\nu) \tau(z,\nu)
d85 8
d249 1
a249 1
% $Id: wvs-026.tex,v 1.1 2008/06/11 20:14:51 vsnyder Exp $
@


1.1
log
@Initial commit
@
text
@d9 2
a10 2
\newcommand{\docname}{\bf wvs-026r2}
\newcommand{\docdate}{17 October 2005}
d180 1
a180 1
altogether from array quantities other then the pointing frequency grids
d201 1
a201 1
\begin{equation}
d219 7
d240 1
a240 1
% $Id: wvs-026r2.tex,v 1.1 2008/06/11 20:14:51 vsnyder Exp $
@

