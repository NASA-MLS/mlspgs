head	1.1;
access;
symbols
	v5-02-NRT-19:1.1
	v6-00:1.1
	v5-02-NRT-18:1.1
	v5-02:1.1
	v5-01-NRT-17:1.1
	v5-01-NRT-16:1.1
	v5-01-NRT-15:1.1
	v5-01-NRT-14:1.1
	neuralnetworks-1-0:1.1.0.14
	cfm-single-freq-0-1:1.1.0.12
	v5-01:1.1
	v5-00:1.1
	v4-23-TA133:1.1.0.10
	mus-emls-1-70:1.1.0.8
	rel-1-0-englocks-work:1.1.0.6
	VUMLS1-00:1.1
	VPL1-00:1.1
	V4-22-NRT-08:1.1
	VAM1-00:1.1
	V4-21:1.1.0.4
	V4-13:1.1
	V4-12:1.1
	V4-11:1.1
	V4-10:1.1
	V3-43:1.1
	M4-00:1.1
	V3-41:1.1
	V3-40-PlusGM57:1.1.0.2
	V3-33:1.1
	V3-31:1.1
	V3-30-NRT-05:1.1
	cfm-01-00:1.1
	V3-30:1.1
	V3-20:1.1
	V3-10:1.1;
locks; strict;
comment	@% @;


1.1
date	2008.06.11.20.14.54;	author vsnyder;	state Exp;
branches;
next	;


desc
@@


1.1
log
@Initial commit
@
text
@\documentclass[11pt]{article}
\usepackage[fleqn]{amsmath}\textwidth 6.5in
\oddsidemargin -0.25in
%\evensidemargin -0.5in
\topmargin -0.5in
\textheight 9.4in

\newcommand{\docname}{\bf wvs-060}
\newcommand{\docdate}{25 October 2007}

\begin{document}

%\tracingcommands=1
\newlength{\hW} % heading box width
\newlength{\pW} % page number field width
\settowidth{\hW}{\docname}
\settowidth{\pW}{Page \pageref{lastpage}\ of \pageref{lastpage}}
\ifdim \pW > \hW \setlength{\hW}{\pW} \fi
\makeatletter
\def\@@biblabel#1{#1.}
\newcommand{\ps@@twolines}{%
  \renewcommand{\@@oddhead}{%
    \docdate\hfill\parbox[t]{\hW}{{\hfill\docname}\newline
                          Page \thepage\ of \pageref{lastpage}}}%
\renewcommand{\@@evenhead}{}%
\renewcommand{\@@oddfoot}{}%
\renewcommand{\@@evenfoot}{}%
}%
\makeatother
\pagestyle{twolines}

\vspace{-10pt}
\begin{tabbing}
\phantom{References: }\= \\
To: \>Bill, Nathaniel\\
Subject: \>Trouble with GL correction in the forward model\\
From: \>Van Snyder\\
%Reference: \>wvs-048
\end{tabbing}

\parindent 0pt \parskip 6pt
\vspace{-10pt}

The forward model computes the incremental optical depth along the line
of sight by approximating the integral of the species-averaged cross
section, $\int \alpha(s)\, \text{d}s$, by a rectangle rule, \emph{viz.}
$\alpha(s_j)\, \delta s_j$, where $\delta(s_j) = s_j - s_{j-1}$.

Where $\alpha(s_j) - \alpha(s_{j-1})$ is less than a specified
tolerance, it replaces the rectangle rule by a trapezoid rule, \emph{viz.}
$\frac12(\alpha(s_{j-1})+\alpha(s_j))\, \delta s_j$.

Where $\alpha(s_j) - \alpha(s_{j-1})$ is greater than a specified
tolerance, it replaces the rectangle rule by a Gauss-Legendre quadrature,
\emph{viz.}\
$\int \alpha(s) \text{d}s = \int \alpha(\zeta) \frac{\text{d}s}{\text{d}h}
\frac{\text{d}h}{\text{d}\zeta} \text{d} \zeta \approx \delta \zeta
\sum_{i=1}^{n_{\text{GL}}} \alpha(\zeta_i) \frac{\text{d}s}{\text{d}h}
\frac{\text{d}h}{\text{d}\zeta} \omega_i$, where $\zeta_i$ are the
abscissae of the Gauss-Legendre quadrature formula, and $\omega_i$ are the
corresponding weights.

This is complicated by a singularity in $\frac{\text{d}s}{\text{d}h} = h /
\sqrt{h^2 - h_t^2}$ at the tangent point, which is removed by adding and
subtracting $\alpha(s_j)$ (it ought actually to be removed by adding and
subtracting $\alpha(h_t)$).  The net effect is that we evaluate
%
\begin{equation}
\delta \zeta \sum_{i=1}^{n_{\text{GL}}} \frac{\text{d}s}{\text{d}h}
\frac{\text{d}h}{\text{d}\zeta} \omega_i ( \alpha(\zeta_i) - \alpha(s_j) ) +
\alpha(s_j) \delta s\,.
\end{equation}
%
Analytically, as opposed to computationally, this is
%
\begin{equation}
\int \frac{\text{d}s}{\text{d}h}
\frac{\text{d}h}{\text{d}\zeta}\,( \alpha(\zeta) - \alpha(s_j) )\,
\text{d}\zeta +
\int \alpha(s_j)\, \text{d}s =
\int \alpha(\zeta) \frac{\text{d}s}{\text{d}h}
\frac{\text{d}h}{\text{d}\zeta} \text{d} \zeta =
\int \alpha(s) \text{d}s\,.
\end{equation}
%
A problem arises, however, because the forward model has trouble modeling
$\frac{\text{d}h}{\text{d}\zeta}$ on a sufficiently fine scale that $\int
\frac{\text{d}s}{\text{d}h}\frac{\text{d}h}{\text{d}\zeta}\text{d}\zeta /
\delta s = 1$.  In experiments I have run so far, this ratio varies
between 0.8 and 1.95.  In the last case, this resulted in negative
incremental optical depth.  At the same point, the computation of the
refractive correction failed to converge, resulting in 100 being used. 
This caused the quantity $\tau$, which is the exponential of the negative
of the product of the refractive correction and the incremental optical
depth, to exceed the largest single-precision floating-point number,
which resulted in NaNs in the Jacobian matrix, which resulted in
inability to factor the normal equations.

There are several possible responses to this problem.

One is to crash the chunk, which the software does now.  Another is to
reject blocks of the Jacobian matrix containing NaNs, which might or
might not result in crashing the chunk.  A diagnostic ought to be
produced to indicate that the quality of retrieval of the relevant
quantities is questionable.  The third is to try to compensate for the
problem in modeling $\frac{\text{d}h}{\text{d}\zeta}$, \emph{viz.}
%
\begin{equation}\begin{split}
\int \frac{\text{d}s}{\text{d}h}
\frac{\text{d}h}{\text{d}\zeta}\,( \alpha(\zeta) - \alpha(s_j) )\,
\text{d}\zeta +\,&
\int \alpha(s_j)\, \text{d}s =
\left[
\frac{\int \text{d}s}
     {\int \frac{\text{d}s}{\text{d}h}\frac{\text{d}h}{\text{d}\zeta}
     \text{d} \zeta}
\right]
\int \frac{\text{d}s}{\text{d}h}
\frac{\text{d}h}{\text{d}\zeta}\,( \alpha(\zeta) - \alpha(s_j) )\,
\text{d}\zeta +
\int \alpha(s_j)\, \text{d}s\\
\approx\,&
\left[
\frac{\delta s}{\delta \zeta \sum_{i=1}^{n_{\text{GL}}} \frac{\text{d}s}{\text{d}h}
\frac{\text{d}h}{\text{d}\zeta} \omega_i}
\right]\,
\delta \zeta \sum_{i=1}^{n_{\text{GL}}} \frac{\text{d}s}{\text{d}h}
\frac{\text{d}h}{\text{d}\zeta} \omega_i ( \alpha(\zeta_i) - \alpha(s_j) ) +
\alpha(s_j) \delta s\,.
\end{split}\end{equation}
%
The first term in brackets is clearly exactly 1.  The second one ought to
be 1, but computationally it sometimes is not.  Introducing it
compensates for errors in modeling $\frac{\text{d}h}{\text{d}\zeta}$.

The third response could change results somewhat, and thereby affect the
conclusions of the validation papers.  The underlying problem might
contribute to the biases in certain retrievals.

\label{lastpage}
\end{document}
% $Id: $
@
