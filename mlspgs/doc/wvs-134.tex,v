head	1.2;
access;
symbols
	v5-02-NRT-19:1.2
	v6-00:1.2
	v5-02-NRT-18:1.2
	v5-02:1.2
	v5-01-NRT-17:1.2
	v5-01-NRT-16:1.2
	v5-01-NRT-15:1.2
	v5-01-NRT-14:1.2
	neuralnetworks-1-0:1.2.0.10
	cfm-single-freq-0-1:1.2.0.8
	v5-01:1.2
	v5-00:1.2
	v4-23-TA133:1.2.0.6
	mus-emls-1-70:1.2.0.4
	rel-1-0-englocks-work:1.2.0.2
	VUMLS1-00:1.2
	VPL1-00:1.2
	V4-22-NRT-08:1.2;
locks; strict;
comment	@% @;


1.2
date	2016.03.28.18.31.08;	author vsnyder;	state Exp;
branches;
next	1.1;

1.1
date	2016.03.17.19.04.25;	author vsnyder;	state Exp;
branches;
next	;


desc
@@


1.2
log
@Add Fred's method
@
text
@\documentclass[11pt]{article}
\usepackage{alltt}
\usepackage[fleqn]{amsmath}
\usepackage{floatflt}
\usepackage{graphicx}
\usepackage{longtable}
\usepackage[strings]{underscore}

\textwidth 6.5in
\oddsidemargin -0.25in
%\evensidemargin -0.5in
\topmargin -0.5in
\textheight 9in

\newcommand{\docname}{wvs-134r1}
\newcommand{\docdate}{25 March 2016}

\ifx\pdfoutput\undefined
  \pdfoutput=0
  \usepackage[hypertex,plainpages,hyperindex=true]{hyperref}
  \hypersetup{%
    hypertexnames=false%
  }
  % Specify the driver for the color package
  \ExecuteOptions{dvips}
  %\ExecuteOptions{xdvi}
\else
  \ifnum\pdfoutput>0
    \usepackage[pdftex,plainpages,hyperindex=true,pdfpagelabels]{hyperref}
    \hypersetup{%
      hypertexnames=false,%
      colorlinks=true,%
      linktocpage=true,%
    }
    % Specify the driver for the color package
    \ExecuteOptions{pdftex}
  \else
    \usepackage[hypertex,plainpages,hyperindex=true]{hyperref}
    \hypersetup{%
      hypertexnames=false%
    }
    % Specify the driver for the color package
    \ExecuteOptions{dvips}
    %\ExecuteOptions{xdvi}
  \fi
\fi

\hyperbaseurl{}
\newcommand\hr[1]{\href{#1.dvi}{dvi}, \href{#1.pdf}{pdf}}
\newcommand\h[1]{#1 (\hr{#1})}

\begin{document}

%\tracingcommands=1
\newlength{\hW} % heading box width
\newlength{\pW} % page number field width
\settowidth{\hW}{\bf\docname}
\settowidth{\pW}{Page \pageref{lastpage}\ of \pageref{lastpage}}
\ifdim \pW > \hW \setlength{\hW}{\pW} \fi
\makeatletter
\def\@@biblabel#1{#1.}
\newcommand{\ps@@twolines}{%
  \renewcommand{\@@oddhead}{%
    \docdate\hfill\parbox[t]{\hW}{{\hfill\bf\docname}\newline
                          Page \thepage\ of \pageref{lastpage}}}%
\renewcommand{\@@evenhead}{}%
\renewcommand{\@@oddfoot}{}%
\renewcommand{\@@evenfoot}{}%
}%
\makeatother
\pagestyle{twolines}

\vspace{-10pt}
\begin{tabbing}
\phantom{References: }\= \\
To: \>Van\\
Subject: \>Intersection of line with surface at constant height above Earth
reference ellipsoid\\
From: \>Van Snyder\\
Reference: \> wvs-030 \hr{wvs-030}, wvs-131 \hr{wvs-131} \\
\end{tabbing}

\parindent 0pt \parskip 6pt
\vspace{-20pt}

\section{Using derivatives in a Newton iteration for Geodetic
co\"ordinates}

The Cartesian co\"ordinates of points on a surface at height $h$ above the
Earth reference ellipsoid in the direction normal to it are given in terms
of geodetic co\"ordinates by the vector $\mathbf{V}_e = [ x, y, z ]^T$
where

\begin{equation}\begin{split}
x = \,& p \cos \phi \cos \lambda \,, \\
y = \,& p \cos \phi \sin \lambda \,, \\
z = \,& q \sin \phi \,, \\
\end{split}\end{equation}

$\phi$ is geodetic latitude, $\lambda$ is longitude,

\begin{equation}\begin{split}
p = \,& a^2 d + h \,, \\
q = \,& b^2 d + h \,,  \\
d = \,& \frac1{\sqrt{a^2 \cos^2 \phi + b^2 \sin^2 \phi}} \,, \\
\end{split}\end{equation}

$h$ is height, and $a$ and $b$ are the equatorial and polar radii of the
Earth, respectively.

The Cartesian co\"ordinates of points on a line are given by the vector
$\mathbf{V}_l(s) = \mathbf{V}_0 + s \mathbf{V}_1$, where $\mathbf{V}_0 =
[x_0, y_0, z_0]^T$ is a vector to a point on the line, $\mathbf{V}_1 =
[x_1, y_1, z_1]^T$ is a unit vector along the line, and $s$ is the
distance along the line from $\mathbf{V}_0$ in the direction
$\mathbf{V}_1$.

The intersection of the line with the surface is given by the solution
$\mathbf{S} = [ \phi, \lambda, s ]^T$ of the equation

\begin{equation}
\mathbf{F} = \mathbf{V}_e - \mathbf{V}_l(s) = \left[ \begin{array}{l}
p \cos \phi \cos \lambda - x_0 - x_1 s \\
p \cos \phi \sin \lambda - y_0 - y_1 s \\
q \sin \phi - z_0 - z_1 s \\
\end{array} \right] = 0 \,.
\end{equation}

A solution can be obtained by a Newton iteration

\begin{equation}
\mathbf{J}\, \delta \mathbf{S} = - \mathbf{F} \text{ where}
\end{equation}

\begin{equation}
\mathbf{J} = \left[ \begin{array}{ccc}
p^\prime \cos\phi \cos\lambda
 - p \sin\phi \cos\lambda & -p \cos\phi \sin\lambda & -x_1 \\
p^\prime \cos\phi \sin\lambda
 - p \sin\phi \sin\lambda & p \cos\phi \cos\lambda & -y_1 \\
q^\prime \sin\phi + q \cos\phi & 0 & -z_1 \\
\end{array} \right] \,,
\end{equation}

\begin{equation}\begin{split}
p^\prime = \,& a^2 d^\prime + h \\
q^\prime = \,& b^2 d^\prime + h \text{ and}\\
d^\prime = \,& \frac{\text{d}d}{\text{d}\phi} =
 \cos\phi \sin\phi\, (a^2-b^2)\, d^3 \,.
\end{split}\end{equation}

There can be zero, one, or two solutions. To allow for the possibility of
zero solutions, i.e., that the line does not intersect the surface, a
least-squares Newton iteration

\begin{equation}
\mathbf{J}^T \, \mathbf{J} \, \delta \mathbf{S} = - \mathbf{J}^T \,
\mathbf{F}
\end{equation}

can be used.  If $|\mathbf{F}|$ is large, there is no intersection.

Starting points can be produced by computing the intersections of the line
with the ellipsoid

\begin{equation}\label{eight}
( \mathbf{M} \mathbf{V} )^T ( \mathbf{M} \mathbf{V} ) =
\frac{x^2}{(a+h)^2} + \frac{y^2}{(a+h)^2} + \frac{z^2}{(b+h)^2} = 1 \,,
\end{equation}

where $\mathbf{V} = [ x, y, z ]^T$ and

\begin{equation}
\mathbf{M} = \left[ \begin{array}{ccc}
\frac1{a+h} & 0 & 0 \\
0 & \frac1{a+h} & 0 \\
0 & 0 & \frac1{b+h} \\
\end{array} \right]
\end{equation}

produces the exact solution at the poles and on the equator. As described
in wvs-131 \hr{wvs-131}, this involves solving a quadratic equation

\begin{equation}\label{nine}
(\mathbf{M} \mathbf{V}_1)^T (\mathbf{M} \mathbf{V}_1) s^2 +
(\mathbf{M} \mathbf{V}_0)^T (\mathbf{M} \mathbf{V}_1) s +
(\mathbf{M} \mathbf{V}_0)^T (\mathbf{M} \mathbf{V}_0) = 0 \,.
\end{equation}

This solution produces only values of $s$, from which values of $\phi$ and
$\lambda$ can be determined by Fukushima's algorithm [1] to compute
geodetic co\"ordinates $[\phi, \lambda, h]^T$ from Cartesian
co\"ordinates.  If the value of $h$ produced by Fukushima's algorithm is
sufficiently close to the given value of $h$, the Newton iteration is not
necessary.

If there is no solution of Equation (\ref{nine}), the closest point to the
ellipsoid can be determined, as described in wvs-030 \hr{wvs-030}.  If the
distance at the closest point is greater than $h$, there is no
intersection between the line and the surface.  Using this desideratum,
the least-squares Newton iteration would not be necessary.

The reason to solve simultaneously for $\phi$, $\lambda$, and $s$, even
though $\phi$ and $\lambda$ can be computed from $\mathbf{V}_l(s)$ using
Fukushima's algorithm, is that we do not have a formula in Cartesian
co\"ordinates for the surface at the constant ellipsoidal height $h$, and
we do not have a formula in geodetic co\"ordinates for $\mathbf{V}_l(s)$.

\section{Without using derivatives}

An alternative iteration, that is simpler and converges remarkably quickly
for the Earth reference ellipsoid, probably because the eccentricity is so
small, consists of

\begin{enumerate}

\item\label{step1} Compute $s_0$, the value of $s$ at an intersection, if
      any, with the ellipsoid defined by Equation (\ref{eight}).

\item\label{step2} If step \ref{step1} does not produce an intersection,
      compute the value of $s_0$ at which the line defined by
      $\mathbf{V}_l(s)$ is nearest to the Earth reference ellipsoid using
      the method described in wvs-030 \hr{wvs-030}.  Use Fukushima's
      algorithm to compute $h_0$ at $s_0$.  If $h_0 > h$ there is no
      intersection; otherwise

{\bf for} $i = 0$, \dots

  \begin{enumerate}

  \item\label{step2a} Evaluate $\mathbf{V}_l(s_i)$.

  \item\label{step2b} Using Fukushima's algorithm, compute $\phi_i$,
        $\lambda_i$, and $h_i$ at $\mathbf{V}_l(s_i)$.

        Step \ref{step2a} and this step can be skipped on the first
        iteration if no intersection was found in step \ref{step1}; use
        the values computed in step \ref{step2} instead.

  \item If $|h-h_i| \leq h_{\text{tol}}$ {\bf exit}.

  \item\label{step2d} Compute
  %
        \begin{equation*}
        s_{i+1} = s_i + \frac{\delta h}
         {\text{sign}(\max(|\cos\alpha_i|, \frac12),\cos\alpha_i)}
        \end{equation*}
  %
        where $\cos\alpha_i = \mathbf{N}_i \cdot \mathbf{V}_1$, and
        $\mathbf{N}_i =[ \cos\phi_i \cos\lambda_i, \cos\phi_i
        \sin\lambda_i, \sin\phi_i ]^T$ is the unit normal to the ellipsoid
        at $\mathbf{V}_l(s_i)$.

  \end{enumerate}

\end{enumerate}

The subroutine DZERO from the Math77 library could be used for steps
\ref{step2a}--\ref{step2d}.  Instead of computing $s_i$ as in \ref{step2d}
above, DZERO specifies it.  DZERO needs two values of $s$ and $h$ to get
started.  To get DZERO started in the correct direction, compute $s_1$ as
in step \ref{step2d} above.

Fukushima's algorithm uses a Halley iteration.  One iteration suffices to
produce a value of $\phi_i$ that is accurate to within 30 micro arcseconds
if $h < 30,000$ km, so step \ref{step2b} is fast.

\vspace{0.25in}
\includegraphics{wvs-134-1}

\section{A method provided by Fred Krogh}

Define an ellipsoid by
%
\begin{equation}\label{one}
\mathbf{x}^T \mathbf{D} \mathbf{x} = 1
\end{equation}

where $\mathbf{D} = \text{Diag}(1/a_i^2)$ and $a_i$ is a semi-axis length.

Define a line by
%
\begin{equation}\label{twelve}
\mathbf{y}(s) = \mathbf{u} + s \mathbf{v}
\end{equation}

The vector from the ellipsoid to the point $\mathbf{y}(s)$ that is a
distance $h$ from the ellipsoid in the normal direction is a multiple $w$
of the gradient at $\mathbf{x}$, \emph{viz.} $w \mathbf{D} \mathbf{x}$. 
The quantities $\mathbf{D}$, $\mathbf{u}$, $\mathbf{v}$, and $h$ are
given.  We wish to know the point where the lines $\mathbf{y}(s)$ and
$\mathbf{x} + w\mathbf{D}\mathbf{x}$ intersect, for which it is sufficient
to know either $s$, or $\mathbf{x}$ and $w$. Using the intersection
condition, the vector $\mathbf{x}$ can be expressed in terms of
$\mathbf{D}$, $s$ and $w$ by observing that $\mathbf{x} + w \mathbf{D}
\mathbf{x} = ( \mathbf{I} + w \mathbf{D} ) \mathbf{x} = \mathbf{y}(s) =
\mathbf{u} + s \mathbf{v}$, from which
%
\begin{equation}\label{x}
\mathbf{x} = (\mathbf{I} + w \mathbf{D})^{-1} \mathbf{y}(s) =
 \mathbf{E}(w) \mathbf{y}(s) =
 (\mathbf{I} + w \mathbf{D})^{-1} ( \mathbf{u} + s \mathbf{v}) =
 \mathbf{E}(w) ( \mathbf{u} + s \mathbf{v}) \,,
\end{equation}

where $\mathbf{E}(w) = (\mathbf{I} + w \mathbf{D})^{-1}$.  From the
definition of $\mathbf{D}$, $\mathbf{E}(w) = \text{Diag} (a_i^2 / (
a_i^2+w ) )$. Substituting Equation (\ref{x}) into Equation (\ref{one}) we
have
%
\begin{equation}\label{three}
\mathbf{y}(s)^T \mathbf{E}(w)^T \mathbf{D} \mathbf{E}(w) \mathbf{y}(s) =
(\mathbf{u} + s \mathbf{v})^T (\mathbf{I} + w \mathbf{D})^{-T} \mathbf{D}
 (\mathbf{I} + w \mathbf{D})^{-1} (\mathbf{u} + s \mathbf{v}) = 1 \,.
\end{equation}

Let $\mathbf{G}(w) = \mathbf{E}(w)^T \mathbf{D} \mathbf{E}(w) =
\text{Diag} (a_i^2 / ( a_i^2+w )^2 )$.

Then Equation (\ref{three}) becomes
%
\begin{equation}\label{four}
\mathbf{y}(s)^T \mathbf{G}(w) \mathbf{y}(s) =
(\mathbf{u} + s \mathbf{v})^T \mathbf{G}(w) (\mathbf{u} + s \mathbf{v})
 = 1 \,.
\end{equation}

We also want the condition
%
\begin{equation}\label{five}
w | \mathbf{D} \mathbf{x} | = h \text{, or }
 w^2 | \mathbf{D} \mathbf{x} |^2 =
   w^2 \mathbf{x}^T \mathbf{D}^T \mathbf{D} \mathbf{x} =
     w^2 (\mathbf{u} + s \mathbf{v})^T \mathbf{E}(w)^T \mathbf{D}^T \mathbf{D}
      \mathbf{E}(w) (\mathbf{u} + s \mathbf{v}) = h^2 \,.
\end{equation}

Let $\mathbf{H}(w) = \mathbf{E}(w)^T \mathbf{D}^T \mathbf{D} \mathbf{E}(w)
= \mathbf{D} \mathbf{G}(w) = \text{Diag} ( 1 / ( a_i^2 + w )^2$.  Then
Equation (\ref{five}) becomes
%
\begin{equation}\label{six}
w^2 \mathbf{y}(s)^T \mathbf{H}(w) \mathbf{y}(s) =
w^2 (\mathbf{u} + s \mathbf{v})^T \mathbf{H}(w) (\mathbf{u} + s \mathbf{v})
 = h^2 \,.
\end{equation}

Collecting Equations (\ref{four}) and (\ref{six}) into a single vector
equation, we have
%
\begin{equation}
\mathbf{F}(w,s) = \left[ \begin{array}{c}
 \mathbf{F}_1(w,s) \\
 \mathbf{F}_2(w,s) \\ \end{array} \right]
= \left[ \begin{array}{c}
 \mathbf{y}(s)^T \mathbf{G}(w) \mathbf{y}(s) - 1 \\
 w^2\, \mathbf{y}(s)^T \mathbf{H}(w) \mathbf{y}(s) - h^2 \\
 \end{array} \right] = \mathbf{0} \\
\end{equation}

with Jacobian matrix $\mathbf{J}(w,s)$
%
\begin{equation}
\left[ \begin{array}{cc}
\frac{\partial \mathbf{F}_1}{\partial s} &
 \frac{\partial \mathbf{F}_1}{\partial w} \\
  &\\
\frac{\partial \mathbf{F}_2}{\partial s} &
 \frac{\partial \mathbf{F}_2}{\partial w}
\end{array} \right]
= \left[ \begin{array}{cc}
2\, \mathbf{y}(s)_s^T \mathbf{G}(w) \mathbf{y}(s) &
 \mathbf{y}(s)^T \mathbf{G}(w)_w \mathbf{y}(s) \\
& \\
2 w^2 \, \mathbf{y}(s)_s^T \mathbf{H}(w) \mathbf{y}(s) &
 \frac{2\mathbf{F}_2}w +
  w^2 \, \mathbf{y}(s) \mathbf{H}(w)_w \mathbf{y}(s) \\
\end{array} \right] \\
\end{equation}

where
%
\begin{equation}\begin{split}
\mathbf{y}(s)_s = \,& \frac{\partial \mathbf{y}(s)}{\partial s} =
 \mathbf{v} \\
& \\
\mathbf{G}(w)_w = \,& \frac{\partial \mathbf{G}(w)}{\partial w} =
 \text{Diag}\left(\frac{-2 a_i^2}{(a_i^2+w)^3} \right) \\
& \\
\mathbf{H}(w)_w = \,& \frac{\partial \mathbf{H}(w)}{\partial w} =
 \mathbf{D} \mathbf{G}(w)_w =
  \text{Diag}\left(\frac{-2}{(a_i^2+w)^3} \right) \,. \\
\end{split}\end{equation}

Given initial estimates for $s$ and $w$, a Newton iteration using
$\mathbf{F}(w,s)$ and $\mathbf{J}(w,s)$ can be used to refine the values
of $s$ and $w$.

An initial estimate for $s$ can be gotten by solving for the intersection
of $\mathbf{y}(s)$ with an ellipse having $\mathbf{D} =
\text{Diag}(1/(a_i+h)^2)$, i.e., its semi-axes are $h$ longer than the
given ones, as in Equation (\ref{eight}), and as described in wvs-131
\hr{wvs-131}.  This gives the exact answer on the axes, and on the equator
of the Earth.

One initial estimate for $w^2$ can be gotten by solving $\mathbf{F}_1(w,s)
= 0$ (in $n$ dimensions,  $\mathbf{F}_1(w,s)$ is a polynomial in $w$ of
degree $2n$).

To derive the initial estimate $w^2 \approx
\frac{nh^2}{\text{Tr}(\mathbf{D})}$, consider Equation (\ref{five})
modified for a sphere, i.e., $\mathbf{D} = a \mathbf{I}$, with $a = 1/r^2$
so that Equation (\ref{five}) becomes
%
\begin{equation}\label{grad-1}
w^2 \mathbf{x}^T \mathbf{D}^T \mathbf{D} \mathbf{x} =
w^2 a^2 \mathbf{x}^T \mathbf{I}^T \mathbf{I} \mathbf{x} =
w^2 a^2 \mathbf{x}^T \mathbf{x} = h^2 \,.
\end{equation}

If we substitute $\mathbf{D} = a \mathbf{I}$ into Equation (\ref{one}),
the equation for an ellipsoid, we get
%
\begin{equation}\label{ellipsoid-1}
\mathbf{x}^T \mathbf{D} \mathbf{x} =
a \mathbf{x}^T \mathbf{I} \mathbf{x} =
a \mathbf{x}^T  \mathbf{x} = 1 \text{ or }
\mathbf{x}^T  \mathbf{x} = \frac1a \,.
\end{equation}

Substituting the conclusion of Equation(\ref{ellipsoid-1}) into Equation
(\ref{grad-1}) we have
%
\begin{equation}
w^2 a = h^2 \text{ or } w^2 = \frac{h^2}a = r^2 h^2 \,.
\end{equation}

One definition of the mean radius of a sphere not too different from the
ellipsoid is the average of the ellipsoid's semi-axes.  This is the
definition used by the International Union of Geodesy and Geophysics for
the mean Earth radius.  Making a further approximation that the inverse of
the square of the sphere's radius is the average of the inverses of the
squares of the ellipsoid's semi-axes, we have $a = \frac1{r^2} \approx
\frac{\text{Tr}(\mathbf{D})}n$, or
%
\begin{equation}
w^2 = \frac{nh^2}{\text{Tr}(\mathbf{D})} \,.
\end{equation}

If $\mathbf{D}$ is given, this is somewhat easier to compute than $\frac1a
= r^2 \approx \frac{\text{Tr}(\mathbf{D}^{-1})}n$, i.e., the square of the
sphere's radius is the average of the squares of the ellipsoid's
semi-axes.  However, if the semi-axes $a_i$, i.e., the square roots of the
inverses of the diagonal elements of $\mathbf{D}$, are given, $\frac1a =
r^2 \approx \left[ \frac{\text{Tr}(\mathbf{D}^{-\frac12})}n\right]^2 =
\left[\frac1n \sum a_i\right]^2$ might be easiest to compute.

[1] Toshio Fukushima, \emph{Transformation from Cartesian to geodetic
coordinates accelerated by Halley's method}, {\bf J. Geod. 79}, 12
(February 2006) pp 689--693.  DOI 10.1007/s00190-006-0023-2.

\label{lastpage}
\vspace*{-0.1in} % Somehow, this causes lastpage to be defined
\end{document}

% $Id: wvs-134.tex,v 1.1 2016/03/17 19:04:25 vsnyder Exp $

% $Log: wvs-134.tex,v $
% Revision 1.1  2016/03/17 19:04:25  vsnyder
% Initial commit
%
@


1.1
log
@Initial commit
@
text
@d15 2
a16 2
\newcommand{\docname}{wvs-134}
\newcommand{\docdate}{15 March 2016}
d86 2
a87 1
\section{Using derivatives in a Newton iteration}
d167 1
d171 1
a171 11
which produces the exact solution at the poles and on the equator.
As described in wvs-131 \hr{wvs-131}, this involves solving a quadratic
equation

\begin{equation}\label{nine}
(\mathbf{M} \mathbf{V}_1)^T (\mathbf{M} \mathbf{V}_1) s^2 +
(\mathbf{M} \mathbf{V}_0)^T (\mathbf{M} \mathbf{V}_1) s +
(\mathbf{M} \mathbf{V}_0)^T (\mathbf{M} \mathbf{V}_0) = 0
\end{equation}

where
d178 10
a187 1
\end{array} \right] \,.
d211 3
a213 2
An alternative iteration, that is simpler but might not converge as
quickly, consists of
d268 190
a461 3
\vspace{0.25in}
\includegraphics{wvs-134-1}

d466 1
a466 1
% $Id: wvs-133.tex,v 1.1 2016/03/03 02:59:29 vsnyder Exp $
d468 4
a471 1
% $Log: $
@

