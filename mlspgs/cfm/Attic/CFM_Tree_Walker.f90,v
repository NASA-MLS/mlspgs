head	1.2;
access;
symbols
	V3-43:1.1
	V3-41:1.1
	V3-40-PlusGM57:1.1.0.2
	V3-30:1.1
	V3-20:1.1;
locks; strict;
comment	@# @;


1.2
date	2010.03.24.17.44.48;	author honghanh;	state dead;
branches;
next	1.1;

1.1
date	2010.02.17.16.41.33;	author honghanh;	state Exp;
branches;
next	;


desc
@@


1.2
log
@Conformed all module names to end with _m, changed file names to all
lowercase, add comments
@
text
@! Copyright 2005, by the California Institute of Technology. ALL
! RIGHTS RESERVED. United States Government Sponsorship acknowledged. Any
! commercial use must be negotiated with the Office of Technology Transfer
! at the California Institute of Technology.

! This software may be subject to U.S. export control laws. By accepting this
! software, the user agrees to comply with all applicable U.S. export laws and
! regulations. User has the responsibility to obtain export licenses, or other
! export authority as may be required before exporting such information to
! foreign countries or providing access to foreign persons.

module CFM_Tree_Walker

! Traverse the tree output by the parser and checked by the tree checker.
! Perform the actions in the order indicated.

  implicit none
  private

  public :: Walk_Tree

!---------------------------- RCS Ident Info -------------------------------
  character(len=*), private, parameter :: ModuleName= &
       "$RCSfile: CFM_Tree_Walker.f90,v $"
  private :: not_used_here 
!---------------------------------------------------------------------------

contains ! ====     Public Procedures     ==============================

  subroutine Walk_Tree ( Root, First_Section, ForwardModelConfigDatabase )

    use Allocate_Deallocate, only: TEST_DEALLOCATE
    use ForwardModelConfig, only: ForwardModelConfig_T
    use Global_Settings, only: Set_Global_Settings
    use Init_Tables_Module, only: Z_GLOBALSETTINGS, Z_MLSSIGNALS, Z_SPECTROSCOPY
    use Intrinsic, only: Section_Indices
    use MLSCommon, only: MLSFile_T
    use MLSMessageModule, only: MLSMessage, MLSMSG_Error
    use MLSPCF2, only: mlspcf_spectroscopy_end
    use MoreTree, only: StartErrorMessage
    use Output_m, only: Output
    use SpectroscopyCatalog_m, only: Spectroscopy
    use String_Table, only: Display_String
    use Time_M, only: Time_Now
    use Toggles, only: GEN, LEVELS, SWITCHES, TOGGLE
    use Trace_m, only: DEPTH, TRACE_BEGIN, TRACE_END
    use Tree, only: DECORATION, NSONS, SUBTREE
    use MLSSignals_M, only: MLSSignals

    integer, intent(in) ::       Root          ! Root of the abstract syntax tree
    integer, intent(in) ::       First_Section ! Index of son of root of first n_cf
    type (ForwardModelConfig_T), pointer :: ForwardModelConfigDatabase(:)

    type (MLSFile_T), pointer :: File_Data_Base(:)
    integer :: I             ! Loop inductor, subtree index
    integer :: Section_Index ! Z_MLSSignals, Z_GlobalSettings, Z_Spectroscopy
    integer :: Son           ! Tree index of son of a tree vertex
    integer :: Stat          ! From deallocate
    real :: T1, T2           ! For timing

    logical, parameter :: TOOLKIT = .false.

    if ( toggle(gen) ) &
      & call trace_begin ( 'Walk_Tree', subtree(first_section,root) )
    call time_now ( t1 )
    nullify ( File_Data_Base )

    ! Loop over the tree
    do i = first_section, nsons(root)
      son = subtree(i,root)
      section_index = decoration(subtree(1,son))
      select case ( section_index )
      case ( z_GlobalSettings )
        call set_global_settings ( son, forwardModelConfigDatabase, File_Data_Base )
      case ( z_MLSSignals )
        call MLSSignals ( son )
      case ( z_Spectroscopy )
        call spectroscopy ( son, TOOLKIT, mlspcf_spectroscopy_end, File_Data_Base )
      case default
        call startErrorMessage ( son )
        call output ( 'Section ' )
        call display_string ( section_indices(section_index) )
        call output ( ' is not supported in callable forward model', advance='yes' )
        call MLSMessage ( MLSMSG_Error, moduleName, 'Unsupported CF section' )
      end select
    end do

    ! We only needed File_Data_Base to keep Spectroscopy and
    ! Set_Global_Settings happy
    deallocate ( File_Data_Base, stat=stat )
    call test_deallocate ( stat, moduleName, 'File_Data_Base' )

    call time_now ( t2 )
    !call output ( t2-t1, before='Timing to set up forward model = ', advance='yes' )

    if ( toggle(gen) ) call trace_end ( 'Walk_Tree' )

  end subroutine Walk_Tree

!--------------------------- end bloc --------------------------------------
  logical function not_used_here()
  character (len=*), parameter :: IdParm = &
       "$Id: CFM_Tree_Walker.f90,v 1.1 2010/02/17 16:41:33 honghanh Exp $"
  character (len=len(idParm)) :: Id = idParm
    not_used_here = (id(1:1) == ModuleName(1:1))
    print *, Id ! .mod files sometimes change if PRINT is added
  end function not_used_here
!---------------------------------------------------------------------------

end module CFM_Tree_Walker

! $Log: CFM_Tree_Walker.f90,v $
! Revision 1.1  2010/02/17 16:41:33  honghanh
! An example of using CFM_MLSSetup and creating a VGrid
!
@


1.1
log
@An example of using CFM_MLSSetup and creating a VGrid
@
text
@d24 1
a24 1
       "$RCSfile: $"
d103 1
a103 1
       "$Id: tree_walker.f90,v 2.167 2009/06/23 18:46:19 pwagner Exp $"
d112 4
a115 1
! $Log: $
@

