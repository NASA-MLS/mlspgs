head	1.21;
access;
symbols;
locks; strict;
comment	@# @;


1.21
date	2001.04.10.02.38.25;	author livesey;	state dead;
branches;
next	1.20;

1.20
date	2001.04.06.20.14.00;	author vsnyder;	state Exp;
branches;
next	1.19;

1.19
date	2001.04.03.07.32.45;	author zvi;	state Exp;
branches;
next	1.18;

1.18
date	2001.04.02.17.33.32;	author pwagner;	state Exp;
branches;
next	1.17;

1.17
date	2001.04.01.00.16.13;	author zvi;	state dead;
branches;
next	1.16;

1.16
date	2001.03.29.12.08.17;	author zvi;	state Exp;
branches;
next	1.15;

1.15
date	2001.03.29.08.51.01;	author zvi;	state Exp;
branches;
next	1.14;

1.14
date	2001.03.26.21.14.54;	author livesey;	state Exp;
branches;
next	1.13;

1.13
date	2001.03.24.00.41.48;	author zvi;	state Exp;
branches;
next	1.12;

1.12
date	2001.03.20.23.22.40;	author zvi;	state Exp;
branches;
next	1.11;

1.11
date	2001.03.20.11.03.16;	author zvi;	state Exp;
branches;
next	1.10;

1.10
date	2001.03.20.02.31.00;	author livesey;	state Exp;
branches;
next	1.9;

1.9
date	2001.03.15.12.18.03;	author zvi;	state Exp;
branches;
next	1.8;

1.8
date	2001.03.13.01.46.46;	author vsnyder;	state Exp;
branches;
next	1.7;

1.7
date	2001.03.09.00.40.32;	author zvi;	state Exp;
branches;
next	1.6;

1.6
date	2001.03.08.22.01.11;	author vsnyder;	state Exp;
branches;
next	1.5;

1.5
date	2001.03.08.00.08.04;	author vsnyder;	state Exp;
branches;
next	1.4;

1.4
date	2001.03.07.23.45.14;	author zvi;	state Exp;
branches;
next	1.3;

1.3
date	2001.03.06.18.17.57;	author pwagner;	state Exp;
branches;
next	1.2;

1.2
date	2001.03.06.09.28.28;	author zvi;	state Exp;
branches;
next	1.1;

1.1
date	2001.03.05.21.37.20;	author zvi;	state Exp;
branches;
next	;


desc
@@


1.21
log
@They're gonecvs remove l2_load_m.f90 l2_test_structures_m.f90 ptg_frq_load_m.f90cvs remove l2_load_m.f90 l2_test_structures_m.f90 ptg_frq_load_m.f90
@
text
@module L2_LOAD_M
  use GL6P, only: NG
  use MLSCommon, only: I4, R4, R8
  use L2_TEST_STRUCTURES_M
  use L2PC_FILE_PARAMETERS, only: mxco => MAX_NO_ELMNTS_PER_SV_COMPONENT, &
                                  DEG2RAD
  use L2PC_PFA_STRUCTURES, only: ATMOS_COMP, PFA_SLAB, SPECTRO_PARAM, &
                                 LIMB_PRESS
  use L2PCdim, only: N2lvl, Nptg, NCH, MNP => max_no_phi
  use PATH_ENTITIES_M, only: PATH_VECTOR
  use D_HUNT_M, only: HUNT
  implicit NONE

  integer, public, parameter :: AAAP_UNIT = 51
  integer, public, parameter :: FILTER_UNIT = 52

!---------------------------- RCS Ident Info -------------------------------
  CHARACTER (LEN=256) :: Id = &
    "$Id: l2_load_m.f90,v 1.20 2001/04/06 20:14:00 vsnyder Exp $"
  CHARACTER (LEN=*), PARAMETER :: ModuleName= "$RCSfile: l2_load_m.f90,v $"
!---------------------------------------------------------------------------
contains
!---------------------------------------------------------------------------
! ====================================================     L2_LOAD =====
! This subprogram loads all the needed inputs for the l2_test run

  SUBROUTINE L2_LOAD(FMC, FMI, T_FMI, Ier)
!---------------------------------------------------------------------------

! Process FMC if and only if FMI is not present.
! Process FMI and T_FMI if and only if they are present (duh).  If FMI
! is present, T_FMI must be present (it isn't checked).

Type(fwd_mdl_config), INTENT(IN OUT) :: FMC

Type(fwd_mdl_info), OPTIONAL, INTENT(OUT) :: FMI
Type(temporary_fwd_mdl_info), OPTIONAL, INTENT(OUT) :: T_FMI

Integer(i4), INTENT(OUT) :: ier
!
! ---- Local variables ---------
!
Logical :: geom_deriv(6)
Integer(i4) :: i, j, k, kk, ht_i, no_t, mnz, kz, si, n_sps, io, nl, &
               Spectag, m, no_phi_t, no_mmaf, jj

Integer(i4) :: ch1, ch2, no_pfa_ch, pfa_ch(25)

Real(r8) :: dummy(N2lvl), thbs(10), Qlog(3)

Real(r8) :: z0, zn, q, r, v

!
Character (LEN=08) :: Name
Character (LEN=40) :: Ax
Character (LEN=80) :: Fnd, Line

!  ----------------------
!??? The following are now gotten from the forwardModelGlobal command
!??? in the L2CF
! Read convolution & freq. averaging data from file: tmp.dat
!
! Line = 'tmp.dat'
! CLOSE(13,iostat=i)
! OPEN(13,file=Line,status='OLD',action='READ',iostat=io)
! if(io /= 0) goto 99
!
! FMC%Zfrq = -1.0
! FMC%temp_der = .true.
! read(13,*,iostat=io) FMC%do_conv
! if(io /= 0) goto 99
! read(13,*,iostat=io) FMC%do_frqavg
! if(io /= 0) goto 99
! if(.not. FMC%do_frqavg) then
!   read(13,*,iostat=io) FMC%Zfrq
!   if(io /= 0) goto 99
! endif
! CLOSE(13,iostat=io)

!  ----------------------
! Read the rest of the inputs from a file...
!
  ier = 0
!
  if ( .not. present(fmi) ) then
    line = "Reading " // fmc%z
    CLOSE(11,iostat=io)
    OPEN(11,file=FMC%Z,status='OLD',action='READ',iostat=io)
    if(io /= 0) goto 99
!
! *** Begining the FMC Section
!
    do
      read(11,'(A)',iostat=io) Ax
      if(io /= 0) goto 99
      if (Index(Ax,'No_Mmaf') > 0) EXIT
    end do

    read(11,*,iostat=io) j
    if(io /= 0) goto 99

    FMC%no_mmaf = min(j,100)   ! Assuming mmaf chunk of no more than 100
    no_mmaf = FMC%no_mmaf

    DEALLOCATE(FMC%phi_tan_mmaf,FMC%vel_z_mmaf,STAT=i)
    ALLOCATE(FMC%phi_tan_mmaf(no_mmaf),FMC%vel_z_mmaf(no_mmaf),STAT=i)
    if(i /= 0) goto 99

    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99

    read(11,*,iostat=io) (FMC%vel_z_mmaf(i),i=1,no_mmaf)
    if(io /= 0) goto 99

    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99

    dummy(1:no_mmaf) = 0.0
    read(11,*,iostat=io) (dummy(i),i=1,no_mmaf)
    if(io /= 0) goto 99

    FMC%phi_tan_mmaf(1:no_mmaf) = dummy(1:no_mmaf) * deg2rad

    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99

    read(11,*,iostat=io) ch1, ch2
    if(io /= 0) goto 99

    no_pfa_ch = ch2-ch1+1
    do i = 1, no_pfa_ch
      ch2 = ch1 + i - 1
      pfa_ch(i) = ch2
    end do

    FMC%Channels_range(1) = ch1
    FMC%Channels_range(2) = ch2

    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99

    read(11,*,iostat=io) FMC%Sideband
    if(io /= 0) goto 99
  !
    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99

    read(11,*,iostat=io) k, j
    if(io /= 0) goto 99

    FMC%n_lvls = k
    FMC%no_tan_hts = j

    DEALLOCATE(FMC%p_Indx,FMC%t_Indx,STAT=i)
    ALLOCATE(FMC%p_Indx(k),FMC%t_Indx(j),STAT=i)
    if(i /= 0) goto 99

    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99

    read(11,*,iostat=io) (FMC%p_indx(i),i=1,k)
    if(io /= 0) goto 99

    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99

    read(11,*,iostat=io) (FMC%t_indx(i),i=1,FMC%no_tan_hts)
    if(io /= 0) goto 99

    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99

    read(11,'(A)',iostat=io) Fnd
    if(io /= 0) goto 99

    Fnd = AdjustL(Fnd)
    i = LEN_TRIM(Fnd)
    if(Fnd(i:i) /= '/') then
      i = i + 1
      Fnd(i:i) = '/'
    endif

    FMC%InDir = Fnd

    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99

    read(11,'(A)',iostat=io) Fnd
    if(io /= 0) goto 99

!   FMC%B = AdjustL(Fnd) !??? Now Filled from forwardModelGlobal command

    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99

    read(11,'(A)',iostat=io) Fnd
    if(io /= 0) goto 99

    FMC%aaap_file = AdjustL(Fnd)

    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99
    return
  end if
!
! *** Begining the FMI Section
!
  no_mmaf = FMC%no_mmaf
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) FMI%n_sps
  if(io /= 0) goto 99
!
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  n_sps = FMI%n_sps
  DEALLOCATE(FMI%Species,STAT=i)
  ALLOCATE(FMI%Species(n_sps),STAT=i)
  if(i /= 0) goto 99

  do i = 1, FMI%n_sps
    read(11,*,iostat=io) FMI%Species(i)
    if(io /= 0) goto 99
  end do
!
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) FMI%band
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) FMI%Surface_index,FMI%max_no_zeta, &
                       FMI%no_filt_pts,FMI%fft_pts
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) z0, zn
  if(io /= 0) goto 99

  k = FMC%n_lvls
  mnz = FMI%Max_no_zeta
  si = FMI%Surface_index

  r = (zn - z0)/ (mnz - 1)

  j = k + si - 1
! DEALLOCATE(FMI%z_grid,FMI%tan_press,STAT=i)
! ALLOCATE(FMI%z_grid(k),FMI%tan_press(j),STAT=i)
! if(i /= 0) goto 99
!
! FMI%z_grid(j) = 0.0
! DO i = 1, k
!   j = FMC%p_indx(i)
!   FMI%z_grid(i) = z0 + (j - 1) * r
! END DO
!
! Define tan_press as a TRUE subset of z_grid:
!
! kz = si - 1
! FMI%tan_press(1:kz) = -5.0
! do i = 1, FMC%no_tan_hts
!   kz = kz + 1
!   j = FMC%t_indx(i)
!   FMI%tan_press(kz) = FMI%z_grid(j)
! end do
!
  j = 2**FMI%fft_pts
  DEALLOCATE(FMI%AAAP,FMI%D1AAAP,FMI%D2AAAP,STAT=i)
  ALLOCATE(FMI%AAAP(j,3),FMI%D1AAAP(j,3),FMI%D2AAAP(j,3),STAT=i)
  if(i /= 0) goto 99

  Call ANTENNA(FMC%aaap_file, FMI%fft_pts, FMI%Xlamda, FMI%AAAP, &
 &             FMI%D1AAAP, FMI%D2AAAP, FMI%IAS, Ier)
  if(ier /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  DEALLOCATE(FMI%Tan_hts_below_surface,STAT=i)
  ALLOCATE(FMI%Tan_hts_below_surface(si),STAT=i)
  if(i /= 0) goto 99

  FMI%Tan_hts_below_surface(1:si) = 0.0
  read(11,*,iostat=io) (FMI%Tan_hts_below_surface(i),i=1,si-1)
  if(io /= 0) goto 99

  n_sps = FMI%n_sps
  DEALLOCATE(FMI%Pfa_spectrum,STAT=i)
  ALLOCATE(FMI%Pfa_spectrum(n_sps),STAT=i)
  if(i /= 0) goto 99

  m = 0
  FMI%Pfa_spectrum(1)%NO_SPS = n_sps   ! Make sure we have this

  read(11,'(A)',iostat=io) Ax    ! pfa_spectrum(s)
  if(io /= 0) goto 99

  DO

    if(m == n_sps) then
      do
        read(11,'(A)',iostat=io) Ax
        if(io /= 0) goto 99
        if(Index(Ax,'END_CAT') > 0) EXIT
      end do
      EXIT
    endif

    Name = ' '
    read(11,'(A)',iostat=io) Line
    if(io /= 0) goto 99
    if(Index(Line,'END_CAT').gt.0) EXIT
!
    Read(Line,*,iostat=io) Name, Spectag, nl, (Qlog(i),i=1,3)
    if(io /= 0) goto 99
!
    j = 0
    DO i = 1, n_sps
      if(Name == FMI%Species(i)) then
        j = i
        EXIT
      endif
    END DO

    if(j < 1) then
      do i = 1, nl
        read(11,'(A)',iostat=io) Ax
        if(io /= 0) goto 99
      end do
    else
      m = m + 1
      FMI%Pfa_spectrum(j)%NAME = Name
      FMI%Pfa_spectrum(j)%NO_SPS = n_sps
      FMI%Pfa_spectrum(j)%NO_LINES = nl
      FMI%Pfa_spectrum(j)%SPECTAG = Spectag
      FMI%Pfa_spectrum(j)%QLOG(1:3) = Qlog(1:3)
      do i = 1, nl
        read(11,*,iostat=io) (thbs(k),k=1,10)
        if(io /= 0) goto 99
        FMI%Pfa_spectrum(j)%V0(i) = thbs(1)
        FMI%Pfa_spectrum(j)%EL(i) = thbs(2)
        FMI%Pfa_spectrum(j)%STR(i) = thbs(3)
        FMI%Pfa_spectrum(j)%W(i) = thbs(4)
        FMI%Pfa_spectrum(j)%PS(i) = 0.0   !  thbs(5) *** DEBUG
        FMI%Pfa_spectrum(j)%N(i) = thbs(6)
        FMI%Pfa_spectrum(j)%DELTA(i) = thbs(7)
        FMI%Pfa_spectrum(j)%N1(i) = thbs(8)
        FMI%Pfa_spectrum(j)%GAMMA(i) = thbs(9)
        FMI%Pfa_spectrum(j)%N2(i) = thbs(10)
      end do
    endif
!
  END DO
!
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) FMI%no_spectro, FMI%mfi
  if(io /= 0) goto 99

  j = FMI%no_spectro
  DEALLOCATE(FMI%spectroscopic,STAT=i)
  ALLOCATE(FMI%spectroscopic(j),STAT=i)
  if(i /= 0) goto 99
!
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  Line(1:) = ' '
  do j = 1, FMI%no_spectro
    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99
    FMI%spectroscopic(j)%TYPE = AdjustL(Ax)
    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99
    FMI%spectroscopic(j)%NAME = AdjustL(Ax)
    read(11,*,iostat=io) Spectag
    if(io /= 0) goto 99
    FMI%spectroscopic(j)%SPECTAG = Spectag
    read(11,*,iostat=io) k
    if(io /= 0) goto 99
    FMI%spectroscopic(j)%NO_PHI_VALUES = k
    read(11,*,iostat=io) kk
    if(io /= 0) goto 99
    FMI%spectroscopic(j)%NO_ZETA_VALUES = kk
    read(11,*,iostat=io) (FMI%spectroscopic(j)%DER_CALC(i),i=1,6)
    if(io /= 0) goto 99
    dummy(1:k) = 0.0
    read(11,*,iostat=io) (dummy(i),i=1,k)
    if(io /= 0) goto 99
    FMI%spectroscopic(j)%PHI_BASIS(1:k) = dummy(1:k) * deg2rad
    read(11,*,iostat=io) (FMI%spectroscopic(j)%ZETA_BASIS(i),i=1,kk)
    if(io /= 0) goto 99
  end do
!
! *** Begining the T_FMI Section
!
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99
!
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) T_FMI%ptg_press%name, &
                      (T_FMI%ptg_press%der_calc(i),i=1,6)
  if(io /= 0) goto 99

  read(11,*,iostat=io) j
  if(io /= 0) goto 99

  T_FMI%ptg_press%no_lin_values = j
  read(11,*,iostat=io) (T_FMI%ptg_press%lin_val(i),i=1,j)
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) T_FMI%No_Geometric
  if(io /= 0) goto 99
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  do i = 1, T_FMI%No_Geometric
    read(11,*,iostat=io) Name, geom_deriv, r
    if(io /= 0) goto 99
    IF(Name == 'ELEV_183') THEN
      T_FMI%elev_183 = r
    ELSE IF(Name == 'ELEV_205') THEN
      T_FMI%elev_205 = r
    ELSE IF(Name == 'EARTHREF') THEN
      T_FMI%earth_ref = r
    ELSE IF(Name == 'SPACE_T') THEN
      T_FMI%s_temp = r
    ELSE IF(Name == 'GEOCSRAD') THEN
      T_FMI%h_obs = r
    END IF
  end do
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  DEALLOCATE(T_FMI%Atmospheric,STAT=i)
  ALLOCATE(T_FMI%Atmospheric(n_sps),STAT=i)
  if(i /= 0) goto 99

  do k = 1, n_sps
    j = -1
    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99
    Name = AdjustL(Ax)
    do jj = 1, n_sps
      if(Name == FMI%Species(jj)) then
        j = jj
        EXIT
      endif
    end do
    if(j < 0) then
      io = 5
      Print *,'** Error in: l2_load ..'
      Print *,'   Unknown molecule: ',Name,' in T_FMI%Atmospheric input ..'
      goto 99
    endif
    T_FMI%Atmospheric(j)%NAME = Name
    read(11,*,iostat=io) Spectag, ht_i
    if(io /= 0) goto 99
    T_FMI%Atmospheric(j)%LIN_VAL(1:) = 0.0
    T_FMI%Atmospheric(j)%SPECTAG = Spectag
    T_FMI%Atmospheric(j)%NO_LIN_VALUES = ht_i
    read(11,*,iostat=io) (T_FMI%Atmospheric(j)%FWD_CALC(i),i=1,6)
    if(io /= 0) goto 99
    read(11,*,iostat=io) (T_FMI%Atmospheric(j)%DER_CALC(i),i=1,6)
    if(io /= 0) goto 99
    read(11,*,iostat=io) (T_FMI%Atmospheric(j)%BASIS_PEAKS(i),i=1,ht_i)
    if(io /= 0) goto 99
  end do
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99
  read(11,*,iostat=io) T_FMI%Zref, T_FMI%beta_inc
  if(io /= 0) goto 99
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99
  DEALLOCATE(T_FMI%Href,STAT=i)
  ALLOCATE(T_FMI%Href(no_mmaf),STAT=i)
  read(11,*,iostat=io) (T_FMI%Href(i),i=1,no_mmaf)
  if(io /= 0) goto 99
!
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99
!
  read(11,*,iostat=io) T_FMI%no_t, T_FMI%no_phi_t
  if(io /= 0) goto 99
  if(FMC%no_mmaf < T_FMI%no_phi_t) then
    io = -1
    Print *,'** Error: no_mmaf < no_phi_t ...'
    Print *,'   Please correct input file and re-run !'
    goto 99
  endif

  no_t = T_FMI%no_t
  no_phi_t = T_FMI%no_phi_t
  DEALLOCATE(T_FMI%t_zeta_basis,T_FMI%t_phi_basis,T_FMI%t_geod_lat, &
             T_FMI%t_coeff,STAT=i)
  ALLOCATE(T_FMI%t_zeta_basis(no_t),T_FMI%t_phi_basis(no_phi_t),   &
           T_FMI%t_geod_lat(no_phi_t),T_FMI%t_coeff(no_t,no_mmaf),STAT=i)
  if(i /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) (T_FMI%t_zeta_basis(i),i=1,no_t)
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  dummy(1:) = 0.0
  read(11,*,iostat=io) (dummy(i),i=1,no_phi_t)
  if(io /= 0) goto 99
  T_FMI%t_phi_basis(1:no_phi_t) = dummy(1:no_phi_t) * deg2rad

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  dummy(1:) = 0.0
  read(11,*,iostat=io) (dummy(i),i=1,no_phi_t)
  if(io /= 0) goto 99
  T_FMI%t_geod_lat(1:no_phi_t) = dummy(1:no_phi_t)

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) ((T_FMI%t_coeff(i,j),j=1,no_mmaf),i=1,no_t)
  if(io /= 0) goto 99
!
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  DEALLOCATE(T_FMI%no_phi_f,T_FMI%no_coeffs_f,T_FMI%is_f_log, &
 &           STAT=i)
  ALLOCATE(T_FMI%no_phi_f(n_sps),T_FMI%no_coeffs_f(n_sps), &
 &         T_FMI%is_f_log(n_sps),STAT=i)
  if(i /= 0) goto 99

  read(11,*,iostat=io) (T_FMI%no_phi_f(i),i=1,n_sps)
  if(io /= 0) goto 99

  do i = 1, n_sps
    if(no_mmaf < T_FMI%no_phi_f(i)) then
      io = -1
      Print *,'** Error: no_mmaf < no_phi_f(i), i =',i
      Print *,'   Please correct input file and re-run !'
      goto 99
    endif
  end do

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) (T_FMI%no_coeffs_f(i),i=1,n_sps)
  if(io /= 0) goto 99
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) (T_FMI%is_f_log(i),i=1,n_sps)
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  kk = MAXVAL(T_FMI%no_phi_f)
  ht_i = MAXVAL(T_FMI%no_coeffs_f)
  DEALLOCATE(T_FMI%f_zeta_basis,T_FMI%f_phi_basis,T_FMI%mr_f,STAT=i)
  ALLOCATE(T_FMI%f_zeta_basis(ht_i,n_sps),   &
 &         T_FMI%f_phi_basis(kk,n_sps),      &
 &         T_FMI%mr_f(ht_i,kk,n_sps), STAT=i)
  if(i /= 0) goto 99
!
  DO m = 1, n_sps
    kk = T_FMI%no_phi_f(m)
    ht_i = T_FMI%no_coeffs_f(m)
    read(11,*,iostat=io) (T_FMI%f_zeta_basis(i,m),i=1,ht_i)
    if(io /= 0) goto 99
    dummy(1:kk) = 0.0
    read(11,*,iostat=io) (dummy(i),i=1,kk)
    if(io /= 0) goto 99
    T_FMI%f_phi_basis(1:kk,m) = dummy(1:kk) * deg2rad
    read(11,*,iostat=io) ((T_FMI%mr_f(i,j,m),j=1,kk),i=1,ht_i)
    if(io /= 0) goto 99
  END DO
!
! Create spect_atmos array:
!
  DEALLOCATE(FMI%spect_atmos,STAT=i)
  ALLOCATE(FMI%spect_atmos(n_sps),STAT=i)
  if(i /= 0) goto 99

  do k = 1, n_sps
    Spectag = T_FMI%atmospheric(k)%Spectag
    do i = 1, FMI%no_spectro
      if(Spectag == FMI%spectroscopic(i)%Spectag) then
        FMI%spect_atmos(k) = i
        EXIT
      endif
    end do
  end do
!
  CLOSE(11,iostat=i)
!
! Get all the filter's loaded & define:
!
! no_pfa_ch = FMC%Channels_range(2)-FMC%Channels_range(1)+1
! do i = 1, no_pfa_ch
!   ch2 = FMC%Channels_range(1) + i - 1
!   pfa_ch(i) = ch2
! end do

! j = no_pfa_ch
! k = FMI%no_filt_pts
! DEALLOCATE(FMI%F_grid_filter,FMI%Filter_func,STAT=i)
! ALLOCATE(FMI%F_grid_filter(k,j),FMI%Filter_func(k,j),STAT=i)
! if(i /= 0) goto 99

! Call get_filters(no_pfa_ch,FMI%no_filt_pts,pfa_ch, &
!&                 FMI%F_grid_filter,FMI%Filter_func,  &
!&                 FMC%InDir,ier)

 99  CLOSE(11,iostat=i)
!    CLOSE(13,iostat=i)
!
     if(io /= 0) then
       Ier = iabs(io)
       Call ErrMsg(Line,io)
     endif

     Return

  END SUBROUTINE L2_LOAD

! *****     Private procedures     *************************************
! ------------------------------------------------     ANTENNA     -----
! This subroutine reads an external antenna aperture autocorrelation
! file
!
  Subroutine ANTENNA (Fn, M, XLAMDA, AAAP, D1AAP, D2AAP, IAS, IER)

!   use units, only: AAAP_UNIT
    use MACHINE, only: IO_ERROR

    Integer(i4), parameter :: MaxV= 2048
!
    Real(r8), intent(out) :: AAAP(*),D1AAP(*),D2AAP(*),XLAMDA
    integer(i4), intent(out) :: IAS, IER
!
    Integer(i4) :: M, k, lf, I, J, NTR, L, N
    REAL(r8) :: V(6), VALL(MaxV, 6), dx2p, Q, Q2
!
    Character*(*) Fn
!
    ier = 0
    lf = len_trim(Fn)
    OPEN(aaap_unit,FILE=Fn(1:lf),action='READ',STATUS='OLD',iostat=k)
    if(k /= 0) then
      ier = 1
      Print *,'** File: ',Fn(1:lf)
      call io_error ('Opening file in ANTENNA', k, Fn(1:lf) )
      goto 20
    endif
!
    READ(aaap_unit,*,iostat=k) XLAMDA
    if(k /= 0) then
      ier = 1
      Print *,'** Reading error in file: ',Fn(1:lf)
      call io_error ( 'Reading file in ANTENNA', k, Fn(1:lf) )
      goto 20
    endif
!
    dx2p = 6.28318530717959_r8 * Xlamda         ! 2 * Pi * Lambda
!
    i = 0
    k = 0
!
    do while(k == 0)
!
! This loop MUST exit on an end of file condition
!
      read(aaap_unit,*,iostat=k) v
      if(k == -1) exit
      if(k == 0) then
        if(I == MaxV) then
          ier = 1
          Print *,'** Error in ANTENNA subroutine !!'
          Print *,'   Too many lines in: ',Fn(1:lf)
          Print *,'   Maximum allowed is:',MaxV
          goto 20
        endif
        i = i + 1
        vall(i,:) = v
      else
        ier = 1
        Print *,'** Reading error in file: ',Fn(1:lf)
        call io_error ( 'Reading file in ANTENNA', k, Fn(1:lf) )
        goto 20
      endif
!
    end do
!
    ias = i
    ntr = 2**m
!
    do i = 1, ias
!
      j = 2 * i - 1
      l = 2 * ias + j
      n = 4 * ias + j
!
      v = vall(i,:)
!
      aaap(j)   = v(1)
      aaap(j+1) = v(2)
      aaap(l)   = v(3)
      aaap(l+1) = v(4)
      aaap(n)   = v(5)
      aaap(n+1) = v(6)
!
! Below is the  first derivative field:     ! i*Q * F(S), i = Sqrt(-1)
!
      q = (i - 1) * dx2p
      d1aap(j)    = -v(2) * q
      d1aap(j+1)  =  v(1) * q
      d1aap(l)    = -v(4) * q
      d1aap(l+1)  =  v(3) * q
      d1aap(n)    = -v(6) * q
      d1aap(n+1)  =  v(5) * q
!
! Below is the second derivative field:     ! (i*Q)**2 * F(S), i = Sqrt(-1)
!
      q2 = -q * q                         ! (i*q)**2 = -q*q
      d2aap(j)    =  v(1) * q2
      d2aap(j+1)  =  v(2) * q2
      d2aap(l)    =  v(3) * q2
      d2aap(l+1)  =  v(4) * q2
      d2aap(n)    =  v(5) * q2
      d2aap(n+1)  =  v(6) * q2
!
    end do
!
20  CLOSE(aaap_unit,iostat=k)
!
    Return

  End subroutine ANTENNA

! ------------------------------------------------ GET_FILTERS   -----
! This subroutine loads the filter shapes into memory
!
SUBROUTINE get_filters(no_pfa_ch,no_filt_pts,pfa_ch,f_grid_filter, &
               &       filter_func,InDir,ier)

  use MLSCommon, only: I4, R8
! use units, only: filter_unit

!  ===============================================================
!  Declaration of variables for sub-program: get_filters
!  ===============================================================
!  ---------------------------
!  Calling sequence variables:
!  ---------------------------
Integer(i4), INTENT(IN) :: pfa_ch(:)
Integer(i4), INTENT(IN) :: no_pfa_ch, no_filt_pts

Integer(i4), INTENT(OUT) :: ier

Real(r8), INTENT(OUT) :: filter_func(:,:), f_grid_filter(:,:)

Character (LEN=*), INTENT(IN) :: InDir

!  ----------------
!  Local variables:
!  ----------------

Real(r8) :: df, q
Character (LEN=80) :: Fn
Integer(i4) :: j, ch_i, ld, mch, pch

Integer(i4) :: Channel,Nfp
Real(r8) :: Xlhs,Xrhs,N_Filter(200)

NAMELIST/IN/Channel,Nfp,Xlhs,Xrhs,N_Filter

! Begin code:

  ier = 0

  pch = -1
  ld = LEN_TRIM(InDir)
  Fn = InDir(1:ld)//'normalized_filter_banks.dat'
!
  Close(filter_unit,iostat=j)
  Open(filter_unit,file=Fn,status='OLD',action='READ',iostat=ier)
  IF(ier /= 0) goto 99

! Find the species index in the l2pc mixing ratio database:

  DO ch_i = 1, no_pfa_ch

    mch = pfa_ch(ch_i)

! Read in filter's response function

    if(mch < pch) then
      ier = 0
      REWIND(filter_unit,IOSTAT=j)
    endif

    DO
      READ(UNIT=filter_unit,nml=IN,IOSTAT=ier)
      IF(ier > 0) goto 99
      if(Channel == mch .or. ier < 0) EXIT
    END DO

    if(Channel /= mch) then
      Ier = 1
      WRITE(6,905) mch,Fn(1:ld)
      GOTO 99
    endif

    IF(nfp /= no_filt_pts) THEN
      ier = 1
      WRITE(6,910) Fn(1:ld),no_filt_pts,nfp
      GOTO 99
    END IF

    pch = mch
    df = (xrhs-xlhs)/(nfp-1)
    DO j = 1, nfp
      q = xlhs + (j - 1) * df
      f_grid_filter(j,ch_i) = q
    END DO

    filter_func(1:nfp,ch_i) = N_Filter(1:nfp)

  END DO                         ! On ch_i

 99 Close(filter_unit,iostat=j)

    IF(ier /= 0) CALL errmsg(Fn,ier)

 905 FORMAT(' ** Error in get_filters subroutine **',/, &
            '    Channel:',i3,' not found in file: ',A)

 910 FORMAT(' ** Error in get_filters subroutine **',/, &
            '    Inconsistant Input for file:',A,/, &
            '    Input no_filt_pts:',i4,' no_filt_pts in file:',i4)

  Return

END SUBROUTINE get_filters

!=====================================================================

end module L2_LOAD_M
! $Log: l2_load_m.f90,v $
! Revision 1.20  2001/04/06 20:14:00  vsnyder
! Comment-out some unused stuff
!
! Revision 1.19  2001/04/03 07:32:45  zvi
! Modify the spectral structure - eliminating sps_ from the names
!
! Revision 1.18  2001/04/02 17:33:32  pwagner
! Resurrected--still needed by l2
!
! Revision 1.16  2001/03/29 12:08:17  zvi
! Fixing bugs
!
! Revision 1.15  2001/03/29 08:51:01  zvi
! Changing the (*) toi (:) everywhere
!
! Revision 1.14  2001/03/26 21:14:54  livesey
! Modified pfa stuff to not have old dimensions of 2
!
! Revision 1.13  2001/03/24 00:41:48  zvi
! Get rid of the UARS Channel's center frequency in F_grid_Filter ..
!
! Revision 1.12  2001/03/20 23:22:40  zvi
! Change to new geoc_geod routine..
!
! Revision 1.11  2001/03/20 11:03:16  zvi
! Fixing code for "real" data run, increase dim. etc.
!
! Revision 1.10  2001/03/20 02:31:00  livesey
! Interim version, gets same numbers as zvi
!
! Revision 1.9  2001/03/15 12:18:03  zvi
! Adding the Velocity effect on Line center frequency
!
! Revision 1.8  2001/03/13 01:46:46  vsnyder
! Allocate and use the correct size for tan_press
!
! Revision 1.7  2001/03/09 00:40:32  zvi
! Correcting an error in HUNT routine
!
! Revision 1.6  2001/03/08 22:01:11  vsnyder
! Make sure 'line' has a value, in case of an error
!
! Revision 1.5  2001/03/08 00:08:04  vsnyder
! Modifications to work inside of MLSL2.
!
! Revision 1.4  2001/03/07 23:45:14  zvi
! Adding logical flags fro Temp, Atmos & Spect. derivatives
!
! Revision 1.1  2001/02/22 18:12:05  ZShippony
! Initial conversion to Fortran 90
@


1.20
log
@Comment-out some unused stuff
@
text
@d19 1
a19 1
    "$Id: l2_load_m.f90,v 1.19 2001/04/03 07:32:45 zvi Exp $"
d869 3
@


1.19
log
@Modify the spectral structure - eliminating sps_ from the names
@
text
@d19 1
a19 1
    "$Id: l2_load_m.f90,v 1.18 2001/04/02 17:33:32 pwagner Exp $"
d254 9
a262 9
  DEALLOCATE(FMI%z_grid,FMI%tan_press,STAT=i)
  ALLOCATE(FMI%z_grid(k),FMI%tan_press(j),STAT=i)
  if(i /= 0) goto 99
!
  FMI%z_grid(j) = 0.0
  DO i = 1, k
    j = FMC%p_indx(i)
    FMI%z_grid(i) = z0 + (j - 1) * r
  END DO
d266 7
a272 7
  kz = si - 1
  FMI%tan_press(1:kz) = -5.0
  do i = 1, FMC%no_tan_hts
    kz = kz + 1
    j = FMC%t_indx(i)
    FMI%tan_press(kz) = FMI%z_grid(j)
  end do
d617 15
a631 5
  no_pfa_ch = FMC%Channels_range(2)-FMC%Channels_range(1)+1
  do i = 1, no_pfa_ch
    ch2 = FMC%Channels_range(1) + i - 1
    pfa_ch(i) = ch2
  end do
a632 11
  j = no_pfa_ch
  k = FMI%no_filt_pts
  DEALLOCATE(FMI%F_grid_filter,FMI%Filter_func,STAT=i)
  ALLOCATE(FMI%F_grid_filter(k,j),FMI%Filter_func(k,j),STAT=i)
  if(i /= 0) goto 99

  Call get_filters(no_pfa_ch,FMI%no_filt_pts,pfa_ch, &
 &                 FMI%F_grid_filter,FMI%Filter_func,  &
 &                 FMC%InDir,ier)
  if(ier /= 0) goto 99
!
d634 1
a634 1
     CLOSE(13,iostat=i)
d869 3
@


1.18
log
@Resurrected--still needed by l2
@
text
@d19 1
a19 1
    "$Id: l2_load_m.f90,v 1.16 2001/03/29 12:08:17 zvi Exp $"
d339 1
a339 1
      FMI%Pfa_spectrum(j)%SPS_NAME = Name
d342 2
a343 2
      FMI%Pfa_spectrum(j)%SPS_SPECTAG = Spectag
      FMI%Pfa_spectrum(j)%SPS_QLOG(1:3) = Qlog(1:3)
d347 10
a356 10
        FMI%Pfa_spectrum(j)%SPS_V0(i) = thbs(1)
        FMI%Pfa_spectrum(j)%SPS_EL(i) = thbs(2)
        FMI%Pfa_spectrum(j)%SPS_STR(i) = thbs(3)
        FMI%Pfa_spectrum(j)%SPS_W(i) = thbs(4)
        FMI%Pfa_spectrum(j)%SPS_PS(i) = 0.0   !  thbs(5) *** DEBUG
        FMI%Pfa_spectrum(j)%SPS_N(i) = thbs(6)
        FMI%Pfa_spectrum(j)%SPS_DELTA(i) = thbs(7)
        FMI%Pfa_spectrum(j)%SPS_N1(i) = thbs(8)
        FMI%Pfa_spectrum(j)%SPS_GAMMA(i) = thbs(9)
        FMI%Pfa_spectrum(j)%SPS_N2(i) = thbs(10)
d870 3
@


1.17
log
@*** empty log message ***
@
text
@@


1.16
log
@Fixing bugs
@
text
@d19 1
a19 1
    "$Id: l2_load_m.f90,v 1.15 2001/03/29 08:51:01 zvi Exp $"
d870 3
@


1.15
log
@Changing the (*) toi (:) everywhere
@
text
@d11 1
a11 1
  use D_HUNT_M, only: HUNT          ! ** DEBUG
d19 1
a19 1
    "$Id: l2_load_m.f90,v 1.14 2001/03/26 21:14:54 livesey Exp $"
d255 1
a255 1
  ALLOCATE(FMI%z_grid(j),FMI%tan_press(j),STAT=i)
a262 1
  FMI%z_grid(k+1) = FMI%z_grid(k)
d870 3
@


1.14
log
@Modified pfa stuff to not have old dimensions of 2
@
text
@d19 1
a19 1
    "$Id: l2_load_m.f90,v 1.13 2001/03/24 00:41:48 zvi Exp $"
d776 1
a776 1
Integer(i4), INTENT(IN) :: pfa_ch(*)
d871 3
@


1.13
log
@Get rid of the UARS Channel's center frequency in F_grid_Filter ..
@
text
@d19 1
a19 1
    "$Id: l2_load_m.f90,v 1.12 2001/03/20 23:22:40 zvi Exp $"
d47 1
a47 1
Integer(i4) :: ch1, ch2, no_pfa_ch, pfa_ch(2)
d130 1
a130 1
    no_pfa_ch = min(2,ch2-ch1+1)
d618 1
a618 1
  no_pfa_ch = min(2,FMC%Channels_range(2)-FMC%Channels_range(1)+1)
d871 3
@


1.12
log
@Change to new geoc_geod routine..
@
text
@d19 1
a19 1
    "$Id: l2_load_m.f90,v 1.11 2001/03/20 11:03:16 zvi Exp $"
a50 2
real(r8) :: freqs(Nch)

a629 7
  freqs(1:Nch) = 0.0D0
  DO i = FMC%Channels_Range(1), FMC%Channels_Range(2)
    CALL radiometry(i,q,r,v,kk)
    IF(FMC%Sideband < 0) freqs(i) = q
    IF(FMC%Sideband > 0) freqs(i) = r
  END DO

d631 1
a631 1
 &                 FMI%F_grid_filter,freqs,FMI%Filter_func,  &
a647 77
! ------------------------------------------------ Radiometry   -----

SUBROUTINE radiometry(ch, f_p, f_i, db_fi, lmt)

! This subroutine calculates the center frequency of the primary and image
! sideband by channel. It also Returns the bandwidth limits of integration
! and the gain of the primary sideband relative to the image in db units.

INTEGER(i4), INTENT(IN) :: ch
INTEGER(i4), INTENT(OUT) :: lmt

REAL(r8), INTENT(OUT) :: f_p
REAL(r8), INTENT(OUT) :: f_i
REAL(r8), INTENT(OUT) :: db_fi

LOGICAL, SAVE :: sgn_fp(6) = (/                                    &
                 .false., .true., .false., .true., .true., .false./)

INTEGER(i4) :: band, sub_ch, j

Real(r4), SAVE :: db_fi_data(90) =(/                   &
     &    -0.5218,  0.0000,  0.5218,  0.8264,  0.9654, &
     &     1.0332,  1.0668,  1.0890,  1.1111,  1.1440, &
     &     1.2091,  1.3365,  1.5807,  0.3476, -3.6798, &
     &    -1.7854, -1.6204, -1.5519, -1.5142, -1.4966, &
     &    -1.4884, -1.4840, -1.4811, -1.4783, -1.4741, &
     &    -1.4659, -1.4486, -1.4167, -1.3607, -1.2602, &
     &    -1.0409, -1.1206, -1.1641, -1.1874, -1.1995, &
     &    -1.2052, -1.2084, -1.2104, -1.2124, -1.2157, &
     &    -1.2216, -1.2347, -1.2607, -1.3128, -1.4233, &
     &    -1.0921, -1.2329, -1.2863, -1.3121, -1.3234, &
     &    -1.3284, -1.3309, -1.3327, -1.3343, -1.3367, &
     &    -1.3416, -1.3507, -1.3667, -1.3884, -1.4035, &
     &     0.6661,  0.6480,  0.7759,  0.8029,  0.8741, &
     &     0.8307,  0.9736,  0.9273,  0.5800,  0.8906, &
     &     0.9772,  0.9596,  0.9426,  0.8669,  0.7433, &
     &     0.3108,  1.0632,  0.7029,  0.4426,  0.2910, &
     &     0.2261,  0.2396,  0.2244,  0.2237,  0.1811, &
     &     0.1795,  0.1534,  0.1418,  0.3651,  0.5647 /)
!

REAL(r8), SAVE :: f_prime(6) = (/                          &
    63568.418D0, 204352.161D0, 204574.627D0, 206132.067D0, &
    183310.062D0, 184377.788D0/)

REAL(r8), SAVE :: f_image(6) = (/                          &
    62997.812D0, 202181.555D0, 201959.089D0, 200401.648D0, &
    186245.513D0, 185177.788D0/)

REAL(r8) :: ch_offset

  band = (ch - 1) / 15 + 1
  sub_ch = ch - 15 * (band - 1)
!
  IF(sub_ch == 8) THEN
    j = 0
    lmt = 1
  ELSE                      ! Above and below the spectral center
    lmt = 2**(ABS(sub_ch - 8) - 1)
    j = SIGN(3*lmt - 1, sub_ch - 8)
  END IF

  ch_offset = float(j)
  db_fi = db_fi_data(ch)

  IF(sgn_fp(band)) THEN
    f_p = f_prime(band) + ch_offset
    f_i = f_image(band) - ch_offset
  ELSE
    f_p = f_prime(band) - ch_offset
    f_i = f_image(band) + ch_offset
  END IF

  Return

END SUBROUTINE radiometry

d765 1
a765 1
               &       freqs,filter_func,InDir,ier)
a780 2
Real(r8), INTENT(IN) :: freqs(*)

d789 1
a789 1
Real(r8) :: df, frq, q
a814 6
    frq = freqs(mch)
    IF(frq < 1.0D0) THEN
      ier = 1
      WRITE(6,900) mch
      GOTO 99
    END IF
d845 1
a845 1
      f_grid_filter(j,ch_i) = frq + q
a855 4
 900 FORMAT(' ** Error in get_filters subroutine **',/, &
            '    Inconsistant User Input.',/, &
            '    PFA Channel:',i3,' not among the non-PFA channels !')

d871 3
@


1.11
log
@Fixing code for "real" data run, increase dim. etc.
@
text
@d19 1
a19 1
    "$Id: l2_load_m.f90,v 1.10 2001/03/20 02:31:00 livesey Exp $"
a507 3
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

d510 2
a511 1
  DEALLOCATE(T_FMI%t_zeta_basis,T_FMI%t_phi_basis,T_FMI%t_coeff,STAT=i)
d513 1
a513 1
 &         T_FMI%t_coeff(no_t,no_mmaf),STAT=i)
d516 3
d533 8
d969 3
@


1.10
log
@Interim version, gets same numbers as zvi
@
text
@d19 1
a19 1
    "$Id: l2_load_m.f90,v 1.9 2001/03/15 12:18:03 zvi Exp $"
a378 3
  kk = mxco
  k = FMI%mfi + 2

d390 1
a390 1
    read(11,*,iostat=io) ht_i
d392 2
a393 2
    FMI%spectroscopic(j)%NO_PHI_VALUES = ht_i
    read(11,*,iostat=io) ht_i
d395 1
a395 1
    FMI%spectroscopic(j)%NO_ZETA_VALUES = ht_i
d402 1
a402 1
    read(11,*,iostat=io) (FMI%spectroscopic(j)%ZETA_BASIS(i),i=1,kk+2)
a454 1
  kk = mxco
d475 1
d482 1
a482 3
    read(11,*,iostat=io) (T_FMI%Atmospheric(j)%LIN_VAL(i),i=1,kk)
    if(io /= 0) goto 99
    read(11,*,iostat=io) (T_FMI%Atmospheric(j)%BASIS_PEAKS(i),i=1,kk+2)
d513 1
a513 2
  DEALLOCATE(T_FMI%t_zeta_basis,T_FMI%t_phi_basis,T_FMI%t_coeff, &
 &           T_FMI%t_phi_basis_copy,STAT=i)
d515 1
a515 2
 &    T_FMI%t_phi_basis_copy(no_phi_t),T_FMI%t_coeff(no_t,no_mmaf),&
      STAT=i)
a527 1
  T_FMI%t_phi_basis_copy(1:no_phi_t) = T_FMI%t_phi_basis(1:no_phi_t)
d572 1
a572 2
  DEALLOCATE(T_FMI%f_zeta_basis,T_FMI%f_phi_basis,T_FMI%mr_f, &
             T_FMI%f_phi_basis_copy,STAT=i)
a574 1
 &         T_FMI%f_phi_basis_copy(kk,n_sps), &
a586 1
    T_FMI%f_phi_basis_copy(1:kk,m) = T_FMI%f_phi_basis(1:kk,m)
a606 14
  kk = mxco
  k = FMI%mfi + 2

  DEALLOCATE(T_FMI%S_PHI_BASIS_COPY,STAT=i)
  ALLOCATE(T_FMI%S_PHI_BASIS_COPY(k,FMI%no_spectro),STAT=io)
  IF(io /= 0) then
    Print *,'** ALLOCATE Error: T_FMI%S_PHI_BASIS_COPY, STAT =',io
    goto 99
  endif

  do j = 1, FMI%no_spectro
    T_FMI%S_PHI_BASIS_COPY(1:k,j) = FMI%spectroscopic(j)%PHI_BASIS(1:k)
  end do

d960 3
@


1.9
log
@Adding the Velocity effect on Line center frequency
@
text
@d19 1
a19 1
    "$Id: l2_load_m.f90,v 1.8 2001/03/13 01:46:46 vsnyder Exp $"
d210 1
a432 1

a450 1

a489 1

a491 1

a493 1

a495 1

a497 1

a505 1

a533 1

a568 1

d636 6
d649 1
a649 1
  DO i = ch1, ch2
d985 3
@


1.8
log
@Allocate and use the correct size for tan_press
@
text
@d19 1
a19 1
    "$Id: l2_load_m.f90,v 1.7 2001/03/09 00:40:32 zvi Exp $"
d107 10
a123 4
    DEALLOCATE(FMC%phi_tan_mmaf,STAT=i)
    ALLOCATE(FMC%phi_tan_mmaf(no_mmaf),STAT=i)
    if(i /= 0) goto 99

d988 3
@


1.7
log
@Correcting an error in HUNT routine
@
text
@d19 1
a19 1
    "$Id: l2_load_m.f90,v 1.6 2001/03/08 22:01:11 vsnyder Exp $"
d248 1
a248 1
  j = k + si
a268 1
  FMI%no_ptg_frq(1) = kz
d982 3
@


1.6
log
@Make sure 'line' has a value, in case of an error
@
text
@d19 1
a19 1
    "$Id: l2_load_m.f90,v 1.5 2001/03/08 00:08:04 vsnyder Exp $"
d86 1
a86 1

d983 3
@


1.5
log
@Modifications to work inside of MLSL2.
@
text
@d19 1
a19 1
    "$Id: l2_load_m.f90,v 1.4 2001/03/07 23:45:14 zvi Exp $"
d88 1
d983 3
@


1.4
log
@Adding logical flags fro Temp, Atmos & Spect. derivatives
@
text
@d13 4
d19 1
a19 1
    "$Id: l2_load_m.f90,v 1.1 2001/02/22 18:12:05 ZShippony Exp $"
d24 1
a24 1
! ===========================================     L2_LOAD =====
d26 1
a26 1
!
d30 4
d61 2
d65 17
a81 15
  Line = 'tmp.dat'
  CLOSE(13,iostat=i)
  OPEN(13,file=Line,status='OLD',action='READ',iostat=io)
  if(io /= 0) goto 99
!
  FMC%Zfrq = -1.0
  read(13,*,iostat=io) FMC%do_conv
  if(io /= 0) goto 99
  read(13,*,iostat=io) FMC%do_frqavg
  if(io /= 0) goto 99
  if(.not. FMC%do_frqavg) then
    read(13,*,iostat=io) FMC%Zfrq
    if(io /= 0) goto 99
  endif
  CLOSE(13,iostat=io)
a85 3
  Fnd(1:) = ' '
  Fnd = FMC%Z
  Line = Fnd
d87 4
a90 3
  CLOSE(11,iostat=io)
  OPEN(11,file=Fnd,status='OLD',action='READ',iostat=io)
  if(io /= 0) goto 99
d94 7
a100 3
  do
    Ax(1:) = ' '
    read(11,'(A)',iostat=io) Ax
a101 2
    if (Index(Ax,'No_Mmaf') > 0) EXIT
  end do
d103 2
a104 2
  read(11,*,iostat=io) j
  if(io /= 0) goto 99
d106 2
a107 2
  FMC%no_mmaf = min(j,100)   ! Assuming mmaf chunk of no more then 100
  no_mmaf = FMC%no_mmaf
d109 3
a111 2
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99
d113 3
a115 3
  dummy(1:no_mmaf) = 0.0
  read(11,*,iostat=io) (dummy(i),i=1,no_mmaf)
  if(io /= 0) goto 99
d117 1
a117 3
  DEALLOCATE(FMC%phi_tan_mmaf,STAT=i)
  ALLOCATE(FMC%phi_tan_mmaf(no_mmaf),STAT=i)
  if(i /= 0) goto 99
d119 2
a120 1
  FMC%phi_tan_mmaf(1:no_mmaf) = dummy(1:no_mmaf) * deg2rad
d122 2
a123 2
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99
d125 5
a129 2
  read(11,*,iostat=io) ch1, ch2
  if(io /= 0) goto 99
d131 2
a132 5
  no_pfa_ch = min(2,ch2-ch1+1)
  do i = 1, no_pfa_ch
    ch2 = ch1 + i - 1
    pfa_ch(i) = ch2
  end do
d134 2
a135 2
  FMC%Channels_range(1) = ch1
  FMC%Channels_range(2) = ch2
d137 5
a141 2
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99
d143 2
a144 5
  read(11,*,iostat=io) FMC%Sideband
  if(io /= 0) goto 99
!
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99
d146 2
a147 5
  read(11,*,iostat=io) FMC%temp_der, FMC%atmos_der, FMC%spect_der
  if(io /= 0) goto 99
!
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99
d149 3
a151 2
  read(11,*,iostat=io) k, j
  if(io /= 0) goto 99
d153 2
a154 2
  FMC%n_lvls = k
  FMC%no_tan_hts = j
d156 2
a157 3
  DEALLOCATE(FMC%p_Indx,FMC%t_Indx,STAT=i)
  ALLOCATE(FMC%p_Indx(k),FMC%t_Indx(j),STAT=i)
  if(i /= 0) goto 99
d159 2
a160 2
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99
d162 2
a163 2
  read(11,*,iostat=io) (FMC%p_indx(i),i=1,k)
  if(io /= 0) goto 99
d165 2
a166 2
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99
d168 2
a169 2
  read(11,*,iostat=io) (FMC%t_indx(i),i=1,FMC%no_tan_hts)
  if(io /= 0) goto 99
d171 6
a176 2
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99
d178 1
a178 3
  Fnd(1:)=' '
  read(11,'(A)',iostat=io) Fnd
  if(io /= 0) goto 99
d180 2
a181 6
  Fnd = AdjustL(Fnd)
  i = LEN_TRIM(Fnd)
  if(Fnd(i:i) /= '/') then
    i = i + 1
    Fnd(i:i) = '/'
  endif
d183 2
a184 1
  FMC%InDir = Fnd
d186 1
a186 2
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99
d188 2
a189 3
  Fnd(1:)=' '
  read(11,'(A)',iostat=io) Fnd
  if(io /= 0) goto 99
d191 2
a192 1
  FMC%B = AdjustL(Fnd)
d194 1
a194 2
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99
d196 4
a199 8
  Fnd(1:)=' '
  read(11,'(A)',iostat=io) Fnd
  if(io /= 0) goto 99

  FMC%aaap_file = AdjustL(Fnd)

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99
a311 1
    Line = ' '
a376 1
    Ax(1:)=' '
a379 1
    Ax(1:)=' '
a455 1
    Ax(1:)=' '
d753 1
a753 1
    use GET_LUN, only: AAAP_UNIT
d867 1
a867 1
  use GET_LUN, only: filter_unit
a903 1
  Fn(1:)=' '
d982 3
@


1.3
log
@clean more amitious--rms * from MLSCONFGl[13]/MakeFC
@
text
@d15 1
a15 1
    "$Id: l2_load_m.f90,v 1.2 2001/03/06 09:28:28 zvi Exp $"
a60 1
  FMC%temp_der = .true.
d134 6
d755 1
a755 1
    use get_lun, only: AAAP_UNIT
d869 1
a869 1
  use get_lun, only: filter_unit
a984 3
! Revision 1.2  2001/03/06 09:28:28  zvi
! *** empty log message ***
!
@


1.2
log
@*** empty log message ***
@
text
@d15 1
a15 1
    "$Id: l2_load_m.f90,v 1.1 2001/02/22 18:12:05 ZShippony Exp $"
d750 1
a750 1
    use UNITS, only: AAAP_UNIT
d864 1
a864 1
  use UNITS, only: filter_unit
d980 3
@


1.1
log
@New filter format
@
text
@d30 2
d36 2
a37 2
Integer(i4) :: i, j, k, kk, ht_i, no_t, mnz, kz, band, si, ier, jp, &
               n_sps, io, l, nl, Spectag, m, no_phi_t, no_mmaf, jj
a42 2
Real(r8), DIMENSION(:), ALLOCATABLE :: z_gnlv

d261 1
d310 2
a311 1
    read(Line,*,iostat=io) Name, Spectag, nl, (Qlog(i),i=1,3)
d313 1
a313 1

d369 1
d402 3
d407 1
a407 1
 &                    (T_FMI%ptg_press%der_calc(i),i=1,6)
d427 1
a427 1
    read(11,*,iostat=io) Name,geom_deriv,r
d517 4
a520 3
 &           STAT=i)
  ALLOCATE(T_FMI%t_zeta_basis(no_t),T_FMI%t_phi_basis(no_phi_t), &
 &         T_FMI%t_coeff(no_t,no_mmaf),STAT=i)
d534 1
d580 5
a584 3
  DEALLOCATE(T_FMI%f_zeta_basis,T_FMI%f_phi_basis,T_FMI%mr_f,STAT=i)
  ALLOCATE(T_FMI%f_zeta_basis(ht_i,n_sps), &
 &         T_FMI%f_phi_basis(kk,n_sps),    &
a587 1
  dummy(1:mnp) = 0.0
d597 1
d601 30
a653 102
! Load the pointing vs. frequencies database for the given band
! (needed for frequency averaging)
!
  Fnd(1:) = ' '
  Fnd = FMC%B
!
  kk = -1
  FMI%no_ptg_frq(1:Nptg) = 0
!
  CLOSE(32,iostat=i)
  OPEN(32,file=Fnd,action='READ',status='OLD',iostat=io)
  if(io /= 0) goto 44
!
! First entry in the file is the 'Band' frequency. All the rest are
! relative to this (center) frequency for this band
!
  Read(32,*,iostat=io) q
  if(io /= 0) goto 44
!
  DO
!
    Read(32,*,iostat=io) r, jp
    if(io > 0) goto 44
    if(io /= 0) EXIT
    Call Hunt(r,FMI%tan_press,kz,k,i)
    IF(ABS(r-FMI%tan_press(i)) < ABS(r-FMI%tan_press(k))) k = i
!
    if(ABS(r-FMI%tan_press(k)) > 0.001) then
      Print *,'** Warning **'
      Print *,'   Zeta:',Sngl(r),' not an entry in tan_press !'
      Print *,'   ptg_frq_grid for this Zeta is ignored ..'
      Print *
      Read(32,*,iostat=io) (dummy(i),i=1,jp)
      if(io /= 0) goto 44
!
    else

      DEALLOCATE(FMI%ptg_frq_grid(k)%values,STAT=i)

      if(FMC%Zfrq > 0.0) then
        FMI%no_ptg_frq(k) = 1
        ALLOCATE(FMI%ptg_frq_grid(k)%values(2),STAT=i)
      else
        FMI%no_ptg_frq(k) = jp
        ALLOCATE(FMI%ptg_frq_grid(k)%values(jp),STAT=i)
      endif

      IF(i /= 0) THEN
        ier = i
        PRINT *,'** Error: ALLOCATION error for ptg_frq_grid ..'
        PRINT *,'   tan_hts index:',k,' STAT =',ier
        do l = 1, k
          DEALLOCATE(FMI%ptg_frq_grid(l)%values,STAT=i)
        end do
        goto 99
      ENDIF

      Read(32,*,iostat=io) (dummy(i),i=1,jp)
      if(io /= 0) goto 44
      if(kk < 0) kk = k

      if(FMC%Zfrq > 0.0) dummy(1) = FMC%Zfrq - q
!
! Add 'band' frequency to ptg_frq_grid to convert to absolute grid
!
      jp = FMI%no_ptg_frq(k)
      FMI%ptg_frq_grid(k)%values(1:jp) = dummy(1:jp) + q
!
    endif
!
  END DO
!
  if(kk > 1) then
    jp = FMI%no_ptg_frq(kk)
    do k = 1, kk-1
      DEALLOCATE(FMI%ptg_frq_grid(k)%values,STAT=i)
      ALLOCATE(FMI%ptg_frq_grid(k)%values(jp),STAT=i)
      IF(i /= 0) THEN
        ier = i
        PRINT *,'** Error: ALLOCATION error for ptg_frq_grid ..'
        PRINT *,'   tan_hts index:',k,' STAT =',ier
        do l = 1, k
          DEALLOCATE(FMI%ptg_frq_grid(l)%values,STAT=i)
        end do
        goto 99
      ENDIF
      FMI%no_ptg_frq(k) = jp
      FMI%ptg_frq_grid(k)%values(1:jp) = &
     &           FMI%ptg_frq_grid(kk)%values(1:jp)
    end do
  endif
!
 44 CLOSE(32,iostat=i)
    if(io > 0) then
      ier = io
      goto 99
    else
      io = 0
    endif
!
!  **** END DEBUG
!
a655 1
     CLOSE(32,iostat=i)
a659 1
       Stop
d750 1
a750 1
    use GET_LUN, only: AAAP_UNIT
d864 1
a864 1
  use GET_LUN, only: filter_unit
@

