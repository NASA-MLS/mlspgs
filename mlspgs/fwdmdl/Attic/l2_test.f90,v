head	1.12;
access;
symbols
	newfwm-sep01:1.12.0.2;
locks; strict;
comment	@# @;


1.12
date	2001.04.01.00.16.13;	author zvi;	state dead;
branches
	1.12.2.1;
next	1.11;

1.11
date	2001.03.09.00.40.32;	author zvi;	state Exp;
branches;
next	1.10;

1.10
date	2001.03.08.00.11.16;	author zvi;	state Exp;
branches;
next	1.9;

1.9
date	2001.03.07.23.45.14;	author zvi;	state Exp;
branches;
next	1.8;

1.8
date	2001.03.06.22.47.30;	author zvi;	state Exp;
branches;
next	1.7;

1.7
date	2001.03.06.09.28.28;	author zvi;	state Exp;
branches;
next	1.6;

1.6
date	2001.03.05.21.37.20;	author zvi;	state Exp;
branches;
next	1.5;

1.5
date	2001.02.26.09.01.16;	author zvi;	state Exp;
branches;
next	1.4;

1.4
date	2001.02.19.22.14.21;	author zvi;	state Exp;
branches;
next	1.3;

1.3
date	2001.02.03.02.07.01;	author zvi;	state Exp;
branches;
next	1.2;

1.2
date	2001.01.31.01.08.48;	author zvi;	state Exp;
branches;
next	1.1;

1.1
date	2000.11.22.23.07.28;	author zvi;	state Exp;
branches;
next	;

1.12.2.1
date	2001.09.07.22.23.07;	author zvi;	state Exp;
branches;
next	1.12.2.2;

1.12.2.2
date	2001.09.10.10.00.53;	author zvi;	state dead;
branches;
next	;


desc
@@


1.12
log
@*** empty log message ***
@
text
@Program l2_Test
  use GL6P, only: NG
  use MLSCommon, only: I4, R4, R8
  use L2_TEST_STRUCTURES_M
  use L2PC_FILE_PARAMETERS, only: mxco => MAX_NO_ELMNTS_PER_SV_COMPONENT
  use L2PC_PFA_STRUCTURES, only: K_MATRIX_INFO
  use L2PCdim, only: Nlvl, N2lvl, NSPS, Nptg, NCH, MNP => max_no_phi, &
                     MNM => max_no_mmaf
  use ELLIPSE, only: PHI_TAN, ROC
  use L2_LOAD_M, only: L2_LOAD
  use PTG_FRQ_LOAD_M, only: PTG_FRQ_LOAD
  use COMP_PATH_ENTITIES_M, only: COMP_PATH_ENTITIES
  use REFRACTION_M, only: REFRACTION_CORRECTION
  use PATH_ENTITIES_M, only: PATH_INDEX, PATH_VECTOR, PATH_BETA, &
                             PATH_DERIVATIVE
  use HYDROSTATIC_MODEL_M, only: HYDROSTATIC_MODEL
  use GET_CHI_ANGLES_M, only: GET_CHI_ANGLES
  use GET_BETA_PATH_M, only: GET_BETA_PATH
  use GEOC_GEOD_CONV_M, only: GEOC_GEOD_CONV
  use RAD_TRAN_M, only: RAD_TRAN
  use RAD_TRAN_WD_M, only: RAD_TRAN_WD
  use FREQ_AVG_M, only: FREQ_AVG
  use CONVOLVE_ALL_M, only: CONVOLVE_ALL
  use NO_CONV_AT_ALL_M, only: NO_CONV_AT_ALL
  use D_HUNT_M, only: HUNT          ! ** DEBUG
  implicit NONE
!---------------------------------------------------------------------------
!
Integer(i4), PARAMETER :: ngt = (Ng+1) * N2lvl

Type(fwd_mdl_info) :: FMI
Type(fwd_mdl_config) :: FMC
Type(temporary_fwd_mdl_info) :: T_FMI

Integer(i4) :: i, j, k, kk, kz, ht_i, mnz, no_tan_hts, ch, Spectag, &
               m, prev_npf, ier, mmaf, si, ptg_i, &
               frq_i, io, klo, jj, l, n, brkpt, no_ele, mid, ilo, ihi, &
               k_info_count, gl_count, ld

Integer(i4) :: ch1, ch2, no_pfa_ch, pfa_ch(2)

Type(path_index)  :: ndx_path(Nptg,mnm)
Type(path_vector) :: z_path(Nptg,mnm),t_path(Nptg,mnm),h_path(Nptg,mnm),  &
                     dhdz_path(Nptg,mnm), spsfunc_path(Nsps,Nptg,mnm),    &
                     n_path(Nptg,mnm),phi_path(Nptg,mnm)

Type(path_derivative) :: dh_dt_path(Nptg,mnm)

Real(r8) :: thbs(10),elev_offset
Real(r8) :: t_script(N2lvl),ref_corr(N2lvl,Nptg),tau(N2lvl), &
            tan_dh_dt(Nlvl,mnm,mxco)

Real(r8) :: dx_dt(Nptg,mxco), d2x_dxdt(Nptg,mxco)

Real(r8) :: h_glgrid(ngt,mnm), t_glgrid(ngt,mnm), z_glgrid(ngt/2)
Real(r8) :: dh_dt_glgrid(ngt,mnm,mxco), dhdz_glgrid(ngt,mnp)

Real(r8) :: ptg_angles(Nptg,mnm), center_angle
Real(r8) :: tan_hts(Nptg,mnm), tan_temp(Nptg,mnm)


! Real(r4) :: K_TEMP(Nch,Nptg,mxco,mnp)
! Real(r4) :: K_ATMOS(Nch,Nptg,mxco,mnp,Nsps)
! Real(r4) :: K_SPECT_DW(Nch,Nptg,mxco,mnp,Nsps),  &
!             K_SPECT_DN(Nch,Nptg,mxco,mnp,Nsps),  &
!             K_SPECT_DNU(Nch,Nptg,mxco,mnp,Nsps)

! ** DEBUG, memory limitations force us to have up to 2 channels
!           only (Replacing Nch by: 2)

Real(r4) :: K_TEMP(02,Nptg,mxco,mnp)
Real(r4) :: K_ATMOS(02,Nptg,mxco,mnp,Nsps)
Real(r4) :: K_SPECT_DW(02,Nptg,mxco,mnp,Nsps),  &
            K_SPECT_DN(02,Nptg,mxco,mnp,Nsps),  &
            K_SPECT_DNU(02,Nptg,mxco,mnp,Nsps)

real(r8) :: I_STAR_ALL(Nch,Nptg)

real(r4) :: K_STAR_ALL(02,20,mxco,mnp,Nptg)      ! 02 should be: Nch
Type(k_matrix_info) :: k_star_info(20)

Type(path_derivative) :: k_temp_frq, k_atmos_frq(Nsps), &
                         k_spect_dw_frq(Nsps), k_spect_dn_frq(Nsps), &
                         k_spect_dnu_frq(Nsps)
!
Type(path_beta), DIMENSION(:,:), POINTER :: beta_path

Real(r8) :: Radiances(Nptg,Nch)
Real(r8) :: e_rad, Zeta, Frq, h_tan, Rad, geoc_lat, r
!
Character (LEN=01) :: CA
Character (LEN=08) :: Name
Character (LEN=16) :: Vname
Character (LEN=80) :: Line
Character (LEN=40) :: Ax, Dtm1, Dtm2

Real(r8), DIMENSION(:), ALLOCATABLE :: RadV, F_grid

!  ----------------------

  Line(1:) = ' '
! Line = '/home/zvi/seez'      ! HOME PC, JPL PC
  Line = '/user5/zvi/seez'     ! MLSGATE, SUN
  FMC%Z = Line
!
! Load all the needed L2 data:
!
  Dtm1(1:)=' '
  Dtm2(1:)=' '
  Call Z_DATETIME(Dtm1)

  Call L2_LOAD(FMC, FMI, T_FMI, Ier)
  if(ier /= 0) goto 99

  ch1 = FMC%Channels_range(1)
  ch2 = FMC%Channels_range(2)
  no_pfa_ch = min(2,ch2-ch1+1)
  do i = 1, no_pfa_ch
    pfa_ch(i) = ch1 + i - 1
  end do

  elev_offset = 0.0                         ! Zero elev_offset in any case

  Call Z_DATETIME(Dtm1)
!
! Load the "Frequency gridding by pointing" file ("Bill's" file..)
!
  Call ptg_frq_load(FMC, FMI, Ier)
  if(ier /= 0) goto 99
!
! Convert GeoDetic Latitude to GeoCentric Latitude, and convert both to
! Radians (instead of Degrees). Also compute the effective earth radius.
!
  mmaf = 3                     ! Do only this mmaf (middle phi)
  phi_tan = FMC%phi_tan_mmaf(mmaf)
  Call geoc_geod_conv(T_FMI%beta_inc,phi_tan,geoc_lat,E_rad)
!
! Compute the hydrostatic_model on the GL-Grid for all mmaf(s):
!
  thbs(1:) = 0.0
  si = FMI%Surface_index
  thbs(1:si-1) = FMI%Tan_hts_below_surface(1:si-1)
  Call hydrostatic_model(si,FMC%N_lvls,T_FMI%no_t,FMC%no_mmaf,FMC%t_indx, &
       FMC%no_tan_hts,geoc_lat,T_FMI%Href,T_FMI%Zref,FMI%z_grid,thbs, &
       T_FMI%t_zeta_basis, T_FMI%t_coeff, z_glgrid, h_glgrid, t_glgrid, &
       dhdz_glgrid,dh_dt_glgrid,FMI%tan_press,tan_hts,tan_temp,tan_dh_dt, &
       gl_count, Ier)
  IF(ier /= 0) goto 99
!
  jj = -1
  Zeta = -1.666667
  no_tan_hts = FMC%no_tan_hts
  Call Hunt(Zeta,FMI%tan_press,no_tan_hts,jj,i)
  IF(ABS(Zeta-FMI%tan_press(i)) < ABS(Zeta-FMI%tan_press(jj))) jj = i
!
! Compute all path entities for all mmafs and tanget pointings
!
  Call comp_path_entities(FMC%n_lvls,T_FMI%no_t,gl_count,ndx_path, &
       z_glgrid,t_glgrid,h_glgrid,dhdz_glgrid,dh_dt_glgrid,        &
       T_FMI%atmospheric,T_FMI%f_zeta_basis,T_FMI%mr_f,            &
       T_FMI%no_coeffs_f,tan_hts,no_tan_hts,FMI%n_sps,             &
       T_FMI%no_phi_f,T_FMI%f_phi_basis,z_path,h_path,t_path,      &
       phi_path,n_path,dhdz_path,dh_dt_path,T_FMI%no_phi_t,        &
       T_FMI%t_phi_basis,spsfunc_path,T_FMI%is_f_log,FMC%no_mmaf,  &
       FMC%phi_tan_mmaf,Ier)
  IF(ier /= 0) goto 99
!
! **********************  MAIN Mmaf Loop *******************

! DO l = 1, FMC%no_mmaf
  DO l = mmaf, mmaf                 ! ** DEBUG, only one mmaf
!
    phi_tan = FMC%phi_tan_mmaf(l)
!
    T_FMI%t_phi_basis(1:T_FMI%no_phi_t) = &
                    T_FMI%T_PHI_BASIS_COPY(1:T_FMI%no_phi_t) + phi_tan

    DO j = 1, FMI%n_sps
      k = T_FMI%no_phi_f(j)
      T_FMI%f_phi_basis(1:k,j) = T_FMI%F_PHI_BASIS_COPY(1:k,j) + phi_tan
    end do

    k = FMI%mfi + 2
    do j = 1, FMI%no_spectro
      FMI%spectroscopic(j)%PHI_BASIS(1:k) = &
     &                T_FMI%S_PHI_BASIS_COPY(1:k,j) + phi_tan
    end do
!
! Compute the ptg_angles (chi) for Antenna convolution, also the derivatives
! of chi w.r.t to T and other parameters
!
    Call get_chi_angles(ndx_path(1:,l),n_path(1:,l),FMI%tan_press,         &
   &     tan_hts(1:,l),tan_temp(1:,l),phi_tan,RoC,T_FMI%h_obs,elev_offset, &
   &     tan_dh_dt(1:,l,1:),no_tan_hts,T_FMI%no_t,T_FMI%t_zeta_basis,si,   &
   &     center_angle,ptg_angles(1:,l),dx_dt,d2x_dxdt,ier)
    IF(ier /= 0) goto 99
!
! Compute the refraction correction scaling matrix for this mmaf:
!
    Call refraction_correction(no_tan_hts, tan_hts(1:,l), h_path(1:,l), &
   &                n_path(1:,l), ndx_path(1:,l), E_rad, ref_corr)
!
    prev_npf = -1
    Radiances(1:Nptg,1:Nch) = 0.0
!
! **********************  MAIN Pointing Loop *******************
!
    DO ptg_i = 1, no_tan_hts-1
!
      k = ptg_i
      h_tan = tan_hts(k,l)
      kk = FMI%no_ptg_frq(k)
!
      if(kk /= prev_npf) then
!
        prev_npf = kk
        DEALLOCATE(k_temp_frq%values,STAT=i)
!
        DEALLOCATE(RadV,F_grid,STAT=i)
        ALLOCATE(RadV(kk),F_grid(kk),STAT=ier)
        IF(ier /= 0) then
          Print *,'** ALLOCATE Error: RadV or F_grid arrays, STAT =',ier
          goto 99
        endif
!
        do j = 1, FMI%n_sps
          DEALLOCATE(k_atmos_frq(j)%values,STAT=i)
          DEALLOCATE(k_spect_dw_frq(j)%values,STAT=i)
          DEALLOCATE(k_spect_dn_frq(j)%values,STAT=i)
          DEALLOCATE(k_spect_dnu_frq(j)%values,STAT=i)
        end do
!
        ALLOCATE(k_temp_frq%values(kk,T_FMI%no_t,T_FMI%no_phi_t),STAT=ier)
        IF(ier /= 0) then
          Print *,'** ALLOCATE Error: k_temp_frq array, STAT =',ier
          goto 99
        endif
!
        do j = 1, FMI%n_sps
          m = max(1,T_FMI%no_phi_f(j))
          i = max(1,T_FMI%no_coeffs_f(j))
          ALLOCATE(k_atmos_frq(j)%values(kk,i,m),STAT=ier)
          IF(ier /= 0) then
            Print *,'** ALLOCATE Error: k_atmos_frq, STAT =',ier
            goto 99
          endif
        end do
!
        do m = 1, FMI%n_sps
          j = FMI%spect_atmos(m)
          if(j < 1) CYCLE
          if(.not. FMI%spectroscopic(j)%DER_CALC(FMI%band)) CYCLE
          Vname(1:) = ' '
          Spectag = FMI%spectroscopic(j)%Spectag
          DO
            if(FMI%spectroscopic(j)%Spectag /= Spectag) EXIT
            n = FMI%spectroscopic(j)%no_phi_values
            i = FMI%spectroscopic(j)%no_zeta_values
            CA = FMI%spectroscopic(j)%type
            select case ( CA )
              case ( 'W' )
                Vname = 'k_spect_dw_frq'
                ALLOCATE(k_spect_dw_frq(m)%values(kk,i,n),STAT=ier)
              case ( 'N' )
                Vname = 'k_spect_dn_frq'
                ALLOCATE(k_spect_dn_frq(m)%values(kk,i,n),STAT=ier)
              case ( 'V' )
                Vname = 'k_spect_dnu_frq'
                ALLOCATE(k_spect_dnu_frq(m)%values(kk,i,n),STAT=ier)
              case default
                Ier = -99
                Print *,'** Unknown Spectroscopic element !'
            end select
            IF(ier /= 0) then
              Print *,'** ALLOCATE Error: ',Vname,', STAT =',ier
              goto 99
            ENDIF
            j = j + 1
            if(j > 3 * FMI%n_sps) EXIT
          END DO
        end do

      endif            ! On DEALLOCATE/ALLOCATE cycle
!
! Compute the beta's along the path, for this tanget hight and this mmaf:
!
      no_ele = ndx_path(ptg_i,l)%total_number_of_elements
      Call get_beta_path(ptg_i,FMI%pfa_spectrum,no_ele,FMI%no_ptg_frq, &
     &     FMI%ptg_frq_grid,z_path(ptg_i,l),t_path(ptg_i,l),beta_path,ier)
      IF(ier /= 0) goto 99
!
      k_temp_frq%values = 0.0
      do j = 1, FMI%n_sps
        k_atmos_frq(j)%values = 0.0
        k_spect_dw_frq(j)%values = 0.0
        k_spect_dn_frq(j)%values = 0.0
        k_spect_dnu_frq(j)%values = 0.0
      end do
!
      RadV(1:kk) = 0.0
      F_grid(1:kk) = FMI%ptg_frq_grid(k)%values(1:kk)
!
      do frq_i = 1, kk
!
        Frq = F_grid(frq_i)
!
        Call Rad_Tran(Frq, FMC%N_lvls, h_tan, FMI%n_sps, ndx_path(k,l),  &
       &    z_path(k,l), h_path(k,l), t_path(k,l), phi_path(k,l),&
       &    dHdz_path(k,l), T_FMI%earth_ref, beta_path(1:,frq_i),      &
       &    spsfunc_path(1:,k,l), ref_corr(1:,k), T_FMI%s_temp, brkpt, &
       &    no_ele, mid, ilo, ihi, t_script, tau, Rad, Ier)
        IF(ier /= 0) goto 99
!
        RadV(frq_i) = Rad
!
! Now, Compute the radiances derivatives:
!
        CALL Rad_Tran_WD(frq_i,FMI%band,Frq,FMC%N_lvls,FMI%n_sps, &
       &     FMC%temp_der,FMC%atmos_der,FMC%spect_der,            &
       &     z_path(k,l),h_path(k,l),t_path(k,l),phi_path(k,l),   &
       &     dHdz_path(k,l),T_FMI%atmospheric,beta_path(1:,frq_i),&
       &     spsfunc_path(1:,k,l),T_FMI%t_zeta_basis,  &
       &     T_FMI%f_zeta_basis,T_FMI%no_coeffs_f,   &
       &     T_FMI%mr_f,T_FMI%no_t,ref_corr(1:,k),T_FMI%no_phi_f,       &
       &     T_FMI%f_phi_basis,T_FMI%no_phi_t,T_FMI%t_phi_basis,  &
       &     dh_dt_path(k,l),FMI%spect_atmos,         &
       &     FMI%spectroscopic,k_temp_frq,k_atmos_frq,k_spect_dw_frq,   &
       &     k_spect_dn_frq,k_spect_dnu_frq,T_FMI%is_f_log,brkpt,       &
       &     no_ele,mid,ilo,ihi,t_script,tau,ier)
        IF(ier /= 0) goto 99
!
      end do

! Frequency Average the radiances with the appropriate filter shapes
!
      do i = 1, no_pfa_ch
        ch = pfa_ch(i)
        if(FMC%do_frqavg) then
          Call Freq_Avg(F_grid,FMI%F_grid_filter(1:,i),  &
         &     FMI%Filter_func(1:,i),RadV,kk,FMI%no_filt_pts, &
         &     Radiances(ptg_i,ch))
        else
          Radiances(ptg_i,ch) = RadV(1)
        endif
      end do
!
      if(FMC%temp_der) then
!
! Frequency Average the temperature derivatives with the appropriate
! filter shapes
!
        RadV(1:kk) = 0.0
        do i = 1, no_pfa_ch
!         ch = pfa_ch(i)
          ch = i               ! ** DEBUG, memory limitations on MLSGATE
          do j = 1, T_FMI%no_phi_t
            do k = 1, T_FMI%no_t
              if(FMC%do_frqavg) then
                RadV(1:kk) = k_temp_frq%values(1:kk,k,j)
                Call Freq_Avg(F_grid,FMI%F_grid_filter(1:,i), &
               &              FMI%Filter_func(1:,i),          &
               &              RadV,kk,FMI%no_filt_pts,r)
              else
                r = k_temp_frq%values(1,k,j)
              endif
              k_temp(ch,ptg_i,k,j) = r
            end do
          end do
        end do
!
      endif

      if(FMC%atmos_der) then
!
! Frequency Average the atmospheric derivatives with the appropriate
! filter shapes
!
        do i = 1, no_pfa_ch
!         ch = pfa_ch(i)
          ch = i                 ! ** DEBUG, memory limitations on MLSGATE
          do j = 1, FMI%n_sps
            if(T_FMI%atmospheric(j)%der_calc(FMI%band)) THEN
              RadV(1:kk) = 0.0
              do k = 1, T_FMI%no_phi_f(j)
                do n = 1, T_FMI%no_coeffs_f(j)
                  if(FMC%do_frqavg) then
                    RadV(1:kk) = k_atmos_frq(j)%values(1:kk,n,k)
                    Call Freq_Avg(F_grid,FMI%F_grid_filter(1:,i), &
                   &              FMI%Filter_func(1:,i),          &
                   &              RadV,kk,FMI%no_filt_pts,r)
                  else
                    r = k_atmos_frq(j)%values(1,n,k)
                  endif
                  k_atmos(ch,ptg_i,n,k,j) = r
                end do
              end do
            endif
          end do
        end do
!
      endif

      if(FMC%spect_der) then
!
! Frequency Average the spectroscopic derivatives with the appropriate
! filter shapes
!
        do i = 1, no_pfa_ch
!         ch = pfa_ch(i)
          ch = i                 ! ** DEBUG, memory limitations on MLSGATE
          do m = 1, FMI%n_sps
            j = FMI%spect_atmos(m)
            if(.not.  FMI%spectroscopic(j)%DER_CALC(FMI%band)) CYCLE
            Spectag = FMI%spectroscopic(j)%Spectag
            DO
              if(FMI%spectroscopic(j)%Spectag /= Spectag) EXIT
              RadV(1:kk) = 0.0
              CA = FMI%spectroscopic(j)%type
              do k = 1, FMI%spectroscopic(j)%no_phi_values
                do n = 1, FMI%spectroscopic(j)%no_zeta_values
                  select case ( CA )
                    case ( 'W' )
                      RadV(1:kk) = k_spect_dw_frq(m)%values(1:kk,n,k)
                    case ( 'N' )
                      RadV(1:kk) = k_spect_dn_frq(m)%values(1:kk,n,k)
                    case ( 'V' )
                      RadV(1:kk) = k_spect_dnu_frq(m)%values(1:kk,n,k)
                  end select
                  if(FMC%do_frqavg) then
                      Call Freq_Avg(F_grid,FMI%F_grid_filter(1:,i), &
                   &              FMI%Filter_func(1:,i),&
                   &              RadV,kk,FMI%no_filt_pts,r)
                  else
                    r = RadV(1)
                  endif
                  select case ( CA )
                    case ( 'W' )
                      k_spect_dw(ch,ptg_i,n,k,j) = r
                    case ( 'N' )
                      k_spect_dn(ch,ptg_i,n,k,j) = r
                    case ( 'V' )
                      k_spect_dnu(ch,ptg_i,n,k,j) = r
                  end select
                end do
              end do
              j = j + 1
              if(j > 3 * FMI%n_sps) EXIT
            END DO
          end do
        end do
!
      endif
!
    END DO              ! Pointing Loop
!
! Complete the radiances's last location, also  complete k_temp last
! location as well as k_atmos last location and k_spect_d? last location:
!
    kk = no_tan_hts
    do i = 1, no_pfa_ch
      ch = pfa_ch(i)
      Radiances(kk,ch) = Radiances(kk-1,ch)
      if(FMC%temp_der) then
        k_temp(i,kk,1:T_FMI%no_t,1:T_FMI%no_phi_t) = &
     &              k_temp(i,kk-1,1:T_FMI%no_t,1:T_FMI%no_phi_t)
      endif
      if(FMC%atmos_der) then
        do m = 1, FMI%n_sps
          if(T_FMI%atmospheric(m)%der_calc(FMI%band)) then
            k = T_FMI%no_phi_f(m)
            n = T_FMI%no_coeffs_f(m)
            k_atmos(i,kk,1:n,1:k,m)=k_atmos(i,kk-1,1:n,1:k,m)
          endif
        end do
      endif
      if(FMC%spect_der) then
        do m = 1, FMI%n_sps
          j = FMI%spect_atmos(m)
          if(.not.  FMI%spectroscopic(j)%DER_CALC(FMI%band)) CYCLE
          Spectag =  FMI%spectroscopic(j)%Spectag
          DO
            if(FMI%spectroscopic(j)%Spectag /= Spectag) EXIT
            k = FMI%spectroscopic(j)%no_phi_values
            n = FMI%spectroscopic(j)%no_zeta_values
            k_spect_dw(i,kk,1:n,1:k,j)=k_spect_dw(i,kk-1,1:n,1:k,j)
            k_spect_dn(i,kk,1:n,1:k,j)=k_spect_dn(i,kk-1,1:n,1:k,j)
            k_spect_dnu(i,kk,1:n,1:k,j)=k_spect_dnu(i,kk-1,1:n,1:k,j)
            j = j + 1
            if(j > 3 * FMI%n_sps) EXIT
          END DO
        end do
      endif
    end do
!
!  Here comes the Convolution code
!
    DO i = 1, no_pfa_ch
!
      ch = pfa_ch(i)
!
      if(FMC%do_conv) then
!
        Call convolve_all(T_FMI%ptg_press,T_FMI%atmospheric,FMI%n_sps,   &
       &     FMC%temp_der,FMC%atmos_der,FMC%spect_der,                   &
       &     FMI%tan_press,ptg_angles(1:,l),tan_temp(1:,l), &
       &     dx_dt, d2x_dxdt,FMI%band,center_angle,FMI%fft_pts,          &
       &     Radiances(1:,ch),k_temp(i,1:,1:,1:),k_atmos(i,1:,1:,1:,1:), &
       &     k_spect_dw(i,1:,1:,1:,1:),k_spect_dn(i,1:,1:,1:,1:),    &
       &     k_spect_dnu(i,1:,1:,1:,1:),FMI%spect_atmos,no_tan_hts,  &
       &     k_info_count,i_star_all(i,1:),k_star_all(i,1:,1:,1:,1:), &
       &     k_star_info,T_FMI%no_t,T_FMI%no_phi_t,T_FMI%no_phi_f,   &
       &     FMI%spectroscopic,T_FMI%t_zeta_basis,FMI%Xlamda,FMI%Aaap,&
       &     FMI%D1Aaap,FMI%D2Aaap,FMI%Ias,ier)
        IF(ier /= 0) goto 99
!
      else
!
        Call no_conv_at_all(T_FMI%ptg_press,FMI%n_sps,FMI%tan_press, &
       &     FMI%band,FMC%temp_der,FMC%atmos_der,FMC%spect_der,      &
       &     Radiances(1:,ch),k_temp(i,1:,1:,1:),                    &
       &     k_atmos(i,1:,1:,1:,1:),k_spect_dw(i,1:,1:,1:,1:),       &
       &     k_spect_dn(i,1:,1:,1:,1:),k_spect_dnu(i,1:,1:,1:,1:),   &
       &     FMI%spect_atmos, no_tan_hts,k_info_count,               &
       &     i_star_all(i,1:), k_star_all(i,1:,1:,1:,1:),            &
       &     k_star_info,T_FMI%no_t,T_FMI%no_phi_t,                  &
       &     T_FMI%no_phi_f,T_FMI%t_zeta_basis,T_FMI%atmospheric,    &
       &     FMI%spectroscopic)
!
      endif
!
    END DO

  END DO                ! Mmaf Loop
!
  if(FMC%temp_der) DEALLOCATE(k_temp_frq%values,STAT=i)
  do j = 1, FMI%n_sps
    if(FMC%atmos_der) DEALLOCATE(k_atmos_frq(j)%values,STAT=i)
    if(FMC%spect_der) then
      DEALLOCATE(k_spect_dw_frq(j)%values,STAT=i)
      DEALLOCATE(k_spect_dn_frq(j)%values,STAT=i)
      DEALLOCATE(k_spect_dnu_frq(j)%values,STAT=i)
    endif
  end do
!
! *** DEBUG Print
!
    if(FMC%do_conv) then
      Print *,'Convolution: ON'
    else
      Print *,'Convolution: OFF'
    endif
!
    if(FMC%Zfrq > 0.0) then
      Frq = FMC%Zfrq
      write(*,901) Frq
901   format(' Frequency Averaging: OFF',/,  &
        &    ' (All computations done at Frq =',f12.4,')')
    else
      Print *,'Frequency Averaging: ON'
    endif
    Print *
!
    klo = -1
    tau(1:Nptg) = 0.0
    kk = T_FMI%ptg_press%no_lin_values
    tau(1:kk) = dble(T_FMI%ptg_press%lin_val(1:kk))
    Call Hunt(Zeta,tau,kk,klo,j)
    IF(ABS(Zeta-tau(j)) < ABS(Zeta-tau(klo))) klo=j
!
    do i = 1, no_pfa_ch
      ch = pfa_ch(i)
      write(*,903) ch,char(92),kk
      write(*,905) (i_star_all(i,k),k=1,kk)
    end do
903 format('ch',i2.2,'_avg_conv_pfa_rad',a1,i2.2)
905 format(4(2x,1pg15.8))
!
    if(.not. ANY((/FMC%temp_der,FMC%atmos_der,FMC%spect_der/))) goto 99
!
    m = -1
    ch = 1
    tau(1:) = 0.0
    do i = 1, k_info_count
      Print *
      Name(1:) = ' '
      Name = k_star_info(i)%name
      if(Name == 'PTAN') CYCLE
      kz = k_star_info(i)%first_dim_index
      mnz = k_star_info(i)%no_zeta_basis
      ht_i = k_star_info(i)%no_phi_basis
      l = LEN_TRIM(Name)
      if(Name(l-1:l) == '_W' .or.  &
     &   Name(l-1:l) == '_N' .or.  &
     &   Name(l-1:l) == '_V' ) then
        Print *,Name
        r = SUM(k_star_all(ch,kz,1:mnz,1:ht_i,klo))
        Print *,'  Sum over all zeta & phi coeff:',sngl(r)
      else
        if(Name == 'TEMP') then
          write(6,913) 'dI_dT',char(92),ht_i
        else
          write(6,913) 'dI_d'//Name(1:l),char(92),ht_i
        endif
        tau(1:) = 0.0
        tau(1:mnz) = k_star_info(i)%zeta_basis(1:mnz)
        Call Hunt(Zeta,tau,mnz,m,j)
        IF(ABS(Zeta-tau(j)) < ABS(Zeta-tau(m))) m=j
        Print *,(k_star_all(ch,kz,m,kk,klo),kk=1,ht_i)
      endif
    end do
913 format(a,a1,i2.2)
!
 99  if(io /= 0) then
       Call ErrMsg(Line,io)
       Stop
     endif

     Call Z_DATETIME(Dtm2)
     Print *
     Print *,'** Actual computations started at: ',Dtm1
     Print *,'**            Program finished at: ',Dtm2

     Ax(1:) = ' '
     Read(Dtm1(14:21),'(i2,1x,i2,1x,i2)') i,j,k       ! hh:mm:ss
     Read(Dtm2(14:21),'(i2,1x,i2,1x,i2)') kk,ch,ld    ! hh:mm:ss
     r = Real(ld-k)+60.0*Real(ch-j)+3600.0*Real(kk-i)
     if(r < 0.0) r = r + 86400.00
     i = Int(r/3600.0)
     r = r - 3600.0*Real(i)
     j = Int(r/60.0)
     r = r - 60.0*Real(j)
     k = Int(r)
     Write(Ax(14:21),'(i2.2,'':'',i2.2,'':'',i2.2)') i,j,k
     Print *,'**         Wall-Clock elapse time: ',Ax

     Stop

!---------------------------------------------------------------------------
contains
!---------------------------------------------------------------------

SUBROUTINE Z_DATETIME(dtm)

! Output: Date & Time array in the format:

!    dd-mm-ccyy  hh:mm:ss


CHARACTER (LEN=*), INTENT(OUT) :: dtm

CHARACTER (LEN=10) :: tm
CHARACTER (LEN=8) :: dt

INTEGER :: io,iy,jm,id,ih,im,is

CHARACTER (LEN=3) :: months(12) = (/             &
         &  'JAN','FEB','MAR','APR','MAY','JUN', &
         &  'JUL','AUG','SEP','OCT','NOV','DEC'/)

! Begin code:

  dtm(1:) = ' '
  CALL date_and_time(dt,tm)

!  Dt = ccyymmdd

  READ(dt,'(i4,i2,i2)',IOSTAT=io) iy,jm,id
  IF(io /= 0) RETURN

!  Tm = hhmmss.sss

  READ(tm,'(i2,i2,i2)',IOSTAT=io) ih,im,is

  dtm(1:3) = months(jm)
  dtm(4:4) = '/'
  WRITE(dtm(5:6),'(i2.2)') id
  dtm(7:7) = '/'
  WRITE(dtm(8:11),'(i4.4)') iy

  WRITE(dtm(14:21),'(i2.2,'':'',i2.2,'':'',i2.2)') ih,im,is

  RETURN
END SUBROUTINE Z_DATETIME

end Program l2_Test
@


1.12.2.1
log
@Just for working
@
text
@d2 2
a3 2
  use SET_PRECISION_M
  USE GLNP, ONLY: NG, GX
d5 1
a5 2
  use L2PC_FILE_PARAMETERS, only: mxco => MAX_NO_ELMNTS_PER_SV_COMPONENT, &
                              &   Deg2Rad
d7 3
a9 1
  use L2PCdim, only: NSPS,Nptg,MNP=>max_no_phi,MNM=>max_no_mmaf
d12 5
a16 4
  USE COMP_SPS_PATH_M, only: COMP_SPS_PATH
  USE EVAL_SPECT_PATH_M, only: EVAL_SPECT_PATH
  USE REFRACTION_M, ONLY: REFRACTIVE_INDEX, COMP_REFCOR, PATH_DS_DH
  use PATH_ENTITIES_M, only: PATH_VECTOR
d18 4
a21 3
  USE GET_BETA_PATH_M, ONLY: GET_BETA_PATH
  USE RAD_TRAN_M, ONLY: PATH_CONTRIB, RAD_TRAN, DRAD_TRAN_DF,DRAD_TRAN_DT, &
                       &  DRAD_TRAN_DX
d25 1
a25 5
  use SLABS_SW_M, only: GET_GL_SLABS_ARRAYS
!  use D_LINTRP_M, only: LINTRP
  use D_HUNT_M, only: HUNT
  USE TWO_D_HYDROSTATIC_M
  USE METRICS_M
a26 1
!
d29 2
d35 41
a75 65
Integer(ip) :: ld, i, j, k, kk, kz, ht_i, mnz, no_tan_hts, ch, Spectag, &
               Nglp, m, ier, mmaf, ptg_i, frq_i, klo, l,  &
               brkpt, no_ele, i_stop, k_info_count,    &
               n, tot_num_frq, max_num_frq, phi_window, nl, sv_i

Integer(ip) :: ch1, ch2, no_pfa_ch, pfa_ch(25)

REAL(rp) :: elev_offset,del_temp

Real(rp) :: dx_dt(Nptg,mxco), d2x_dxdt(Nptg,mxco)

REAL(rp), ALLOCATABLE :: z_glgrid(:),p_glgrid(:),p_path(:)
REAL(rp), ALLOCATABLE :: h_glgrid(:,:), t_glgrid(:,:), dhdz_glgrid(:,:)
REAL(rp), ALLOCATABLE :: dh_dt_glgrid(:,:,:), dh_dt_path(:,:)
REAL(rp), ALLOCATABLE :: z_path(:),h_path(:),phi_path(:),t_path(:),dhdz_path(:)
REAL(rp), ALLOCATABLE :: n_path(:), ref_corr(:),del_s(:),path_dsdh(:)
REAL(rp), ALLOCATABLE :: tan_dh_dt(:,:),t_script(:),tau(:),alpha_path_c(:)
REAL(rp), ALLOCATABLE :: one_tan_temp(:),one_tan_ht(:)
REAL(rp), ALLOCATABLE :: sps_path(:,:),sps_values(:),eta_zxp(:,:)
REAL(rp), ALLOCATABLE :: eta_zxp_t(:,:)
REAL(rp), ALLOCATABLE :: z_basis(:),phi_basis(:),incoptdepth(:)
REAL(rp), ALLOCATABLE :: drad_df(:),drad_dt(:),radiances(:,:)
REAL(rp), ALLOCATABLE :: k_atmos_frq(:,:),k_temp_frq(:,:)
REAL(rp), ALLOCATABLE :: k_spect_dw_frq(:,:),k_spect_dn_frq(:,:)
REAL(rp), ALLOCATABLE :: k_spect_dv_frq(:,:)
REAL(rp), ALLOCATABLE :: beta_path_c(:,:)
REAL(rp), ALLOCATABLE :: beta_path_f(:,:)
REAL(rp), ALLOCATABLE :: dbeta_dt_path_c(:,:)
REAL(rp), ALLOCATABLE :: dbeta_dt_path_f(:,:)
LOGICAL,  ALLOCATABLE :: do_calc(:,:),lin_log(:),do_gl(:)
LOGICAL,  ALLOCATABLE :: do_calc_t(:,:),do_calc_hyd(:,:)
INTEGER(ip), ALLOCATABLE :: no_z(:), no_phi(:)
INTEGER(ip), ALLOCATABLE :: tan_inds(:),gl_indgen(:,:),gl_inds(:)
INTEGER(ip) :: no_ss,l1,l2,n_sv_phi,n_sv_zeta,n_sps,sv_len,h2o_ind
INTEGER(ip) :: no_frq_on_ptg_i,sv_t_len

INTEGER(ip) :: n_sv_phi_dw, n_sv_zeta_dw, n_sv_phi_dn, n_sv_zeta_dn, &
            &  n_sv_phi_dv, n_sv_zeta_dv, sv_dw_len, sv_dn_len, sv_dv_len

INTEGER(ip), ALLOCATABLE :: no_z_dw(:), no_phi_dw(:), no_z_dn(:), &
                         &  no_phi_dn(:), no_z_dv(:), no_phi_dv(:)

REAL(rp), ALLOCATABLE :: z_basis_dw(:), phi_basis_dw(:), drad_dw(:), &
                   &     z_basis_dn(:), phi_basis_dn(:), drad_dn(:), &
                   &     z_basis_dv(:), phi_basis_dv(:), drad_dv(:), &
                   &     eta_zxp_dw(:,:), eta_zxp_dn(:,:), eta_zxp_dv(:,:)

LOGICAL,  ALLOCATABLE :: do_calc_dw(:,:),do_calc_dn(:,:),do_calc_dv(:,:)

REAL(rp), ALLOCATABLE :: dbeta_dw_path_c(:,:)
REAL(rp), ALLOCATABLE :: dbeta_dn_path_c(:,:)
REAL(rp), ALLOCATABLE :: dbeta_dv_path_c(:,:)

REAL(rp), ALLOCATABLE :: dbeta_dw_path_f(:,:)
REAL(rp), ALLOCATABLE :: dbeta_dn_path_f(:,:)
REAL(rp), ALLOCATABLE :: dbeta_dv_path_f(:,:)

REAL(rp) :: ptg_angles(Nptg,mnm), center_angle, e_rflty
Real(rp) :: tan_temp(Nptg,mnm)

Real(r4) :: K_TEMP(25,Nptg,mxco,mnp)
Real(r4) :: K_ATMOS(25,Nptg,mxco,mnp,Nsps)
Real(r4) :: K_SPECT_DW(25,Nptg,mxco,mnp,Nsps),  &
            K_SPECT_DN(25,Nptg,mxco,mnp,Nsps),  &
            K_SPECT_DV(25,Nptg,mxco,mnp,Nsps)
d77 1
a77 1
real(rp) :: I_STAR_ALL(25,Nptg)
d79 1
a79 1
real(r4) :: K_STAR_ALL(25,20,mxco,mnp,Nptg)
d82 3
d86 1
a86 2
Type (slabs_struct), DIMENSION(:,:), POINTER :: gl_slabs, &
                                             &  gl_slabs_p, gl_slabs_m
d88 2
a89 2
REAL(rp) :: Zeta, Frq, Rad, phi_tan, tol, r, neg_tan_ht, Req
Real(rp) :: Radiometer_Frq, Band_frq
d93 2
d97 1
a97 2
Integer(ip) :: no_gl_ndx
Integer(ip), DIMENSION(:,:), ALLOCATABLE :: gl_ndx
d99 1
a99 2
Real(rp), DIMENSION(:), ALLOCATABLE :: RadV, F_grid
Real(rp), DIMENSION(:), ALLOCATABLE :: Adjusted_Filter_Grid
d101 7
a107 12
Type(path_vector) :: ptg_frq_grid(Nptg)
Real(rp), DIMENSION(:), ALLOCATABLE :: ptg_frq_zeta
Integer(ip), DIMENSION(:), ALLOCATABLE :: no_ptg_frq

REAL(rp) :: t1,t2,t3,t4,t5,t6,t7,t8,t9

Integer(ip) :: ne_path, n_lines, npc, NLm1, Ngp1
Integer(ip), DIMENSION(:), ALLOCATABLE :: ext_ind_c

REAL(rp), ALLOCATABLE :: xm(:),ym(:),zgx(:)

!  ----------------------
d111 1
a111 3
!
! Load all the needed L2 data:
!
d113 1
a113 12
  IF(ier /= 0) goto 99
!
  tol =  FMC%Tol              ! Tolerance for the Path_contrib routine

  IF(Ng > 8) tol = -3.0_rp     ! *** ZEBUG

  Nglp = (FMC%N_lvls-1) * Ng + FMC%N_lvls

  ALLOCATE(z_glgrid(Nglp),p_glgrid(Nglp),STAT=i)
  ALLOCATE(h_glgrid(Nglp,FMC%no_mmaf),t_glgrid(Nglp,FMC%no_mmaf), &
        &  dhdz_glgrid(Nglp,FMC%no_mmaf), STAT=i)
  ALLOCATE(dh_dt_glgrid(Nglp,FMC%no_mmaf,T_FMI%no_t),STAT=i)
d117 1
a117 1
  no_pfa_ch = ch2 - ch1 + 1
d122 1
a122 4
  Band_frq = 8585.8_rp              ! B2F center freq.
  Radiometer_Frq = 191900.0_rp      ! R2 center Freq.

  elev_offset = 0.0_rp                         ! Zero elev_offset in any case
d126 1
a126 4
  ALLOCATE(Adjusted_Filter_Grid(FMI%no_filt_pts),STAT=ier)
  IF(ier /= 0) goto 99
!
! Make z_glgrid
d128 2
a129 33
  NLm1 = FMC%N_Lvls - 1
  Ngp1 = Ng + 1
  ALLOCATE(xm(NLm1),ym(NLm1),zgx(Ngp1),STAT=ier)
  IF(ier /= 0) then
    Print *,'** Error making z_glgrid ..'
    Print *,'   Allocation error for vectors: xm and ym, STAT=',ier
    GOTO 99
  ENDIF
!
! From the selected integration grid pressures define the GL pressure
! grid:

  zGx(1) = -1.0_rp
  zGx(2:Ngp1) = Gx(1:Ng)
  xm(1:NLm1) = 0.5_rp * ( FMI%z_grid(2:FMC%N_Lvls) + FMI%z_grid(1:NLm1) )
  ym(1:NLm1) = 0.5_rp * ( FMI%z_grid(2:FMC%N_Lvls) - FMI%z_grid(1:NLm1) )
  z_glgrid(1:Nglp-1) = RESHAPE ((SPREAD(xm,1,Ngp1) +                 &
                        &   SPREAD(ym,1,Ngp1) * SPREAD(zGx,2,NLm1)), &
                        &  (/Nglp-1/))
  z_glgrid(Nglp) = FMI%z_grid(FMC%N_Lvls)
  p_glgrid = 10.0_rp**(-z_glgrid)
  DEALLOCATE(xm,ym,zgx)
!
! insert into bill's 2 d hydrostatic
! The phi input for this program are the orbit plane projected
! geodetic locations of the temperature phi basis--not necessarily
! the tangent phi's which may be somewhat different.
!
!  T_FMI%t_coeff(9,4) = T_FMI%t_coeff(9,4)+2.0_rp
  CALL two_d_hydrostatic(T_FMI%t_zeta_basis,T_FMI%t_geod_lat*Deg2Rad,   &
                      &  T_FMI%t_coeff,SPREAD(T_FMI%zref,1,FMC%no_mmaf),&
                      &  T_FMI%href,z_glgrid,T_FMI%beta_inc*Deg2Rad,    &
                      &  t_glgrid,h_glgrid,dhdz_glgrid,dh_dt_glgrid)
d131 2
a132 1
! Load the "Frequency gridding by pointing" file ("Bill's" file..)
d134 14
a147 11
  ALLOCATE(ptg_frq_zeta(Nptg),STAT=ier)
  IF(ier == 0) ALLOCATE(no_ptg_frq(Nptg),STAT=ier)
  IF(ier /= 0) then
    Print *,'** ALLOCATE Error: Ptg_frq_? arrays, STAT =',ier
    goto 99
  ENDIF

  no_ptg_frq(1:Nptg) = 0
  ptg_frq_zeta(1:Nptg) = 7.0_rp
  Call ptg_frq_load(FMC%B,FMC%do_frqavg,FMC%Zfrq,ptg_frq_grid, &
                    ptg_frq_zeta,no_ptg_frq,tot_num_frq,Ier)
d150 2
a151 1
  phi_window = FMI%phi_window
d153 2
a154 12
  max_num_frq = MAXVAL(no_ptg_frq)
  ALLOCATE(tan_inds(1:no_tan_hts))
  do k = 1, no_tan_hts
    Zeta = FMI%tan_press(k)
    CALL Hunt(Zeta,z_glgrid-0.0001_rp,Nglp,i,j)
    tan_inds(k) = i
    Call Hunt(Zeta,ptg_frq_zeta,tot_num_frq,i,j)
    kz = no_ptg_frq(i)
    FMI%no_ptg_frq(k) = kz
    ALLOCATE(FMI%ptg_frq_grid(k)%values(kz),STAT=j)
    FMI%ptg_frq_grid(k)%values(1:kz) = ptg_frq_grid(i)%values(1:kz)
  end do
d156 1
a156 1
! we need to set up a negative h_tan array for metrics
d158 9
a166 5
  no_ss = COUNT(tan_inds == 1) - 1
  DEALLOCATE(ptg_frq_zeta,no_ptg_frq,STAT=i)
  do i = 1, tot_num_frq
    DEALLOCATE(ptg_frq_grid(i)%values,STAT=j)
  end do
d168 1
a168 98
  ALLOCATE(one_tan_ht(1),one_tan_temp(1))
!
! Special band allocation loop goes here
  ne_path = 2*SIZE(FMI%z_grid)
  n_lines = SUM(FMI%pfa_spectrum(:)%no_lines)
!
! LOAD SPECIES DATA
!
  sv_len = SUM(T_FMI%no_coeffs_f*T_FMI%no_phi_f)
  n_sv_phi = SUM(T_FMI%no_phi_f)
  n_sv_zeta = SUM(T_FMI%no_coeffs_f)
  n_sps = FMI%n_sps
  ALLOCATE(sps_values(1:sv_len),no_z(1:n_sps),no_phi(1:n_sps), &
         & lin_log(1:n_sps), z_basis(1:n_sv_zeta),phi_basis(1:n_sv_phi), &
         & drad_df(1:sv_len))
  j = 1
  l = 1
  sv_len = 1
  h2o_ind = 0
  DO i = 1 , n_sps
    IF(T_FMI%atmospheric(i)%spectag == 18003) h2o_ind = i
    no_phi(i) = T_FMI%no_phi_f(i)
    no_z(i) = T_FMI%no_coeffs_f(i)
    k = j + no_phi(i)
    n = l + no_z(i)
    m = sv_len + no_z(i) * no_phi(i)
    z_basis(l:n-1) = T_FMI%f_zeta_basis(l:n-1,i)
    phi_basis(j:k-1) = T_FMI%f_phi_basis(j:k-1,i) * Deg2Rad
    sps_values(sv_len:m-1) = RESHAPE(T_FMI%mr_f(1:no_z(i),1:no_phi(i),i), &
                          &  (/no_z(i)*no_phi(i)/))
    IF(T_FMI%is_f_log(i)) THEN
      lin_log(i) = .true.
      sps_values(sv_len:m-1) = LOG(sps_values(sv_len:m-1))
    ELSE
      lin_log(i) = .false.
    ENDIF
    j = k
    l = n
    sv_len = m
  ENDDO
  sv_len = sv_len - 1
!
!******************* LOAD Spectral SPECIES DATA ****************
!
  IF(FMC%spect_der) then

    n_sv_phi_dw = 0
    n_sv_phi_dn = 0
    n_sv_phi_dv = 0
    n_sv_zeta_dw = 0
    n_sv_zeta_dn = 0
    n_sv_zeta_dv = 0

    no_z_dw(1:) = 0
    no_z_dn(1:) = 0
    no_z_dv(1:) = 0
    no_phi_dw(1:) = 0
    no_phi_dn(1:) = 0
    no_phi_dv(1:) = 0

    ALLOCATE(no_z_dw(1:n_sps),no_phi_dw(1:n_sps), &
          &  no_z_dn(1:n_sps),no_phi_dn(1:n_sps), &
          &  no_z_dv(1:n_sps),no_phi_dv(1:n_sps))

    DO i = 1, n_sps
      kk = FMI%spect_atmos(i)
      IF(kk < 1) CYCLE
      IF(.not. FMI%spectroscopic(kk)%DER_CALC(FMI%band)) CYCLE
      kz = FMI%spectroscopic(kk)%no_phi_values
      ht_i = FMI%spectroscopic(kk)%no_zeta_values
      Spectag = FMI%spectroscopic(kk)%Spectag
      DO
        IF(FMI%spectroscopic(kk)%Spectag /= Spectag) EXIT
        CA = FMI%spectroscopic(kk)%type
        select case ( CA )
          case ( 'W' )
            no_z_dw(i) = ht_i
            no_phi_dw(i) = kz
            n_sv_phi_dw = n_sv_phi_dw + kz
            n_sv_zeta_dw = n_sv_zeta_dw + ht_i
          case ( 'N' )
            no_z_dn(i) = ht_i
            no_phi_dn(i) = kz
            n_sv_phi_dn = n_sv_phi_dn + kz
            n_sv_zeta_dn = n_sv_zeta_dn + ht_i
          case ( 'V' )
            no_z_dv(i) = ht_i
            no_phi_dv(i) = kz
            n_sv_phi_dv = n_sv_phi_dv + kz
            n_sv_zeta_dv = n_sv_zeta_dv + ht_i
          case default
            Ier = -99
            Print *,'** Unknown Spectroscopic element !'
        end select
        kk = kk + 1
        IF(kk > 3 * n_sps) EXIT
      END DO
    END DO
d170 2
a171 116
    k = n_sv_zeta_dw * n_sv_phi_dw
    IF(k > 0) THEN
      ALLOCATE(z_basis_dw(1:n_sv_zeta_dw),  &
             & phi_basis_dw(1:n_sv_phi_dw))
      j = 1
      l = 1
      DO i = 1, n_sps
        ht_i = no_z_dw(i)
        kz = no_phi_dw(i)
        IF(kz*ht_i > 0) THEN
          m = FMI%spect_atmos(i)
          DO
            CA = FMI%spectroscopic(m)%type
            if(CA == 'W') EXIT
            m = m + 1
            IF(m > 3 * n_sps) EXIT
          END DO
          k = j + kz
          n = l + ht_i
          z_basis_dw(l:n-1)=FMI%spectroscopic(m)%zeta_basis(1:ht_i)
          phi_basis_dw(j:k-1)=FMI%spectroscopic(m)%phi_basis(1:kz)
          j = k
          l = n
        ENDIF
      END DO
      phi_basis_dw(1:) = Deg2Rad * phi_basis_dw(1:)
    ENDIF
!
    k = n_sv_zeta_dn * n_sv_phi_dn
    IF(k > 0) THEN
      ALLOCATE(z_basis_dn(1:n_sv_zeta_dn),  &
             & phi_basis_dn(1:n_sv_phi_dn))
      j = 1
      l = 1
      DO i = 1, n_sps
        ht_i = no_z_dn(i)
        kz = no_phi_dn(i)
        IF(kz*ht_i > 0) THEN
          m = FMI%spect_atmos(i)
          DO
            CA = FMI%spectroscopic(m)%type
            if(CA == 'N') EXIT
            m = m + 1
            IF(m > 3 * n_sps) EXIT
          END DO
          k = j + kz
          n = l + ht_i
          z_basis_dn(l:n-1)=FMI%spectroscopic(m)%zeta_basis(1:ht_i)
          phi_basis_dn(j:k-1)=FMI%spectroscopic(m)%phi_basis(1:kz)
          j = k
          l = n
        ENDIF
      END DO
      phi_basis_dn(1:) = Deg2Rad * phi_basis_dn(1:)
    ENDIF
!
    k = n_sv_zeta_dv * n_sv_phi_dv
    IF(k > 0) THEN
      ALLOCATE(z_basis_dv(1:n_sv_zeta_dv),  &
             & phi_basis_dv(1:n_sv_phi_dv))
      j = 1
      l = 1
      DO i = 1, n_sps
        ht_i = no_z_dv(i)
        kz = no_phi_dv(i)
        IF(kz*ht_i > 0) THEN
          m = FMI%spect_atmos(i)
          DO
            CA = FMI%spectroscopic(m)%type
            if(CA == 'V') EXIT
            m = m + 1
            IF(m > 3 * n_sps) EXIT
          END DO
          k = j + kz
          n = l + ht_i
          z_basis_dv(l:n-1)=FMI%spectroscopic(m)%zeta_basis(1:ht_i)
          phi_basis_dv(j:k-1)=FMI%spectroscopic(m)%phi_basis(1:kz)
          j = k
          l = n
        ENDIF
      END DO
      phi_basis_dv(1:) = Deg2Rad * phi_basis_dv(1:)
    ENDIF

  ENDIF
!
!******************* END LOAD Spectral SPECIES DATA ************
!
! It is true that we could allocate the gl_slabs for each path, with
! its own number of elements, but then we will have to deallocate it too,
! and end up allocating and deallocating all the time and THAT too cost
! times,,,so I think we should allocate gl_slabs only once with the
! longest path (first pointing) and deallocate it when the pointing
! loop is done ...Zvi
!
  no_ele = 2*Nglp ! maximum possible
  ALLOCATE(gl_slabs(no_ele,FMI%n_sps),STAT=ier)
  IF(ier /= 0) THEN
    Print *,'** ALLOCATE Error: gl_slabs, STAT =',ier
    goto 99
  ENDIF
!
  DO i = 1, FMI%n_sps
    nl = FMI%pfa_spectrum(i)%no_lines
    gl_slabs(1:no_ele,i)%no_lines = nl
    DO j = 1, no_ele
      ALLOCATE(gl_slabs(j,i)%v0s(nl),gl_slabs(j,i)%x1(nl), &
          &    gl_slabs(j,i)%y(nl),gl_slabs(j,i)%yi(nl),   &
          &    gl_slabs(j,i)%slabs1(nl),                   &
          &    gl_slabs(j,i)%dslabs1_dv0(nl),STAT = ier)
      IF(ier /= 0) THEN
        Print *,'** ALLOCATE Error: gl_slabs%comp(nl),STAT=',ier
        goto 99
      ENDIF
    END DO
  END DO
d173 1
a173 27
  IF(FMC%temp_der) THEN
    ALLOCATE(gl_slabs_p(no_ele,FMI%n_sps), &
          &  gl_slabs_m(no_ele,FMI%n_sps), STAT=ier)
    IF(ier /= 0) THEN
      Print *,'** ALLOCATE Error: gl_slabs_p/m, STAT =',ier
      goto 99
    ENDIF
    DO i = 1, FMI%n_sps
      nl = FMI%pfa_spectrum(i)%no_lines
      gl_slabs_m(1:no_ele,i)%no_lines = nl
      gl_slabs_p(1:no_ele,i)%no_lines = nl
      DO j = 1, no_ele
        ALLOCATE(gl_slabs_p(j,i)%v0s(nl),gl_slabs_p(j,i)%x1(nl), &
            &    gl_slabs_p(j,i)%y(nl),gl_slabs_p(j,i)%yi(nl),   &
            &    gl_slabs_p(j,i)%slabs1(nl),                     &
            &    gl_slabs_p(j,i)%dslabs1_dv0(nl),                &
            &    gl_slabs_m(j,i)%v0s(nl),gl_slabs_m(j,i)%x1(nl), &
            &    gl_slabs_m(j,i)%y(nl),gl_slabs_m(j,i)%yi(nl),   &
            &    gl_slabs_m(j,i)%slabs1(nl),                     &
            &    gl_slabs_m(j,i)%dslabs1_dv0(nl), STAT = ier)
        IF(ier /= 0) THEN
          Print *,'** ALLOCATE Error: gl_slabs_p/m%comp,STAT=',ier
          goto 99
        ENDIF
      END DO
    END DO
  ENDIF
d175 2
a176 2
! allocate main working arrays
  ALLOCATE(radiances(1:no_tan_hts,1:no_pfa_ch))
d178 4
a181 9
  t3 = 0.0_rp
  t4 = 0.0_rp
  t5 = 0.0_rp
  t6 = 0.0_rp
  t7 = 0.0_rp
  t8 = 0.0_rp
  t9 = 0.0_rp
!
! **********************  MAIN Mmaf Loop *******************
d183 5
a187 70
! mmaf = 1                          ! ** ZEBUG, do mmaf # 1 only ..
  mmaf = 3                          ! ** ZEBUG, do mmaf # 3 only ..
!  DO l = 1, FMC%no_mmaf
  DO l = mmaf, mmaf                 ! ** ZEBUG, only one mmaf

!    CALL cpu_time(t1)
!
    l1 = MAX(1,l-FMI%phi_window/2)
    l2 = MIN(l+FMI%phi_window/2,FMC%no_mmaf)
    phi_tan = FMC%phi_tan_mmaf(l) * Deg2Rad

    brkpt = Nglp   ! Longest possible path
    no_ele = 2*brkpt
    npc = 2 * (brkpt + Ng) / Ngp1
!
! This can be put outside the mmaf loop
    ALLOCATE(z_path(1:no_ele),h_path(1:no_ele),phi_path(1:no_ele),  &
          &  t_path(1:no_ele),dhdz_path(1:no_ele), del_s(1:npc),    &
          &  n_path(1:npc),ext_ind_c(1:npc),ref_corr(1:npc),        &
          &  sps_path(1:no_ele,1:n_sps),do_calc(1:no_ele,1:sv_len), &
          &  do_gl(1:npc),incoptdepth(1:npc),path_dsdh(1:no_ele),   &
          &  tau(1:npc),t_script(1:npc),alpha_path_c(1:npc),        &
          &  beta_path_c(1:npc,1:n_sps),p_path(1:no_ele),           &
          &  eta_zxp(1:no_ele,1:sv_len))
!
    IF(FMC%temp_der) THEN
!
! Allocation for metrics routine when Temp. derivative is needed:
!
      sv_t_len = SIZE(T_FMI%t_zeta_basis)*(l2-l1+1)
      ALLOCATE(dh_dt_path(1:no_ele,sv_t_len),           &
           &   tan_dh_dt(1,1:SIZE(T_FMI%t_zeta_basis)), &
           &   do_calc_t(1:no_ele,1:sv_t_len),          &
           &   do_calc_hyd(1:no_ele,1:sv_t_len),        &
           &   eta_zxp_t(1:no_ele,1:sv_t_len),          &
           &   dbeta_dt_path_c(1:npc,1:n_sps),drad_dt(1:sv_t_len))
!
    ENDIF

    IF(FMC%spect_der) THEN
!
! Allocation when spectaral derivative are needed:
!
      ALLOCATE(dbeta_dw_path_c(1:npc,1:n_sps))
      ALLOCATE(dbeta_dn_path_c(1:npc,1:n_sps))
      ALLOCATE(dbeta_dv_path_c(1:npc,1:n_sps))

      DO i = 1, n_sps
        kz = no_z_dw(i)
        if(kz > 0) then
          sv_dw_len = kz * (l2 - l1 + 1)
          ALLOCATE(do_calc_dw(1:no_ele,1:sv_dw_len), &
             &     eta_zxp_dw(1:no_ele,1:sv_dw_len), &
             &     drad_dw(1:sv_dw_len))
        endif
        kz = no_z_dn(i)
        if(kz > 0) then
          sv_dn_len = kz * (l2 - l1 + 1)
          ALLOCATE(do_calc_dn(1:no_ele,1:sv_dn_len), &
             &     eta_zxp_dn(1:no_ele,1:sv_dn_len), &
             &     drad_dn(1:sv_dn_len))
        endif
        kz = no_z_dv(i)
        if(kz > 0) then
          sv_dv_len = kz * (l2 - l1 + 1)
          ALLOCATE(do_calc_dv(1:no_ele,1:sv_dv_len), &
             &     eta_zxp_dv(1:no_ele,1:sv_dv_len), &
             &     drad_dv(1:sv_dv_len))
        endif
      END DO
d189 2
a190 1
    ENDIF
d192 5
a196 1
! **********************  MAIN Pointing Loop *******************
d198 1
a198 2
    DO ptg_i = 1, no_tan_hts
!   DO ptg_i = 24, 24
d200 2
a201 1
! allocate the path stuff
d203 2
a204 3
      brkpt = Nglp + 1 - tan_inds(ptg_i) !path tangent index
      no_ele = 2 * brkpt
      npc = 2 * (brkpt + Ng) / Ngp1
d206 1
a206 55
! This is not pretty but we need some coarse grid extraction indicies
!
      k = Ngp1
      j = (npc+1)/2
      ext_ind_c(:) = 0
      ext_ind_c(1:npc) = (/(i*k-Ng,i=1,j),((i-1)*k-Ng+1,i=j+1,npc)/)
!
! compute z_path & p_path
!
      z_path(1:no_ele) = (/(z_glgrid(i),i=Nglp,tan_inds(ptg_i),-1), &
                           (z_glgrid(i),i=tan_inds(ptg_i),Nglp)/)
      p_path(1:no_ele) = (/(p_glgrid(i),i=Nglp,tan_inds(ptg_i),-1), &
                           (p_glgrid(i),i=tan_inds(ptg_i),Nglp)/)
!
! compute the h_path,t_path,dhdz_path,phi_path,dhdt_path
!
      CALL cpu_time(t1)
!
      IF(ptg_i <= no_ss) THEN
!
        neg_tan_ht = T_FMI%t_coeff(1,l)*(FMI%tan_press(ptg_i) &
                   - z_glgrid(1)) / 14.8_rp
        e_rflty = T_FMI%earth_ref
!
        IF(FMC%temp_der) THEN
!
! set up temperature representation basis stuff
!
          CALL metrics((/phi_tan/),(/tan_inds(ptg_i)/),                    &
            &  T_FMI%t_geod_lat(l1:l2)*Deg2Rad,z_glgrid,h_glgrid(:,l1:l2), &
            &  t_glgrid(:,l1:l2),dhdz_glgrid(:,l1:l2),                     &
            &  T_FMI%beta_inc*Deg2Rad,h_path(1:no_ele),phi_path(1:no_ele), &
            &  t_path(1:no_ele),dhdz_path(1:no_ele),                       &
            &  Req,TAN_PHI_T_GRID=one_tan_temp,                            &
            &  NEG_H_TAN = (/neg_tan_ht/),DHTDTL0=tan_dh_dt,               &
            &  DHIDTLM=dh_dt_glgrid, DHITDTLM=dh_dt_path(1:no_ele,:),      &
            &  Z_BASIS = T_FMI%t_zeta_basis,ETA_ZXP=eta_zxp_t(1:no_ele,:), &
            &  DO_CALC_T = do_calc_t(1:no_ele,:),                          &
            &  DO_CALC_HYD = do_calc_hyd(1:no_ele,:))
!
        ELSE
!
          CALL metrics((/phi_tan/),(/tan_inds(ptg_i)/),                    &
            &  T_FMI%t_geod_lat(l1:l2)*Deg2Rad,z_glgrid,h_glgrid(:,l1:l2), &
            &  t_glgrid(:,l1:l2),dhdz_glgrid(:,l1:l2),                     &
            &  T_FMI%beta_inc*Deg2Rad, h_path(1:no_ele),phi_path(1:no_ele),&
            &  t_path(1:no_ele),dhdz_path(1:no_ele),                       &
            &  Req,TAN_PHI_H_GRID=one_tan_ht,TAN_PHI_T_GRID=one_tan_temp,  &
            &  NEG_H_TAN = (/neg_tan_ht/))
!
        ENDIF
!
! tan heights for a negative tan height from metrics is not correctly working.
!
      ELSE
d208 1
a208 1
        e_rflty = 1.0_rp
a209 87
        IF(FMC%temp_der) THEN
!
! set up temperature representation basis stuff
!
          CALL metrics((/phi_tan/),(/tan_inds(ptg_i)/),                    &
            &  T_FMI%t_geod_lat(l1:l2)*Deg2Rad,z_glgrid,h_glgrid(:,l1:l2), &
            &  t_glgrid(:,l1:l2),dhdz_glgrid(:,l1:l2),                     &
            &  T_FMI%beta_inc*Deg2Rad,h_path(1:no_ele),phi_path(1:no_ele), &
            &  t_path(1:no_ele),dhdz_path(1:no_ele),                       &
            &  Req,TAN_PHI_H_GRID=one_tan_ht,TAN_PHI_T_GRID=one_tan_temp,  &
            &  DHTDTL0=tan_dh_dt,DHIDTLM=dh_dt_glgrid,                     &
            &  DHITDTLM=dh_dt_path(1:no_ele,:),                            &
            &  Z_BASIS = T_FMI%t_zeta_basis,ETA_ZXP=eta_zxp_t(1:no_ele,:), &
            &  DO_CALC_T = do_calc_t(1:no_ele,:),                          &
            &  DO_CALC_HYD = do_calc_hyd(1:no_ele,:))
!
        ELSE
!
          CALL metrics((/phi_tan/),(/tan_inds(ptg_i)/),                    &
            &  T_FMI%t_geod_lat(l1:l2)*Deg2Rad,z_glgrid,h_glgrid(:,l1:l2), &
            &  t_glgrid(:,l1:l2),dhdz_glgrid(:,l1:l2),                     &
            &  T_FMI%beta_inc*Deg2Rad,h_path(1:no_ele),phi_path(1:no_ele), &
            &  t_path(1:no_ele),dhdz_path(1:no_ele),                       &
            &  Req,TAN_PHI_H_GRID=one_tan_ht,TAN_PHI_T_GRID=one_tan_temp)
!
        ENDIF
!
      ENDIF
!
!  ** Determine the eta_zxp_dw, eta_zxp_dn, eta_zxp_dv
!
      IF(FMC%spect_der) then
!
        CALL eval_spect_path(z_basis_dw,phi_basis_dw+phi_tan, &
          &  no_z_dw,no_phi_dw,z_path(1:no_ele),phi_path(1:no_ele), &
          &  do_calc_dw(1:no_ele,:),eta_zxp_dw(1:no_ele,:))
!
        CALL eval_spect_path(z_basis_dn,phi_basis_dn+phi_tan, &
          &  no_z_dn,no_phi_dn,z_path(1:no_ele),phi_path(1:no_ele), &
          &  do_calc_dn(1:no_ele,:),eta_zxp_dn(1:no_ele,:))
!
        CALL eval_spect_path(z_basis_dv,phi_basis_dv+phi_tan, &
          &  no_z_dv,no_phi_dv,z_path(1:no_ele),phi_path(1:no_ele), &
          &  do_calc_dv(1:no_ele,:),eta_zxp_dv(1:no_ele,:))
!
      ENDIF
!
      tan_temp(ptg_i,l) = one_tan_temp(1)
!
      CALL cpu_time(t2)
      t4 = t4 + t2 - t1
!
! Now compute the sps_path
!
      CALL cpu_time(t1)
!
      CALL comp_sps_path(z_basis,phi_basis,sps_values,no_z,no_phi, &
                &   lin_log,z_path(1:no_ele),phi_path(1:no_ele),   &
                &   sps_path(1:no_ele,:),do_calc(1:no_ele,:),      &
                &   eta_zxp(1:no_ele,:))
!
      CALL cpu_time(t2)
      t3 = t3 + t2 - t1
!
      IF(h2o_ind > 0) THEN
        CALL refractive_index(p_path(ext_ind_c(1:npc)), &
          &  t_path(ext_ind_c(1:npc)),n_path(1:npc),    &
          &  h2o_path=sps_path((ext_ind_c(1:npc)),h2o_ind))
      ELSE
        CALL refractive_index(p_path(ext_ind_c(1:npc)), &
                          &   t_path(ext_ind_c(1:npc)),n_path(1:npc))
      ENDIF
!
      CALL get_chi_angles(T_FMI%h_obs,n_path(npc/2),one_tan_ht(1), &
                       &  phi_tan,Req,elev_offset,ptg_angles(ptg_i,l))
!
      CALL comp_refcor(Req+h_path(ext_ind_c(1:npc)), &
            &   1.0_rp+n_path(1:npc),Req+one_tan_ht(1), &
            &   del_s(1:npc),ref_corr(1:npc))
!
! this only needs to be computed on the gl (not coarse) grid thus there is
! some duplication here.
!
      path_dsdh(2:brkpt-1) = path_ds_dh(Req+h_path(2:brkpt-1), &
                                     &  Req+one_tan_ht(1))
      path_dsdh(brkpt+2:no_ele-1) = path_ds_dh(Req+h_path(brkpt+2:no_ele-1), &
                                     &         Req+one_tan_ht(1))
d211 2
d214 1
a214 1
      CALL cpu_time(t1)
d216 2
a217 2
! Compute ALL the slabs_prep entities over the path's GL grid for this
! pointing & mmaf:
d219 2
a220 31
      del_temp = 0.0_rp
      Call get_gl_slabs_arrays(FMI%pfa_spectrum,p_path(1:no_ele), &
       &   t_path(1:no_ele),FMC%vel_z_mmaf(l),gl_slabs,no_ele,del_temp)

      IF(FMC%temp_der) THEN
        del_temp = 10.0_rp
        Call get_gl_slabs_arrays(FMI%pfa_spectrum,p_path(1:no_ele), &
           & t_path(1:no_ele),FMC%vel_z_mmaf(l),gl_slabs_p,no_ele,del_temp)
        Call get_gl_slabs_arrays(FMI%pfa_spectrum,p_path(1:no_ele), &
           & t_path(1:no_ele),FMC%vel_z_mmaf(l),gl_slabs_m,no_ele,-del_temp)
      ENDIF

      CALL cpu_time(t2)
      t5 = t5 + t2 - t1
!
! Do a frequencies loop:
!
! allocate frequency dependent stuff here
!
      no_frq_on_ptg_i = 1
      IF(FMC%do_frqavg) no_frq_on_ptg_i = FMI%no_ptg_frq(ptg_i)

      ALLOCATE(RadV(1:no_frq_on_ptg_i),F_grid(1:no_frq_on_ptg_i),STAT=ier)
      IF(ier /= 0) then
        Print *,'** ALLOCATE Error **'
        Print *,'** RadV or F_grid arrays, STAT =',ier
        goto 99
      ENDIF

      IF(FMC%temp_der) then
        ALLOCATE(k_temp_frq(1:no_frq_on_ptg_i,1:sv_t_len),STAT=ier)
d222 1
a222 1
          Print *,'** ALLOCATE Error: k_temp_frq array, STAT =',ier
d224 8
a231 2
        ENDIF
      ENDIF
d233 1
a233 2
      IF(FMC%atmos_der) then
        ALLOCATE(k_atmos_frq(1:no_frq_on_ptg_i,1:sv_len),STAT=ier)
d235 1
a235 1
          Print *,'** ALLOCATE Error: k_atmos_frq, STAT =',ier
d237 1
a237 2
        ENDIF
      ENDIF
d239 9
a247 5
      IF(FMC%spect_der) then
        ALLOCATE(k_spect_dw_frq(1:no_frq_on_ptg_i,1:sv_dw_len))
        ALLOCATE(k_spect_dn_frq(1:no_frq_on_ptg_i,1:sv_dn_len))
        ALLOCATE(k_spect_dv_frq(1:no_frq_on_ptg_i,1:sv_dv_len))
      ENDIF
d249 33
a281 3
      F_grid(1:no_frq_on_ptg_i) = &
                        FMI%ptg_frq_grid(ptg_i)%values(1:no_frq_on_ptg_i)
      DO frq_i = 1, no_frq_on_ptg_i
d283 3
a285 1
!      do frq_i = 1, 1
d287 4
a290 2
! Compute the beta's along the path on the COARSE grid only, for this pointing
! and this mmaf:
d292 7
a298 1
        CALL cpu_time(t1)
d300 2
a301 1
        Frq = F_grid(frq_i)
d303 1
a303 1
        IF(FMC%temp_der .AND. FMC%spect_der) THEN
d305 1
a305 120
          CALL get_beta_path(Frq,p_path(1:no_ele),t_path(1:no_ele),          &
           & FMI%pfa_spectrum,gl_slabs,ext_ind_c(1:npc),beta_path_c(1:npc,:),&
           & GL_SLABS_M=gl_slabs_m, T_PATH_M=t_path(1:no_ele)-del_temp,      &
           & GL_SLABS_P=gl_slabs_p, T_PATH_P=t_path(1:no_ele)+del_temp,      &
           & DBETA_DT_PATH=dbeta_dt_path_c(1:npc,:),                         &
           & DBETA_DW_PATH=dbeta_dw_path_c(1:npc,:),                         &
           & DBETA_DN_PATH=dbeta_dn_path_c(1:npc,:),                         &
           & DBETA_DV_PATH=dbeta_dv_path_c(1:npc,:) )

        ELSE IF(FMC%temp_der) THEN
!
          CALL get_beta_path(Frq,p_path(1:no_ele),t_path(1:no_ele),          &
           & FMI%pfa_spectrum,gl_slabs,ext_ind_c(1:npc),beta_path_c(1:npc,:),&
           & GL_SLABS_M=gl_slabs_m, T_PATH_M=t_path(1:no_ele)-del_temp,      &
           & GL_SLABS_P=gl_slabs_p, T_PATH_P=t_path(1:no_ele)+del_temp,      &
           & DBETA_DT_PATH=dbeta_dt_path_c(1:npc,:))

        ELSE IF(FMC%spect_der) THEN
!
          CALL get_beta_path(Frq,p_path(1:no_ele),t_path(1:no_ele),          &
           & FMI%pfa_spectrum,gl_slabs,ext_ind_c(1:npc),beta_path_c(1:npc,:),&
           & DBETA_DW_PATH=dbeta_dw_path_c(1:npc,:),                         &
           & DBETA_DN_PATH=dbeta_dn_path_c(1:npc,:),                         &
           & DBETA_DV_PATH=dbeta_dv_path_c(1:npc,:) )
!
        ELSE
!
          CALL get_beta_path(Frq,p_path(1:no_ele),t_path(1:no_ele),       &
                         &   FMI%pfa_spectrum,gl_slabs,ext_ind_c(1:npc),  &
                         &   beta_path_c(1:npc,:))
!
        ENDIF
!
        CALL cpu_time(t2)
        t6 = t6 + t2 - t1
        CALL cpu_time(t1)
!
        alpha_path_c(1:npc) = SUM(sps_path(ext_ind_c(1:npc),:) &
                           &    * beta_path_c(1:npc,:),DIM=2)
        CALL path_contrib(alpha_path_c(1:npc),del_s(1:npc),e_rflty,tol, &
                       &  tau(1:npc),incoptdepth(1:npc),do_gl(1:npc))
!
! ALLOCATE gl grid beta
!
        no_gl_ndx = COUNT(do_gl(1:npc))
        ALLOCATE(gl_inds(1:Ng*no_gl_ndx),beta_path_f(1:Ng*no_gl_ndx,1:n_sps), &
                 gl_indgen(1:Ng,1:no_gl_ndx),gl_ndx(1:no_gl_ndx,1:2))
        gl_ndx(:,1) = PACK((/(i,i=1,npc)/),do_gl(1:npc))
!
! Make (/(j-Ng-1,j=1,Ng)/), (/(j,j=1,Ng)/) parameter variables later on
!
        DO i = 1 , no_gl_ndx
          IF(gl_ndx(i,1) > npc/2) THEN
            gl_ndx(i,2) = 1 - Ng + Ngp1 * (gl_ndx(i,1) - 1)
            gl_indgen(:,i) = (/(j,j=1,Ng)/)
          ELSE
            gl_ndx(i,2) = 1 +      Ngp1 * (gl_ndx(i,1) - 1)
            gl_indgen(:,i) = (/(j-Ng-1,j=1,Ng)/)
          ENDIF
        ENDDO
!
! compute the gl indicies
!
        gl_inds = RESHAPE(SPREAD(gl_ndx(1:no_gl_ndx,2),1,Ng) +  &
                              &  gl_indgen,(/Ng*no_gl_ndx/))
        CALL cpu_time(t2)
        t7 = t7 + t2 - t1
        CALL cpu_time(t1)
!
        j = Ng*no_gl_ndx
        IF(FMC%temp_der .AND. FMC%spect_der) THEN
!
          ALLOCATE(dbeta_dt_path_f(1:j,1:n_sps))
          ALLOCATE(dbeta_dw_path_f(1:j,1:n_sps))
          ALLOCATE(dbeta_dn_path_f(1:j,1:n_sps))
          ALLOCATE(dbeta_dv_path_f(1:j,1:n_sps))

          CALL get_beta_path(Frq,p_path(1:no_ele),t_path(1:no_ele),      &
           & FMI%pfa_spectrum,gl_slabs,gl_inds,beta_path_f,              &
           & GL_SLABS_M=gl_slabs_m, T_PATH_M=t_path(1:no_ele)-del_temp,  &
           & GL_SLABS_P=gl_slabs_p, T_PATH_P=t_path(1:no_ele)+del_temp,  &
           & DBETA_DT_PATH=dbeta_dt_path_f,DBETA_DW_PATH=dbeta_dw_path_f,&
           & DBETA_DN_PATH=dbeta_dn_path_f,DBETA_DV_PATH=dbeta_dv_path_f)
!
        ELSE IF(FMC%temp_der) THEN
!
          ALLOCATE(dbeta_dt_path_f(1:j,1:n_sps))
          CALL get_beta_path(Frq,p_path(1:no_ele),t_path(1:no_ele),      &
           &   FMI%pfa_spectrum,gl_slabs,gl_inds,beta_path_f,            &
           &   GL_SLABS_M=gl_slabs_m,T_PATH_M=t_path(1:no_ele)-del_temp, &
           &   GL_SLABS_P=gl_slabs_p,T_PATH_P=t_path(1:no_ele)+del_temp, &
           &   DBETA_DT_PATH=dbeta_dt_path_f)

        ELSE IF(FMC%spect_der) THEN
!
          ALLOCATE(dbeta_dw_path_f(1:j,1:n_sps))
          ALLOCATE(dbeta_dn_path_f(1:j,1:n_sps))
          ALLOCATE(dbeta_dv_path_f(1:j,1:n_sps))
          CALL get_beta_path(Frq,p_path(1:no_ele),t_path(1:no_ele),    &
           & FMI%pfa_spectrum,gl_slabs,gl_inds,beta_path_f,            &
           & DBETA_DW_PATH=dbeta_dw_path_f,DBETA_DN_PATH=dbeta_dn_path_f,&
           & DBETA_DV_PATH=dbeta_dv_path_f)
!
        ELSE
!
          CALL get_beta_path(Frq,p_path(1:no_ele),t_path(1:no_ele),   &
                   &    FMI%pfa_spectrum,gl_slabs,gl_inds,beta_path_f)
!
        ENDIF
!
        CALL cpu_time(t2)
        t6 = t6 + t2 - t1
        CALL cpu_time(t1)
!
        CALL rad_tran(Frq,T_FMI%s_temp,e_rflty,z_path(ext_ind_c(1:npc)),  &
          &  t_path(ext_ind_c(1:npc)),alpha_path_c(1:npc),ref_corr(1:npc),&
          &  do_gl(1:npc),incoptdepth(1:npc),                             &
          &  SUM(sps_path(gl_inds,:)*beta_path_f,DIM=2),                  &
          &  path_dsdh(gl_inds),dhdz_path(gl_inds),t_script(1:npc),       &
          &  tau(1:npc),Rad,i_stop)
d307 6
a312 2
        CALL cpu_time(t2)
        t7 = t7 + t2 - t1
d318 13
a330 91
        IF(fmc%atmos_der) THEN
!
          CALL cpu_time(t1)
!
          CALL drad_tran_df(z_path(ext_ind_c(1:npc)),no_z,no_phi,lin_log,&
            &  sps_values,beta_path_c(1:npc,:),eta_zxp(ext_ind_c(1:npc),:),&
            &  sps_path(ext_ind_c(1:npc),:),do_calc(ext_ind_c(1:npc),:), &
            &  beta_path_f,eta_zxp(gl_inds,:),sps_path(gl_inds,:),&
            &  do_calc(gl_inds,:),do_gl(1:npc),del_s(1:npc), &
            &  ref_corr(1:npc),path_dsdh(gl_inds),dhdz_path(gl_inds), &
            &  t_script(1:npc),tau(1:npc),i_stop,drad_df,ptg_i,frq_i)
!
          CALL cpu_time(t2)
          t8 = t8 + t2 - t1
!
          k_atmos_frq(frq_i,:) = drad_df
!
        ENDIF
!
        IF(fmc%temp_der) THEN
!
          CALL cpu_time(t1)
!
!          PRINT *,'ptg_i = ',ptg_i,' frq_i = ',frq_i
          CALL drad_tran_dt(z_path(ext_ind_c(1:npc)), &
           &   Req + h_path(ext_ind_c(1:npc)),                              &
           &   t_path(ext_ind_c(1:npc)),dh_dt_path(ext_ind_c(1:npc),:),     &
           &   alpha_path_c(1:npc),SUM(sps_path(ext_ind_c(1:npc),:)         &
           &   * dbeta_dt_path_c(1:npc,:) * beta_path_c(1:npc,:),DIM=2),    &
           &   eta_zxp_t(ext_ind_c(1:npc),:),do_calc_t(ext_ind_c(1:npc),:), &
           &   do_calc_hyd(ext_ind_c(1:npc),:),del_s(1:npc),ref_corr(1:npc),&
           &   Req + one_tan_ht(1),dh_dt_path(brkpt,:),frq,do_gl(1:npc),    &
           &   req + h_path(gl_inds),t_path(gl_inds),dh_dt_path(gl_inds,:), &
           &   SUM(sps_path(gl_inds,:)*beta_path_f,DIM=2),                  &
           &   SUM(sps_path(gl_inds,:)*beta_path_f*dbeta_dt_path_f,DIM=2),  &
           &   eta_zxp_t(gl_inds,:),do_calc_t(gl_inds,:),path_dsdh(gl_inds),&
           &   dhdz_path(gl_inds),t_script(1:npc),tau(1:npc),i_stop,drad_dt,&
           &   ptg_i,frq_i)
!
          CALL cpu_time(t2)
          t9 = t9 + t2 - t1
!
          k_temp_frq(frq_i,:) = drad_dt
!
        ENDIF
!
        IF(fmc%spect_der) THEN
!
! Spectroscopic derivative  wrt: W
!
          CALL drad_tran_dx(z_path(ext_ind_c(1:npc)),no_z_dw,no_phi_dw,&
            &  dbeta_dw_path_c(1:npc,:),eta_zxp_dw(ext_ind_c(1:npc),:),&
            &  sps_path(ext_ind_c(1:npc),:),do_calc_dw(ext_ind_c(1:npc),:), &
            &  dbeta_dw_path_f,eta_zxp_dw(gl_inds,:),sps_path(gl_inds,:),&
            &  do_calc_dw(gl_inds,:),do_gl(1:npc),del_s(1:npc), &
            &  ref_corr(1:npc),path_dsdh(gl_inds),dhdz_path(gl_inds), &
            &  t_script(1:npc),tau(1:npc),i_stop,drad_dw,ptg_i,frq_i)
          k_spect_dw_frq(frq_i,:) = drad_dw
!
! Spectroscopic derivative  wrt: N
!
          CALL drad_tran_dx(z_path(ext_ind_c(1:npc)),no_z_dn,no_phi_dn,&
            &  dbeta_dn_path_c(1:npc,:),eta_zxp_dn(ext_ind_c(1:npc),:),&
            &  sps_path(ext_ind_c(1:npc),:),do_calc_dn(ext_ind_c(1:npc),:), &
            &  dbeta_dn_path_f,eta_zxp_dn(gl_inds,:),sps_path(gl_inds,:),&
            &  do_calc_dn(gl_inds,:),do_gl(1:npc),del_s(1:npc), &
            &  ref_corr(1:npc),path_dsdh(gl_inds),dhdz_path(gl_inds), &
            &  t_script(1:npc),tau(1:npc),i_stop,drad_dn,ptg_i,frq_i)
          k_spect_dn_frq(frq_i,:) = drad_dn
!
! Spectroscopic derivative  wrt: Nu0
!
          CALL drad_tran_dx(z_path(ext_ind_c(1:npc)),no_z_dv,no_phi_dv,&
            &  dbeta_dv_path_c(1:npc,:),eta_zxp_dv(ext_ind_c(1:npc),:),&
            &  sps_path(ext_ind_c(1:npc),:),do_calc_dv(ext_ind_c(1:npc),:), &
            &  dbeta_dv_path_f,eta_zxp_dv(gl_inds,:),sps_path(gl_inds,:),&
            &  do_calc_dv(gl_inds,:),do_gl(1:npc),del_s(1:npc), &
            &  ref_corr(1:npc),path_dsdh(gl_inds),dhdz_path(gl_inds), &
            &  t_script(1:npc),tau(1:npc),i_stop,drad_dv,ptg_i,frq_i)
          k_spect_dv_frq(frq_i,:) = drad_dv
!
          CALL cpu_time(t2)
!
        ENDIF
!
        DEALLOCATE(gl_inds,beta_path_f,gl_indgen,gl_ndx)
        IF(FMC%temp_der) DEALLOCATE(dbeta_dt_path_f)
        IF(FMC%spect_der) DEALLOCATE(dbeta_dw_path_f,dbeta_dn_path_f, &
                                  &  dbeta_dv_path_f)
!
      END DO                 ! End of frequencies loop
d332 2
d336 5
a340 10
      IF(FMC%do_frqavg) then
!
! radiances
!
        do i = 1, no_pfa_ch
          ch = pfa_ch(i)
          Adjusted_Filter_Grid = &
            Radiometer_Frq + FMC%Sideband*(Band_frq+FMI%F_grid_filter(:,i))
          Call Freq_Avg(F_grid,Adjusted_Filter_Grid, &
         &     FMI%Filter_func(:,i),RadV,no_frq_on_ptg_i,FMI%no_filt_pts, &
d342 4
a345 1
        enddo
d347 1
a347 1
! atmospheric derivatives
d349 2
a350 22
        IF(FMC%atmos_der) then
          do i = 1, no_pfa_ch
            sv_i = 1
            do j = 1, n_sps
              IF(T_FMI%atmospheric(j)%der_calc(FMI%band)) THEN
                Adjusted_Filter_Grid = Radiometer_Frq + &
                     &  FMC%Sideband*(Band_frq+FMI%F_grid_filter(:,i))
                do k = 1, no_phi(j)
                  do n = 1, no_z(j)
                    Call Freq_Avg(F_grid,Adjusted_Filter_Grid, &
                 &                FMI%Filter_func(:,i),k_atmos_frq(:,sv_i), &
                 &                no_frq_on_ptg_i,FMI%no_filt_pts,r)
                    k_atmos(i,ptg_i,n,k,j) = r
                    sv_i = sv_i + 1
                  end do
                end do
              ELSE
                sv_i = sv_i * no_phi(j) * no_z(j)
              ENDIF
            end do
          enddo
        ENDIF
d352 15
a366 13
        IF(FMC%temp_der) then
          do i = 1, no_pfa_ch
            Adjusted_Filter_Grid = Radiometer_Frq + &
                      &   FMC%Sideband*(Band_frq+FMI%F_grid_filter(:,i))
            sv_i = 1
            do j = 1, T_FMI%no_phi_t
              do k = 1, T_FMI%no_t
                Call Freq_Avg(F_grid,Adjusted_Filter_Grid, &
               &              FMI%Filter_func(:,i),k_temp_frq(:,sv_i), &
                              no_frq_on_ptg_i,FMI%no_filt_pts,r)
                k_temp(i,ptg_i,k,j) = r
                sv_i = sv_i + 1
              end do
d369 1
a369 1
        ENDIF
d371 3
a373 1
! spectral derivatives:
d375 1
a375 3
        IF(FMC%spect_der) THEN
!
! Frequency Average the spectroscopic derivatives with the appropriate
d378 17
a394 12
          do i = 1, no_pfa_ch
            sv_i = 1
            Adjusted_Filter_Grid = Radiometer_Frq + &
             &     FMC%Sideband*(Band_frq+FMI%F_grid_filter(:,i))
            do j = 1, n_sps
              do k = 1, no_phi_dw(j)
                do n = 1, no_z_dw(j)
                  Call Freq_Avg(F_grid,Adjusted_Filter_Grid, &
                      &     FMI%Filter_func(:,i),k_spect_dw_frq(:,sv_i), &
                      &     no_frq_on_ptg_i,FMI%no_filt_pts,r)
                  k_spect_dw(i,ptg_i,n,k,j) = r
                  sv_i = sv_i + 1
d397 1
a397 18
            end do
          end do
!
          do i = 1, no_pfa_ch
            sv_i = 1
            Adjusted_Filter_Grid = Radiometer_Frq + &
             &     FMC%Sideband*(Band_frq+FMI%F_grid_filter(:,i))
            do j = 1, n_sps
              do k = 1, no_phi_dn(j)
                do n = 1, no_z_dn(j)
                  Call Freq_Avg(F_grid,Adjusted_Filter_Grid, &
                      &     FMI%Filter_func(:,i),k_spect_dn_frq(:,sv_i), &
                      &     no_frq_on_ptg_i,FMI%no_filt_pts,r)
                  k_spect_dn(i,ptg_i,n,k,j) = r
                  sv_i = sv_i + 1
                end do
              end do
            end do
d399 1
d401 1
a401 16
          do i = 1, no_pfa_ch
            sv_i = 1
            Adjusted_Filter_Grid = Radiometer_Frq + &
             &     FMC%Sideband*(Band_frq+FMI%F_grid_filter(:,i))
            do j = 1, n_sps
              do k = 1, no_phi_dv(j)
                do n = 1, no_z_dv(j)
                  Call Freq_Avg(F_grid,Adjusted_Filter_Grid, &
                      &     FMI%Filter_func(:,i),k_spect_dv_frq(:,sv_i), &
                      &     no_frq_on_ptg_i,FMI%no_filt_pts,r)
                  k_spect_dv(i,ptg_i,n,k,j) = r
                  sv_i = sv_i + 1
                end do
              end do
            end do
          end do
d403 1
a403 1
        ENDIF
d405 2
a406 1
      ELSE
d408 36
a443 16
! no frequency averaging
! radiances
!
        Radiances(ptg_i,:) = radv
!
        IF(FMC%atmos_der) then
!
! atmospheric derivatives
!
          sv_i = 1
          do j = 1, n_sps
            IF(T_FMI%atmospheric(j)%der_calc(FMI%band)) THEN
              do k = 1, no_phi(j)
                do n = 1, no_z(j)
                  k_atmos(1:no_pfa_ch,ptg_i,n,k,j) = k_atmos_frq(1,sv_i)
                  sv_i = sv_i + 1
a444 30
              enddo
            ELSE
              sv_i = sv_i + no_z(j) * no_phi(j)
            ENDIF
          enddo
        ENDIF
!
        IF(FMC%temp_der) then
!
! temperature derivatives
!
          sv_i = 1
          do j = 1, T_FMI%no_phi_t
            do k = 1, T_FMI%no_t
              k_temp(1:no_pfa_ch,ptg_i,k,j) = k_temp_frq(1,sv_i)
              sv_i = sv_i + 1
            end do
          enddo
        ENDIF
!
! spectral derivatives
!
        IF(FMC%spect_der) then
!
          sv_i = 1
          do j = 1, n_sps
            do k = 1, no_phi_dw(j)
              do n = 1, no_z_dw(j)
                k_spect_dw(1:no_pfa_ch,ptg_i,n,k,j) = k_spect_dw_frq(1,sv_i)
                sv_i = sv_i + 1
d446 3
a448 1
            end do
d450 1
d452 1
a452 9
          sv_i = 1
          do j = 1, n_sps
            do k = 1, no_phi_dn(j)
              do n = 1, no_z_dn(j)
                k_spect_dn(1:no_pfa_ch,ptg_i,n,k,j) = k_spect_dn_frq(1,sv_i)
                sv_i = sv_i + 1
              end do
            end do
          end do
d454 1
a454 11
          sv_i = 1
          do j = 1, n_sps
            do k = 1, no_phi_dv(j)
              do n = 1, no_z_dv(j)
                k_spect_dv(1:no_pfa_ch,ptg_i,n,k,j) = k_spect_dv_frq(1,sv_i)
                sv_i = sv_i + 1
              end do
            end do
          end do

        ENDIF
d456 2
a457 1
      ENDIF
d459 35
a493 82
      DEALLOCATE(radv,f_grid,STAT=j)
!
      IF(FMC%temp_der) DEALLOCATE(k_temp_frq,STAT=ier)
!
      IF(FMC%atmos_der) DEALLOCATE(k_atmos_frq,STAT=i)
!
      IF(FMC%spect_der) THEN
        DEALLOCATE(k_spect_dw_frq,STAT=i)
        DEALLOCATE(k_spect_dn_frq,STAT=i)
        DEALLOCATE(k_spect_dv_frq,STAT=i)
      ENDIF
!
    END DO              ! End of Pointing Loop
!
    DEALLOCATE(z_path,h_path,phi_path,t_path,dhdz_path,ext_ind_c, &
          &    n_path,sps_path,do_calc,del_s,ref_corr,incoptdepth, &
          &    do_gl,path_dsdh,tau,t_script,alpha_path_c,beta_path_c, &
          &    p_path,eta_zxp,STAT=j)

    IF(FMC%temp_der) DEALLOCATE(k_temp_frq,dh_dt_path,tan_dh_dt, &
          &    do_calc_t,do_calc_hyd,eta_zxp_t,dbeta_dt_path_c, &
          &    drad_dt,STAT=i)
!
    IF(FMC%spect_der) THEN
      DEALLOCATE(dbeta_dw_path_c)
      DEALLOCATE(dbeta_dn_path_c)
      DEALLOCATE(dbeta_dv_path_c)
      DO i = 1, n_sps
        if(no_z_dw(i) > 0) DEALLOCATE(do_calc_dw,eta_zxp_dw,drad_dw)
        if(no_z_dn(i) > 0) DEALLOCATE(do_calc_dn,eta_zxp_dn,drad_dn)
        if(no_z_dv(i) > 0) DEALLOCATE(do_calc_dv,eta_zxp_dv,drad_dv)
      END DO
    ENDIF
!
    DEALLOCATE(Adjusted_Filter_Grid,STAT=i)
!
    center_angle = ptg_angles(no_ss+1,l)
!
!  De-allocate the gl_slabs structures..
!
    DO i = 1, FMI%n_sps
      DO j = 1, 2*Nglp !?
        DEALLOCATE(gl_slabs(j,i)%v0s,gl_slabs(j,i)%x1,gl_slabs(j,i)%y, &
                &  gl_slabs(j,i)%yi,gl_slabs(j,i)%slabs1,              &
                &  gl_slabs(j,i)%dslabs1_dv0,STAT=ier)
        IF(ier /= 0) THEN
          Print *,'** DEALLOCATE Error: gl_slabs%comp,STAT=',ier
          goto 99
        ENDIF
      END DO
      IF(FMC%temp_der) THEN
        DO j = 1, no_ele
          DEALLOCATE(gl_slabs_p(j,i)%v0s,gl_slabs_p(j,i)%x1, &
                &    gl_slabs_m(j,i)%v0s,gl_slabs_m(j,i)%x1, &
                &    gl_slabs_p(j,i)%y,gl_slabs_p(j,i)%yi,   &
                &    gl_slabs_m(j,i)%y,gl_slabs_m(j,i)%yi,   &
                &    gl_slabs_p(j,i)%slabs1,                 &
                &    gl_slabs_m(j,i)%slabs1,                 &
                &    gl_slabs_p(j,i)%dslabs1_dv0,            &
                &    gl_slabs_m(j,i)%dslabs1_dv0, STAT=ier)
          IF(ier /= 0) THEN
            Print *,'** DEALLOCATE Error: gl_slabs_p/m%comp,STAT=',ier
            goto 99
          ENDIF
        END DO
      ENDIF
    END DO
!
    DEALLOCATE(gl_slabs,STAT=ier)
    IF(ier == 0 .AND. FMC%temp_der) DEALLOCATE(gl_slabs_p,gl_slabs_m,STAT=ier)
    IF(ier /= 0) THEN
      Print *,'** DEALLOCATE Error: gl_slabs, STAT =',ier
      goto 99
    ENDIF
!
! *** ZEBUG
!   ch = pfa_ch(1)
!   kk = no_tan_hts
!   write(*,903) ch,char(92),kk
!   write(*,905) (Radiances(j,ch),j=1,kk)
!   IF(kk > -2) goto 99
! *** END ZEBUG
d501 1
a501 1
      IF(FMC%do_conv) then
d503 11
a513 5
        Call convolve_all(FMC,FMI,T_FMI,ptg_angles(:,l),tan_temp(:,l),      &
       &     dx_dt,d2x_dxdt,center_angle,Radiances(:,ch),k_temp(i,:,:,:),   &
       &     k_atmos(i,:,:,:,:),k_spect_dw(i,:,:,:,:),k_spect_dn(i,:,:,:,:),&
       &     k_spect_dv(i,:,:,:,:),k_info_count,i_star_all(i,:),           &
       &     k_star_all(i,:,:,:,:),k_star_info,ier)
d516 1
a516 1
      ELSE
d518 10
a527 4
        Call no_conv_at_all(FMC,FMI,T_FMI,Radiances(:,ch),k_temp(i,:,:,:),  &
       &     k_atmos(i,:,:,:,:),k_spect_dw(i,:,:,:,:),k_spect_dn(i,:,:,:,:),&
       &     k_spect_dv(i,:,:,:,:),k_info_count,i_star_all(i,:),           &
       &     k_star_all(i,:,:,:,:),k_star_info)
d529 1
a529 1
      ENDIF
d532 1
a532 13
!
!   CALL cpu_time(t2)
!   PRINT 923,'This mmaf radiative transfer took:',t2-t1
    PRINT 923,'           This sps_path took:',t3
    PRINT 923,'                 metrics took:',t4
    PRINT 923,'               beta prep took:',t5
    PRINT 923,'              beta calcs took:',t6
    PRINT 923,'Radiative transfer calcs took:',t7
    PRINT 923,'mixing ratio derivatives took:',t8
    PRINT 923,'tempersture  derivatives took:',t9
    PRINT *
 923  format(A,f9.4,' seconds')
!
d535 9
a543 2
  DEALLOCATE(radiances)
  DEALLOCATE(sps_values,no_z,no_phi,lin_log,z_basis,phi_basis,drad_df)
d545 1
a545 1
! *** ZEBUG Print
d547 1
a547 1
    IF(FMC%do_conv) then
d549 1
a549 1
    ELSE
d551 1
a551 1
    ENDIF
d553 1
a553 1
    IF(FMC%Zfrq > 0.0_r8) then
d558 1
a558 1
    ELSE
d560 1
a560 2
    ENDIF
!
a561 7
    kk = T_FMI%ptg_press%no_lin_values
    write(*,902) kk
902 format('Ptan\',i3.3)
    write(*,904) T_FMI%ptg_press%lin_val(1:kk)
904 format ( 4(4x, f10.7))
!
! DUMMY CODE
a562 1
    ALLOCATE(tau(1:Nptg))
d564 2
a565 3
!   Zeta = -0.5_rp
    Zeta = -1.666667_rp
    tau(1:Nptg) = 0.0_rp
a569 1
    Print *
d575 1
a575 1
903 format('ch',i2.2,'_pfa_rad',a1,i3.3)
d578 1
a578 1
    IF(.not. ANY((/FMC%temp_der,FMC%atmos_der,FMC%spect_der/))) goto 99
d582 1
a582 1
    tau(:) = 0.0
d585 1
a585 1
      Name(:) = ' '
d587 1
a587 1
      IF(Name == 'PTAN') CYCLE
d592 1
a592 1
      IF(Name(l-1:l) == '_W' .or.  &
d598 2
a599 3
        write(6,915) klo
      ELSE
        IF(Name == 'TEMP') then
d601 1
a601 1
        ELSE
d603 2
a604 2
        ENDIF
        tau(1:) = 0.0_rp
d609 1
a609 2
        write(6,914) klo,m
      ENDIF
a610 1

a611 2
914 format(/,'  (Computed at PTAN element#:',i3,',  K element#:',i3,')')
915 format(3x,'(Computed at PTAN element#:',i3,')')
d613 4
a616 3
  99 IF(ier /= 0) THEN
       PRINT *,'An error ocurred'
     ENDIF
d626 6
a631 6
     r = Real(ld-k)+60.0_rp*Real(ch-j)+3600.0_rp*Real(kk-i)
     IF(r < 0.0) r = r + 86400.00_rp
     i = Int(r/3600.0_rp)
     r = r - 3600.0_rp*Real(i)
     j = Int(r/60.0_rp)
     r = r - 60.0_rp*Real(j)
d642 5
a646 1
  SUBROUTINE Z_DATETIME(dtm)
a647 1
! Output: Date & Time array in the format:  'dd-mm-ccyy  hh:mm:ss'
d654 1
a654 1
INTEGER(ip) :: io,iy,jm,id,ih,im,is
d683 1
a683 1
  END SUBROUTINE Z_DATETIME
d685 1
a685 1
END Program l2_Test
@


1.12.2.2
log
@*** empty log message ***
@
text
@@


1.11
log
@Correcting an error in HUNT routine
@
text
@@


1.10
log
@*** empty log message ***
@
text
@d150 1
d563 1
d580 1
@


1.9
log
@Adding logical flags fro Temp, Atmos & Spect. derivatives
@
text
@d318 1
d324 2
a325 2
       &     T_FMI%f_phi_basis,FMC%temp_der,T_FMI%no_phi_t,             &
       &     T_FMI%t_phi_basis,dh_dt_path(k,l),FMI%spect_atmos,         &
@


1.8
log
@*** empty log message ***
@
text
@d344 2
a345 2

!     if(i > -3) goto 77           ! ** DEBUG, Bypass derivatives avg.
a349 1
      if(FMC%temp_der) then
d368 1
d371 1
a371 1
!     if(i > -3) goto 77           ! ** DEBUG, Bypass derivatives avg.
d376 18
a393 17
      do i = 1, no_pfa_ch
!       ch = pfa_ch(i)
        ch = i                 ! ** DEBUG, memory limitations on MLSGATE
        do j = 1, FMI%n_sps
          if(T_FMI%atmospheric(j)%der_calc(FMI%band)) THEN
            RadV(1:kk) = 0.0
            do k = 1, T_FMI%no_phi_f(j)
              do n = 1, T_FMI%no_coeffs_f(j)
                if(FMC%do_frqavg) then
                  RadV(1:kk) = k_atmos_frq(j)%values(1:kk,n,k)
                  Call Freq_Avg(F_grid,FMI%F_grid_filter(1:,i), &
                 &              FMI%Filter_func(1:,i),          &
                 &              RadV,kk,FMI%no_filt_pts,r)
                else
                  r = k_atmos_frq(j)%values(1,n,k)
                endif
                k_atmos(ch,ptg_i,n,k,j) = r
d395 2
a396 2
            end do
          endif
d398 2
a399 1
      end do
d401 1
a401 1
!     if(i > -3) goto 77           ! ** DEBUG, Bypass derivatives avg.
d406 37
a442 36
      do i = 1, no_pfa_ch
!       ch = pfa_ch(i)
        ch = i                 ! ** DEBUG, memory limitations on MLSGATE
        do m = 1, FMI%n_sps
          j = FMI%spect_atmos(m)
          if(.not.  FMI%spectroscopic(j)%DER_CALC(FMI%band)) CYCLE
          Spectag = FMI%spectroscopic(j)%Spectag
          DO
            if(FMI%spectroscopic(j)%Spectag /= Spectag) EXIT
            RadV(1:kk) = 0.0
            CA = FMI%spectroscopic(j)%type
            do k = 1, FMI%spectroscopic(j)%no_phi_values
              do n = 1, FMI%spectroscopic(j)%no_zeta_values
                select case ( CA )
                  case ( 'W' )
                    RadV(1:kk) = k_spect_dw_frq(m)%values(1:kk,n,k)
                  case ( 'N' )
                    RadV(1:kk) = k_spect_dn_frq(m)%values(1:kk,n,k)
                  case ( 'V' )
                    RadV(1:kk) = k_spect_dnu_frq(m)%values(1:kk,n,k)
                end select
                if(FMC%do_frqavg) then
                  Call Freq_Avg(F_grid,FMI%F_grid_filter(1:,i), &
                 &              FMI%Filter_func(1:,i),&
                 &              RadV,kk,FMI%no_filt_pts,r)
                else
                  r = RadV(1)
                endif
                select case ( CA )
                  case ( 'W' )
                    k_spect_dw(ch,ptg_i,n,k,j) = r
                  case ( 'N' )
                    k_spect_dn(ch,ptg_i,n,k,j) = r
                  case ( 'V' )
                    k_spect_dnu(ch,ptg_i,n,k,j) = r
                end select
d444 4
a447 4
            end do
            j = j + 1
            if(j > 3 * FMI%n_sps) EXIT
          END DO
a448 1
      end do
d450 1
a450 1
 77   j = 0             ! ** DEBUG
d461 30
a490 24
      k_temp(i,kk,1:T_FMI%no_t,1:T_FMI%no_phi_t) = &
     &            k_temp(i,kk-1,1:T_FMI%no_t,1:T_FMI%no_phi_t)
      do m = 1, FMI%n_sps
        if(T_FMI%atmospheric(m)%der_calc(FMI%band)) then
          k = T_FMI%no_phi_f(m)
          n = T_FMI%no_coeffs_f(m)
          k_atmos(i,kk,1:n,1:k,m)=k_atmos(i,kk-1,1:n,1:k,m)
        endif
      end do
      do m = 1, FMI%n_sps
        j = FMI%spect_atmos(m)
        if(.not.  FMI%spectroscopic(j)%DER_CALC(FMI%band)) CYCLE
        Spectag =  FMI%spectroscopic(j)%Spectag
        DO
          if(FMI%spectroscopic(j)%Spectag /= Spectag) EXIT
          k = FMI%spectroscopic(j)%no_phi_values
          n = FMI%spectroscopic(j)%no_zeta_values
          k_spect_dw(i,kk,1:n,1:k,j)=k_spect_dw(i,kk-1,1:n,1:k,j)
          k_spect_dn(i,kk,1:n,1:k,j)=k_spect_dn(i,kk-1,1:n,1:k,j)
          k_spect_dnu(i,kk,1:n,1:k,j)=k_spect_dnu(i,kk-1,1:n,1:k,j)
          j = j + 1
          if(j > 3 * FMI%n_sps) EXIT
        END DO
      end do
d502 2
a503 1
       &     FMC%temp_der,FMI%tan_press,ptg_angles(1:,l),tan_temp(1:,l), &
d517 2
a518 1
       &     FMI%band,Radiances(1:,ch),k_temp(i,1:,1:,1:),           &
d523 1
a523 1
       &     k_star_info,FMC%temp_der,T_FMI%no_t,T_FMI%no_phi_t,     &
d533 1
a533 1
  DEALLOCATE(k_temp_frq%values,STAT=i)
d535 6
a540 4
    DEALLOCATE(k_atmos_frq(j)%values,STAT=i)
    DEALLOCATE(k_spect_dw_frq(j)%values,STAT=i)
    DEALLOCATE(k_spect_dn_frq(j)%values,STAT=i)
    DEALLOCATE(k_spect_dnu_frq(j)%values,STAT=i)
d574 2
@


1.7
log
@*** empty log message ***
@
text
@d125 3
a127 1

@


1.6
log
@New filter format
@
text
@d11 1
d35 2
a36 4
Integer(i4) :: SPECT_ATMOS(Nsps), ld

Integer(i4) :: i, j, k, kk, kz, ht_i, no_t, mnz, no_tan_hts, ch, Spectag, &
               m, prev_npf, ier, n_obs, mmaf, n_sps, si, band, ptg_i, &
d38 1
a38 1
               no_phi_t, k_info_count, gl_count
a96 3
real(r8) :: T_PHI_BASIS_COPY(mnp)
real(r8) :: F_PHI_BASIS_COPY(mnp,Nsps)

a97 1
Real(r8), DIMENSION(:,:), ALLOCATABLE :: S_PHI_BASIS_COPY
a122 44
  SPECT_ATMOS(1:Nsps) = -1
!
! Set n_obs to be: N_lvls always.
!   (Changed, Aug/6/96 Z.Shippony & W.G.Read)

  band = FMI%band
  n_obs = FMC%n_lvls

  no_t = T_FMI%no_t
  no_phi_t = T_FMI%no_phi_t

  T_PHI_BASIS_COPY(1:no_phi_t) = T_FMI%t_phi_basis(1:no_phi_t)
!
  n_sps = FMI%n_sps
  DO m = 1, n_sps
    kk = T_FMI%no_phi_f(m)
    F_PHI_BASIS_COPY(1:kk,m) = T_FMI%f_phi_basis(1:kk,m)
  END DO
!
! Create spect_atmos array:
!
  do k = 1, n_sps
    Spectag = T_FMI%atmospheric(k)%Spectag
    do i = 1, FMI%no_spectro
      if(Spectag == FMI%spectroscopic(i)%Spectag) then
        spect_atmos(k) = i
        EXIT
      endif
    end do
  end do
!
  kk = mxco
  k = FMI%mfi + 2

  DEALLOCATE(S_PHI_BASIS_COPY,STAT=i)
  ALLOCATE(S_PHI_BASIS_COPY(k,FMI%no_spectro),STAT=io)
  IF(io /= 0) then
    Print *,'** ALLOCATE Error: S_PHI_BASIS_COPY, STAT =',io
    goto 99
  endif

  do j = 1, FMI%no_spectro
    S_PHI_BASIS_COPY(1:k,j) = FMI%spectroscopic(j)%PHI_BASIS(1:k)
  end do
d126 2
a127 1
  Zeta = -1.666667
d148 1
d172 2
a173 1
    T_FMI%t_phi_basis(1:no_phi_t) = T_PHI_BASIS_COPY(1:no_phi_t) + phi_tan
d175 1
a175 1
    DO j = 1, n_sps
d177 1
a177 1
      T_FMI%f_phi_basis(1:k,j) = F_PHI_BASIS_COPY(1:k,j) + phi_tan
d183 1
a183 1
     &                S_PHI_BASIS_COPY(1:k,j) + phi_tan
d230 1
a230 1
        ALLOCATE(k_temp_frq%values(kk,no_t,no_phi_t),STAT=ier)
d247 1
a247 1
          j = spect_atmos(m)
d249 1
a249 1
          if(.not. FMI%spectroscopic(j)%DER_CALC(band)) CYCLE
d315 5
a319 4
        CALL Rad_Tran_WD(frq_i,band,Frq,FMC%N_lvls,FMI%n_sps,z_path(k,l),&
       &     h_path(k,l),t_path(k,l),phi_path(k,l),dHdz_path(k,l),      &
       &     T_FMI%atmospheric,beta_path(1:,frq_i),spsfunc_path(1:,k,l),  &
       &     T_FMI%t_zeta_basis,T_FMI%f_zeta_basis,T_FMI%no_coeffs_f,   &
d322 1
a322 1
       &     T_FMI%t_phi_basis,dh_dt_path(k,l),spect_atmos,             &
d378 1
a378 1
          if(T_FMI%atmospheric(j)%der_calc(band)) THEN
d406 2
a407 2
          j = spect_atmos(m)
          if(.not.  FMI%spectroscopic(j)%DER_CALC(band)) CYCLE
d460 1
a460 1
        if(T_FMI%atmospheric(m)%der_calc(band)) then
d467 2
a468 2
        j = spect_atmos(m)
        if(.not.  FMI%spectroscopic(j)%DER_CALC(band)) CYCLE
d491 1
a491 1
        Call convolve_all(T_FMI%ptg_press,T_FMI%atmospheric,FMI%n_sps, &
d493 1
a493 1
       &     dx_dt, d2x_dxdt,band,center_angle,FMI%fft_pts,          &
d496 1
a496 1
       &     k_spect_dnu(i,1:,1:,1:,1:),spect_atmos,no_tan_hts,      &
d505 8
a512 7
        Call no_conv_at_all(T_FMI%ptg_press,FMI%n_sps,FMI%tan_press,band, &
       &     Radiances(1:,ch),k_temp(i,1:,1:,1:),k_atmos(i,1:,1:,1:,1:), &
       &     k_spect_dw(i,1:,1:,1:,1:), k_spect_dn(i,1:,1:,1:,1:),     &
       &     k_spect_dnu(i,1:,1:,1:,1:), spect_atmos, no_tan_hts,      &
       &     k_info_count, i_star_all(i,1:), k_star_all(i,1:,1:,1:,1:), &
       &     k_star_info,FMC%temp_der,T_FMI%no_t,T_FMI%no_phi_t,       &
       &     T_FMI%no_phi_f,T_FMI%t_zeta_basis,T_FMI%atmospheric,        &
@


1.5
log
@New version - Using "Super-Structures"
@
text
@a29 2
Integer(i4), PARAMETER :: mnf = 75

d37 5
a41 3
               m, prev_npf, ier, n_obs, mmaf, no_atmos, si, band, ptg_i, &
               frq_i, io, klo, khi, l, n, brkpt, no_ele, mid, ilo, ihi, &
               no_phi_t, k_info_count, gl_count, Freq_Index, k1, k2, jj
d87 1
a87 1
Type(path_beta) :: beta_path(Nsps,mnf)
a89 1
Real(r8) :: RadV(mnf), F_grid(mnf)
d101 1
d105 7
a111 1
! Read convolution & freq. averaging data from file: tmp.dat
d113 5
a117 1
  Call L2_LOAD(T_FMI, FMI, FMC, Ier)
d120 7
d134 1
a134 1
  n_obs = FMI%n_lvls
d141 2
a142 2
  no_atmos = FMI%no_atmos
  DO m = 1, no_atmos
d149 1
a149 1
  do k = 1, no_atmos
a160 1
  Freq_Index = FMC%Freq_Index
d189 2
a190 2
  Call hydrostatic_model(si,FMI%N_lvls,T_FMI%no_t,FMC%no_mmaf,FMI%t_indx, &
       T_FMI%no_tan_hts,geoc_lat,T_FMI%Href,T_FMI%Zref,FMI%z_grid,thbs, &
d196 1
a196 1
  no_tan_hts = T_FMI%no_tan_hts
d202 8
a209 7
  Call comp_path_entities(FMI%n_lvls,T_FMI%no_t,gl_count,ndx_path, &
       z_glgrid,t_glgrid,h_glgrid,dhdz_glgrid,dh_dt_glgrid, &
       T_FMI%atmospheric,FMI%no_atmos,T_FMI%f_zeta_basis,     &
       T_FMI%mr_f,T_FMI%no_coeffs_f,tan_hts,no_tan_hts,FMI%n_sps, &
       T_FMI%no_phi_f,T_FMI%f_phi_basis,z_path,h_path,t_path,phi_path,&
       n_path,dhdz_path,dh_dt_path,T_FMI%no_phi_t,T_FMI%t_phi_basis, &
       spsfunc_path,T_FMI%is_f_log,FMC%no_mmaf,FMC%phi_tan_mmaf,Ier)
d221 1
a221 1
    DO j = 1, no_atmos
a259 1
        F_grid(1:mnf) = 0.0
d262 7
d330 2
a331 2
      khi = ndx_path(ptg_i,l)%total_number_of_elements
      Call get_beta_path(ptg_i,FMI%pfa_spectrum,khi,FMI%no_ptg_frq, &
d343 1
a343 1
      RadV(1:mnf) = 0.0
d346 1
a346 9
      k1 = 1
      k2 = kk

      if(Freq_Index > 0) then
        k1 = Freq_Index
        k2 = Freq_Index
      endif
!
      do frq_i = k1, k2
d350 1
a350 1
        Call Rad_Tran(Frq, FMI%N_lvls, h_tan, FMI%n_sps, ndx_path(k,l),  &
d361 1
a361 1
        CALL Rad_Tran_WD(frq_i,band,Frq,FMI%N_lvls,FMI%n_sps,z_path(k,l),&
d377 2
a378 2
      do i = 1, FMC%no_pfa_ch
        ch = FMC%pfa_ch(i)
d384 1
a384 1
          Radiances(ptg_i,ch) = RadV(Freq_Index)
d394 3
a396 3
        RadV(1:mnf) = 0.0
        do i = 1, FMC%no_pfa_ch
!         ch = FMC%pfa_ch(i)
d406 1
a406 1
                r = k_temp_frq%values(Freq_Index,k,j)
d419 2
a420 2
      do i = 1, FMC%no_pfa_ch
!       ch = FMC%pfa_ch(i)
d424 1
a424 1
            RadV(1:mnf) = 0.0
d433 1
a433 1
                  r = k_atmos_frq(j)%values(Freq_Index,n,k)
d447 2
a448 2
      do i = 1, FMC%no_pfa_ch
!       ch = FMC%pfa_ch(i)
d456 1
a456 1
            RadV(1:mnf) = 0.0
d473 1
a473 1
                  r = RadV(Freq_Index)
d499 2
a500 2
    do i = 1, FMC%no_pfa_ch
      ch = FMC%pfa_ch(i)
d530 1
a530 1
    DO i = 1, FMC%no_pfa_ch
d532 1
a532 1
      ch = FMC%pfa_ch(i)
d581 2
a582 2
    if(Freq_Index > 0) then
      Frq = FMI%ptg_frq_grid(jj)%values(Freq_Index)
d597 2
a598 2
    do i = 1, FMC%no_pfa_ch
      ch = FMC%pfa_ch(i)
@


1.4
log
@
Ctest modification Conv/NoConvVS: ----------------------------------------------------------------------
@
text
@d4 3
a6 5
  use L2PC_FILE_PARAMETERS, only: mxco => MAX_NO_ELMNTS_PER_SV_COMPONENT, &
                                  DEG2RAD
  use L2PC_PFA_STRUCTURES, only: ATMOS_COMP, GEOM_PARAM, MAXFILTPTS, &
                                 PFA_SLAB, SPECTRO_PARAM, MAXPFACH, &
                                 MAXGEOM, LIMB_PRESS, K_MATRIX_INFO
d10 1
a16 1
  use GET_FILTERS_M, only: GET_FILTERS
d32 10
a41 12
Logical :: temp_der, do_conv, do_frqavg

Integer(i4) :: p_indx(Nlvl), SPECT_ATMOS(Nsps), no_ptg_frq(Nptg), ld,&
               no_coeffs_f(Nsps), no_phi_f(Nsps), SPECT_INDEX(Nsps), &
               no_spectro, pfa_ch(MAXPFACH), t_indx(Nptg)

Integer(i4) :: i, j, k, kk, ht_i, no_t, mnz, no_geom, no_tan_hts, kz, &
               ch, Spectag, no_freqs,no_pfa_ch,prev_npf, n_obs, mmaf, &
               no_atmos, ch1, ch2, n_lvls, si, mfi, jp, band, n_sps,  &
               ptg_i, frq_i, io, klo, khi, l, n, brkpt, no_ele, nl,   &
               m, mid, ilo, ihi, ier, no_filt_pts, no_phi_t, fft_pts, &
               k_info_count,  no_mmaf, gl_count, Freq_Index, k1, k2, jj
a46 1
Type(path_vector) :: ptg_frq_grid(Nptg)
d50 3
a52 4
Real(r8) :: z_gnlv(400),thbs(10),phi_tan_mmaf(mnm),elev_offset
Real(r8) :: href(Nlvl),zref(Nlvl),t_z_basis(mxco),t_script(N2lvl),  &
            t_coeff(mxco,mnm),ref_corr(N2lvl,Nptg),tau(N2lvl),Qlog(3), &
            tan_dh_dt(Nlvl,mnm,mxco),t_phi_basis(mnp),t_phi_basis_copy(mnp)
d57 1
a57 6
Real(r8) :: z_grid(Nlvl),dh_dt_glgrid(ngt,mnm,mxco), dhdz_glgrid(ngt,mnp)

Real(r8) :: ptg_angles(Nptg,mnm), center_angle, Zfrq
Real(r8) :: tan_press(Nptg), tan_hts(Nptg,mnm), tan_temp(Nptg,mnm)

Logical :: IS_F_LOG(Nsps)
d59 2
a60 1
real(r8) :: freq_grid(mnf),freqs(Nch)
a61 5
real(r8) :: MR_F(mxco,mnp,Nsps), F_BASIS(mxco,Nsps)
real(r8) :: F_PHI_BASIS(mnp,Nsps), F_PHI_BASIS_COPY(mnp,Nsps)

real(r8) :: FILTER_FUNC(maxfiltpts,maxpfach)
real(r8) :: F_GRID_FILTER(maxfiltpts,maxpfach)
d91 1
a91 4
Real(r8) :: s_temp, h_obs, earth_ref, e_rad, Zeta, Frq, h_tan, Rad, &
            beta_inc, geoc_lat, q, r

Real(r4) :: elev_183, elev_205
d93 1
a93 1
Character (LEN=01) :: CA, Primag
d96 1
a96 1
Character (LEN=80) :: InDir, Aaap, Fnd, Line
d99 2
a100 5
Type(limb_press)       :: PTG_PRESS
Type (atmos_comp)      :: ATMOSPHERIC(Nsps)
Type (geom_param)      :: GEOMETRIC(maxgeom)
Type (pfa_slab)        :: PFA_SPECTRUM(Nsps)
Type (spectro_param)   :: SPECTROSCOPIC(3*Nsps)
d102 1
a102 1
Real(r8), DIMENSION(:,:), ALLOCATABLE :: s_phi_basis_copy
d107 2
a108 33
  Line = 'tmp.dat'
  CLOSE(13,iostat=i)
  OPEN(13,file=Line,status='OLD',action='READ',iostat=io)
  if(io /= 0) goto 99
!
  Zfrq = -1.0
  Freq_Index = -1
  read(13,*,iostat=io) do_conv
  if(io /= 0) goto 99
  read(13,*,iostat=io) do_frqavg
  if(io /= 0) goto 99
  if(.not. do_frqavg) then
    read(13,*,iostat=io) Zfrq
    if(io /= 0) goto 99
  endif
  CLOSE(13,iostat=io)
!  ----------------------
! Read the rest of the inputs from a file...
!
  ier = 0
  Fnd(1:) = ' '
! Fnd = '/home/zvi/mod_seez'      ! HOME PC
  Fnd = '/user5/zvi/mod_seez'     ! MLSGATE, SUN
  CLOSE(11,iostat=io)
  OPEN(11,file=Fnd,status='OLD',action='READ',iostat=io)
  if(io /= 0) goto 99

  p_indx(1:Nlvl) = 0
  t_indx(1:Nptg) = 0
  no_phi_f(1:Nsps) = 0
  no_ptg_frq(1:Nptg) = 0
  pfa_ch(1:MAXPFACH) = 0
  no_coeffs_f(1:Nsps) = 0
d110 1
a110 1
  SPECT_INDEX(1:Nsps) = -1
a111 52

  do
    Ax(1:) = ' '
    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99
    if (Index(Ax,'No_Mmaf') > 0) EXIT
  end do

  read(11,*,iostat=io) j
  if(io /= 0) goto 99

  Primag = 'p'
  no_mmaf = min(j,mnm)

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  tau(1:no_mmaf) = 0.0
  read(11,*,iostat=io) (tau(i),i=1,no_mmaf)
  if(io /= 0) goto 99

  phi_tan_mmaf(1:no_mmaf) = tau(1:no_mmaf) * deg2rad

  do
    Ax(1:) = ' '
    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99
    if (Index(Ax,'Channels_Range') > 0) EXIT
  end do

  read(11,*,iostat=io) ch1, ch2
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) no_pfa_ch
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) (pfa_ch(i),i=1,no_pfa_ch)
  if(io /= 0) goto 99
!
  primag = 'p'
  freqs(1:Nch) = 0.0D0
  DO i = ch1, ch2
    CALL radiometry(i,q,r,Zeta,kk)     ! DEBUG, Added Jan/23/2000, Z.S
    IF(primag == 'p') freqs(i) = q     ! DEBUG, Added Jan/23/2000, Z.S
    IF(primag == 'i') freqs(i) = r     ! DEBUG, Added Jan/23/2000, Z.S
  END DO
d113 2
a114 80
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) ptg_press%name, (ptg_press%der_calc(i),i=1,6)
  if(io /= 0) goto 99

  read(11,*,iostat=io) j
  if(io /= 0) goto 99

  ptg_press%no_lin_values = j
  read(11,*,iostat=io) (ptg_press%lin_val(i),i=1,j)
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) no_geom
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  do i = 1, no_geom
    read(11,*,iostat=io) geometric(i)
    if(io /= 0) goto 99
    r = geometric(i)%lin_val
    IF(geometric(i)%name == 'ELEV_183') THEN
      elev_183 = r
    ELSE IF(geometric(i)%name == 'ELEV_205') THEN
      elev_205 = r
    ELSE IF(geometric(i)%name == 'EARTHREF') THEN
      earth_ref = r
    ELSE IF(geometric(i)%name == 'SPACE_T') THEN
      s_temp = r
    ELSE IF(geometric(i)%name == 'GEOCSRAD') THEN
      h_obs = r
    END IF
  end do

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) no_atmos
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

! read(11,*,iostat=io) (atmos_index(i),i=1,no_atmos)
  read(11,*,iostat=io) i                              ! ** DUMMY read
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  kk = mxco
  do j = 1, no_atmos
    Ax(1:)=' '
    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99
    atmospheric(j)%NAME = AdjustL(Ax)
    read(11,*,iostat=io) Spectag, ht_i
    if(io /= 0) goto 99
    atmospheric(j)%SPECTAG = Spectag
    atmospheric(j)%NO_LIN_VALUES = ht_i
    read(11,*,iostat=io) (atmospheric(j)%FWD_CALC(i),i=1,6)
    if(io /= 0) goto 99
    read(11,*,iostat=io) (atmospheric(j)%DER_CALC(i),i=1,6)
    if(io /= 0) goto 99
    read(11,*,iostat=io) (atmospheric(j)%LIN_VAL(i),i=1,kk)
    if(io /= 0) goto 99
    read(11,*,iostat=io) (atmospheric(j)%BASIS_PEAKS(i),i=1,kk+2)
    if(io /= 0) goto 99
  end do

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) band, n_sps
  if(io /= 0) goto 99
d116 2
a117 24
  elev_offset = 0.0                         ! Zero elev_offset in any case
! if (band >= 5) then                       ! 183
!   elev_offset = elev_183 * deg2rad
! else if (band >= 2) then                  ! 205
!   elev_offset = elev_205 * deg2rad
! else                                      ! 63 / pointing reference
!   elev_offset = 0.0
! end if

  m = 0
  do j = 1, no_atmos
    IF(atmospheric(j)%FWD_CALC(band)) THEN
      m = m + 1
      atmospheric(m) = atmospheric(j)
    ENDIF
  end do
  no_atmos = m

  if(no_atmos /= n_sps) then
    io = 3
    Print *,'** Error: New code: n_sps should be equal to no_atmos !'
    Print *,'          n_sps =',n_sps,' no_atmos:',no_atmos
    goto 99
  endif
d119 2
a120 16
  m = 0
  pfa_spectrum(1)%NO_SPS = n_sps     ! Make sure we have this

  read(11,'(A)',iostat=io) Ax    ! pfa_spectrum(s)
  if(io /= 0) goto 99

  DO

    if(m == n_sps) then
      do
        read(11,'(A)',iostat=io) Ax
        if(io /= 0) goto 99
        if(Index(Ax,'END_CAT') > 0) EXIT
      end do
      EXIT
    endif
d122 1
a122 43
    Line = ' '
    Name = ' '
    read(11,'(A)',iostat=io) Line
    if(io /= 0) goto 99
    if(Index(Line,'END_CAT').gt.0) EXIT
    read(Line,*,iostat=io) Name, Spectag, nl, (Qlog(i),i=1,3)
    if(io /= 0) goto 99

    j = 0
    DO i = 1, n_sps
      if(Name == atmospheric(i)%NAME) then
        j = i
        EXIT
      endif
    END DO

    if(j < 1) then
      do i = 1, nl
        read(11,'(A)',iostat=io) Ax
        if(io /= 0) goto 99
      end do
    else
      m = m + 1
      pfa_spectrum(j)%SPS_NAME = Name
      pfa_spectrum(j)%NO_SPS = n_sps
      pfa_spectrum(j)%NO_LINES = nl
      pfa_spectrum(j)%SPS_SPECTAG = Spectag
      pfa_spectrum(j)%SPS_QLOG(1:3) = Qlog(1:3)
      do i = 1, nl
        read(11,*,iostat=io) (thbs(k),k=1,10)
        if(io /= 0) goto 99
        pfa_spectrum(j)%SPS_V0(i) = thbs(1)
        pfa_spectrum(j)%SPS_EL(i) = thbs(2)
        pfa_spectrum(j)%SPS_STR(i) = thbs(3)
        pfa_spectrum(j)%SPS_W(i) = thbs(4)
        pfa_spectrum(j)%SPS_PS(i) = 0.0   !  thbs(5) *** DEBUG
        pfa_spectrum(j)%SPS_N(i) = thbs(6)
        pfa_spectrum(j)%SPS_DELTA(i) = thbs(7)
        pfa_spectrum(j)%SPS_N1(i) = thbs(8)
        pfa_spectrum(j)%SPS_GAMMA(i) = thbs(9)
        pfa_spectrum(j)%SPS_N2(i) = thbs(10)
      end do
    endif
d124 4
a129 54
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) no_spectro, mfi
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) (spect_index(i),i=1,no_spectro)
  if(io /= 0) goto 99
!
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  kk = mxco
  k = mfi + 2

  DEALLOCATE(s_phi_basis_copy,STAT=i)
  ALLOCATE(s_phi_basis_copy(k,no_spectro),STAT=io)
  IF(io /= 0) then
    Print *,'** ALLOCATE Error: s_phi_basis_copy, STAT =',io
    goto 99
  endif

  do j = 1, no_spectro
    Ax(1:)=' '
    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99
    spectroscopic(j)%TYPE = AdjustL(Ax)
    Ax(1:)=' '
    read(11,'(A)',iostat=io) Ax
    if(io /= 0) goto 99
    spectroscopic(j)%NAME = AdjustL(Ax)
    read(11,*,iostat=io) Spectag
    if(io /= 0) goto 99
    spectroscopic(j)%SPECTAG = Spectag
    read(11,*,iostat=io) ht_i
    if(io /= 0) goto 99
    spectroscopic(j)%NO_PHI_VALUES = ht_i
    read(11,*,iostat=io) ht_i
    if(io /= 0) goto 99
    spectroscopic(j)%NO_ZETA_VALUES = ht_i
    read(11,*,iostat=io) (spectroscopic(j)%DER_CALC(i),i=1,6)
    if(io /= 0) goto 99
    tau(1:k) = 0.0
    read(11,*,iostat=io) (tau(i),i=1,k)
    if(io /= 0) goto 99
    spectroscopic(j)%PHI_BASIS(1:k) = tau(1:k) * deg2rad
    s_phi_basis_copy(1:k,j) = spectroscopic(j)%PHI_BASIS(1:k)
    read(11,*,iostat=io) (spectroscopic(j)%ZETA_BASIS(i),i=1,kk+2)
    if(io /= 0) goto 99
  end do
!
d133 3
a135 3
    Spectag = atmospheric(k)%Spectag
    do i = 1, no_spectro
      if(Spectag == spectroscopic(i)%Spectag) then
d142 3
a144 2
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99
d146 4
a149 71
  InDir(1:)=' '
  read(11,'(A)',iostat=io) InDir
  if(io /= 0) goto 99
  InDir = AdjustL(InDir)

  Aaap(1:) = ' '
  Aaap = 'aaap.umls'

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  Ax(1:)=' '
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99
  Ax = AdjustL(Ax)

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) si,n_lvls,no_tan_hts,mnz,no_filt_pts
  if(io /= 0) goto 99
!
! Set n_obs to be: N_lvls always.
!   (Changed, Aug/6/96 Z.Shippony & W.G.Read)

  n_obs = n_lvls

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) q, r, beta_inc
  if(io /= 0) goto 99

  href(1:n_lvls) = q
  zref(1:n_lvls) = r
!
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) (p_indx(i),i=1,n_lvls)
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) (t_indx(i),i=1,no_tan_hts)
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  thbs(1:) = 0.0
  read(11,*,iostat=io) (thbs(i),i=1,si-1)   ! tan_hts_below_surface
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) (z_gnlv(i),i=1,mnz)
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) no_t, no_phi_t
  if(io /= 0) goto 99

  if(no_mmaf < no_phi_t) then
    io = -1
    Print *,'** Error: no_mmaf < no_phi_t ...'
    Print *,'   Please correct input file and re-run !'
d153 2
a154 34
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) (t_z_basis(i),i=1,no_t)
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) (t_phi_basis(i),i=1,no_phi_t)
  if(io /= 0) goto 99

  t_phi_basis(1:no_phi_t) = t_phi_basis(1:no_phi_t) * deg2rad
  t_phi_basis_copy(1:no_phi_t) = t_phi_basis(1:no_phi_t)

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) ((t_coeff(i,j),j=1,no_mmaf),i=1,no_t)
  if(io /= 0) goto 99
!
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) (no_phi_f(i),i=1,no_atmos)
  if(io /= 0) goto 99

  do i = 1, no_atmos
    if(no_mmaf < no_phi_f(i)) then
      io = -1
      Print *,'** Error: no_mmaf < no_phi_f(i), i =',i
      Print *,'   Please correct input file and re-run !'
      goto 99
    endif
a156 41
  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) (no_coeffs_f(i),i=1,no_atmos)
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) (is_f_log(i),i=1,no_atmos)     ! ** A a new one !
  if(io /= 0) goto 99
!
  tau(1:mnp) = 0.0
  DO m = 1, no_atmos
    kk = no_phi_f(m)
    ht_i = no_coeffs_f(m)
    read(11,*,iostat=io) (f_basis(i,m),i=1,ht_i)
    if(io /= 0) goto 99
    tau(1:kk) = 0.0
    read(11,*,iostat=io) (tau(i),i=1,kk)
    if(io /= 0) goto 99
    f_phi_basis(1:kk,m) = tau(1:kk) * deg2rad
    f_phi_basis_copy(1:kk,m) = f_phi_basis(1:kk,m)
    read(11,*,iostat=io) ((mr_f(i,j,m),j=1,kk),i=1,ht_i)
    if(io /= 0) goto 99
  END DO

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) no_freqs
  if(io /= 0) goto 99

  read(11,'(A)',iostat=io) Ax
  if(io /= 0) goto 99

  read(11,*,iostat=io) (freq_grid(i),i=1,no_freqs)
  if(io /= 0) goto 99

  CLOSE(11,iostat=i)
!
a158 1
  fft_pts = 10
a160 19
  temp_der = .true.
! temp_der = .false.
!
! Get all the filter's loaded & define:
!
  Call get_filters(no_pfa_ch,no_filt_pts,pfa_ch,F_grid_filter, &
 &                 freqs,Filter_func,InDir,ld,primag,ier)
  if(ier /= 0) goto 99
!
! Get the selected integration grid pressures. Also, define the GL
! pressure grid:

  z_grid(1:) = 0.0
  DO i = 1, n_lvls
    j = p_indx(i)
    z_grid(i) = z_gnlv(j)
  END DO
  z_grid(n_lvls+1) = z_grid(n_lvls)
!
d165 2
a166 2
  phi_tan = phi_tan_mmaf(mmaf)
  Call geoc_geod_conv(beta_inc,phi_tan,geoc_lat,E_rad)
d170 7
a176 4
  Call hydrostatic_model(si,N_lvls,no_t,no_mmaf,t_indx,   &
       no_tan_hts, geoc_lat, Href, Zref, z_grid, thbs, t_z_basis,  &
       t_coeff, z_glgrid, h_glgrid, t_glgrid, dhdz_glgrid,         &
       dh_dt_glgrid, tan_press, tan_hts, tan_temp, tan_dh_dt,      &
d180 3
a182 105
  Call Hunt(Zeta,tan_press,no_tan_hts,jj,i)
  IF(ABS(Zeta-tan_press(i)) < ABS(Zeta-tan_press(jj))) jj = i
!
! Load the pointing vs. frequencies database for the given band
! (needed for frequency averaging)
!
  Fnd(1:) = ' '
! Fnd = '/home/zvi/ptg_frq_grid_bxx.dat'     ! HOME PC
  Fnd = '/user5/zvi/ptg_frq_grid_bxx.dat'    ! SUN, MLSGATE
  i = index(Fnd,'_bxx.dat')
  write(Fnd(i+2:i+3),'(i2.2)') band
!
  kk = -1
  no_ptg_frq(1:Nptg) = 0
!
  CLOSE(32,iostat=i)
  OPEN(32,file=Fnd,action='READ',status='OLD',iostat=io)
  if(io /= 0) goto 44
!
! First entry in the file is the 'Band' frequency. All the rest are
! relative to this (center) frequency for this band
!
  Read(32,*,iostat=io) q
  if(io /= 0) goto 44
!
  DO
    Read(32,*,iostat=io) r, jp
    if(io > 0) goto 44
    if(io /= 0) EXIT
    Call Hunt(r,tan_press,no_tan_hts,k,i)
    IF(ABS(r-tan_press(i)) < ABS(r-tan_press(k))) k = i
    if(ABS(r-tan_press(k)) > 0.001) &
   &       Print *,'** Warning: Zeta:',r,' k:',k
    no_ptg_frq(k) = jp
    DEALLOCATE(ptg_frq_grid(k)%values,STAT=i)
!   ALLOCATE(ptg_frq_grid(k)%values(jp),STAT=i)
        j = max(53,jp)                                  ! ** DEBUG
        ALLOCATE(ptg_frq_grid(k)%values(j),STAT=i)      ! ** DEBUG
        no_ptg_frq(k) = j                               ! ** DEBUG
    IF(i /= 0) THEN
      ier = i
      PRINT *,'** Error: ALLOCATION error for ptg_frq_grid ..'
      PRINT *,'   tan_hts index:',k,' STAT =',ier
      do l = 1, k
        DEALLOCATE(ptg_frq_grid(l)%values,STAT=i)
      end do
      goto 99
    ENDIF
    Read(32,*,iostat=io) (ptg_frq_grid(k)%values(i),i=1,jp)
    if(io /= 0) goto 44
    if(kk < 0) kk = k
!
! Add 'band' frequency to ptg_frq_grid to convert to absolute grid
!
    ptg_frq_grid(k)%values(1:jp) = ptg_frq_grid(k)%values(1:jp) + q
!
  END DO
!
  if(kk > 1) then
    jp = no_ptg_frq(kk)
    do k = 1, kk-1
      DEALLOCATE(ptg_frq_grid(k)%values,STAT=i)
      ALLOCATE(ptg_frq_grid(k)%values(jp),STAT=i)
      IF(i /= 0) THEN
        ier = i
        PRINT *,'** Error: ALLOCATION error for ptg_frq_grid ..'
        PRINT *,'   tan_hts index:',k,' STAT =',ier
        do l = 1, k
          DEALLOCATE(ptg_frq_grid(l)%values,STAT=i)
        end do
        goto 99
      ENDIF
      no_ptg_frq(k) = jp
      ptg_frq_grid(k)%values(1:jp) = ptg_frq_grid(kk)%values(1:jp)
    end do
  endif
!
 44 CLOSE(32,iostat=i)
    if(io > 0) then
      ier = io
      goto 99
    else
      io = 0
    endif

    if(Zfrq > 0.0) then
      kk = no_ptg_frq(jj)
      Call Hunt(Zfrq,ptg_frq_grid(jj)%values,kk,i,j)
      IF(ABS(Zfrq-ptg_frq_grid(jj)%values(j)) <    &
         ABS(Zfrq-ptg_frq_grid(jj)%values(i))) i=j
      ptg_frq_grid(jj)%values(i) = Zfrq
      Freq_Index = i
    endif
!
!  **** DEBUG
!
    jp = no_ptg_frq(jj)
    do i = 1, no_tan_hts
      if(i /= jj) then
        no_ptg_frq(i)=no_ptg_frq(jj)
        ptg_frq_grid(i)%values(1:jp)=ptg_frq_grid(jj)%values(1:jp)
      endif
    end do
!
!  **** END DEBUG
d186 7
a192 6
  Call comp_path_entities(n_lvls,no_t,gl_count,ndx_path,z_glgrid,  &
       t_glgrid,h_glgrid,dhdz_glgrid,dh_dt_glgrid,atmospheric,     &
       no_atmos,f_basis,mr_f,no_coeffs_f,tan_hts,no_tan_hts,n_sps, &
       no_phi_f,f_phi_basis,z_path,h_path,t_path,phi_path,n_path,  &
       dhdz_path,dh_dt_path,no_phi_t,t_phi_basis,spsfunc_path,     &
       is_f_log,no_mmaf,phi_tan_mmaf,Ier)
d197 1
a197 1
! DO l = 1, no_mmaf
d200 1
a200 1
    phi_tan = phi_tan_mmaf(l)
d202 1
a202 1
    t_phi_basis(1:no_phi_t) = t_phi_basis_copy(1:no_phi_t) + phi_tan
d205 2
a206 2
      k = no_phi_f(j)
      f_phi_basis(1:k,j) = f_phi_basis_copy(1:k,j) + phi_tan
d209 4
a212 3
    k = mfi + 2
    do j = 1, no_spectro
      spectroscopic(j)%PHI_BASIS(1:k) = s_phi_basis_copy(1:k,j) + phi_tan
d218 4
a221 4
    Call get_chi_angles(ndx_path(1:,l),n_path(1:,l),tan_press,tan_hts(1:,l),&
   &     tan_temp(1:,l),phi_tan,RoC,h_obs,elev_offset,tan_dh_dt(1:,l,1:),   &
   &     no_tan_hts,no_t,t_z_basis,si,center_angle,ptg_angles(1:,l),dx_dt,  &
   &     d2x_dxdt,ier)
d238 1
a238 1
      kk = no_ptg_frq(k)
d246 1
a246 1
        do j = 1, n_sps
d259 3
a261 3
        do j = 1, n_sps
          m = max(1,no_phi_f(j))
          i = max(1,no_coeffs_f(j))
d269 1
a269 1
        do m = 1, n_sps
d272 1
a272 1
          if(.not.spectroscopic(j)%DER_CALC(band)) CYCLE
d274 1
a274 1
          Spectag = spectroscopic(j)%Spectag
d276 4
a279 4
            if(spectroscopic(j)%Spectag /= Spectag) EXIT
            n = spectroscopic(j)%no_phi_values
            i = spectroscopic(j)%no_zeta_values
            CA = spectroscopic(j)%type
d299 1
a299 1
            if(j > 3 * n_sps) EXIT
d308 2
a309 2
      Call get_beta_path(ptg_i,pfa_spectrum,khi,no_ptg_frq, &
     &     ptg_frq_grid,z_path(ptg_i,l),t_path(ptg_i,l),beta_path,ier)
d313 1
a313 1
      do j = 1, n_sps
d321 1
a321 1
      F_grid(1:kk) = ptg_frq_grid(k)%values(1:kk)
d335 1
a335 1
        Call Rad_Tran(Frq, N_lvls, h_tan, n_sps, ndx_path(k,l),  &
d337 2
a338 2
       &    dHdz_path(k,l), earth_ref, beta_path(1:,frq_i),      &
       &    spsfunc_path(1:,k,l), ref_corr(1:,k), s_temp, brkpt, &
d346 1
a346 1
        CALL Rad_Tran_WD(frq_i,band,Frq,N_lvls,n_sps,z_path(k,l),       &
d348 8
a355 6
       &     atmospheric,beta_path(1:,frq_i),spsfunc_path(1:,k,l),      &
       &     t_z_basis,f_basis,no_coeffs_f,mr_f,no_t,ref_corr(1:,k),    &
       &     no_phi_f,f_phi_basis,temp_der,no_phi_t,t_phi_basis,        &
       &     dh_dt_path(k,l),spect_atmos,spectroscopic,k_temp_frq,      &
       &     k_atmos_frq,k_spect_dw_frq,k_spect_dn_frq,k_spect_dnu_frq, &
       &     is_f_log,brkpt,no_ele,mid,ilo,ihi,t_script,tau,ier)
d362 6
a367 5
      do i = 1, no_pfa_ch
        ch = pfa_ch(i)
        if(do_frqavg) then
          Call Freq_Avg(F_grid,F_grid_filter(1:,i),Filter_func(1:,i), &
       &                RadV,kk,no_filt_pts,Radiances(ptg_i,ch))
d378 1
a378 1
      if(temp_der) then
d380 2
a381 2
        do i = 1, no_pfa_ch
!         ch = pfa_ch(i)
d383 3
a385 3
          do j = 1, no_phi_t
            do k = 1, no_t
              if(do_frqavg) then
d387 3
a389 3
                Call Freq_Avg(F_grid,F_grid_filter(1:,i), &
               &              Filter_func(1:,i),          &
               &              RadV,kk,no_filt_pts,r)
d399 1
a399 1
      if(i > -3) goto 77           ! ** DEBUG, Bypass derivatives avg.
d404 2
a405 2
      do i = 1, no_pfa_ch
!       ch = pfa_ch(i)
d407 2
a408 2
        do j = 1, n_sps
          if(atmospheric(j)%der_calc(band)) THEN
d410 3
a412 3
            do k = 1, no_phi_f(j)
              do n = 1, no_coeffs_f(j)
                if(do_frqavg) then
d414 3
a416 3
                  Call Freq_Avg(F_grid,F_grid_filter(1:,i), &
                 &              Filter_func(1:,i),          &
                 &              RadV,kk,no_filt_pts,r)
d432 2
a433 2
      do i = 1, no_pfa_ch
!       ch = pfa_ch(i)
d435 1
a435 1
        do m = 1, n_sps
d437 2
a438 2
          if(.not.spectroscopic(j)%DER_CALC(band)) CYCLE
          Spectag = spectroscopic(j)%Spectag
d440 1
a440 1
            if(spectroscopic(j)%Spectag /= Spectag) EXIT
d442 3
a444 3
            CA = spectroscopic(j)%type
            do k = 1, spectroscopic(j)%no_phi_values
              do n = 1, spectroscopic(j)%no_zeta_values
d453 4
a456 4
                if(do_frqavg) then
                  Call Freq_Avg(F_grid,F_grid_filter(1:,i), &
                 &              Filter_func(1:,i),&
                 &              RadV,kk,no_filt_pts,r)
d471 1
a471 1
            if(j > 3 * n_sps) EXIT
d484 2
a485 2
    do i = 1, no_pfa_ch
      ch = pfa_ch(i)
d487 6
a492 5
      k_temp(i,kk,1:no_t,1:no_phi_t)=k_temp(i,kk-1,1:no_t,1:no_phi_t)
      do m = 1, n_sps
        if(atmospheric(m)%der_calc(band)) then
          k = no_phi_f(m)
          n = no_coeffs_f(m)
d496 1
a496 1
      do m = 1, n_sps
d498 2
a499 2
        if(.not.spectroscopic(j)%DER_CALC(band)) CYCLE
        Spectag =  spectroscopic(j)%Spectag
d501 3
a503 3
          if(spectroscopic(j)%Spectag /= Spectag) EXIT
          k = spectroscopic(j)%no_phi_values
          n = spectroscopic(j)%no_zeta_values
d508 1
a508 1
          if(j > 3 * n_sps) EXIT
d515 1
a515 1
    DO i = 1, no_pfa_ch
d517 1
a517 1
      ch = pfa_ch(i)
d519 1
a519 1
      if(do_conv) then
d521 11
a531 8
      Call convolve_all(ptg_press,atmospheric,n_sps,temp_der,tan_press,&
     &     ptg_angles(1:,l),tan_temp(1:,l), dx_dt, d2x_dxdt,band,      &
     &     center_angle,fft_pts,Radiances(1:,ch),k_temp(i,1:,1:,1:),   &
     &     k_atmos(i,1:,1:,1:,1:), k_spect_dw(i,1:,1:,1:,1:),          &
     &     k_spect_dn(i,1:,1:,1:,1:),k_spect_dnu(i,1:,1:,1:,1:),       &
     &     spect_atmos,no_tan_hts,k_info_count,i_star_all(i,1:),       &
     &     k_star_all(i,1:,1:,1:,1:),k_star_info,no_t,no_phi_t,        &
     &     no_phi_f,InDir,Aaap,spectroscopic,t_z_basis,Ier)
d535 8
a542 7
      Call no_conv_at_all(ptg_press,n_sps,tan_press,band,Radiances(1:,ch), &
     &     k_temp(i,1:,1:,1:),k_atmos(i,1:,1:,1:,1:),                      &
     &     k_spect_dw(i,1:,1:,1:,1:), k_spect_dn(i,1:,1:,1:,1:),           &
     &     k_spect_dnu(i,1:,1:,1:,1:), spect_atmos, no_tan_hts,            &
     &     k_info_count, i_star_all(i,1:), k_star_all(i,1:,1:,1:,1:),      &
     &     k_star_info,temp_der,no_t,no_phi_t,no_phi_f,t_z_basis,          &
     &     atmospheric,spectroscopic)
d551 1
a551 1
  do j = 1, n_sps
d560 1
a560 1
    if(do_conv) then
d567 1
a567 1
      Frq = ptg_frq_grid(jj)%values(Freq_Index)
d576 5
a580 5
    zref(1:) = 0.0
    kk = ptg_press%no_lin_values
    zref(1:kk) = dble(ptg_press%lin_val(1:kk))
    Call Hunt(Zeta,zref,kk,klo,j)
    IF(ABS(Zeta-zref(j)) < ABS(Zeta-zref(klo))) klo=j
d582 2
a583 2
    do i = 1, no_pfa_ch
      ch = pfa_ch(i)
d591 1
a591 1
    href(1:) = 0.0
d609 1
a609 1
          Print *,' dI/dT, Phi = 1..',ht_i
d611 1
a611 1
          Print *,' dI/d',Name(1:l),', Phi = 1..',ht_i
d613 4
a616 4
        href(1:) = 0.0
        href(1:mnz) = k_star_info(i)%zeta_basis(1:mnz)
        Call Hunt(Zeta,href,mnz,m,j)
        IF(ABS(Zeta-href(j)) < ABS(Zeta-href(m))) m=j
d620 1
d622 1
a622 5
 99  CLOSE(11,iostat=i)
     CLOSE(13,iostat=i)
     CLOSE(32,iostat=i)
!
     if(io /= 0) then
d632 1
a632 1
     Ax(1:40) = ' '
a648 76
!---------------------------------------------------------------------------

SUBROUTINE radiometry(ch, f_p, f_i, db_fi, lmt)

! This subroutine calculates the center frequency of the primary and image
! sideband by channel. It also Returns the bandwidth limits of integration
! and the gain of the primary sideband relative to the image in db units.

INTEGER(i4), INTENT(IN) :: ch
INTEGER(i4), INTENT(OUT) :: lmt

REAL(r8), INTENT(OUT) :: f_p
REAL(r8), INTENT(OUT) :: f_i
REAL(r8), INTENT(OUT) :: db_fi

LOGICAL, SAVE :: sgn_fp(6) = (/                                    &
                 .false., .true., .false., .true., .true., .false./)

INTEGER(i4) :: band, sub_ch, j

Real(r4), SAVE :: db_fi_data(90) =(/                   &
     &    -0.5218,  0.0000,  0.5218,  0.8264,  0.9654, &
     &     1.0332,  1.0668,  1.0890,  1.1111,  1.1440, &
     &     1.2091,  1.3365,  1.5807,  0.3476, -3.6798, &
     &    -1.7854, -1.6204, -1.5519, -1.5142, -1.4966, &
     &    -1.4884, -1.4840, -1.4811, -1.4783, -1.4741, &
     &    -1.4659, -1.4486, -1.4167, -1.3607, -1.2602, &
     &    -1.0409, -1.1206, -1.1641, -1.1874, -1.1995, &
     &    -1.2052, -1.2084, -1.2104, -1.2124, -1.2157, &
     &    -1.2216, -1.2347, -1.2607, -1.3128, -1.4233, &
     &    -1.0921, -1.2329, -1.2863, -1.3121, -1.3234, &
     &    -1.3284, -1.3309, -1.3327, -1.3343, -1.3367, &
     &    -1.3416, -1.3507, -1.3667, -1.3884, -1.4035, &
     &     0.6661,  0.6480,  0.7759,  0.8029,  0.8741, &
     &     0.8307,  0.9736,  0.9273,  0.5800,  0.8906, &
     &     0.9772,  0.9596,  0.9426,  0.8669,  0.7433, &
     &     0.3108,  1.0632,  0.7029,  0.4426,  0.2910, &
     &     0.2261,  0.2396,  0.2244,  0.2237,  0.1811, &
     &     0.1795,  0.1534,  0.1418,  0.3651,  0.5647 /)
!

REAL(r8), SAVE :: f_prime(6) = (/                          &
    63568.418D0, 204352.161D0, 204574.627D0, 206132.067D0, &
    183310.062D0, 184377.788D0/)

REAL(r8), SAVE :: f_image(6) = (/                          &
    62997.812D0, 202181.555D0, 201959.089D0, 200401.648D0, &
    186245.513D0, 185177.788D0/)

REAL(r8) :: ch_offset

  band = (ch - 1) / 15 + 1
  sub_ch = ch - 15 * (band - 1)
!
  IF(sub_ch == 8) THEN
    j = 0
    lmt = 1
  ELSE                      ! Above and below the spectral center
    lmt = 2**(ABS(sub_ch - 8) - 1)
    j = SIGN(3*lmt - 1, sub_ch - 8)
  END IF

  ch_offset = float(j)
  db_fi = db_fi_data(ch)

  IF(sgn_fp(band)) THEN
    f_p = f_prime(band) + ch_offset
    f_i = f_image(band) - ch_offset
  ELSE
    f_p = f_prime(band) - ch_offset
    f_i = f_image(band) + ch_offset
  END IF

  Return
END SUBROUTINE radiometry

@


1.3
log
@Changes and additions
@
text
@a3 1
  use STRINGS, only: STRLWR
d25 1
d34 1
a34 1
Logical :: temp_der
d36 1
a36 1
Integer(i4) :: p_indx(Nlvl), SPECT_ATMOS(Nsps), no_ptg_frq(Nptg), &
d41 1
a41 1
               ld, ch, Spectag, no_freqs, no_pfa_ch, prev_npf, n_obs, &
d45 1
a45 1
               k_info_count,  no_mmaf, gl_count
d63 1
a63 1
Real(r8) :: z_grid(Nlvl),dh_dt_glgrid(ngt,mnp,mxco), dhdz_glgrid(ngt,mnp)
d65 1
a65 1
Real(r8) :: ptg_angles(Nptg,mnm), center_angle
d93 1
a93 1
real(r8) :: I_STAR_ALL(Nch)
d105 2
a106 2
Real(r8) :: RadV(mnf), f_grid(mnf)
Real(r8) :: s_temp, h_obs, earth_ref, e_rad, zeta, Frq, h_tan, Rad, &
d126 20
a145 1
! Read the inputs from a file...
d149 2
a150 1
  Fnd = '/user5/zvi/mod_seez'
d212 1
a212 1
    CALL radiometry(i,q,r,zeta,kk)     ! DEBUG, Added Jan/23/2000, Z.S
d298 8
a305 7
  if (band >= 5) then                       ! 183
    elev_offset = elev_183 * deg2rad
  else if (band >= 2) then                  ! 205
    elev_offset = elev_205 * deg2rad
  else                                      ! 63 / pointing reference
    elev_offset = 0.0
  end if
d375 1
a375 1
        pfa_spectrum(j)%SPS_PS(i) = thbs(5)
d547 1
a547 1
  read(11,*,iostat=io) ((t_coeff(i,j),j=1,no_phi_t),i=1,no_t)
a549 10
! Complete the t_coeff array to have full NO_MMAF cover
!
  khi = no_phi_t + 1
  do
    klo = khi
    khi = klo + no_phi_t - 1
    if(khi > no_mmaf) EXIT
    t_coeff(1:no_t,klo:khi) = t_coeff(1:no_t,1:no_phi_t)
  end do

d609 2
a610 1

d616 2
a617 2
  Call get_filters(no_pfa_ch,no_filt_pts,pfa_ch,f_grid_filter, &
 &                 freqs,filter_func,InDir,ld,primag,ier)
d633 2
a634 1
  phi_tan = phi_tan_mmaf(1)
d639 1
a639 1
  Call hydrostatic_model(si, n_lvls, no_t, no_mmaf, t_indx,        &
d646 3
d661 2
a662 2
  Close(32,iostat=i)
  Open(32,file=Fnd,action='READ',status='OLD',iostat=io)
d681 4
a684 1
    ALLOCATE(ptg_frq_grid(k)%values(jp),STAT=i)
d723 1
a723 1
 44 Close(32,iostat=i)
d730 21
d765 1
a765 1
  DO l = 1, 1                 ! ** DEBUG, only one mmaf
d786 2
a787 2
   &     n_lvls,no_tan_hts,no_t,t_z_basis,z_grid,si,center_angle,           &
   &     ptg_angles(1:,l),dx_dt,d2x_dxdt,ier)
d789 1
a789 1

a794 7
! *** DEBUG
    klo = -1
    zeta = -1.666667
    Call Hunt(zeta,tan_press,no_tan_hts,klo,khi)
    IF(ABS(zeta-tan_press(khi)) < ABS(zeta-tan_press(klo))) klo = khi
! *** END DEBUG
!
d809 1
a809 1
        f_grid(1:mnf) = 0.0
d887 4
a890 1
      f_grid(1:kk) = ptg_frq_grid(k)%values(1:kk)
d892 6
a897 1
      do frq_i = 1, kk
d899 1
a899 1
        Frq = f_grid(frq_i)
d928 6
a933 4
        Call Freq_Avg(f_grid,F_grid_filter(1:,i),Filter_func(1:,i), &
       &              RadV,kk,maxfiltpts,Rad,Ier)
        IF(ier /= 0) goto 99
        Radiances(ptg_i,ch) = Rad
d948 8
a955 4
              RadV(1:kk) = k_temp_frq%values(1:kk,k,j)
              Call Freq_Avg(f_grid,F_grid_filter(1:,i),Filter_func(1:,i), &
       &           RadV,kk,maxfiltpts,r,Ier)
              IF(ier /= 0) goto 99
d962 1
a962 1
!     if(i > -3) goto 77           ! ** DEBUG, Bypass derivatives avg.
d975 8
a982 4
                RadV(1:kk) = k_atmos_frq(j)%values(1:kk,n,k)
                Call Freq_Avg(f_grid,F_grid_filter(1:,i),Filter_func(1:,i), &
       &             RadV,kk,maxfiltpts,r,Ier)
                IF(ier /= 0) goto 99
d1016 7
a1022 3
                Call Freq_Avg(f_grid,F_grid_filter(1:,i),Filter_func(1:,i),&
               &              RadV,kk,maxfiltpts,r,Ier)
                IF(ier /= 0) goto 99
d1078 1
d1080 6
a1085 3
      Call convolve_all(ch, ptg_press, atmospheric, n_sps, temp_der,   &
     &     tan_press,ptg_angles(1:,l),tan_temp(1:,l), dx_dt, d2x_dxdt, &
     &     band,center_angle,fft_pts,Radiances(1:,ch),k_temp(i,1:,1:,1:), &
d1088 16
a1103 3
     &     spect_atmos,no_tan_hts,k_info_count,i_star_all,k_star_all,  &
     &     k_star_info,no_t,no_phi_t,no_phi_f,InDir,Aaap,spectroscopic,&
     &     Ier)
d1118 22
a1139 1
    kk = no_tan_hts - si + 1
d1143 1
a1143 1
      write(*,905) (Radiances(k,ch),k=si,no_tan_hts)
d1145 1
a1145 1
903 format('ch',i2.2,'_avg_pfa_rad',a1,i2.2)
d1148 16
a1163 77
!   if(kk > -5) goto 99      ! Bypass print of ALL derivatives
!
     frq_i = 1
     Spectag = 18003
!    ch = pfa_ch(1)
     ch = 1                  ! ** DEBUG, memory limitations on MLSGATE
!
     m = -1
     do j = 1, n_sps
       if(atmospheric(j)%SPECTAG == Spectag) then
         m = j
         EXIT
       endif
     end do

!   if(m < -100) then           ! Bypass print of k_atmos derivatives
    if(m > 0) then
      Ax(1:)=' '
      k = no_coeffs_f(m)
      Ax = 'avg_k_'//atmospheric(m)%NAME
      l = Len_Trim(Ax) + 1
      Ax = Ax(1:l-1)//'_'
      Call StrLwr(Ax)
      j = (no_phi_f(m)+1)/2
      Call Hunt(zeta,f_basis(1:,m),k,kz,i)
      IF(ABS(zeta-f_basis(i,m)) < ABS(zeta-f_basis(kz,m))) kz = i
      Print 900,Ax(1:l),frq_i,frq_i
      Print 901, k_atmos(ch,klo,kz,j,m)
    endif
!
!   if(kk > -5) goto 99            ! Bypass print of k_temp derivatives
!
    j = (no_phi_t+1)/2
    Call Hunt(zeta,t_z_basis,no_t,kz,i)
    IF(ABS(zeta-t_z_basis(i)) < ABS(zeta-t_z_basis(kz))) kz = i
    Print 900,'avg_k_temp_',frq_i,frq_i
    Print 901, k_temp(ch,klo,kz,j)
!
!   if(kk > -5) goto 99            ! Bypass print of k_spect derivatives
!
!   ch = pfa_ch(1)
    ch = 1                  ! ** DEBUG, memory limitations on MLSGATE
!
    do m = 1, n_sps
      j = spect_atmos(m)
      if(.not.spectroscopic(j)%DER_CALC(band)) CYCLE
      Spectag =  spectroscopic(j)%Spectag
      DO
        if(spectroscopic(j)%Spectag /= Spectag) EXIT
        CA = spectroscopic(j)%type
        Ax(1:) = ' '
        RadV(1:mnf) = 0.0
        kk = spectroscopic(j)%no_phi_values
        ht_i = spectroscopic(j)%no_zeta_values
        select case ( CA )
          case ( 'W' )
            Ax = 'avg_k_spect_dw_'
            r = SUM(k_spect_dw(ch,klo,1:ht_i,1:kk,j))
          case ( 'N' )
            Ax = 'avg_k_spect_dn_'
            r = SUM(k_spect_dn(ch,klo,1:ht_i,1:kk,j))
          case ( 'V' )
            Ax = 'avg_k_spect_dnu_'
            r = SUM(k_spect_dnu(ch,klo,1:ht_i,1:kk,j))
        end select
        i = Len_Trim(Ax)
        Print 900,Ax(1:i),frq_i,ht_i*kk
        do k = 1, ht_i
          select case ( CA )
            case ( 'W' )
              Print 901,(k_spect_dw(ch,klo,k,i,j),i=1,kk)
            case ( 'N' )
              Print 901,(k_spect_dn(ch,klo,k,i,j),i=1,kk)
            case ( 'V' )
              Print 901,(k_spect_dnu(ch,klo,k,i,j),i=1,kk)
          end select
        end do
d1165 12
a1176 3
        j = j + 1
        if(j > 3 * n_sps) EXIT
      END DO
d1179 3
a1181 2
900 format(a,i2.2,'\',i3.3)
901 format(5(2x,1pe13.6))
d1183 4
a1186 3

 99  CLOSE(11,iostat=i)
     if(io /= 0) Call ErrMsg(' ',io)
@


1.2
log
@New version of forward model
@
text
@d19 2
d40 6
a45 5
Integer(i4) :: i, j, k, kk, ht_i, no_t, mnz, no_geom, no_tan_hts, kz, ld, ch, &
               no_atmos, ch1, ch2, n_lvls, si, mfi, jp, band, n_sps, Spectag, &
               no_freqs, ptg_i, frq_i, io, klo, khi, m, l, n, brkpt, no_ele, &
               mid, ilo, ihi, no_pfa_ch, n_obs, ier, no_filt_pts, no_phi_t,&
               k_info_count, prev_npf, no_mmaf, gl_count, fft_pts
d49 2
a50 2
                     n_path(Nptg,mnm),phi_path(Nptg,mnm),dhdz_path(Nptg,mnm),&
                     spsfunc_path(Nsps,Nptg,mnm)
d57 1
a57 1
            t_coeff(mxco,mnm),ref_corr(N2lvl,Nptg),tau(N2lvl),  &
d70 1
a70 1
real(r8) :: freq_grid(mnf),freq(Nch)
d102 1
a102 1
Type(path_beta) :: beta_path(Nsps,mnf,Nptg,mnm)
d112 1
d114 1
a114 1
Character (LEN=80) :: InDir, Aaap, Fnd
d120 1
a120 1
Type (pfa_slab)        :: PFA_SPECTRUM(6,Nsps)
d130 1
a130 2
  Fnd = '/user5/zvi/new_seez'     ! SUN, MLSGATE, VANPC
! Fnd = '/home/zvi/new_seez'      ! HOME PC
d155 1
d190 1
a190 1
  freq(1:Nch) = 0.0D0
d192 3
a194 3
    CALL radiometry(i,q,r,zeta,kk)    ! DEBUG, Added Jan/23/2000, Z.S
    IF(primag == 'p') freq(i) = q     ! DEBUG, Added Jan/23/2000, Z.S
    IF(primag == 'i') freq(i) = r     ! DEBUG, Added Jan/23/2000, Z.S
d196 1
a196 1

d302 4
a305 1
  read(11,'(A)',iostat=io) Ax
d307 18
a324 2
  do i = 1, n_sps
    read(11,*,iostat=io) pfa_spectrum(band,i)%NO_SPS
a325 5
    read(11,*,iostat=io) pfa_spectrum(band,i)%NO_LINES
    if(io /= 0) goto 99
    read(11,*,iostat=io) pfa_spectrum(band,i)%SPS_SPECTAG
    if(io /= 0) goto 99
  end do
d327 38
d485 1
d602 6
a607 1

d714 6
a719 8
  Primag = 'p'
  Call comp_path_entities(primag,n_lvls,no_t,gl_count,ndx_path,z_glgrid, &
       t_glgrid,h_glgrid,dhdz_glgrid,dh_dt_glgrid,atmospheric,no_atmos,  &
       f_basis,mr_f,no_coeffs_f,freq,tan_hts,no_tan_hts,n_sps,no_pfa_ch, &
       no_filt_pts,pfa_ch,pfa_spectrum,f_grid_filter,filter_func,InDir,  &
       ld,band,no_phi_f,f_phi_basis,z_path,h_path,t_path,phi_path,       &
       n_path,dhdz_path,dh_dt_path,no_phi_t,t_phi_basis,spsfunc_path,    &
       no_ptg_frq,ptg_frq_grid,is_f_log,beta_path,no_mmaf,phi_tan_mmaf,ier)
a723 2
  jp = no_phi_t/2

d837 8
a844 1

d858 1
a858 1
        Frq = ptg_frq_grid(k)%values(frq_i)
d862 1
a862 1
       &    dHdz_path(k,l), earth_ref, beta_path(1:,frq_i,k,l),  &
d873 1
a873 1
       &     atmospheric,beta_path(1:,frq_i,k,l),spsfunc_path(1:,k,l),  &
@


1.1
log
@New version
@
text
@d2 1
a2 12
  use GL6P
  use EOS_MDB, only: CS_MNF => MAX_FREQ
  use L2PC_FILE_PARAMETERS, only: DEG2RAD,                  &
                                  mnsv => MAX_NO_SV_ELMNTS, &
                                  mxco => MAX_NO_ELMNTS_PER_SV_COMPONENT
  use L2PC_PFA_STRUCTURES, only: ATMOS_COMP, GEOM_PARAM, &
                                 MAXAITKENPTS, MAXFILTPTS,  &
                                 PFA_SLAB, SPECTRO_PARAM,  MAXPFACH, &
                                 EARTH_MAJOR, EARTH_MINOR, &
                                 MAXGEOM, MAXLINES
  use L2PC_FILE_STRUCTURES, only: L2PC_HEADER_ONE
  use L2PCdim, only: Nlvl, N2lvl, NSPS, Nptg, NCH, MNP => max_no_phi
d5 9
a13 4
  use MDBETA, only: NO_T_PHI
  use ELLIPSE, only: A2, C2, C2OA2, CPT, SPT, CPS, SPS, CPTS, SPTS, HT, &
      HT2, RR, PHI_TAN, NPHI_TAN, PHI_S, NPHI_S, PS, ROC, XOC, YOC, EARTHX
  use FWD_MDL_SET_UP_M, only: FWD_MDL_SET_UP
d17 3
d22 2
d28 1
a28 2
Integer(i4), PARAMETER :: ngt = (Ng+1) * Nlvl
Integer(i4), PARAMETER :: Npath = 2 * ngt
d30 1
a30 1
Integer(i4), PARAMETER :: mnf = 25
d34 30
a63 24
Integer(i4) :: p_indx(Nlvl), N_TAN(Nlvl),no_filt_pts,  &
  ier, no_phi_t, no_spectro, SPECT_ATMOS(Nsps),        &
  no_coeffs_f(Nsps), no_phi_f(Nsps), n_obs, NO_SPS_TBL(6), no_pfa_ch,    &
  SPECT_INDEX(Nsps), ATMOS_INDEX(Nsps), NDX_SPS(Nsps,MAXPFACH),          &
  SPS_TBL(Nsps,6),pfa_ch(MAXPFACH),NO_INT_FRQS(MAXPFACH),NO_PHI_VEC(mnsv)

Integer(i4) :: i, j, k, kk, ht_i, no_t, mnz, no_geom, no_tan_hts, ld, &
               no_atmos, ch1, ch2, geo_i, n_lvls, si, mfi, band, n_sps, &
               no_freqs, ptg_i, frq_i, io, klo, khi, m, l, brkpt, no_ele, &
               mid, ilo, ihi

Type(path_index)  :: ndx_path(Nptg)
Type(path_vector) :: z_path(Nptg),t_path(Nptg),h_path(Nptg), &
                     n_path(Nptg),phi_path(Nptg),dhdz_path(Nptg), &
                     spsfunc_path(Nsps,Nptg)

Type(path_derivative) :: dh_dt_path(Nptg)

Real(r8) :: href(Nlvl), zref(Nlvl), t_tan(Nptg), tan_hts(Nptg),  &
            tan_hts_raw(Nptg), tan_press(Nptg), tan_temp(Nptg), &
            t_coeff(mxco,mnp), t_z_basis(mxco), t_phi_basis(mnp), &
            tan_dh_dt(Nlvl,mxco),z_grid(Nlvl), Frq, h_tan, Rad, &
            t_grid(Nlvl),h_grid(Nlvl),z_gnlv(400), e_rad, cse, Rs, &
            ref_corr(N2lvl,Nptg), t_script(N2lvl), tau(N2lvl)
d67 6
a72 4
real(r8) :: C_FREQ(Nch), freq_grid(mnf)
real(r8) :: MR_F(mxco,mnp,Nsps)
real(r8) :: F_BASIS(mxco,Nsps), PHI_BASIS_F(mnp,Nsps)
real(r8) :: F_GRID(maxaitkenpts,maxpfach)
a73 1
real(r8) :: FILTER_FUNC(maxfiltpts,maxpfach)
d75 45
a119 20
Real(r4) :: K_TEMP(Nptg,mxco,mnp)
Real(r4) :: K_ATMOS(Nptg,mxco,mnp,Nsps)
Real(r4) :: K_SPECT_DW(Nptg,mxco,mnp,Nsps),  &
            K_SPECT_DN(Nptg,mxco,mnp,Nsps),  &
            K_SPECT_DNU(Nptg,mxco,mnp,Nsps)
!
Type(path_beta) :: beta_path(Nsps,mnf,Nptg)

Real(r8) :: S_TEMP, H_OBS, EARTH_REF, ZRoC, geoc_lat, q, r
Real(r8) :: RadV(Nptg)
!
Character :: Primag
Character (LEN=40) :: Ax, Fdata
Character (LEN=80) :: InDir, Fnd

Type (l2pc_header_one) :: HEADER1
Type (atmos_comp) :: ATMOSPHERIC(Nsps)
Type (geom_param) :: GEOMETRIC(maxgeom)
Type (spectro_param) :: SPECTROSCOPIC(3*Nsps)
Type (pfa_slab)   :: PFA_SPECTRUM(6,Nsps)
d125 3
a127 3
  Fdata(1:) = ' '
  Fdata = '/user5/zvi/seez'     ! SUN
! Fdata = '/home/zvi/seez'      ! PC
d129 21
a149 1
  OPEN(11,file=Fdata,status='OLD',action='READ',iostat=io)
d152 1
a152 1
  no_int_frqs(1:maxpfach) = 0
d157 2
a158 2
  kk = 0
  read(11,*,iostat=io) kk
d161 10
a170 2
  HEADER1%NO_POINTINGS = kk
  read(11,*,iostat=io) (HEADER1%sv_components(i),i=1,kk)
d172 2
a173 1
  read(11,*,iostat=io) (HEADER1%no_elmnts_per_sv_component(i),i=1,kk)
d175 2
a176 9
  read(11,*,iostat=io) (HEADER1%sv_component_first_elmnt_index(i),i=1,kk)
  if(io /= 0) goto 99
  read(11,*,iostat=io) HEADER1%no_bands
  if(io /= 0) goto 99
  read(11,*,iostat=io) HEADER1%no_channels_per_band
  if(io /= 0) goto 99
  read(11,*,iostat=io) HEADER1%no_sv_components
  if(io /= 0) goto 99
  read(11,*,iostat=io) HEADER1%no_coeff_per_component
d182 1
a182 1
  read(11,*,iostat=io) ch1, ch2
d184 8
d196 1
a196 1
  read(11,*,iostat=io) no_pfa_ch
d199 1
a199 1
  read(11,'(A)',iostat=io) Ax
d202 2
a203 1
  read(11,*,iostat=io) (pfa_ch(i),i=1,no_pfa_ch)
d216 1
a216 1
    read(11,*,iostat=io) GEOMETRIC(i)
d218 12
d241 2
a242 1
  read(11,*,iostat=io) (atmos_index(i),i=1,no_atmos)
d254 1
a254 1
    read(11,*,iostat=io) k, ht_i
d256 1
a256 1
    atmospheric(j)%SPECTAG = k
d274 24
a317 3
  SPECT_INDEX(1:Nsps) = -1
  SPECT_ATMOS(1:Nsps) = -1

d325 9
d343 1
a343 1
    read(11,*,iostat=io) ht_i
d345 1
a345 1
    spectroscopic(j)%SPECTAG = ht_i
d354 2
a355 1
    read(11,*,iostat=io) (spectroscopic(j)%PHI_BASIS(i),i=1,mfi+2)
d357 2
d366 1
a366 1
    kk = atmospheric(k)%Spectag
d368 1
a368 1
      if(kk == spectroscopic(i)%Spectag) then
d383 3
d389 2
a390 2
  Fnd(1:)=' '
  read(11,'(A)',iostat=io) Fnd
d392 1
a392 1
  Fnd = AdjustL(Fnd)
d399 5
d408 1
a408 1
  read(11,*,iostat=io) q, r, phi_tan, geoc_lat
a413 8
! Add phi_tan to the spectroscopic phi's and convert to radiance:
!
  do j = 1, no_spectro
    i = spectroscopic(j)%NO_PHI_VALUES
    spectroscopic(j)%PHI_BASIS(1:i) = (spectroscopic(j)%PHI_BASIS(1:i) + &
   &                                   phi_tan) * deg2rad
  end do
!
d423 7
a429 1
  read(11,*,iostat=io) (z_gnlv(i),i=1,mnz)
d435 1
a435 1
  read(11,*,iostat=io) (tan_hts_raw(i),i=1,no_tan_hts)
d444 7
d463 3
d471 10
d488 9
d508 13
a520 9

  DO geo_i = 1, no_atmos
    kk = no_phi_f(geo_i)
    ht_i = no_coeffs_f(geo_i)
    read(11,*,iostat=io) (f_basis(i,geo_i),i=1,ht_i)
    if(io /= 0) goto 99
    read(11,*,iostat=io) (phi_basis_f(i,geo_i),i=1,kk)
    if(io /= 0) goto 99
    read(11,*,iostat=io) ((mr_f(i,j,geo_i),j=1,kk),i=1,ht_i)
d537 8
d549 1
d556 96
d653 7
a659 12
  Call fwd_mdl_set_up(Primag,href,zref,e_rad,z_grid,t_grid,h_grid,    &
 &     ndx_path,n_lvls,geometric,no_geom,t_z_basis,t_coeff,no_t,      &
 &     geoc_lat,atmospheric,no_atmos,f_basis,mr_f,no_coeffs_f,c_freq, &
 &     si,earth_ref,s_temp,h_obs,n_obs,tan_hts_raw,tan_hts,tan_press, &
 &     tan_temp,no_tan_hts,no_sps_tbl,sps_tbl,no_pfa_ch,no_filt_pts,  &
 &     pfa_ch,no_int_frqs,pfa_spectrum,t_tan,ndx_sps,n_tan,           &
 &     f_grid_filter,f_grid,filter_func,ch1,ch2,InDir,ld,             &
 &     header1,no_phi_f,phi_basis_f,atmos_index,no_phi_vec,z_path,    &
 &     h_path,t_path,phi_path,n_path,dhdz_path,dh_dt_path,Npath,      &
 &     no_phi_t,t_phi_basis,ZRoC,spectroscopic,no_spectro,            &
 &     spect_index,tan_dh_dt,no_freqs,freq_grid,spsfunc_path,         &
 &     is_f_log,beta_path,ier)
d662 20
a681 1
! Compute the refraction correction scaling matrix:
d683 2
a684 2
  CALL refraction_correction(no_tan_hts, tan_hts, h_path, n_path, &
 &                           ndx_path, E_rad, ref_corr)
d686 7
a692 1
! Now, Compute the radiances alone:
d694 2
a695 3
  RadV(:Nptg) = 0.0
  temp_der = .true.
! temp_der = .false.
d698 4
a701 3
     r = -1.66667
     Call Hunt(r,tan_press,no_tan_hts,klo,khi)
     IF(ABS(r-tan_press(khi)) < ABS(r-tan_press(klo))) klo = khi
a702 2

  do ptg_i = 1, no_tan_hts-1
d704 2
a705 2
    k = ptg_i
    h_tan = tan_hts(k)
d707 1
a707 2
!   do frq_i = 1, no_freqs
    do frq_i = 1, 1               ! ** DEBUG
d709 1
a709 1
      Frq = freq_grid(frq_i)
d711 90
a800 6
      Call Rad_Tran(Frq,N_lvls,h_tan,band,n_sps, sps_tbl, ndx_path(k), &
      &    z_path(k), h_path(k), t_path(k), phi_path(k), dHdz_path(k), &
      &    earth_ref, beta_path(1:,frq_i,k), spsfunc_path(1:,k),       &
      &    ref_corr(1:,k), s_temp, brkpt, no_ele, mid, ilo, ihi, cse,  &
      &    Rs, t_script, tau, Rad, Ier)
      IF(ier /= 0) goto 99
d802 1
a802 1
      if(frq_i == 1) RadV(ptg_i) = Rad
d806 48
a853 10
      CALL Rad_Tran_WD(ptg_i,frq_i,Frq,N_lvls,band,n_sps,sps_tbl,    &
   &       z_path(k), h_path(k), t_path(k), phi_path(k), dHdz_path(k),     &
   &       atmospheric, beta_path(1:,frq_i,k), spsfunc_path(1:,k),  &
   &       t_z_basis, f_basis, no_coeffs_f, mr_f, no_t, ref_corr(1:,k),    &
   &       no_phi_f, phi_basis_f, temp_der, no_phi_t, t_phi_basis,         &
   &       dh_dt_path(k), k_atmos, k_temp, spect_atmos,            &
   &       spectroscopic, k_spect_dw, k_spect_dn, k_spect_dnu,             &
   &       is_f_log, brkpt, no_ele, mid, ilo, ihi, t_script, tau, &
   &       Ier)
      IF(ier /= 0) goto 99
d855 98
d955 22
d979 1
a979 1
  RadV(no_tan_hts) = RadV(no_tan_hts-1)
d981 8
a988 1
! *** DEBUG Print
d990 1
a990 6
     k = 61
     j = no_tan_hts
     kk = j - si + 1
     write(*,'(''pfa_rad'',a1,i2.2)') char(92),kk
     write(*,905) (RadV(k),k=si,j)
905  format(4(2x,1pg15.8))
d993 3
a995 1
     k = 18003
d999 1
a999 1
       if(atmospheric(j)%SPECTAG == k) then
d1005 1
a1005 1
!   if(m < -100) then               ! Bypass print
d1009 3
a1011 3
      Ax = 'k_'//atmospheric(m)%NAME
      l = Len_Trim(Ax)
      Ax = Ax(1:l)//'_'
d1014 4
a1017 2
      Print 900,Ax(1:l+1),frq_i,k
      Print 901,(k_atmos(klo,i,j,m),i=1,k)
d1020 2
d1023 48
a1070 27
    Print 900,'k_temp_',frq_i,no_t
    Print 901,(k_temp(klo,i,j),i=1,no_t)
!
    kk = spectroscopic(1)%no_phi_values
    ht_i = spectroscopic(1)%no_zeta_values
    Print 900,'k_spect_dw_',frq_i,ht_i*kk
    r = SUM(k_spect_dw(klo,1:ht_i,1:kk,1))
    do k = 1, ht_i
      Print 901,(k_spect_dw(klo,k,j,1),j=1,kk)
    end do
    Print *,'  Sum over all zeta & phi coeff:',sngl(r)
!
    kk = spectroscopic(2)%no_phi_values
    ht_i = spectroscopic(2)%no_zeta_values
    r = SUM(k_spect_dn(klo,1:ht_i,1:kk,1))
    Print 900,'k_spect_dn_',frq_i,ht_i*kk
    do k = 1, ht_i
      Print 901,(k_spect_dn(klo,k,j,1),j=1,kk)
    end do
    Print *,'  Sum over all zeta & phi coeff:',sngl(r)
!
    kk = spectroscopic(3)%no_phi_values
    ht_i = spectroscopic(3)%no_zeta_values
    r = SUM(k_spect_dnu(klo,1:ht_i,1:kk,1))
    Print 900,'k_spect_dnu_',frq_i,ht_i*kk
    do k = 1, ht_i
      Print 901,(k_spect_dnu(klo,k,j,1),j=1,kk)
a1071 1
    Print *,'  Sum over all zeta & phi coeff:',sngl(r)
d1080 18
d1100 1
d1102 107
d1210 1
a1210 1
Function I2C(n)
d1212 5
a1216 2
Integer n
Character(LEN=12) I2C,Zx
d1218 1
a1218 3
   Zx(1:)=' '
   write(Zx,*) n
   I2C = AdjustL(Zx)
d1220 2
a1221 1
end Function I2C
@

