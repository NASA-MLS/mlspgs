head	2.15;
access;
symbols
	v5-02-NRT-19:2.15
	v6-00:2.15
	v5-02-NRT-18:2.15
	v5-02:2.13
	v5-01-NRT-17:2.15
	v5-01-NRT-16:2.14
	v5-01-NRT-15:2.14
	v5-01-NRT-14:2.14
	neuralnetworks-1-0:2.13.0.4
	cfm-single-freq-0-1:2.13.0.2
	v5-01:2.13
	v5-00:2.13
	v4-23-TA133:2.12.0.4
	mus-emls-1-70:2.12.0.2
	rel-1-0-englocks-work:2.11.0.2
	VUMLS1-00:2.4
	VPL1-00:2.2;
locks; strict;
comment	@# @;


2.15
date	2022.07.07.22.10.49;	author pwagner;	state Exp;
branches;
next	2.14;

2.14
date	2021.04.01.23.44.21;	author pwagner;	state Exp;
branches;
next	2.13;

2.13
date	2019.07.22.22.18.10;	author pwagner;	state Exp;
branches;
next	2.12;

2.12
date	2018.04.13.00.23.27;	author pwagner;	state Exp;
branches;
next	2.11;

2.11
date	2018.04.03.23.16.36;	author pwagner;	state Exp;
branches;
next	2.10;

2.10
date	2018.02.28.19.50.46;	author pwagner;	state Exp;
branches;
next	2.9;

2.9
date	2017.11.30.20.47.31;	author pwagner;	state Exp;
branches;
next	2.8;

2.8
date	2017.09.07.23.44.30;	author pwagner;	state Exp;
branches;
next	2.7;

2.7
date	2017.07.31.23.04.24;	author pwagner;	state Exp;
branches;
next	2.6;

2.6
date	2017.07.31.22.18.22;	author vsnyder;	state Exp;
branches;
next	2.5;

2.5
date	2017.07.19.22.38.31;	author pwagner;	state Exp;
branches;
next	2.4;

2.4
date	2016.12.14.01.20.55;	author pwagner;	state Exp;
branches;
next	2.3;

2.3
date	2016.09.09.20.09.51;	author pwagner;	state Exp;
branches;
next	2.2;

2.2
date	2016.07.28.03.29.28;	author vsnyder;	state Exp;
branches;
next	2.1;

2.1
date	2016.07.28.01.41.48;	author vsnyder;	state Exp;
branches;
next	;


desc
@@


2.15
log
@Fixed bug that mingled transpose with table
@
text
@! Copyright 2005, by the California Institute of Technology. ALL
! RIGHTS RESERVED. United States Government Sponsorship acknowledged. Any
! commercial use must be negotiated with the Office of Technology Transfer
! at the California Institute of Technology.

! This software may be subject to U.S. export control laws. By accepting this
! software, the user agrees to comply with all applicable U.S. export laws and
! regulations. User has the responsibility to obtain export licenses, or other
! export authority as may be required before exporting such information to
! foreign countries or providing access to foreign persons.

module Dump_Options
  use HighOutput, only: Banner, BlanksToColumn, Headline, OutputNamedValue
  use Machine, only: Crash_Burn
  use MLSStrings, only: LowerCase
  use Output_m, only: StampOptions, Blanks, &
    & GetOutputStatus, Newline, Output

  ! Options for Dump_0, Dump_1, Diff_1, and maybe others.
  ! Variables shared between those modules and derived from the options.


! === (start of toc) ===
!     c o n t e n t s
!     - - - - - - - -
!     (subroutines and functions)
! DumpDumpOptions          Show actual dump, diff options
!                            (or if arg is '?' help-fully show all available opts)
! PrintName                Print the item name unless already done so
! RestoreDumpConfig        Restore default values for dump settings
! Set_Options              Set the values in Options using args
! TheDumpBegins            Housekeeping
! TheDumpEnds              Housekeeping
! Most of the optional parameters have default values
! logically set to FALSE or 0, ' ',  or '*' where appropriate
! === (end of toc) ===

!  optional args
!  (dumps and diffs if the same)
!      arg            meaning                                     default
!      ---            -------                                     -------
!    fillvalue        skip dumping lines containg only fillValues    0
!    width            how many values printed per line            depends
!    format           fortran format used to print                depends
!    lbound           lower bound of 1st index                       1
!    options          (see below)                                    ''

!  (diffs)
!      arg            meaning                                     default
!      ---            -------                                     -------
!    fillvalue        don't diff where array elements are this    -999.99

! The format optional arg defaults to SDFORMATDEFAULT for floating pt. arrys
! For integer arrays it defaults to i6 or i_INTPLACES_
! For complex arrays it defaults to SDFORMATDEFAULTCMPLX
! If set to '(*)', for floating point and complex arrays it
! will be the least number of spaces wide enough to contain the
! largest array element printed according to the default format
! If set to '(*.m)', for floating point and complex arrays it
! will be the least number of spaces wide enough to contain the
! largest array element with m spaces after the decimal point

! The meaning of options has replaced the older logical arguments
! if the options is present and contains the following characters:
! (for dump or diff)
!   character         meaning
!      ---            -------
!       ?              show meaning of all available options
!       @@              show differences in the goldbrick-style
!       B              show Bandwidth, % of array that is non-zero
!       H              show rank, shape of array
!       L              laconic; skip printing name, size of array
!       N              Show where NaNs and Infs are located
!       R              rms       -- min, max, etc.
!       b              table of % vs. amount of differences (pdf)
!       c              clean
!       g              gaps      
!       l              collapse (last index)
!       r              ratios    -- min, max, etc. of differences' ratios
!       s              stats     -- number, % of differences
!       p              transpose 
!       t              trim      
!       u              unique    
!       v              verbose
!       w              wholearray
!       W[i]           wholearray, looping over ith index (for rank 3 and 4 arrays only)
!       X              crash with walkback at TheDumpBegins
!       1 or 2 or ..   ignored; calling routine is free to interpret

! An exception is the behavior of wholearray:
! if all {HRblrs} are FALSE, i.e. unset, the whole array is dumped (or diffed)
! if any is TRUE the whole array will be dumped only if
! w or wholearray is set to TRUE

! in the above, a string list is a string of elements (usu. comma-separated)
!
! For an example of the goldbrick style of showing differences,
!  ** Reference values (min : max, rms): -343.791 : 4.67836, 3.52708
!  ** Max. absolute: 0.000439644 ( = 4.39644e+16 fractional )
!  ** Max. fractional: 4.39644e+16 ( = 0.000439644 absolute )

! Appearance flags
! If Name = 'MyName\h'
! then Dump might print this
! ---------------------------MyName---------------------
!    (:) all 3500 values are 0
! So the flags are separated from the final character of Name by a '\'
! flag             effect
!  b               print Name in a Banner
!  h               print Name as a headline
!  n               omit Newline after printing name


  implicit none
  public

  save

  character, public, parameter :: AfterSub = '#'
  character(len=*), parameter :: DefaultPCTFormat = '(0pf6.1)'

  ! These are the possible option characters to dumps, diffs
  character, parameter :: Dopt_AuBrick     = '@@'
  character, parameter :: Dopt_Bandwidth   = 'B'
  character, parameter :: Dopt_Clean       = 'c'
  character, parameter :: Dopt_Collapse    = 'l'
  character, parameter :: Dopt_Crash       = 'X'
  character, parameter :: Dopt_Cyclic      = 'y'
  character, parameter :: Dopt_Direct      = 'd'
  character, parameter :: Dopt_Dot         = '.'
  character, parameter :: Dopt_Gaps        = 'g'
  character, parameter :: Dopt_Laconic     = 'L'
  character, parameter :: Dopt_NaNs        = 'N'
  character, parameter :: Dopt_null        = ' '
  character, parameter :: Dopt_OnlyWholeArray = '' ! Set from other options
  character, parameter :: Dopt_Ratios      = 'r'
  character, parameter :: Dopt_Rms         = 'R'
  character, parameter :: Dopt_Verbose     = 'v'
  character, parameter :: Dopt_Shape       = 'H'
  character, parameter :: Dopt_Stats       = 's'
  character, parameter :: Dopt_Table       = 'b'
  character, parameter :: Dopt_Transpose   = 'p'
  character, parameter :: Dopt_Trim        = 't'
  character, parameter :: Dopt_Unique      = 'u'
  character, parameter :: Dopt_WholeArray  = 'w'

  ! These are the indices of those options in the Dopts array
  enum, bind(c)
    enumerator :: AuBrick = 1
    enumerator :: Bandwidth
    enumerator :: Clean
    enumerator :: CollapseIt
    enumerator :: Crash
    enumerator :: Cyclic
    enumerator :: Direct
    enumerator :: Dot
    enumerator :: ItsShape
    enumerator :: Gaps
    enumerator :: Laconic
    enumerator :: NaNs
    enumerator :: OnlyWholeArray
    enumerator :: Ratios
    enumerator :: Rms
    enumerator :: Verbose
    enumerator :: Stats
    enumerator :: Table
    enumerator :: Transpose
    enumerator :: TrimIt
    enumerator :: Unique
    enumerator :: WholeArray
  end enum

  integer, private, parameter :: NumOpt = WholeArray

  logical :: NameHasBeenPrinted = .false.
  logical :: OldNeverStamp

! ---------------------------------------------------------------------------
!     (parameters)
! ---------------------------------------------------------------------------
! Default values can be overriden for the following public data
! To see the current values, call DumpDumpOptions
! To restore the "factory settings" call RestoreDumpConfig
! ---------------------------------------------------------------------------
! CollapseOptions          Options determining what and how to dump multi-
!                           dimensional arrays collapsed into lower-dimensions
!                           (see the Collapse family in the HyperSlabs module)
! CrashAtBeginning         If set to crash on dump, crash at beginning not end
! DefaultDiffOptions       Switches to set default DIFF values for CLEAN, TRIM,
!                           etc.
! DefaultDumpOptions       Same as above, but for DUMP
! DefaultWidth             How many elements to print per line
!                            (for char-valued arrays only)
!                            (Should we have similar for s.p. and d.p.?)
! DiffRMSMeansRMS          Print abs min, max, etc. when DIFF has RMS set TRUE
! DontDumpIfAllEqual       Don't dump every element of a constant array
! DumpTableSide            What side to place headers when dumping tables
! FilterFillsFromRMS       Exclude fill values when calculating rms, etc.
!                           (not implemented yet)
! IntPlaces                How many places to print when dumping integer values
! MaxNumNANS               How many NaNs can we show where they are
! NameOnEachLine           Item name to print on each output line
! PCTFormat                Use this format to print % with '-s' diff option
! RMSFormat                Use this format to print min, max, rms, etc.
! SDFormatDefault          Use this format to print s.p., d.p.
! StatsOnOneLine           Stats, rms each printed all on a single line
!                           instead of splitting across two lines

  ! The following character strings can include one or more options listed above
  ! E.g., '-crt' turns on Clean, RMS, and TrimIt
  character(len=8)  :: DefaultDiffOptions     = ' '
  character(len=8)  :: DefaultDumpOptions     = ' '
  ! These affect the appearance; some may be temporarily
  ! set by use of appearance flags appended to the item's name field
  logical           :: CrashAtBeginning       = .false.
  integer           :: DefaultMaxLon          = 128
  integer           :: DefaultWidth           = 10
  character(len=8)  :: DumpTableSide          = 'top'
  logical           :: DiffRMSMeansRMS        = .false.
  logical           :: DontDumpIfAllEqual     = .true.
  logical           :: FilterFillsFromRMS     = .false.
  logical           :: PrintFillValue         = .true.
  logical           :: PrintNameAsHeadline    = .false.
  logical           :: PrintNameAtLineEnd     = .false.
  logical           :: PrintNameInBanner      = .false.
  logical           :: PrintNameIfDiff        = .true.
  logical           :: skipNewlineAfterName   = .false.
  logical           :: StatsOnOneLine         = .true.
  character(len=64) :: NameOnEachLine         = ' '

  ! This determines how a higher-rank array is collapsed to a lower-rank one
  character(len=16) :: CollapseOptions = 'num[+]all[+]'

  ! These determine how dumped numerical data (s.p. or d.p.) will be formatted
  character(len=2)  :: IntPlaces       = '6' ! how many places
  integer           :: MaxNumNANs      = 60  ! how many NaNs to show
  character(len=16) :: PCTFormat       = '*' ! * means default format
  character(len=16) :: RMSFormat       = '*' ! * means default format
  character(len=16) :: SDFormatDefault = '(1pg14.6)'
  character(*), parameter :: SDFormatDefaultCmplx = &
    & '(1x,"(",1pg13.6,",",1pg13.6,")")'

! ---------------------------------------------------------------------------
! The dump options data type
! You may set it directly by assignment like this
!    Dopts(whatever) = .true.
! However the usual method is instead to parse the optional arg options using
! subroutine Set_Options (see below)
  type :: Option_T
    character(10) :: Name  ! Option's name
    character :: Char      ! Character that selects option
    logical :: V           ! Value of the option
  end type Option_T

  ! Options for Dumps and Diffs
  type(option_t) :: Dopts(numOpt)
  logical, dimension(numOpt) :: DoptsDefaultVs = .false.

  data dopts(aubrick)    / option_t('aubrick',    dopt_aubrick,    .false. ) /
  data dopts(bandwidth)  / option_t('bandwidth',  dopt_bandwidth,  .false. ) /
  data dopts(clean)      / option_t('clean',      dopt_clean,      .false. ) /
  data dopts(collapseIt) / option_t('collapse',   dopt_collapse,   .false. ) /
  data dopts(crash)      / option_t('crash',      dopt_crash,      .false. ) /
  data dopts(cyclic)     / option_t('cyclic',     dopt_cyclic,     .false. ) /
  data dopts(direct)     / option_t('direct',     dopt_direct,     .false. ) /
  data dopts(dot)        / option_t('dot',        dopt_dot,        .false. ) /
  data dopts(gaps)       / option_t('gaps',       dopt_gaps,       .false. ) /
  data dopts(itsShape)   / option_t('shape',      dopt_shape,      .false. ) /
  data dopts(laconic)    / option_t('laconic',    dopt_laconic,    .false. ) /
  data dopts(NaNs)       / option_t('NaNs',       dopt_nans,       .false. ) /
  data dopts(onlyWholeArray) / option_t('OnlyWholeArray', '',      .false. ) /
  data dopts(ratios)     / option_t('ratios',     dopt_ratios,     .false. ) /
  data dopts(RMS)        / option_t('RMS',        dopt_rms,        .false. ) /
  data dopts(stats)      / option_t('stats',      dopt_stats,      .false. ) /
  data dopts(table)      / option_t('table',      dopt_table,      .false. ) /
  data dopts(transpose)  / option_t('transpose',  dopt_transpose,  .false. ) /
  data dopts(trimIt)     / option_t('trim',       dopt_trim,       .false. ) /
  data dopts(unique)     / option_t('unique',     dopt_unique,     .false. ) /
  data dopts(verbose)    / option_t('verbose',    dopt_verbose,    .false. ) /
  data dopts(wholeArray) / option_t('wholeArray', dopt_wholeArray, .false. ) /

!---------------------------- RCS Module Info ------------------------------
  character (len=*), private, parameter :: ModuleName= &
       "$RCSfile: dump_options.f90,v $"
  private :: not_used_here
!---------------------------------------------------------------------------

contains
  
  ! ---------------------------------------------- DumpDumpOptions -----
  subroutine DumpDumpOptions( OptionString, ThisIsADiff )
    ! Show 
    ! (if current OptionString supplied) actual dump, diff options
    ! (if arg is "?") available options and their meanings
    ! (if no arg) default options
    use MLSStrings, only: Trim_Safe
    character(len=*), intent(in), optional :: OptionString
    logical, intent(in), optional          :: ThisIsADiff
    character(len=1), parameter :: FillChar = '1' ! fill blanks with '. .'
    integer :: I
    logical :: MyDiff
    myDiff = .false.
    if ( present(thisIsADiff) ) myDiff = thisIsADiff
    if ( .not. present(OptionString) ) then
      call blanks(90, fillChar='-', advance='yes')
      call output(' ------------------------ Summary of automatic Dump, Diff options'      , advance='no')
      call output(' ------------------------ ', advance='yes')
      call outputNamedValue ( 'character printed between row, col id and data', aftersub, advance='yes', &
        & fillChar=fillChar, before='* ', after=' *', tabn=4, tabc=62, taba=90 )
      call outputNamedValue ( 'default DIFF switches for CLEAN, TRIM, etc.', trim_safe(DefaultDiffOptions), advance='yes', &
        & fillChar=fillChar, before='* ', after=' *', tabn=4, tabc=62, taba=90 )
      call outputNamedValue ( 'default DUMP switches for CLEAN, TRIM, etc.', trim_safe(DefaultDumpOptions), advance='yes', &
        & fillChar=fillChar, before='* ', after=' *', tabn=4, tabc=62, taba=90 )
      call outputNamedValue ( 'print abs min, max, etc. when DIFF has RMS set TRUE?', DiffRMSMeansRMS, advance='yes', &
        & fillChar=fillChar, before='* ', after=' *', tabn=4, tabc=62, taba=90 )
      call outputNamedValue ( 'skip dumping every element of a constant array?', DiffRMSMeansRMS, advance='yes', &
        & fillChar=fillChar, before='* ', after=' *', tabn=4, tabc=62, taba=90 )
      call outputNamedValue ( 'what side to place headers when dumping tables', trim(DumpTableSide), advance='yes', &
        & fillChar=fillChar, before='* ', after=' *', tabn=4, tabc=62, taba=90 )
      call outputNamedValue ( 'print stats all on one line?', StatsOnOneLine, advance='yes', &
        & fillChar=fillChar, before='* ', after=' *', tabn=4, tabc=62, taba=90 )
      call outputNamedValue ( 'pct output format', trim_safe(PCTFormat), advance='yes', &
        & fillChar=fillChar, before='* ', after=' *', tabn=4, tabc=62, taba=90 )
      call outputNamedValue ( 'rms output format', trim_safe(RMSFormat), advance='yes', &
        & fillChar=fillChar, before='* ', after=' *', tabn=4, tabc=62, taba=90 )
      call outputNamedValue ( 'numeric output format', trim_safe(SDFormatDefault), advance='yes', &
        & fillChar=fillChar, before='* ', after=' *', tabn=4, tabc=62, taba=90 )
      call outputNamedValue ( 'complex output format', trim_safe(sdFormatDefaultCmplx), advance='yes', &
        & fillChar=fillChar, before='* ', after=' *', tabn=4, tabc=62, taba=90 )
      call blanks(90, fillChar='-', advance='yes')
      do i = 1, size(dopts)
        call outputNamedValue ( dopts(i)%name//'?', dopts(i)%v, advance='yes', &
        & fillChar=fillChar, before='* ', after=' *', tabn=4, tabc=62, taba=90 )
      end do
    else if ( index( optionString, "?" ) > 0 ) then
      call output( 'The meaning of options is determined by the presence or absence', advance='yes' )
      call output( 'of specific characters in the options string', advance='yes' )
      call output( 'If options is present and contains the following characters:', advance='yes' )
      call output( '(for dump or diff)', advance='yes' )
      call output( '  character         meaning', advance='yes' )
      call output( '     ---            -------', advance='yes' )
      ! The following are in order according to their option letters
      call output( '     ' // dopt_aubrick     // '              show aubrick, diffs in goldbrick style', advance='yes' )
      call output( '     ' // dopt_bandwidth   // '              show Bandwidth, % of array that is non-zero', advance='yes' )
      call output( '     ' // dopt_shape       // '              show rank, shape of array', advance='yes' )
      call output( '     ' // dopt_laconic     // '              laconic; skip printing name, size of array', advance='yes' )
      call output( '     ' // dopt_NaNs        // '              show where ', advance='yes' )
      call output( '     ' // dopt_null        // '              NaNs and Infs are located (only for floats)', advance='yes' )
      call output( '     ' // dopt_null        // '              T and F are located (only for logicals)', advance='yes' )
      call output( '     ' // dopt_RMS         // '              rms       -- min, max, etc.', advance='yes' )
      call output( '     ' // dopt_table       // '              table of % vs. amount of differences (pdf)', advance='yes' )
      call output( '     ' // dopt_clean       // '              clean', advance='yes' )
      call output( '     ' // dopt_crash       // '              crash', advance='yes' )
      call output( '     ' // dopt_direct      // '              direct', advance='yes' )
      call output( '     ' // dopt_gaps        // '              show only gaps in logicals ', advance='yes' )
      call output( '     ' // dopt_collapse    // '              collapse (last index)', advance='yes' )
      call output( '     ' // dopt_ratios      // '              ratios    -- min, max, etc. of difference ratios', advance='yes' )
      call output( '     ' // dopt_stats       // '              stats     -- number, % of differences', advance='yes' )
      call output( '     ' // dopt_transpose   // '              transpose (for rank 2 arrays only)', advance='yes' )
      call output( '     ' // dopt_trim        // '              trim      ', advance='yes' )
      call output( '     ' // dopt_unique      // '              unique    ', advance='yes' )
      call output( '     ' // dopt_verbose     // '              verbose   ', advance='yes' )
      call output( '     ' // dopt_cyclic      // '              cyclic    ', advance='yes' )
      call output( '     ' // dopt_wholeArray  // '              wholearray', advance='yes' )
      call output( '     W[i]           wholearray, looping over ith index', advance='yes' )
      call output( '                    (for rank 3 and 4 arrays only)', advance='yes' )
      call output( '     1 or 2 or ..   ignored; calling routine is free to interpret', advance='yes' )
      call output( ' ', advance='yes' )
      call output( 'An exception is the behavior of w (wholearray):', advance='yes' )
      call output( 'if all {@@HNRblrs} are FALSE, i.e. unset, the whole array is dumped (or diffed)', advance='yes' )
      call output( 'if any are TRUE the whole array will be dumped only if', advance='yes' )
      call output( 'w is present or wholearray is set to TRUE', advance='yes' )
    else
      call outputNamedValue ( 'options', trim_safe(optionString), advance='yes', &
        & fillChar=fillChar, before='* ', after=' *', tabn=4, tabc=62, taba=90 )
      call outputNamedValue ( 'thisIsADiff?', myDiff, advance='yes', &
        & fillChar=fillChar, before='* ', after=' *', tabn=4, tabc=62, taba=90 )
      do i = 1, size(dopts)
        call outputNamedValue ( dopts(i)%name//'?', dopts(i)%v, advance='yes', &
        & fillChar=fillChar, before='* ', after=' *', tabn=4, tabc=62, taba=90 )
      end do
    end if
  end subroutine DumpDumpOptions

  ! -------------------------------------------------  PrintName  -----
  ! Print the item name unless already done so
  ! In case any of the appearance flags are detected, modify
  ! The appearance of name accordingly
  subroutine PrintName ( Name, nameHasBeenPrintedAlready )
    character(len=*), intent(in), optional        :: Name
    logical, optional                             :: nameHasBeenPrintedAlready
    ! Local variables
    logical                                       :: atLineStart
    character(len=64)                             :: myName
    integer                                       :: n
    logical                                       :: OldPrintNameAsHeadline 
    logical                                       :: OldPrintNameInBanner   
    logical                                       :: OldskipNewlineAfterName
    ! Executable
    if ( present(nameHasBeenPrintedAlready) ) then
      if ( nameHasBeenPrintedAlready ) return
    endif
    myName = NameOnEachLine
    if ( present(name) ) myName = name
    n = len_trim(myName)
    if ( n < 1 ) return
    n = index(myName, '\' )
    OldPrintNameAsHeadline =  PrintNameAsHeadline 
    OldPrintNameInBanner   =  PrintNameInBanner   
    OldskipNewlineAfterName=  skipNewlineAfterName
    if ( n > 0 ) then
      PrintNameAsHeadline  = ( index( myname(n+1:), 'h' ) > 0 )
      PrintNameInBanner    = ( index( myname(n+1:), 'b' ) > 0 )
      skipNewlineAfterName = ( index( myname(n+1:), 'n' ) > 0 )
      myname(n:) = ' '
    endif
    atLineStart = ( getOutputStatus( 'start' ) == 1 )
    if( PrintNameAsHeadline .and. atLineStart ) then
      call Headline( trim(myName), FillChar='-', before='* ', after=' *' )
    elseif( PrintNameInBanner .and. atLineStart ) then
      call Banner( trim(myName) )
    elseif( PrintNameAtLineEnd ) then
      call blanksToColumn ( 80-len_trim(myName) )
      call output ( trim(myName), advance='no' )
      if ( .not. dopts(Clean)%v .and. .not. skipNewlineAfterName ) call newLine
    else
      if ( .not. dopts(Clean)%v .and. .not. atLineStart ) call blanks (2)
      call output ( trim(myName), advance='no' )
      if ( .not. dopts(Clean)%v .and. .not. skipNewlineAfterName ) call newLine
    end if
    if ( present(nameHasBeenPrintedAlready) ) nameHasBeenPrintedAlready = .true.
    PrintNameAsHeadline  = OldPrintNameAsHeadline 
    PrintNameInBanner    = OldPrintNameInBanner   
    skipNewlineAfterName = OldskipNewlineAfterName
  end subroutine PrintName

  ! ------------------------------------------  RestoreDumpConfig  -----
  ! Restore default values for dump settings
  subroutine RestoreDumpConfig
    DefaultDiffOptions        = ' '
    DefaultDumpOptions        = ' '
    DefaultMaxLon             = 128
    DefaultWidth              = 10
    DumpTableSide             = 'top'
    DiffRMSMeansRMS           = .false.
    DontDumpIfAllEqual        = .true.
    FilterFillsFromRMS        = .false.
    printFillValue            = .true.
    printNameIfDiff           = .true.
    StatsOnOneLine            = .true.
    collapseOptions           = 'num[+]all[+]'
    IntPlaces                 = '6' ! how many places
    PCTFormat                 = '*' ! * means default format
    RMSFormat                 = '*' ! * means default format
    SDFormatDefault           = '(1pg14.6)'
  end subroutine RestoreDumpConfig

  ! ------------------------------------------------  Set_Options  -----
  subroutine Set_Options ( OptionString, DefaultOptionString, keyword )
    ! Set the values in Options according to what characters are in
    ! DefaultOptionString, if it's present, else set them false.  Then
    ! turn on options in OptionString.
    character(*), intent(in), optional :: OptionString
    character(*), intent(in), optional :: DefaultOptionString
    character(*), intent(in), optional :: KeyWord
    integer :: I

    if ( present(defaultOptionString) ) then
      do i = 1, size(dopts)
        doptsDefaultVs(i) = index(defaultOptionString, dopts(i)%char) > 0
      end do
    end if
    if ( present(keyword) ) then
      select case (lowercase(keyword))
      case ( 'crash' )
        doptsDefaultVs(crash) = .true.
      case ( 'restore' )
        doptsDefaultVs = .false.
      end select
    endif
    dopts%v = doptsDefaultVs
    if ( present(optionString) ) then
      do i = 1, size(dopts)
        dopts(i)%v = dopts(i)%v .or. index(optionString, dopts(i)%char) > 0
      end do
    end if

  end subroutine Set_Options

  ! -----------------------------------------------  TheDumpBegins -----
  ! A warm-up subroutine that transfers the options string to the Dopts
  subroutine TheDumpBegins ( Options, ThisIsADiff, Name )
    ! use HighOutput, only: OutputNamedValue
    character(len=*), intent(in), optional :: Options
    logical, intent(in), optional          :: ThisIsADiff
    character(len=*), intent(in), optional :: Name
    logical :: MyDiff
    ! Executable
    ! Were we called with the trigger '?'?
    ! call output( 'Entering TheDumpBegins', advance='yes' )
    if ( present(options) ) then
      if ( index( options, '?' ) > 0 ) then
        call DumpDumpOptions ( options )
        stop
      endif
    endif
    myDiff = .false.
    if ( present(thisIsADiff) ) myDiff = thisIsADiff
    OldNeverStamp = stampOptions%neverStamp
    stampOptions%neverStamp = .true. ! So we don't interrupt tables of numbers
    call set_options ( options, &
      & merge(defaultDiffOptions,defaultDumpOptions,myDiff) )
    dopts(wholeArray)%v = dopts(wholeArray)%v .or. &
      & .not. ( dopts(AuBrick)%v .or. dopts(bandwidth)%v .or. dopts(collapseIt)%v .or. &
      &         dopts(ratios)%v .or. dopts(RMS)%v .or. dopts(itsShape)%v .or. &
      &         dopts(stats)%v .or. dopts(table)%v .or. dopts(NaNs)%v )
    dopts(onlyWholeArray)%v = dopts(wholeArray)%v .and. &
      & .not. ( dopts(AuBrick)%v .or. dopts(bandwidth)%v .or. dopts(collapseIt)%v .or. &
      &         dopts(ratios)%v .or. dopts(RMS)%v .or. dopts(itsShape)%v .or. &
      &         dopts(stats)%v .or. dopts(table)%v .or. dopts(NaNs)%v)
    nameHasBeenPrinted = nameHasBeenPrinted .or. dopts(laconic)%v
    if ( dopts(verbose)%v .and. present(name) ) then
      nameOnEachLine = name
    else
      nameOnEachLine = ' '
    endif
    ! if ( present(name) .and. .not. NameHasBeenPrinted ) then
    !  if ( len_trim(name) > 0 ) call PrintName ( Name, nameHasBeenPrinted )
    !  nameHasBeenPrinted = .true.
    ! endif
    if ( dopts(crash)%v .and. CrashAtBeginning ) call Crash_Burn
  end subroutine TheDumpBegins

  ! -------------------------------------------------  TheDumpEnds -----
  subroutine TheDumpEnds
    ! call output( 'Entering TheDumpEnds', advance='yes' )
    stampOptions%neverStamp = OldNeverStamp ! Restore just this component
    if ( dopts(crash)%v .and. .not. CrashAtBeginning ) call Crash_Burn
    nameHasBeenPrinted = .false.
    ! call outputNamedValue( 'Setting nameHasbeenPrinted to ', nameHasbeenPrinted )
  end subroutine TheDumpEnds

!--------------------------- end bloc --------------------------------------
  logical function not_used_here()
  character (len=*), parameter :: IdParm = &
       "$Id: dump_options.f90,v 2.14 2021/04/01 23:44:21 pwagner Exp $"
  character (len=len(idParm)) :: Id = idParm
    not_used_here = (id(1:1) == ModuleName(1:1))
    print *, Id ! .mod files sometimes change if PRINT is added
  end function not_used_here
!---------------------------------------------------------------------------

end module Dump_Options

! $Log: dump_options.f90,v $
! Revision 2.14  2021/04/01 23:44:21  pwagner
! Light housekeeping; clarified some options
!
! Revision 2.13  2019/07/22 22:18:10  pwagner
! Improved DumpDumpOptions
!
! Revision 2.12  2018/04/13 00:23:27  pwagner
! Improved comments; explain use of appearance flags like 'MyName\h'
!
! Revision 2.11  2018/04/03 23:16:36  pwagner
! May use nbh following \ in name to modify how to print name in dump
!
! Revision 2.10  2018/02/28 19:50:46  pwagner
! Moved PrintName here from Dump_0
!
! Revision 2.9  2017/11/30 20:47:31  pwagner
! Now wont stamp on stampOptions%neverStamp
!
! Revision 2.8  2017/09/07 23:44:30  pwagner
! Added PrintNameAsHeadline and PrintNameInBanner options to dump
!
! Revision 2.7  2017/07/31 23:04:24  pwagner
! Moved TheDumpEnds here; tried to prevent repeating Name; default to crash at end of Dump
!
! Revision 2.6  2017/07/31 22:18:22  vsnyder
! Option to print FALSE as dot to make it easier to see TRUE
!
! Revision 2.5  2017/07/19 22:38:31  pwagner
! Added Crash, PrintNameAtLineEnd
!
! Revision 2.4  2016/12/14 01:20:55  pwagner
! Print meaning of all options if options is '?'
!
! Revision 2.3  2016/09/09 20:09:51  pwagner
! Added Au (Gold) brick option removing some hay from the stack of statistics
!
! Revision 2.2  2016/07/28 03:29:28  vsnyder
! Moved a bunch of comments here from Dump_0.  Repaired typo that confused
! "Clean" option with "Collape" option.
!
! Revision 2.1  2016/07/28 01:41:48  vsnyder
! Initial Commit
!
@


2.14
log
@Light housekeeping; clarified some options
@
text
@d275 1
a275 1
  data dopts(table)      / option_t('table',      dopt_transpose,  .false. ) /
d546 1
a546 1
       "$Id: dump_options.f90,v 2.13 2019/07/22 22:18:10 pwagner Exp $"
d556 3
@


2.13
log
@Improved DumpDumpOptions
@
text
@d16 1
a16 1
  use output_m, only: StampOptions, Blanks, &
d178 1
d180 19
a198 9
! CollapseOptions          options determining what and how to dump collapsed
!                           representations of multidimensional arrays
! CrashAtBeginning         if set to crash on dump, crash at beginning not end
! DefaultDiffOptions       switches to set default DIFF values for CLEAN, TRIM, etc.
! DefaultDumpOptions       same as above, but for DUMP
! DiffRMSMeansRMS          print abs min, max, etc. when DIFF has RMS set TRUE
! DontDumpIfAllEqual       don't dump every element of a constant array
! DumpTableSide            what side to place headers when dumping tables
! FilterFillsFromRMS       exclude fill values when calculating rms, etc.
d202 6
a207 5
! NameOnEachLine           item name to print on each output line
! PCTFormat                use this format to print % with '-s' diff option
! RMSFormat                use this format to print min, max, rms, etc.
! SDFormatDefault          use this format to print s.p., d.p. by default
! StatsOnOneLine           stats, rms each printed on a single line
d243 6
d546 1
a546 1
       "$Id: dump_options.f90,v 2.12 2018/04/13 00:23:27 pwagner Exp $"
d556 3
@


2.12
log
@Improved comments; explain use of appearance flags like 'MyName\h'
@
text
@d134 1
d329 3
a331 1
      call output( '     ' // dopt_NaNs        // '              show where NaNs and Infs are located', advance='yes' )
d337 1
a337 1
      call output( '     ' // dopt_gaps        // '              gaps      ', advance='yes' )
d528 1
a528 1
       "$Id: dump_options.f90,v 2.11 2018/04/03 23:16:36 pwagner Exp $"
d538 3
@


2.11
log
@May use nbh following \ in name to modify how to print name in dump
@
text
@d102 11
d200 2
a201 1

d366 2
d525 1
a525 1
       "$Id: dump_options.f90,v 2.10 2018/02/28 19:50:46 pwagner Exp $"
d535 3
@


2.10
log
@Moved PrintName here from Dump_0
@
text
@d202 1
d360 4
d370 12
a381 1
    if ( len_trim(myName) < 1 ) return
d390 1
a390 1
      if ( .not. dopts(Clean)%v ) call newLine
d394 1
a394 1
      if ( .not. dopts(Clean)%v ) call newLine
d397 3
d511 1
a511 1
       "$Id: dump_options.f90,v 2.9 2017/11/30 20:47:31 pwagner Exp $"
d521 3
@


2.9
log
@Now wont stamp on stampOptions%neverStamp
@
text
@d13 1
d16 2
d23 9
d36 1
a263 1
    use HighOutput, only: OutputNamedValue
a264 1
    use Output_m, only: Blanks, Output
d351 32
a439 1
    use Output_m, only: StampOptions
a454 1
!    nameHasBeenPrinted = .false.
d473 4
a476 1
    ! call outputNamedValue( 'NameOnEachLine', trim(NameOnEachLine) )
d482 1
a482 1
    use Output_m, only: StampOptions
d486 1
d492 1
a492 1
       "$Id: dump_options.f90,v 2.8 2017/09/07 23:44:30 pwagner Exp $"
d502 3
@


2.8
log
@Added PrintNameAsHeadline and PrintNameInBanner options to dump
@
text
@d151 1
d414 1
d439 1
a439 1
    stampOptions%neverStamp = .false.
d447 1
a447 1
       "$Id: dump_options.f90,v 2.7 2017/07/31 23:04:24 pwagner Exp $"
d457 3
@


2.7
log
@Moved TheDumpEnds here; tried to prevent repeating Name; default to crash at end of Dump
@
text
@d184 1
d186 1
d445 1
a445 1
       "$Id: dump_options.f90,v 2.5 2017/07/19 22:38:31 pwagner Exp $"
d455 3
@


2.6
log
@Option to print FALSE as dot to make it easier to see TRUE
@
text
@d14 1
d20 2
d155 1
d176 1
d209 1
d249 1
a249 1
    use MLSStrings, only: Trim_safe
d359 1
a359 1
  subroutine Set_Options ( OptionString, DefaultOptionString )
d365 1
a367 1
    dopts%v = .false.
d370 1
a370 1
        dopts(i)%v = index(defaultOptionString, dopts(i)%char) > 0
a371 2
    else
      dopts%v = .false.
d373 9
d393 2
a394 2
    use HighOutput, only: OutputNamedValue
    use Output_m, only: Output, StampOptions
d410 1
a410 1
    nameHasBeenPrinted = .false.
d429 1
a429 1
    if ( dopts(crash)%v ) call Crash_Burn
d432 8
d453 3
@


2.5
log
@Added Crash, PrintNameAtLineEnd
@
text
@d103 1
d128 1
d198 1
a198 1
    character :: Char      ! Letter that selects option
d212 1
d422 1
a422 1
       "$Id: dump_options.f90,v 2.4 2016/12/14 01:20:55 pwagner Exp $"
d432 3
@


2.4
log
@Print meaning of all options if options is '?'
@
text
@d13 1
d52 1
d71 1
d100 1
d124 1
d167 2
a168 2
  character(len=8)  :: DefaultDiffOptions = ' '
  character(len=8)  :: DefaultDumpOptions = ' '
d170 11
a180 10
  integer           :: DefaultMaxLon      = 128
  integer           :: DefaultWidth       = 10
  character(len=8)  :: DumpTableSide      = 'top'
  logical           :: DiffRMSMeansRMS    = .false.
  logical           :: DontDumpIfAllEqual = .true.
  logical           :: FilterFillsFromRMS = .false.
  logical           :: PrintFillValue     = .true.
  logical           :: PrintNameIfDiff    = .true.
  logical           :: StatsOnOneLine     = .true.
  character(len=16) :: NameOnEachLine     = ' '
d186 4
a189 4
  character(len=2)  :: IntPlaces = '6' ! how many places
  integer           :: MaxNumNANs= 60  ! how many NaNs to show
  character(len=16) :: PCTFormat = '*' ! * means default format
  character(len=16) :: RMSFormat = '*' ! * means default format
d207 1
d296 1
d376 3
a378 2
  subroutine TheDumpBegins ( Options, ThisIsADiff )
    use Output_m, only: StampOptions
d381 1
d385 1
d407 7
d419 1
a419 1
       "$Id: dump_options.f90,v 2.3 2016/09/09 20:09:51 pwagner Exp $"
d429 3
@


2.3
log
@Added Au (Gold) brick option removing some hay from the stack of statistics
@
text
@d53 1
a53 1
!       H              show rank, TheShape of array
d62 1
a62 1
!       s              stats     -- number of differences
d283 1
a283 1
      call output( '     ' // dopt_shape       // '              show rank, TheShape of array', advance='yes' )
d289 1
a289 1
      call output( '     ' // dopt_clean       // '              direct', advance='yes' )
d293 1
a293 1
      call output( '     ' // dopt_stats       // '              stats     -- number of differences', advance='yes' )
d300 3
a302 3
      call output( '      W[i]           wholearray, looping over ith index', advance='yes' )
      call output( '                     (for rank 3 and 4 arrays only)', advance='yes' )
      call output( '      1 or 2 or ..   ignored; calling routine is free to interpret', advance='yes' )
d367 1
d373 8
d401 1
a401 1
       "$Id: dump_options.f90,v 2.2 2016/07/28 03:29:28 vsnyder Exp $"
d411 3
@


2.2
log
@Moved a bunch of comments here from Dump_0.  Repaired typo that confused
"Clean" option with "Collape" option.
@
text
@d51 1
d77 6
d84 1
a84 1
  implicit NONE
d93 1
d116 2
a117 1
    enumerator :: Bandwidth = 1
d197 1
d211 1
d269 4
d281 1
d305 1
a305 1
      call output( 'if all {HNRblrs} are FALSE, i.e. unset, the whole array is dumped (or diffed)', advance='yes' )
d379 1
a379 1
      & .not. ( dopts(bandwidth)%v .or. dopts(collapseIt)%v .or. &
d383 1
a383 1
      & .not. ( dopts(bandwidth)%v .or. dopts(collapseIt)%v .or. &
d392 1
a392 1
       "$Id: dump_options.f90,v 2.1 2016/07/28 01:41:48 vsnyder Exp $"
d402 4
@


2.1
log
@Initial Commit
@
text
@d17 60
d133 18
d190 1
a190 1
  data dopts(collapseIt) / option_t('collapse',   dopt_clean,      .false. ) /
d209 1
a209 1
       "$RCSfile: Dump_0.f90,v $"
d376 1
a376 1
       "$Id: Dump_0.f90,v 2.137 2016/04/05 23:54:57 pwagner Exp $"
d385 4
a388 1
! $Log: Dump_0.f90,v $
@

