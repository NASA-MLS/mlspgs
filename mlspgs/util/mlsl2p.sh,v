head	1.48;
access;
symbols
	v5-02-NRT-19:1.48
	v6-00:1.48
	v5-02-NRT-18:1.46
	v5-02:1.40
	v5-01-NRT-17:1.45
	v5-01-NRT-16:1.43
	v5-01-NRT-15:1.41
	v5-01-NRT-14:1.41
	neuralnetworks-1-0:1.41.0.4
	cfm-single-freq-0-1:1.41.0.2
	v5-01:1.40
	v5-00:1.40
	v4-23-TA133:1.37.0.6
	mus-emls-1-70:1.37.0.4
	rel-1-0-englocks-work:1.37.0.2
	VUMLS1-00:1.35
	VPL1-00:1.33
	V4-22-NRT-08:1.33
	VAM1-00:1.29
	V4-21:1.29.0.2
	V4-13:1.29
	V4-12:1.28
	V4-11:1.28
	V4-10:1.28
	V3-43:1.23
	M4-00:1.24
	V3-41:1.23
	V3-40-PlusGM57:1.23.0.2
	V2-24-NRT-04:1.16
	V3-33:1.23
	V2-24:1.16
	V3-31:1.23
	V3-30-NRT-05:1.23
	cfm-01-00:1.23
	V3-30:1.23
	V3-20:1.23
	V3-10:1.21
	V2-23-NRT-02:1.16
	V2-23:1.16
	V2-22-NRT-01:1.16
	V2-22:1.16
	V2-21:1.14
	V2-20:1.13
	V2-11:1.12
	V2-10:1.12
	V2-00:1.12
	V1-51:1.8
	V1-50:1.8
	V1-45:1.8
	V1-44:1.8
	V1-43:1.8
	V1-42:1.7
	V1-41:1.7
	V1-32:1.8
	V1-40:1.7
	V1-31:1.7
	V1-30:1.2;
locks; strict;
comment	@# @;


1.48
date	2024.03.12.20.45.44;	author pwagner;	state Exp;
branches;
next	1.47;

1.47
date	2024.02.15.17.40.02;	author pwagner;	state Exp;
branches;
next	1.46;

1.46
date	2023.05.11.22.42.13;	author pwagner;	state Exp;
branches;
next	1.45;

1.45
date	2022.09.28.21.41.52;	author pwagner;	state Exp;
branches;
next	1.44;

1.44
date	2022.05.27.21.00.41;	author pwagner;	state Exp;
branches;
next	1.43;

1.43
date	2022.02.03.18.45.10;	author pwagner;	state Exp;
branches;
next	1.42;

1.42
date	2022.01.20.22.01.30;	author pwagner;	state Exp;
branches;
next	1.41;

1.41
date	2020.04.22.16.45.40;	author pwagner;	state Exp;
branches;
next	1.40;

1.40
date	2019.07.17.20.23.04;	author pwagner;	state Exp;
branches;
next	1.39;

1.39
date	2019.06.27.21.07.05;	author pwagner;	state Exp;
branches;
next	1.38;

1.38
date	2019.04.18.16.22.08;	author pwagner;	state Exp;
branches;
next	1.37;

1.37
date	2018.03.01.00.21.24;	author pwagner;	state Exp;
branches;
next	1.36;

1.36
date	2017.12.07.22.49.20;	author pwagner;	state Exp;
branches;
next	1.35;

1.35
date	2016.11.16.19.26.50;	author pwagner;	state Exp;
branches;
next	1.34;

1.34
date	2016.10.20.23.24.55;	author pwagner;	state Exp;
branches;
next	1.33;

1.33
date	2016.05.17.17.07.52;	author pwagner;	state Exp;
branches;
next	1.32;

1.32
date	2015.12.09.01.30.59;	author pwagner;	state Exp;
branches;
next	1.31;

1.31
date	2015.11.02.23.21.18;	author pwagner;	state Exp;
branches;
next	1.30;

1.30
date	2015.10.07.22.56.07;	author pwagner;	state Exp;
branches;
next	1.29;

1.29
date	2014.08.14.00.51.17;	author pwagner;	state Exp;
branches;
next	1.28;

1.28
date	2014.04.02.23.07.10;	author pwagner;	state Exp;
branches;
next	1.27;

1.27
date	2013.12.05.00.25.24;	author pwagner;	state Exp;
branches;
next	1.26;

1.26
date	2013.10.29.16.58.20;	author pwagner;	state Exp;
branches;
next	1.25;

1.25
date	2013.09.04.17.44.45;	author pwagner;	state Exp;
branches;
next	1.24;

1.24
date	2012.02.15.18.12.06;	author pwagner;	state Exp;
branches;
next	1.23;

1.23
date	2009.12.10.18.54.21;	author pwagner;	state Exp;
branches;
next	1.22;

1.22
date	2009.10.27.21.09.12;	author pwagner;	state Exp;
branches;
next	1.21;

1.21
date	2009.05.01.22.10.38;	author honghanh;	state Exp;
branches;
next	1.20;

1.20
date	2009.05.01.20.40.22;	author honghanh;	state Exp;
branches;
next	1.19;

1.19
date	2009.02.13.17.37.05;	author pwagner;	state Exp;
branches;
next	1.18;

1.18
date	2008.07.11.20.20.18;	author pwagner;	state Exp;
branches;
next	1.17;

1.17
date	2008.07.10.17.39.50;	author pwagner;	state Exp;
branches;
next	1.16;

1.16
date	2007.05.10.23.40.34;	author pwagner;	state Exp;
branches;
next	1.15;

1.15
date	2007.03.23.00.32.00;	author pwagner;	state Exp;
branches;
next	1.14;

1.14
date	2007.02.09.21.31.19;	author pwagner;	state Exp;
branches;
next	1.13;

1.13
date	2006.10.19.18.31.10;	author pwagner;	state Exp;
branches;
next	1.12;

1.12
date	2006.04.03.23.10.01;	author pwagner;	state Exp;
branches;
next	1.11;

1.11
date	2006.03.23.19.22.42;	author pwagner;	state Exp;
branches;
next	1.10;

1.10
date	2005.12.22.19.07.58;	author pwagner;	state Exp;
branches;
next	1.9;

1.9
date	2005.06.23.22.20.45;	author pwagner;	state Exp;
branches;
next	1.8;

1.8
date	2004.03.05.19.08.04;	author pwagner;	state Exp;
branches;
next	1.7;

1.7
date	2004.01.07.17.26.09;	author pwagner;	state Exp;
branches;
next	1.6;

1.6
date	2003.12.11.23.07.57;	author pwagner;	state Exp;
branches;
next	1.5;

1.5
date	2003.11.15.00.45.08;	author pwagner;	state Exp;
branches;
next	1.4;

1.4
date	2003.10.22.23.00.17;	author pwagner;	state Exp;
branches;
next	1.3;

1.3
date	2003.10.15.17.01.18;	author pwagner;	state Exp;
branches;
next	1.2;

1.2
date	2003.09.11.20.15.57;	author pwagner;	state Exp;
branches;
next	1.1;

1.1
date	2003.08.01.16.46.31;	author pwagner;	state Exp;
branches;
next	;


desc
@@


1.48
log
@Fixed errors in use by v6; defaults to not converting to NetCDF
@
text
@#!/bin/sh
# mlsl2p.sh
# runs the master task for mlsl2
#
# Assumes that:

# (1) Either
#  ----
# (a) It has been called from PGS_PC_Shell.sh as the (pge) in
#  PGS_PC_Shell.sh (pge) 0111 (PCF_file) 25 -v; or
# (b) It has been called to work directly w/o the toolkit panoply
#       with a single command-line arg: the l2cf file
# (a) and (b) are distinguished by the env variable UsingPCF
# If it's defined, and "yes" (or in fact just non-blank)
# then we'll assume we have case(a). Otherwise, we have case (b)
#  ----
# (2) $PGE_BINARY_DIR contains mlsl2 and $PGE_SCRIPT_DIR contains
#       slavetmplt.sh and jobstat-sips.sh
#     (or else define an enviromental variable (PVM_EP) and put them there)
# (3) PVM_HOSTS_INFO is defined as an environment variable
#     It should be the path and name of the host file,
#     a text file containing the hosts available
#     for running the slave tasks, one host per line
# (4) JOBDIR is defined as an environment variable
#     It should be the path where the job is run
# (5) PGE_ROOT is defined as an environment variable
#     It should be the path where the science_env.sh script is kept
# (6) OTHEROPTS is defined as an environment variable
#     It would contain other meaningful runtime options, 
#       e.g. OTHEROPTS="--skipRetrieval"
# (7) POSTL2SCRIPT (just like mlsnrt) is defined
# (8) ATTRFILE (just like mlsnrt) is defined
#
# Copyright 2005, by the California Institute of Technology. ALL
# RIGHTS RESERVED. United States Government Sponsorship acknowledged. Any
# commercial use must be negotiated with the Office of Technology Transfer
# at the California Institute of Technology.

# This software may be subject to U.S. export control laws. By accepting this
# software, the user agrees to comply with all applicable U.S. export laws and
# regulations. User has the responsibility to obtain export licenses, or other
# export authority as may be required before exporting such information to
# foreign countries or providing access to foreign persons.

# At the end of the master task, if the tools
#  h5repack 
#  aug_hdfeos5
# are in PGE_BINARY_DIR
# and if either
#   the current working directory ($cwd) or
#   $cwd/outputs
# houses the product files,
# then as a final step repack and augment them with netCDF attributes.

# As an alternative, if NETCDFCONVERT is defined and executable,
# use that instead to create an explicitly NetCDF-formatted file.
# Additionally, if NCCOPY is defined and executable,
# use that tool to compress the NetCDF file.

# usage: see (1) above

#------------------------------- extant_files ------------
#
# Function to return only those files among the args
# that actually exist
# Useful when passed something like *.f which may 
# (1) expand to list of files, returned as extant_files_result, or
# (2) stay *.f, in which case a blank is returned as extant_files_result 
#     (unless you have perversely named a file '*.f')
# usage: extant_files arg1 [arg2] ..

extant_files()
{
   extant_files_result=
   # Trivial case ($# = 0)
   if [ "$1" != "" ]
   then
      for file
      do
         if [ -f "$file" ]
         then
               extant_files_result="$extant_files_result $file"
         fi
      done
   fi
   echo $extant_files_result
}

#------------------------------- hide_files ------------
#
# Hide files when something goes awry
# usage: hide_files arg1 [arg2] ..

hide_files()
{
   hide_files_result=
   # Trivial case ($# = 0)
   if [ "$1" != "" ]
   then
      for file
      do
         if [ -f "$file" ]
         then
               hide_files_result="$hide_files_result $file"
         fi
      done
   fi
   echo $hide_files_result
   if [ ! -d hidden ]
   then
     mkdir hidden
   fi
   mv $hide_files_result hidden
}

#---------------------------- logit
# Either echo input string(s), or else append them to the master log file, 
# or both
# Which to do depends on $MUSTLOG

logit()
{
   if [ "$dryrun" = "yes" ]
   then
     echo "$@@"
   else
     case "$MUSTLOG" in
     no )
       echo "$@@"
       ;;
     yes )
       echo "$@@" >> "$MLSL2PLOG"
       ;;
     both )
       echo "$@@" | tee -a "$MLSL2PLOG"
       ;;
     esac
   fi
}
      
#-------------- mycp ----------------
# read each line of stdin
# and then echo it to stdout
# Why?
# Lines like
#   b=$a
# will be echoed as
#   b=100
# if the env variable a has been set to 100
mycp()
{
  set -o noglob
  while read line; do
    # Does line begin with a '#'?
    acomment=`echo $line | grep '^#'`
    if [ "$acomment" != "" ]
    then
      # Dont do anything special--just a comment
      echo $line
    else
      # May need to evaluate twice if line contains a $variable
      eval echo $line
    fi
  done
  set +o noglob
}

#------------------------------- mega_buck ------------
#
# Function to force multiple-evaluation of its second arg
# i.e., $$..$color (where the number of $ signs is n)
# usage: mega_buck n color

mega_buck()
{
   # Trivial case (n is 0)
   if [ "$1" -lt 1 ]
   then
     mega_buck_result="$2"
   elif [ "$2" = "" ]
   then
     mega_buck_result="$2"
   else
     mega_buck_result=`pr_mega_buck $1 $2`
   fi
}
      
pr_double_buck()
{
      eval echo $`echo $1`
}
      
pr_mega_buck()
{
      number=0
      mega_buck_temp=$2
      while [ "$number" -lt "$1" ]
      do
        mega_buck_temp=`pr_double_buck $mega_buck_temp`
        number=`expr $number + 1`
      done
      echo $mega_buck_temp
}
      
#---------------------------- lhs_eq_rhs
#
# Function to assign second arg to first: lhs=rhs
# where (lhs rhs) = ($1 $2)
# if given optional third arg "n"
# assigns $$..$lhs = $$..$rhs

lhs_eq_rhs()
{

      if [ $# -lt 3 ]
      then
         eval "$1"="'"$2"'"
      else
         mega_buck $3 $1
         lhs=$mega_buck_result
         mega_buck $3 $2
         rhs=$mega_buck_result
         eval "$lhs"="'"$rhs"'"
      fi
}

#---------------------------- set_if_not_def
#
# Function to assign second arg to first only if first not already defined
set_if_not_def()
{
     # echo $@@
     mega_buck 1 $1
     # echo $mega_buck_result
     if [ "$mega_buck_result" = "" -o "$mega_buck_result" = '$' ]
     then
       lhs_eq_rhs $@@
     fi
}

#---------------------------- rename_all_nc
#
# Function to rename all the .nc-marked l2gp files to .he5
rename_all_nc()
{
  files=`extant_files *L2GP-[A-CE-Z]*.nc *L2GP-DGG_*.nc`
  for file in $files
  do
    hname=`echo $file | sed 's/\.nc/\.he5/'`
    mv $file $hname
  done
}

#---------------------------- create_nc_metafiles
#
# Function to create metadata files for
# all the .nc-marked l2gp files
create_nc_metafiles()
{
  files=`extant_files *L2GP-[A-CE-Z]*.nc *L2GP-DGG_*.nc`
  for file in $files
  do
    hname=`echo $file | sed 's/\.nc/\.he5/'`
    # 1st: the .met files
    if [ -f "$hname.met" ]
    then
      cp $hname.met $file.met.tmp
      sed 's/\.he5/\.nc/' $file.met.tmp > $file.met
      rm $file.met.tmp
    fi
    # 2nd: the .xml files
    if [ -f "$hname.xml" ]
    then
      cp $hname.xml $file.xml.tmp
      sed 's/\.he5/\.nc/' $file.xml.tmp > $file.xml
      rm $file.xml.tmp
    fi
  done
}

# ------------------ check for misalignment ----------------------
# ----------------------------------------------------------------
# Check products for misaligned geolocations
# If they are found to be misaligned, set return_status to 99
check_for_misalignment()
{
if [ -x "$MISALIGNMENT" -a "$file" != "" ]
then
  logit "Checking for misalignment"
  a=`$MISALIGNMENT -silent $file`
  if [ "$a" != "" ]
  then
    logit $a
    logit "Misalignment detected"
    logit hide_files *.he5 *.met *.xml *.h5
    hide_files *.he5 *.met *.xml *.h5
    return_status=99
  fi
fi

}

# ------------------ convert the product file format ----------------------
# ----------------------------------------------------------------
# Convert hdfeos product files to netcdf
# A trick: the hdfeos file names already end in '.nc' so
# we'll need to mv them so they end in .he5
# When we're done we'll have 2 versions of each std. prod. file:
#   product.he5      hdfeos
#   product.nc       NetCDF4
# 
# Possible improvements:
# Option to end file names with ".nc4" instead of ".nc"
# Option to hide the hdfeos versions so they aren't copied
# to the scf or ingested into the database
convert_file_formats()
{
logit "NETCDFCONVERT: $NETCDFCONVERT"
logit "NCCOPY: $NCCOPY"
if [ -x "$NETCDFCONVERT" ]
then
  logit "Converting file format to NetCDF4"
  files=`extant_files *L2GP-*.he5`
  if [ "$files" = "" ]
  then
    if [ -d "outputs" ]
    then
      cd "outputs"
      files=`extant_files *L2GP-*.he5`
    fi
  fi
  for file in $files
  do
    ncname=`echo $file | sed 's/\.he5/\.nc/'`
    logit "Converting $file to $ncname"
    $NETCDFCONVERT $file
    # The tool insists on naming its output file "something.nc4"
    # So we must rename it yet again to "something.nc"
    # What a shameful mess we've made
    nc4name=`echo $file | sed 's/\.he5/\.nc4/'`
    logit "mving $nc4name to $ncname"
    mv $nc4name $ncname
  done
fi
}

# ------------------ nccopy_files ----------------------
# ----------------------------------------------------------------
# h5repack doesn't work properly with NetCDF files
# Instead we must use nccopy
nccopy_files()
{
if [ -x "$NCCOPY" ]
then
  logit "Doing nccopy on files"
  files=`extant_files *.nc`
  if [ "$files" = "" ]
  then
    if [ -d "outputs" ]
    then
      cd "outputs"
      files=`extant_files *.nc`
    fi
  fi
  for file in $files
  do
    if [ -w "$file" ]
    then
      packed="$file".p
      if [ "$GZIPLEVEL" != "" ] 
      then
        filter="-d $GZIPLEVEL"
      else
        filter=""
      fi
      logit "nccopying $file into $packed"
      logit $NCCOPY  $filter "$file" "$packed"
      $NCCOPY  $filter "$file" "$packed"
      # Here we could insert some check involving h5diff if we were dubious
      mv "$packed" "$file"
    fi
  done
fi
# ----------------------------------------------------------------
}
# ----------------------------------------------------------------

# ------------------ repack ----------------------
# ----------------------------------------------------------------
# repack level 2 product files to speed things up
# Last chance to find h5repack
repack_files()
{
if [ ! -x "$H5REPACK" ]
then
  H5REPACK=$HDFTOOLS/h5repack
fi

if [ -x "$H5REPACK" ]
then
  logit "Doing h5repack on files"
  files=`extant_files *L2FWM*.h5 *L2GP-[A-CE-Z]*.he5 *L2GP-DGG_*.he5 *L2AUX-[A-C]*.h5 *L2AUX-DGM_*.h5`
  if [ "$files" = "" ]
  then
    if [ -d "outputs" ]
    then
      cd "outputs"
      files=`extant_files *L2FWM*.h5 *L2GP-*.he5 *L2GP-*.nc *L2AUX-[A-C]*.h5 *L2AUX-DGM_*.h5`
    fi
  fi
  for file in $files
  do
    if [ -w "$file" ]
    then
      packed="$file".p
      if [ "$GZIPLEVEL" != "" ] 
      then
        filter="-f GZIP=$GZIPLEVEL"
      else
        filter=""
      fi
      logit "Packing $file into $packed"
      logit $H5REPACK -i "$file" -o "$packed" $filter
      $H5REPACK -i "$file" -o "$packed" $filter
      # Here we could insert some check involving h5diff if we were dubious
      mv "$packed" "$file"
    fi
  done
fi
# ----------------------------------------------------------------
}

# ------------------ augment ----------------------
# ----------------------------------------------------------------
# augment level 2 product files to make them netcdf-compatible
# (must not reverse order of repack, augment)
# After we become more comfortable with l2gp2nc4 actually
# converting the hdfeos formats to NetCDF4 we may delete
# this section.
augment_files()
{
if [ -x "$NETCDFAUGMENT" ]
then
  logit "Doing augment on files"
  files=`extant_files *L2GP-[A-CE-Z]*.he5 *L2GP-DGG_*.he5`
  if [ "$files" = "" ]
  then
    if [ -d "outputs" ]
    then
      cd "outputs"
      files=`extant_files *L2GP-[A-CE-Z]*.he5 *L2GP-DGG_*.he5`
    fi
  fi
  logit "files: $files"
  for file in $files
  do
    if [ -w "$file" ]
    then
      logit $NETCDFAUGMENT $file
      $NETCDFAUGMENT $file
    fi
  done
fi
# ----------------------------------------------------------------
}

# ----------------------reformat_and_repack-----------------
# ----------------------------------------------------------------
reformat_and_repack()
{

  # Will we use python scripts to predict values for any other
  # products, e.g. CloudTopHeight?
  echo "POSTL2SCRIPT: $POSTL2SCRIPT"
  echo "ATTRFILE: $ATTRFILE"
  if [ -f "$POSTL2SCRIPT" -a -f "$ATTRFILE" ]
  then
    # for postl2script.sh to work properly, we must be in $JOBDIR
    olddir=`pwd`
    cd $JOBDIR
    $POSTL2SCRIPT "$OUTPUTS_C" OUTPUTS_A OUTPUTS_B PCF_A PCF_B
    cd $olddir
  else
    echo "POSTL2SCRIPT or ATTRFILE was not defined, so no post l2 script to run"
  fi
  convert_file_formats
  
  # Do we have metadata files for NetCDF-formatted product files yet?
  ncmetadata=`extant_files *L2GP-DGG_*.nc.met`
  if [ "$ncmetadata" = "" ]
  then
    create_nc_metafiles
  fi


  nccopy_files

  repack_files

  augment_files

}

# ----------------------wait_for_slaves_to_finish-----------------
# ----------------------------------------------------------------
wait_for_slaves_to_finish()
{
logit SAVEJOBSTATS $SAVEJOBSTATS
logit masterlog $masterlog
logit PGE_SCRIPT_DIR/jobstat-sips.sh $PGE_SCRIPT_DIR/jobstat-sips.sh
# Save record of progress thru phases
if [ -f "$masterlog" ]
then
  l2cf=`grep -i 'Level 2 configuration file' $masterlog | head -1 | awk '{print $13}'`
fi
if [ "$SAVEJOBSTATS" = "yes" -a -x "$PGE_SCRIPT_DIR/jobstat-sips.sh" -a -f "$l2cf" ]
then
  # This sleep is to give slave tasks extra time to complete stdout
  sleep 20
  JOBSTATSFILE="$JOBDIR/phases.stats"
  JOBSOPTS="-S $PGE_BINARY_DIR/mlsqlog-scan-sips.py -t $PGE_SCRIPT_DIR/split_path.sh ${JOBDIR}/pvmlog $l2cf $masterlog"
  if [ "$verbose" != "" ]
  then
    JOBSOPTS="-v $JOBSOPTS"
  fi
  logit "$PGE_SCRIPT_DIR/jobstat-sips.sh $JOBSOPTS"
  $PGE_SCRIPT_DIR/jobstat-sips.sh $JOBSOPTS > "$JOBSTATSFILE"
else
  JOBSTATSFILE="none"
fi

# catenate each slave's log to a log file
LOGFILE="${JOBDIR}/pvmlog/mlsl2.log"
if [ ! -w "$LOGFILE"  ]
then
  logit "catenating slave logs in $LOGFILE"
  echo "catenating slave logs in $LOGFILE" > "$LOGFILE".1
  # This sleep is to give slave tasks extra time to complete stdout
  sleep 20
  cat ${JOBDIR}/pvmlog/*.log >> "$LOGFILE".1
  rm -f ${JOBDIR}/pvmlog/*.log
  mv "$LOGFILE".1 "$LOGFILE"
fi

if [ -f "$LOGFILE" -a -f "$JOBSTATSFILE" ]
then
  cat "$LOGFILE" "$JOBSTATSFILE" > "$LOGFILE".1
  mv "$LOGFILE".1 "$LOGFILE"
fi
}

#------------------------------- run_mlsl2_ntk ------------
#
# Function to do one level 2 run after expanding an l2cf template
# so: no toolkit is required
# usage:
# run_mlsl2_ntk [options] l2cf
# args:
# options        recognized cmdline args for mlsl2
# l2cf           level 2 config file
#

run_mlsl2_ntk()
{
  logit "Running mlsl2 master w/o toolkit"
  logit "args $@@"
  # First a pre-flight run to check paths                               
  # If a problem, disclosed by exit status, exit before starting big run
  if [ "$CHECKPATHS" = "yes" ]                                          
  then                                                                  
    $PGE_BINARY --checkPaths --ntk $otheropts $l2cf
    return_status=`expr $?`                                             
    if [ $return_status != $NORMAL_STATUS ]                             
    then                                                                
                                                                        
       logit "Preflight checkPaths run ended badly"                      
       logit "Possibly an error in pathnames; please check your l2cf"    
       exit 1                                                           
    fi                                                                  
  fi                                                                    
                                                                        
  # Next, create a fresh ident based on master task's binary executable 
  if [ "$CHECKIDENTS" = "yes" ]                                         
  then                                                                  
    IDENTFILE="$JOBDIR/master.ident"                                    
    rm -f "$IDENTFILE"                                                  
    ident $PGE_BINARY > "$IDENTFILE"                                    
  else                                                                  
    IDENTFILE="none"                                                    
  fi         

  # HOSTNAME will be stored in metadata as ProductionLocation
  # to trace provenance
  if [ "$HOSTNAME" = "" ]
  then
    HOSTNAME=local
  fi

  # Now we launch the master task itself to set everything in motion  
  $PGE_BINARY --pge $slave_script --ntk --master $PVM_HOSTS_INFO \
    --idents "$IDENTFILE" --loc "$HOSTNAME" \
    $otheropts $l2cf 2> $JOBDIR/master.l2cfname
  return_status=`expr $?`
  wait_for_slaves_to_finish
}

#------------------------------- run_mlsl2_tk ------------
#
# Function to do one level 2 run after expanding a pcf template
# so this run requires the toolkit panoply
# usage:
# run_mlsl2_tk [options]
# args:
# options        recognized cmdline args for mlsl2
#

run_mlsl2_tk()
{
  # First a pre-flight run to check paths
  # If a problem, disclosed by exit status, exit before starting big run
  if [ "$CHECKPATHS" = "yes" ]
  then
    $PGE_BINARY --checkPaths --tk $otheropts 2> $JOBDIR/master.l2cfname
    return_status=`expr $?`
    if [ $return_status != $NORMAL_STATUS ]
    then
       cat $JOBDIR/master.l2cfname
       logit "Preflight checkPaths run ended badly"
       logit "Possibly an error in pathnames; please check your PCF"
       cat $JOBDIR/master.l2cfname >> "$MLSL2PLOG"
       exit 1
    fi
  fi

  # Next, create a fresh ident based on master task's binary executable
  if [ "$CHECKIDENTS" = "yes" ]
  then
    IDENTFILE="$JOBDIR/master.ident"
    rm -f "$IDENTFILE"
    ident $PGE_BINARY > "$IDENTFILE"
  else
    IDENTFILE="none"
  fi

  # HOSTNAME will be stored in metadata as ProductionLocation
  # to trace provenance
  if [ "$HOSTNAME" = "" ]
  then
    logit "Need HOSTNAME to trace provenance as ProductionLocation"
    exit 1
  fi

    if [ "$CAPTURE_MT" = "yes" -a "$STDERRFILE" = "" ]
    then
      STDERRFILE=mlsl2p.stderr
    fi

  # Now we launch the master task itself to set everything in motion
  if [ "$CAPTURE_MT" = "yes" ]
  then
    /usr/bin/time -f 'M: %M t: %e' $PGE_BINARY --pge $slave_script --tk --master $PVM_HOSTS_INFO \
      --idents "$IDENTFILE" --loc "$HOSTNAME" $otheropts 2> "$STDERRFILE"
  elif [ "$STDERRFILE" != "" ]
  then
    $PGE_BINARY --pge $slave_script --tk --master $PVM_HOSTS_INFO \
      --idents "$IDENTFILE" --loc "$HOSTNAME" $otheropts 2> "$STDERRFILE"
  else
    $PGE_BINARY --pge $slave_script --tk --master $PVM_HOSTS_INFO \
      --idents "$IDENTFILE" --loc "$HOSTNAME" $otheropts
  fi
  # Save return status
  return_status=`expr $?`
  wait_for_slaves_to_finish
}

# ------------------------------- run_serially
run_serially()
{
  if [ "$PGE_BINARY" = "" ]
  then
    PGE_BINARY=$BIN_DIR/$MLSPROG
  fi
  echo $PGE_BINARY $EXTRA_OPTIONS "$@@"
  
  if [ ! -x "$PGE_BINARY"  ]
  then
    echo "************************************************************************"
    echo "$PGE_BINARY doesn't exist!"
    echo "Check for typos in its path and program names"
    echo "************************************************************************"
    exit 1
  fi
  if [ -f $BIN_DIR/license.txt ]
  then
    cat $BIN_DIR/license.txt
  fi
  echo $PGE_BINARY $otheropts "$@@"
  if [ "$CAPTURE_MT" = "yes" -a "$STDERRFILE" = "" ]
  then
    STDERRFILE=$MLSPROG.stderr
  fi
  if [ "$UsingPCF" != "" ]
  then
    otheropts="--tk $otheropts"
  fi
  if [ "$CAPTURE_MT" = "yes" ]
  then
    /usr/bin/time -f 'M: %M t: %e' $PGE_BINARY $otheropts "$@@" 2> "$STDERRFILE"
  elif [ "$STDERRFILE" != "" ]
  then
    $PGE_BINARY $otheropts "$@@" 2> "$STDERRFILE"
  else
    $PGE_BINARY $otheropts "$@@"
  fi
  return_status=`expr $?`
  H5REPACK=$BIN_DIR/h5repack
  MISALIGNMENT=$BIN_DIR/misalignment
}

#------------------------------- Main Program ------------

#****************************************************************
#                                                               *
#                  * * * Main Program  * * *                    *
#                                                               *
#                                                               *
#	The entry point where control is given to the script         *
#****************************************************************
#
CHECKPATHS="yes"
#           ^^^---- "yes" if extra preflight non-retrieval run to check paths

CHECKIDENTS="yes"
#            ^^^---- "yes" if each slave to check its ident against master

GZIPLEVEL="1"
#          ^^^---- compression level ("" means none)

MLSL2PLOG="$JOBDIR/mlsl2p.log"
#             ^^^---- "yes" if progress of chunks thru phases recorded

MUSTLOG="both"
if [ -f "$MLSL2PLOG" ]
then
  mv $MLSL2PLOG $MLSL2PLOG.1
fi
echo "Entering mlsl2p.sh with args $@@"
pwd
echo "MLSL2PLOG " > "$MLSL2PLOG"

logit "$MLSL2PLOG"
env | sort >> "$MLSL2PLOG"

SAVEJOBSTATS="no"
#             ^^^---- "yes" if recording progress of chunks through each phase

# In addition to whatever options and switches may be set by the environment
# variable OTHEROPTS, the following are set:
# -g       trace path of execution through code sections
# --wall   show timing in wall clock times
# slv      insert slave outputs among master's stdout
# mas      show master's pvm activities as they occur
# chu      show chunk divisions
# opt1     show command line options
# log      copy any log file messages to stdout
# pro      announce input files at opening, output files at creation
# time     summarize time consumed by each code  section, phase, etc.
otheropts="$OTHEROPTS -g --wall -S'mas,chu,opt1,log,pro,time'"
verbose=`echo "$otheropts" | grep -i verbose`

# Check that assumptions are valid
if [ "$PGS_PC_INFO_FILE" = "" -a "$UsingPCF" != "" ]
then
  logit "************************************************************************"
  logit 'PGS_PC_INFO_FILE undefined'
  logit 'usage:'
  logit 'PGS_PC_Shell.sh (pge) 0111 (PCF_file) 25 -v'
  logit "************************************************************************"
  exit 1
elif [ "$PVM_HOSTS_INFO" = "" ]
then
  logit "************************************************************************"
  logit 'PVM_HOSTS_INFO undefined' 
  logit 'It should be the path and name of the host file'
  logit 'a text file containing the hosts available'
  logit 'for running the slave tasks, one host per line'
  logit "************************************************************************"
  exit 1
elif [ "$JOBDIR" = "" ]
then
  logit "************************************************************************"
  logit 'JOBDIR undefined' 
  logit 'It should be the path where the job is run'
  logit "************************************************************************"
  exit 1
elif [ "$PGE_ROOT" = "" ]
then
  logit "************************************************************************"
  logit 'PGE_ROOT undefined' 
  logit 'It should be the path where the science_env.sh script is kept'
  logit "************************************************************************"
  exit 1
fi

# In case you used the ep=(PGE_BINARY_DIR)
# in the host file
set_if_not_def PGE_BINARY_DIR  $HOME/pvm3/bin/LINUX
set_if_not_def PGE_BINARY      $PGE_BINARY_DIR/mlsl2

if [ ! -x "$PGE_BINARY"  ]
then
  logit "************************************************************************"
  logit "$PGE_BINARY doesn't exist!"
  logit "Check for typos in its path and program names"
  logit "************************************************************************"
  exit 1
elif [ ! -r "$PGE_SCRIPT_DIR/slavetmplt.sh"  ]
then
  logit "************************************************************************"
  logit "slavetmplt.sh not in $PGE_SCRIPT_DIR"
  logit "Check for typos in its path and program names"
  logit "************************************************************************"
  exit 1
fi

set_if_not_def H5REPACK       $PGE_BINARY_DIR/h5repack
set_if_not_def NETCDFAUGMENT  $PGE_BINARY_DIR/aug_hdfeos5
# set_if_not_def NETCDFCONVERT  $PGE_BINARY_DIR/l2gp2nc4
set_if_not_def MISALIGNMENT   $PGE_BINARY_DIR/misalignment
if [ ! -x "$H5REPACK" ]
then
  H5REPACK=$MLSTOOLS/h5repack
fi
if [ ! -x "$NETCDFAUGMENT" ]
then
  NETCDFAUGMENT=$MLSTOOLS/aug_hdfeos5
fi
if [ ! -x "$NETCDFAUGMENT" ]
then
  NETCDFAUGMENT=$MLSTOOLS/aug_eos5
fi

# We are going to insist that both H5REPACK and NETCDFAUGMENT
# be defined before going any further. To override this, set
# the environment variable OKTONOTAUGMENT to "yes"
if [ "$OKTONOTAUGMENT" = "" ]
then
  if [ ! -x "$NETCDFAUGMENT" ]
  then
    echo "NETCDFAUGMENT not defined"
    exit 1
  elif [ ! -x "$H5REPACK" ]
  then
    echo "H5REPACK not defined"
    exit 1
  fi
fi

# if [ # -x "$NETCDFCONVERT" ]
# then
#   NETCDFCONVERT=$MLSTOOLS/l2gp2nc4
# fi
if [ ! -x "$MISALIGNMENT" ]
then
  MISALIGNMENT=$MLSTOOLS/misalignment
fi

masterlog="${JOBDIR}/exec_log/process.stdout"
if [ "$MASTERLOG" != "" ]
then
  masterlog="$MASTERLOG"
fi

# We print the file license.txt to stdout
if [ -f $PGE_BINARY_DIR/license.txt ]
then
  cat $PGE_BINARY_DIR/license.txt
  cat $PGE_BINARY_DIR/license.txt >> "$MLSL2PLOG"
fi

# Oops, this stomps on any PCF we might have selected
# so save it to be restored
logit "Original PCF: $PGS_PC_INFO_FILE"
PCF=$PGS_PC_INFO_FILE
if [ -r "$JOBDIR/job.env"  ]
then
  . $JOBDIR/job.env
  PCF=$PGS_PC_INFO_FILE
elif [ -r "$PGE_ROOT/science_env.sh"  ]
then
  . ${PGE_ROOT}/science_env.sh
elif [ -r "$PGSBIN/pgs-env.ksh" ]
then
  . $PGSBIN/pgs-env.ksh
fi
PGS_PC_INFO_FILE=$PCF
export PGS_PC_INFO_FILE
logit "new PCF: $PGS_PC_INFO_FILE" 

# The logs will be written as separate files into ${JOBDIR}/pvmlog
# before being catenated at end of run
# Make certain this directory exists and that it is empty
if [ ! -d ${JOBDIR}/pvmlog ]
then
  mkdir ${JOBDIR}/pvmlog
else
  rm -f ${JOBDIR}/pvmlog/*.log
fi

# The following environmental variable may already have been set
if [ "$PGSMEM_USESHM" = "" ]
then
  PGSMEM_USESHM=NO
fi

export FLIB_DVT_BUFFER=0

if [ "$MASTEROPTSFILE" != "" ]
then
  mycp < $MASTEROPTSFILE > ${JOBDIR}/master.opts
  otheropts="-g --wall -S'mas,chu,opt1,log,pro,time' --setf ${JOBDIR}/master.opts"
fi
env
env | sort >> "$MLSL2PLOG"
ulimit -s unlimited
ulimit -a
NORMAL_STATUS=2

# ------------------ launch the level 2 run ----------------------
# ----------------------------------------------------------------
if [ "$SERIALRUN" = "yes" ]
then
  run_serially
  reformat_and_repack
elif [ "$UsingPCF" != "" ]
then
  # Use sed to convert slavetmplt.sh into an executable script
  # The resulting script sets some toolkit-savvy environment variables
  # and then launches the regular mlsl2 binary when summoned to do so.
  SLV_SUF=slave
  slave_script=$JOBDIR/mlsl2.$SLV_SUF
  rm -f $slave_script
  sed "s=ppccff=${PGS_PC_INFO_FILE}=;
  s=UUssiinnggPPCCFF=yes=;
  s=ppggssmmeemmuusseesshhmm=${PGSMEM_USESHM}=;
  s=ssllaavveessccrriipptt=${slave_script}=;
  s=ootthheerrooppttss=\"${otheropts}\"=;
  s=ppggeebbiinnaarryy=${PGE_BINARY}=;
  s=ppggssbbiinn=${PGSBIN}=;
  s=jjoobbddiirr=${JOBDIR}=;
  s=ppggeerroott=${PGE_ROOT}=;" $PGE_SCRIPT_DIR/slavetmplt.sh > $slave_script
  chmod a+x $slave_script

  run_mlsl2_tk
  l2cf=$L2CF
  
  # Do we have an outputs subdirectory of JOBDIR for std prods?
  if [ -d "$JOBDIR/outputs" ]
  then
    STDPRODDIR="$JOBDIR/outputs"
    OUTPUTS_C=outputs
  else
    STDPRODDIR="$JOBDIR"
    OUTPUTS_C=./
  fi
  
  cd $STDPRODDIR
  OUTPUTS_C=`pwd`
  # Did we name the dgg file *L2GP-DGG*.nc in the PCF?
  # if so, rename all the l2gp files so they end with .he5
  dggfilenc=`extant_files *L2GP-DGG_*.nc`
  if [ "$dggfilenc" != "" ]
  then
    rename_all_nc
  fi

  check_for_misalignment
  reformat_and_repack
  
else
  # Use sed to convert slavetmplt.sh into an executable script
  # The resulting script sets some toolkitless environment variables
  # and then launches the regular mlsl2 binary when summoned to do so.
  l2cf=$1
  # Check that we were called properly
  if [ ! -f "$l2cf" ]
  then
    logit "************************************************************************"
    logit 'Usage (w/o toolkit): mlsl2p.sh l2cf_file'
    logit 'Check that you really intended to run w/o toolkit'
    logit 'To run with a PCF you must set the environment variable UsingPCF=yes'
    logit "************************************************************************"
    exit 1
  fi
  SLV_SUF=slave
  slave_script=$JOBDIR/mlsl2.$SLV_SUF
  rm -f $slave_script
  sed "s=ppggssmmeemmuusseesshhmm=${PGSMEM_USESHM}=;
  s=UUssiinnggPPCCFF==;
  s=ssllaavveessccrriipptt=${slave_script}=;
  s=ootthheerrooppttss=\"${otheropts}\"=;
  s=ppggeebbiinnaarryy=${PGE_BINARY}=;
  s=ppggssbbiinn=${PGSBIN}=;
  s=jjoobbddiirr=${JOBDIR}=;
  s=ppggeerroott=${PGE_ROOT}=;" $PGE_SCRIPT_DIR/slavetmplt.sh > $slave_script
  chmod a+x $slave_script

  run_mlsl2_ntk
  check_for_misalignment
fi

# ----------------------------------------------------------------

# End toolkitless run's log file with a grep-able sign-off message
if [ "$UsingPCF" = "" ]
then
  logit " "
  logit "mlsl2p.sh: return from PGE: $return_status"
fi

if [ $return_status != $NORMAL_STATUS ]
then
   exit 1
else
   exit 0
fi

# $Log: mlsl2p.sh,v $
# Revision 1.47  2024/02/15 17:40:02  pwagner
# Repaired numerous goldbrick-killing bugs introduced with last commit
#
# Revision 1.46  2023/05/11 22:42:13  pwagner
# Now insists that H5REPACK and NETCDFAUGMENT be defined before running
#
# Revision 1.45  2022/09/28 21:41:52  pwagner
# Add comments regarding NCCOPY variable
#
# Revision 1.44  2022/05/27 21:00:41  pwagner
# Printed a more helpful error message when run w/o toolkit
#
# Revision 1.43  2022/02/03 18:45:10  pwagner
# Move augment, convert, etc. into internal functions
#
# Revision 1.42  2022/01/20 22:01:30  pwagner
# Cant SAVEJOBSTATS until we debug mlsqlog-scan-sips.py
#
# Revision 1.41  2020/04/22 16:45:40  pwagner
# May use NETCDFCONVERT instead of augmenting hdfeos files
#
# Revision 1.40  2019/07/17 20:23:04  pwagner
# Try to makee error mesgs more helpful and conspicuous
#
# Revision 1.39  2019/06/27 21:07:05  pwagner
# Print sign-off at end of toolkitless run; use logit mechanism
#
# Revision 1.38  2019/04/18 16:22:08  pwagner
# May evaluate variables in opts file if USEOPTSENV is set; drop slavetmpltntk.sh because slavetmplt.sh now does double-duty
#
# Revision 1.37  2018/03/01 00:21:24  pwagner
# Now handles both --tk and --ntk cases
#
# Revision 1.36  2017/12/07 22:49:20  pwagner
# Try harder not to stomp on choice of PCF
#
# Revision 1.35  2016/11/16 19:26:50  pwagner
# Avoids stomping on an already-selected PCF
#
# Revision 1.34  2016/10/20 23:24:55  pwagner
# cat master.l2cfname to stdout and to master stdout
#
# Revision 1.33  2016/05/17 17:07:52  pwagner
# 'dot' job.env if found; Obey CAPTURE_MT
#
# Revision 1.32  2015/12/09 01:30:59  pwagner
# Fixed some typos
#
# Revision 1.31  2015/11/02 23:21:18  pwagner
# Now checks for mialigned geolocations
#
# Revision 1.30  2015/10/07 22:56:07  pwagner
# Automtically writes out l2cf name to master.l2cfname
#
# Revision 1.29  2014/08/14 00:51:17  pwagner
# Creates mlsl2p log file
#
# Revision 1.28  2014/04/02 23:07:10  pwagner
# Pass HOSTNAME on commandline to use in metadata
#
# Revision 1.27  2013/12/05 00:25:24  pwagner
# Fix latest problems with creating JOBSTATSFILE
#
# Revision 1.26  2013/10/29 16:58:20  pwagner
# May set environment variable PGE_BINARY
#
# Revision 1.25  2013/09/04 17:44:45  pwagner
# Replaced '--cat' cmdline option; 'Catenate' now an Output section command
#
# Revision 1.24  2012/02/15 18:12:06  pwagner
# Offer last chance to find h5repack in HDFTOOLS directory
#
# Revision 1.23  2009/12/10 18:54:21  pwagner
# Must repack before augmenting, not after
#
# Revision 1.22  2009/10/27 21:09:12  pwagner
# Added NETCDFAUGMENTing hdfeos std products
#
# Revision 1.21  2009/05/01 22:10:38  honghanh
# Change the initialization of l2cf back to the old way because environment
# variables defined in .env file is not avaiable to mlsl2p.sh.
#
# Revision 1.20  2009/05/01 20:40:22  honghanh
# Use L2CFVERSION to supply l2cf variable
#
# Revision 1.19  2009/02/13 17:37:05  pwagner
# Running mlspgs automatically prints license text
#
# Revision 1.18  2008/07/11 20:20:18  pwagner
# Fixed bugs regarding products in outputs subdirectory
#
# Revision 1.17  2008/07/10 17:39:50  pwagner
# Handle case when product files are in outputs subdirectory
#
# Revision 1.16  2007/05/10 23:40:34  pwagner
# Used ulimit to increase tiny stacksize so Intel-built mlsl2 can finish
#
# Revision 1.15  2007/03/23 00:32:00  pwagner
# By default no longer dumps slave stdouts into masters
#
# Revision 1.14  2007/02/09 21:31:19  pwagner
# Sets environmental variable as work-around to Lahey 6.2 bug
#
# Revision 1.13  2006/10/19 18:31:10  pwagner
# Now saves chunk stats at end of output
#
# Revision 1.12  2006/04/03 23:10:01  pwagner
# Fixed serious and various bugs
#
# Revision 1.11  2006/03/23 19:22:42  pwagner
# repack with gzip compression all hdf5/hdfeos5 product files
#
# Revision 1.10  2005/12/22 19:07:58  pwagner
# Imitated l1b repacking to defragment forward model files
#
# Revision 1.9  2005/06/23 22:20:45  pwagner
# Reworded Copyright statement
#
# Revision 1.8  2004/03/05 19:08:04  pwagner
# Made --cat the default option
#
# Revision 1.7  2004/01/07 17:26:09  pwagner
# Merged in sips-friendly changes
#
# Revision 1.6  2003/12/11 23:07:57  pwagner
# May check each slaves ident against master to verify pge versions are the same
#
# Revision 1.5  2003/11/15 00:45:08  pwagner
# Uses --checkPaths to perform extra preflight checks
#
# Revision 1.4  2003/10/22 23:00:17  pwagner
# Catenates each slaves log file to mlsl2.log at end
#
# Revision 1.3  2003/10/15 17:01:18  pwagner
# Added slv option
#
# Revision 1.2  2003/09/11 20:15:57  pwagner
# Allow OTHEROPTS environmental variable pass-through to mlsl2
#
# Revision 1.1  2003/08/01 16:46:31  pwagner
# First commit
#
@


1.47
log
@Repaired numerous goldbrick-killing bugs introduced with last commit
@
text
@d474 2
d478 7
a484 1
      $POSTL2SCRIPT "$OUTPUTS_C" OUTPUTS_A OUTPUTS_B PCF_A PCF_B
d828 1
a828 1
set_if_not_def NETCDFCONVERT  $PGE_BINARY_DIR/l2gp2nc4
d859 4
a862 4
if [ ! -x "$NETCDFCONVERT" ]
then
  NETCDFCONVERT=$MLSTOOLS/l2gp2nc4
fi
d1029 3
@


1.46
log
@Now insists that H5REPACK and NETCDFAUGMENT be defined before running
@
text
@d31 2
d241 40
a282 1
file=`extant_files *L2GP-DGG_*.he5`
d323 1
a323 1
  files=`extant_files *L2GP-*.nc`
d329 1
a329 1
      files=`extant_files *L2GP-*.nc`
d334 3
a336 5
    hname=`echo $file | sed 's/\.nc$/\.he5/'`
    logit "mving $file to $hname"
    mv $file $hname
    logit "Converting $hname to $file"
    $NETCDFCONVERT $hname
d340 3
a342 3
    nc4name=`echo $hname | sed 's/\.he5$/\.nc4/'`
    logit "mving $nc4name to $file"
    mv $nc4name $file
d467 29
d668 44
d739 2
d923 5
a927 1
if [ "$UsingPCF" != "" ]
d948 21
d970 2
a971 9

  convert_file_formats

  nccopy_files

  repack_files

  augment_files

d1021 3
@


1.45
log
@Add comments regarding NCCOPY variable
@
text
@d720 17
d889 3
@


1.44
log
@Printed a more helpful error message when run w/o toolkit
@
text
@d54 3
a56 1
# use that instead.
d278 1
d308 1
a308 1
# ------------------ nccopy ----------------------
d872 3
@


1.43
log
@Move augment, convert, etc. into internal functions
@
text
@d830 2
d869 3
@


1.42
log
@Cant SAVEJOBSTATS until we debug mlsqlog-scan-sips.py
@
text
@d237 236
d525 1
d594 1
d810 10
d847 1
a848 211
# ----------------------------------------------------------------

logit SAVEJOBSTATS $SAVEJOBSTATS
logit masterlog $masterlog
logit PGE_SCRIPT_DIR/jobstat-sips.sh $PGE_SCRIPT_DIR/jobstat-sips.sh
# Save record of progress thru phases
if [ -f "$masterlog" ]
then
  l2cf=`grep -i 'Level 2 configuration file' $masterlog | head -1 | awk '{print $13}'`
fi
if [ "$SAVEJOBSTATS" = "yes" -a -x "$PGE_SCRIPT_DIR/jobstat-sips.sh" -a -f "$l2cf" ]
then
  # This sleep is to give slave tasks extra time to complete stdout
  sleep 20
  JOBSTATSFILE="$JOBDIR/phases.stats"
  JOBSOPTS="-S $PGE_BINARY_DIR/mlsqlog-scan-sips.py -t $PGE_SCRIPT_DIR/split_path.sh ${JOBDIR}/pvmlog $l2cf $masterlog"
  if [ "$verbose" != "" ]
  then
    JOBSOPTS="-v $JOBSOPTS"
  fi
  logit "$PGE_SCRIPT_DIR/jobstat-sips.sh $JOBSOPTS"
  $PGE_SCRIPT_DIR/jobstat-sips.sh $JOBSOPTS > "$JOBSTATSFILE"
else
  JOBSTATSFILE="none"
fi

# catenate each slave's log to a log file
LOGFILE="${JOBDIR}/pvmlog/mlsl2.log"
if [ ! -w "$LOGFILE"  ]
then
  logit "catenating slave logs in $LOGFILE"
  echo "catenating slave logs in $LOGFILE" > "$LOGFILE".1
  # This sleep is to give slave tasks extra time to complete stdout
  sleep 20
  cat ${JOBDIR}/pvmlog/*.log >> "$LOGFILE".1
  rm -f ${JOBDIR}/pvmlog/*.log
  mv "$LOGFILE".1 "$LOGFILE"
fi

if [ -f "$LOGFILE" -a -f "$JOBSTATSFILE" ]
then
  cat "$LOGFILE" "$JOBSTATSFILE" > "$LOGFILE".1
  mv "$LOGFILE".1 "$LOGFILE"
fi

# ------------------ check for misalignment ----------------------
# ----------------------------------------------------------------
file=`extant_files *L2GP-DGG_*.he5`
# Check products for misaligned geolocations
# If they are found to be misaligned, set return_status to 99
if [ -x "$MISALIGNMENT" -a "$file" != "" ]
then
  a=`$MISALIGNMENT -silent $file`
  if [ "$a" != "" ]
  then
    logit $a
    logit "Misalignment detected"
    logit hide_files *.he5 *.met *.xml *.h5
    hide_files *.he5 *.met *.xml *.h5
    return_status=99
  fi
fi

# ------------------ convert the product file format ----------------------
# ----------------------------------------------------------------
# Convert hdfeos product files to netcdf
# A trick: the hdfeos file names already end in '.nc' so
# we'll need to mv them so they end in .he5
# When we're done we'll have 2 versions of each std. prod. file:
#   product.he5      hdfeos
#   product.nc       NetCDF4
# 
# Possible improvements:
# Option to end file names with ".nc4" instead of ".nc"
# Option to hide the hdfeos versions so they aren't copied
# to the scf or ingested into the database
if [ -x "$NETCDFCONVERT" -a "$UsingPCF" != "" ]
then
  files=`extant_files *L2GP-*.nc`
  if [ "$files" = "" ]
  then
    if [ -d "outputs" ]
    then
      cd "outputs"
      files=`extant_files *L2GP-*.nc`
    fi
  fi
  for file in $files
  do
    hname=`echo $file | sed 's/\.nc$/\.he5/'`
    logit "mving $file to $hname"
    mv $file $hname
    logit "Converting $hname to $file"
    $NETCDFCONVERT $hname
    # The tool insists on naming its output file "something.nc4"
    # So we must rename it yet again to "something.nc"
    # What a shameful mess we've made
    nc4name=`echo $hname | sed 's/\.he5$/\.nc4/'`
    logit "mving $nc4name to $file"
    mv $nc4name $file
  done
fi
# ----------------------------------------------------------------


# ------------------ nccopy ----------------------
# ----------------------------------------------------------------
# h5repack doesn't work properly with NetCDF files
# Instead we must use nccopy
if [ -x "$NCCOPY" ]
then
  files=`extant_files *.nc`
  if [ "$files" = "" ]
  then
    if [ -d "outputs" ]
    then
      cd "outputs"
      files=`extant_files *.nc`
    fi
  fi
  for file in $files
  do
    if [ -w "$file" ]
    then
      packed="$file".p
      if [ "$GZIPLEVEL" != "" ] 
      then
        filter="-d $GZIPLEVEL"
      else
        filter=""
      fi
      logit "nccopying $file into $packed"
      logit $NCCOPY  $filter "$file" "$packed"
      $NCCOPY  $filter "$file" "$packed"
      # Here we could insert some check involving h5diff if we were dubious
      mv "$packed" "$file"
    fi
  done
fi
# ----------------------------------------------------------------

# ------------------ repack ----------------------
# ----------------------------------------------------------------
# repack level 2 product files to speed things up
# Last chance to find h5repack
if [ ! -x "$H5REPACK" ]
then
  H5REPACK=$HDFTOOLS/h5repack
fi

if [ -x "$H5REPACK" ]
then
  files=`extant_files *L2FWM*.h5 *L2GP-[A-CE-Z]*.he5 *L2GP-DGG_*.he5 *L2AUX-[A-C]*.h5 *L2AUX-DGM_*.h5`
  if [ "$files" = "" ]
  then
    if [ -d "outputs" ]
    then
      cd "outputs"
      files=`extant_files *L2FWM*.h5 *L2GP-*.he5 *L2GP-*.nc *L2AUX-[A-C]*.h5 *L2AUX-DGM_*.h5`
    fi
  fi
  for file in $files
  do
    if [ -w "$file" ]
    then
      packed="$file".p
      if [ "$GZIPLEVEL" != "" ] 
      then
        filter="-f GZIP=$GZIPLEVEL"
      else
        filter=""
      fi
      logit "Packing $file into $packed"
      logit $H5REPACK -i "$file" -o "$packed" $filter
      $H5REPACK -i "$file" -o "$packed" $filter
      # Here we could insert some check involving h5diff if we were dubious
      mv "$packed" "$file"
    fi
  done
fi
# ----------------------------------------------------------------


# ------------------ augment ----------------------
# ----------------------------------------------------------------
# augment level 2 product files to make them netcdf-compatible
# (must not reverse order of repack, augment)
# After we become more comfortable with l2gp2nc4 actually
# converting the hdfeos formats to NetCDF4 we may delete
# the following part
if [ -x "$NETCDFAUGMENT" -a "$UsingPCF" != "" ]
then
  files=`extant_files *L2GP-[A-CE-Z]*.he5 *L2GP-DGG_*.he5`
  if [ "$files" = "" ]
  then
    if [ -d "outputs" ]
    then
      cd "outputs"
      files=`extant_files *L2GP-[A-CE-Z]*.he5 *L2GP-DGG_*.he5`
    fi
  fi
  for file in $files
  do
    if [ -w "$file" ]
    then
      logit $NETCDFAUGMENT $file
      $NETCDFAUGMENT $file
    fi
  done
fi
# ----------------------------------------------------------------
d867 3
@


1.41
log
@May use NETCDFCONVERT instead of augmenting hdfeos files
@
text
@d391 1
a391 1
SAVEJOBSTATS="yes"
d829 3
@


1.40
log
@Try to makee error mesgs more helpful and conspicuous
@
text
@d53 3
d164 73
d444 2
a445 9
if [ "$PGE_BINARY_DIR" = "" ]
then
  PGE_BINARY_DIR=$HOME/pvm3/bin/LINUX
fi

if [ "$PGE_BINARY" = "" ]
then
  PGE_BINARY=$PGE_BINARY_DIR/mlsl2
fi
d463 4
a466 3
H5REPACK=$PGE_BINARY_DIR/h5repack
NETCDFAUGMENT=$PGE_BINARY_DIR/aug_hdfeos5
MISALIGNMENT=$PGE_BINARY_DIR/misalignment
d479 4
d548 3
d600 2
d645 99
a749 1
# repack level 2 product files to speed things up
d758 1
a758 1
      files=`extant_files *L2FWM*.h5 *L2GP-[A-CE-Z]*.he5 *L2GP-DGG_*.he5 *L2AUX-[A-C]*.h5 *L2AUX-DGM_*.h5`
d780 1
d782 3
d787 3
d810 1
d812 1
a812 15
file=`extant_files *L2GP-DGG_*.he5`
# Check products for misaligned geolocations
# If they are found to be misaligned, set return_status to 99
if [ -x "$MISALIGNMENT" -a "$file" != "" ]
then
  a=`$MISALIGNMENT -silent $file`
  if [ "$a" != "" ]
  then
    logit $a
    logit "Misalignment detected"
    logit hide_files *.he5 *.met *.xml *.h5
    hide_files *.he5 *.met *.xml *.h5
    return_status=99
  fi
fi
d829 3
@


1.39
log
@Print sign-off at end of toolkitless run; use logit mechanism
@
text
@d335 1
d339 1
d343 1
d348 1
d352 1
d355 1
d359 1
d362 1
d380 1
d382 2
d387 1
d389 2
d503 1
d505 1
d658 3
@


1.38
log
@May evaluate variables in opts file if USEOPTSENV is set; drop slavetmpltntk.sh because slavetmplt.sh now does double-duty
@
text
@d7 1
a7 1
# (1) 
d29 1
a29 1
#     It would contain other meaningful runtimeoptions, 
d43 9
a51 3
# Now if the tool h5repack in PGE_BINARY_DIR
# and if the current working directory houses the product files,
# then as a final step repack them
d109 25
d174 2
a175 2
  echo "Running mlsl2 master w/o toolkit"
  echo "args $@@"
d185 2
a186 2
       echo "Preflight checkPaths run ended badly"                      
       echo "Possibly an error in pathnames; please check your l2cf"    
d236 2
a237 2
       echo "Preflight checkPaths run ended badly"
       echo "Possibly an error in pathnames; please check your PCF"
a238 2
       echo "Preflight checkPaths run ended badly" >> "$MLSL2PLOG"
       echo "Possibly an error in pathnames; please check your PCF" >> "$MLSL2PLOG"
d257 1
a257 2
    echo "Need HOSTNAME to trace provenance as ProductionLocation"
    echo "Need HOSTNAME to trace provenance as ProductionLocation" >> "$MLSL2PLOG"
d305 1
d310 1
d312 1
a312 2
echo "$MLSL2PLOG"
echo "$MLSL2PLOG" > "$MLSL2PLOG"
d316 1
a316 1
#             ^^^---- "yes" if progress of chunks thru phases recorded
d335 3
a337 4
  echo 'PGS_PC_INFO_FILE undefined' >> "$MLSL2PLOG"
  echo 'PGS_PC_INFO_FILE undefined'
  echo 'usage:'
  echo 'PGS_PC_Shell.sh (pge) 0111 (PCF_file) 25 -v'
d341 4
a344 5
  echo 'PVM_HOSTS_INFO undefined' >> "$MLSL2PLOG"
  echo 'PVM_HOSTS_INFO undefined'
  echo 'It should be the path and name of the host file'
  echo 'a text file containing the hosts available'
  echo 'for running the slave tasks, one host per line'
d348 2
a349 3
  echo 'JOBDIR undefined' >> "$MLSL2PLOG"
  echo 'JOBDIR undefined'
  echo 'It should be the path where the job is run'
d353 2
a354 3
  echo 'PGE_ROOT undefined' >> "$MLSL2PLOG"
  echo 'PGE_ROOT undefined'
  echo 'It should be the path where the science_env.sh script is kept'
d372 1
a372 2
  echo "$PGE_BINARY doesn't exist!" >> "$MLSL2PLOG"
  echo "$PGE_BINARY doesn't exist!"
d376 1
a376 2
  echo "slavetmplt.sh not in $PGE_SCRIPT_DIR" >> "$MLSL2PLOG"
  echo "slavetmplt.sh not in $PGE_SCRIPT_DIR"
d415 1
a415 1
echo "Original PCF: $PGS_PC_INFO_FILE" >> "$MLSL2PLOG"
d430 1
a430 1
echo "new PCF: $PGS_PC_INFO_FILE" >> "$MLSL2PLOG"
d489 1
a489 1
    echo 'Usage (w/o toolkit): mlsl2p.sh l2cf_file'
d507 3
a509 3
echo SAVEJOBSTATS $SAVEJOBSTATS
echo masterlog $masterlog
echo PGE_SCRIPT_DIR/jobstat-sips.sh $PGE_SCRIPT_DIR/jobstat-sips.sh
d525 1
a525 1
  echo "$PGE_SCRIPT_DIR/jobstat-sips.sh $JOBSOPTS"
d535 1
a535 2
  echo "catenating slave logs in $LOGFILE"
  echo "catenating slave logs in $LOGFILE" >> "$MLSL2PLOG"
d579 2
a580 4
      echo "Packing $file into $packed"
      echo "Packing $file into $packed" >> "$MLSL2PLOG"
      echo $H5REPACK -i "$file" -o "$packed" $filter
      echo $H5REPACK -i "$file" -o "$packed" $filter >> "$MLSL2PLOG"
d605 1
a605 2
      echo $NETCDFAUGMENT $file
      echo $NETCDFAUGMENT $file >> "$MLSL2PLOG"
d619 3
a621 3
    echo $a
    echo "Misalignment detected"
    echo hide_files *.he5 *.met *.xml *.h5
d627 7
d642 3
@


1.37
log
@Now handles both --tk and --ntk cases
@
text
@d103 27
a155 3
                                                                        
                                                                        
                                                                        
d169 8
d179 2
a180 1
    --idents "$IDENTFILE" $otheropts $l2cf 2> $JOBDIR/master.l2cfname
d427 5
d459 2
a460 2
  # Use sed to convert slavetmpltntk.sh into an executable script
  # The resulting script sets some toolkit-savvy environment variables
d463 1
a463 1
  # Check that we were called prroperly
d479 1
a479 1
  s=ppggeerroott=${PGE_ROOT}=;" $PGE_SCRIPT_DIR/slavetmpltntk.sh > $slave_script
d616 3
@


1.36
log
@Try harder not to stomp on choice of PCF
@
text
@d7 10
a16 2
# (1) It has been called from PGS_PC_Shell.sh as the (pge) in
#  PGS_PC_Shell.sh (pge) 0111 (PCF_file) 25 -v
d103 119
d271 1
a271 1
if [ "$PGS_PC_INFO_FILE" = "" ]
a393 18
# Use sed to convert slavetmplt.sh into an executable script
# The resulting script sets some toolkit-savvy environment variables
# and then launches the regular mlsl2 binary when summoned to do so.
SLV_SUF=slave
slave_script=$JOBDIR/mlsl2.$SLV_SUF
rm -f $slave_script
sed "s=ppccff=${PGS_PC_INFO_FILE}=;
s=ppggssmmeemmuusseesshhmm=${PGSMEM_USESHM}=;
s=ssllaavveessccrriipptt=${slave_script}=;
s=ootthheerrooppttss=\"${otheropts}\"=;
s=ppggeebbiinnaarryy=${PGE_BINARY}=;
s=ppggssbbiinn=${PGSBIN}=;
s=jjoobbddiirr=${JOBDIR}=;
s=ppggeerroott=${PGE_ROOT}=;" $PGE_SCRIPT_DIR/slavetmplt.sh > $slave_script
chmod a+x $slave_script

NORMAL_STATUS=2

d398 2
a399 4
#ulimit -a >> ${JOBDIR}/mlsl2p.env
# First a pre-flight run to check paths
# If a problem, disclosed by exit status, exit before starting big run
if [ "$CHECKPATHS" = "yes" ]
d401 16
a416 13
  $PGE_BINARY --checkPaths --tk $otheropts 2> $JOBDIR/master.l2cfname
  return_status=`expr $?`
  if [ $return_status != $NORMAL_STATUS ]
  then
     cat $JOBDIR/master.l2cfname
     echo "Preflight checkPaths run ended badly"
     echo "Possibly an error in pathnames; please check your PCF"
     cat $JOBDIR/master.l2cfname >> "$MLSL2PLOG"
     echo "Preflight checkPaths run ended badly" >> "$MLSL2PLOG"
     echo "Possibly an error in pathnames; please check your PCF" >> "$MLSL2PLOG"
     exit 1
  fi
fi
d418 2
a419 6
# Next, create a fresh ident based on master task's binary executable
if [ "$CHECKIDENTS" = "yes" ]
then
  IDENTFILE="$JOBDIR/master.ident"
  rm -f "$IDENTFILE"
  ident $PGE_BINARY > "$IDENTFILE"
d421 6
a426 13
  IDENTFILE="none"
fi

# HOSTNAME will be stored in metadata as ProductionLocation
# to trace provenance
if [ "$HOSTNAME" = "" ]
then
  echo "Need HOSTNAME to trace provenance as ProductionLocation"
  echo "Need HOSTNAME to trace provenance as ProductionLocation" >> "$MLSL2PLOG"
  exit 1
fi

  if [ "$CAPTURE_MT" = "yes" -a "$STDERRFILE" = "" ]
d428 2
a429 1
    STDERRFILE=mlsl2p.stderr
d431 12
d444 1
a444 12
# Now we launch the master task itself to set everything in motion
if [ "$CAPTURE_MT" = "yes" ]
then
  /usr/bin/time -f 'M: %M t: %e' $PGE_BINARY --pge $slave_script --tk --master $PVM_HOSTS_INFO \
    --idents "$IDENTFILE" --loc "$HOSTNAME" $otheropts 2> "$STDERRFILE"
elif [ "$STDERRFILE" != "" ]
then
  $PGE_BINARY --pge $slave_script --tk --master $PVM_HOSTS_INFO \
    --idents "$IDENTFILE" --loc "$HOSTNAME" $otheropts 2> "$STDERRFILE"
else
  $PGE_BINARY --pge $slave_script --tk --master $PVM_HOSTS_INFO \
    --idents "$IDENTFILE" --loc "$HOSTNAME" $otheropts
a445 3
# Save return status
return_status=`expr $?`

d450 4
a453 1
l2cf=`grep -i 'Level 2 configuration file' $masterlog | head -1 | awk '{print $13}'`
d532 1
a532 1
if [ -x "$NETCDFAUGMENT" ]
d578 3
@


1.35
log
@Avoids stomping on an already-selected PCF
@
text
@d117 9
d146 1
d153 1
d161 1
d167 1
d187 1
d192 1
a215 7
if [ -f "$MLSL2PLOG" ]
then
  mv $MLSL2PLOG $MLSL2PLOG.1
fi

echo "$MLSL2PLOG"
echo "$MLSL2PLOG" > "$MLSL2PLOG"
d230 4
d237 1
a242 3
  # Oops, this stomps on any PCF we might have selected
  # so save it to be restored
  PCF=$PGS_PC_INFO_FILE
a243 1
  export PGS_PC_INFO_FILE=$PCF
d245 3
d477 3
@


1.34
log
@cat master.l2cfname to stdout and to master stdout
@
text
@d230 3
d234 1
d465 3
@


1.33
log
@'dot' job.env if found; Obey CAPTURE_MT
@
text
@d282 1
d285 1
d461 3
@


1.32
log
@Fixed some typos
@
text
@d222 11
d309 5
d315 12
a326 3
$PGE_BINARY --pge $slave_script --tk --master $PVM_HOSTS_INFO \
  --idents "$IDENTFILE" --loc "$HOSTNAME" $otheropts

d459 3
@


1.31
log
@Now checks for mialigned geolocations
@
text
@d187 1
a187 1
  H5REPACK=$MLSTOOLS/H5REPACK
d410 1
d413 1
a413 1
if [ -x "$MISALIGNMENT" ]
d415 1
a415 1
  a=`$MISALIGNMENT -silent *L2GP-DGG_*.he5`
d434 3
@


1.30
log
@Automtically writes out l2cf name to master.l2cfname
@
text
@d68 27
d184 1
d197 4
d410 15
d433 3
@


1.29
log
@Creates mlsl2p log file
@
text
@d235 1
a235 1
  $PGE_BINARY --checkPaths --tk $otheropts
d386 3
@


1.28
log
@Pass HOSTNAME on commandline to use in metadata
@
text
@d87 3
d169 8
d187 1
d227 1
a227 1
#env | sort > ${JOBDIR}/mlsl2p.env
d241 2
d262 1
a276 1
#l2cf=`grep -i l2cf $masterlog | head -1 | awk '{print $9}'`
d299 1
d344 1
d346 1
d372 1
d386 3
@


1.27
log
@Fix latest problems with creating JOBSTATSFILE
@
text
@d243 8
d253 1
a253 1
  --idents "$IDENTFILE" $otheropts
d368 3
@


1.26
log
@May set environment variable PGE_BINARY
@
text
@d102 1
d254 3
a256 1
if [ "$SAVEJOBSTATS" = "yes" -a -x "$PGE_SCRIPT_DIR/jobstat-sips.sh" ]
d261 7
a267 5
  #l2cf=`grep -i l2cf $masterlog | head -1 | awk '{print $9}'`
  l2cf=`grep -i 'Level 2 configuration file name' $masterlog | head -1 | awk '{print $9}'`
  $PGE_SCRIPT_DIR/jobstat-sips.sh -S $PGE_BINARY_DIR/mlsqlog-scan-sips.py \
    -t $PGE_SCRIPT_DIR/split_path.sh ${JOBDIR}/pvmlog "$l2cf" "$masterlog" \
    > "$JOBSTATSFILE"
d360 3
@


1.25
log
@Replaced '--cat' cmdline option; 'Catenate' now an Output section command
@
text
@d135 5
a139 1
PGE_BINARY=$PGE_BINARY_DIR/mlsl2
d355 3
@


1.24
log
@Offer last chance to find h5repack in HDFTOOLS directory
@
text
@a93 1
# --cat    have master task catenate any split dgg/dgm files
d101 1
a101 1
otheropts="$OTHEROPTS -g --wall --cat -S'mas,chu,opt1,log,pro,time'"
d351 3
@


1.23
log
@Must repack before augmenting, not after
@
text
@d158 4
d255 2
a256 1
  l2cf=`grep -i l2cf $masterlog | head -1 | awk '{print $9}'`
d283 6
d352 3
@


1.22
log
@Added NETCDFAUGMENTing hdfeos std products
@
text
@a157 1
#EXTRA_SCRIPT_DIR="$PGE_SCRIPT_DIR/../scripts"
d278 2
a279 2
# augment level 2 product files to make them netcdf-compatible
if [ -x "$NETCDFAUGMENT" ]
d281 1
a281 1
  files=`extant_files *L2GP-[A-CE-Z]*.he5 *L2GP-DGG_*.he5`
d287 1
a287 1
      files=`extant_files *L2GP-[A-CE-Z]*.he5 *L2GP-DGG_*.he5`
d294 12
a305 2
      echo $NETCDFAUGMENT $file
      $NETCDFAUGMENT $file
d310 3
a312 2
# repack level 2 product files to speed things up
if [ -x "$H5REPACK" ]
d314 1
a314 1
  files=`extant_files *L2FWM*.h5 *L2GP-[A-CE-Z]*.he5 *L2GP-DGG_*.he5 *L2AUX-[A-C]*.h5 *L2AUX-DGM_*.h5`
d320 1
a320 1
      files=`extant_files *L2FWM*.h5 *L2GP-[A-CE-Z]*.he5 *L2GP-DGG_*.he5 *L2AUX-[A-C]*.h5 *L2AUX-DGM_*.h5`
d327 2
a328 12
      packed="$file".p
      if [ "$GZIPLEVEL" != "" ] 
      then
        filter="-f GZIP=$GZIPLEVEL"
      else
        filter=""
      fi
      echo "Packing $file into $packed"
      echo $H5REPACK -i "$file" -o "$packed" $filter
      $H5REPACK -i "$file" -o "$packed" $filter
      # Here we could insert some check involving h5diff if we were dubious
      mv "$packed" "$file"
d341 3
@


1.21
log
@Change the initialization of l2cf back to the old way because environment
variables defined in .env file is not avaiable to mlsl2p.sh.
@
text
@d149 9
d278 23
d341 4
@


1.20
log
@Use L2CFVERSION to supply l2cf variable
@
text
@d243 1
a243 1
  l2cf=$L2CFVERSION.l2cf
d309 3
@


1.19
log
@Running mlspgs automatically prints license text
@
text
@d243 1
a243 1
  l2cf=`grep -i l2cf $masterlog | head -1 | awk '{print $9}'`
d309 3
@


1.18
log
@Fixed bugs regarding products in outputs subdirectory
@
text
@d156 6
d309 3
@


1.17
log
@Handle case when product files are in outputs subdirectory
@
text
@d41 37
d266 2
a267 2
  files=`echo *L2FWM*.h5 *L2GP-[A-CE-Z]*.he5 *L2GP-DGG_*.he5 *L2AUX-[A-C]*.h5 *L2AUX-DGM_*.h5`
  if [ "files" = "" ]
d272 1
a272 1
      files=`echo *L2FWM*.h5 *L2GP-[A-CE-Z]*.he5 *L2GP-DGG_*.he5 *L2AUX-[A-C]*.h5 *L2AUX-DGM_*.h5`
d303 3
@


1.16
log
@Used ulimit to increase tiny stacksize so Intel-built mlsl2 can finish
@
text
@d230 8
d266 3
@


1.15
log
@By default no longer dumps slave stdouts into masters
@
text
@d148 1
d155 5
d258 3
@


1.14
log
@Sets environmental variable as work-around to Lahey 6.2 bug
@
text
@d65 1
a65 1
otheropts="$OTHEROPTS -g --wall --cat -S'slv,mas,chu,opt1,log,pro,time'"
d252 3
@


1.13
log
@Now saves chunk stats at end of output
@
text
@d135 2
d252 3
@


1.12
log
@Fixed serious and various bugs
@
text
@d9 2
a10 1
# (2) $PGE_BINARY_DIR contains mlsl2 and $PGE_SCRIPT_DIR slavetmplt.sh
d50 3
d112 6
d183 17
d213 5
d250 3
@


1.11
log
@repack with gzip compression all hdf5/hdfeos5 product files
@
text
@d188 1
d192 1
a192 1
    if [ -r "$file" ]
d195 2
a196 1
      if [ "$GZIPLEVEL" != "" ] then
d207 1
a207 1
then
d218 3
@


1.10
log
@Imitated l1b repacking to defragment forward model files
@
text
@d35 1
a35 1
# and if the current working directory houses the forward model files,
d46 3
d186 1
a186 1
# repack level 2 forward model files to speed things up
d188 1
a188 1
  files=`echo *L2FWM*.h5`
d194 5
d200 2
a201 1
      echo $H5REPACK -i "$file" -o "$packed"
d216 3
@


1.9
log
@Reworded Copyright statement
@
text
@d34 4
d104 2
d183 16
d207 3
@


1.8
log
@Made --cat the default option
@
text
@d23 10
a32 2
# Copyright (c) 2004, California Institute of Technology.  ALL RIGHTS RESERVED.
# U.S. Government Sponsorship under NASA Contract NAS7-1407 is acknowledged.
d185 3
@


1.7
log
@Merged in sips-friendly changes
@
text
@d34 13
a46 1
otheropts="$OTHEROPTS -g --wall -S'slv,mas,chu,opt1,log,pro,time'"
d177 3
@


1.6
log
@May check each slaves ident against master to verify pge versions are the same
@
text
@d9 1
a9 1
# (2) (HOME)/pvm3/bin/LINUX/ contains both mlsl2 and slavetmplt.sh
d15 7
d23 1
a23 1
# Copyright (c) 2003, California Institute of Technology.  ALL RIGHTS RESERVED.
d42 1
d49 11
d62 1
a62 1
# In case you used the ep=(PVM_EP)
d64 1
a64 1
if [ "$PVM_EP" = "" ]
d66 1
a66 1
  PVM_EP=$HOME/pvm3/bin/LINUX
d68 1
d70 5
a74 1
if [ ! -x "$PVM_EP/mlsl2"  ]
d76 8
a83 2
  echo "mlsl2 not in $PVM_EP"
elif [ ! -r "$PVM_EP/slavetmplt.sh"  ]
d85 9
a93 1
  echo "slavetmplt.sh not in $PVM_EP"
d97 1
a97 1
# The resulting script sets some toolkt-savvy environment variables
d100 10
a109 5
rm -f $PVM_EP/mlsl2.$SLV_SUF
sed "s=ssllaavvee=$SLV_SUF=; s=ppggssbbiinn=$PGSBIN=; \
s=ppccff=$PGS_PC_INFO_FILE=; s=ppvvmmbbiinn=$PVM_EP=" \
"$PVM_EP/slavetmplt.sh" > $PVM_EP/mlsl2.$SLV_SUF
chmod a+x $PVM_EP/mlsl2.$SLV_SUF
d117 1
a117 1
  $PVM_EP/mlsl2 --checkPaths --tk $otheropts
d130 1
a130 1
  IDENTFILE="$PVM_EP/master.ident"
d132 1
a132 1
  ident $PVM_EP/mlsl2 > "$IDENTFILE"
d138 1
a138 2
#$PVM_EP/mlsl2 --pge mlsl2.$SLV_SUF --tk --master $PVM_HOSTS_INFO -g -S'mas,chu,pro,log,opt1,pcf,time'
$PVM_EP/mlsl2 --pge mlsl2.$SLV_SUF --tk --master $PVM_HOSTS_INFO \
d145 1
a145 1
LOGFILE="$PVM_EP/mlsl2.log"
d152 2
a153 2
  cat $PVM_EP/*.log >> "$LOGFILE".1
  rm -f $PVM_EP/*.log
d156 1
d165 3
@


1.5
log
@Uses --checkPaths to perform extra preflight checks
@
text
@d22 1
a22 1
#           ^^^---- "yes" if extra prefilght non-retrieval run to check paths
d24 4
a27 1
otheropts="$OTHEROPTS -g -S'slv,mas,chu,opt1,log,pro,time'"
d84 10
d96 2
a97 1
$PVM_EP/mlsl2 --pge mlsl2.$SLV_SUF --tk --master $PVM_HOSTS_INFO $otheropts
d122 3
@


1.4
log
@Catenates each slaves log file to mlsl2.log at end
@
text
@d21 5
d67 14
a82 1
otheropts="$OTHEROPTS -g -S'slv,mas,chu,opt1,log,pro,time'"
d94 2
d108 3
@


1.3
log
@Added slv option
@
text
@d67 1
d70 10
d88 3
@


1.2
log
@Allow OTHEROPTS environmental variable pass-through to mlsl2
@
text
@d64 1
a64 1
otheropts="$OTHEROPTS -g -S'mas,chu,opt1,log,pro,time'"
d77 3
@


1.1
log
@First commit
@
text
@d63 3
a65 1
$PVM_EP/mlsl2 --pge mlsl2.$SLV_SUF --tk --master $PVM_HOSTS_INFO -g -S'mas,chu,pro,log,opt1,pcf,time'
d76 4
a79 1
# $Log: mlsprog.sh,v $
@

