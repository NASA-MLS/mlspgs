head	1.11;
access;
symbols
	v5-02-NRT-19:1.11
	v6-00:1.11
	v5-02-NRT-18:1.11
	v5-02:1.11
	v5-01-NRT-17:1.11
	v5-01-NRT-16:1.11
	v5-01-NRT-15:1.11
	v5-01-NRT-14:1.11
	neuralnetworks-1-0:1.11.0.10
	cfm-single-freq-0-1:1.11.0.8
	v5-01:1.11
	v5-00:1.11
	v4-23-TA133:1.11.0.6
	mus-emls-1-70:1.11.0.4
	rel-1-0-englocks-work:1.11.0.2
	VUMLS1-00:1.10
	VPL1-00:1.10
	V4-22-NRT-08:1.10
	VAM1-00:1.10
	V4-21:1.10.0.2
	V4-13:1.10
	V4-12:1.10
	V4-11:1.10
	V4-10:1.10
	V3-43:1.7
	M4-00:1.7
	V3-41:1.7
	V3-40-PlusGM57:1.7.0.2
	V2-24-NRT-04:1.6
	V3-33:1.7
	V2-24:1.6
	V3-31:1.7
	V3-30-NRT-05:1.7
	cfm-01-00:1.7
	V3-30:1.7
	V3-20:1.7
	V3-10:1.6
	V2-23-NRT-02:1.6
	V2-23:1.6
	V2-22-NRT-01:1.6
	V2-22:1.6
	V2-21:1.5
	V2-20:1.5
	V2-11:1.5
	V2-10:1.5
	V2-00:1.5
	V1-51:1.4
	V1-50:1.4
	V1-45:1.4
	V1-44:1.4
	V1-43:1.4
	V1-42:1.3
	V1-41:1.3
	V1-32:1.3
	V1-40:1.3
	V1-31:1.3
	V1-30:1.3
	V1-13:1.3
	V1-12:1.3
	V1-11:1.3
	V1-10:1.3
	newfwm-feb03:1.3.0.2;
locks; strict;
comment	@# @;


1.11
date	2017.03.28.20.35.10;	author pwagner;	state Exp;
branches;
next	1.10;

1.10
date	2014.01.29.21.03.03;	author pwagner;	state Exp;
branches;
next	1.9;

1.9
date	2014.01.28.19.39.00;	author pwagner;	state Exp;
branches;
next	1.8;

1.8
date	2013.06.05.18.42.40;	author pwagner;	state Exp;
branches;
next	1.7;

1.7
date	2009.12.01.21.32.47;	author pwagner;	state Exp;
branches;
next	1.6;

1.6
date	2007.05.29.17.40.29;	author pwagner;	state Exp;
branches;
next	1.5;

1.5
date	2005.06.23.22.20.46;	author pwagner;	state Exp;
branches;
next	1.4;

1.4
date	2004.03.26.23.31.09;	author pwagner;	state Exp;
branches;
next	1.3;

1.3
date	2002.09.24.18.10.28;	author pwagner;	state Exp;
branches;
next	1.2;

1.2
date	2002.09.04.18.11.36;	author pwagner;	state Exp;
branches;
next	1.1;

1.1
date	2002.07.29.22.59.53;	author pwagner;	state Exp;
branches;
next	;


desc
@@


1.11
log
@Handle case where . is not in PATH
@
text
@#!/bin/sh
# --------------- updatemf.sh help
#                 updatemf.sh    updates the Makefile in the MLSCONFG
#
# Called by make as a subtask of the update target
#
#        O p t i o n s
#  -h[elp]              Help (a work in progress)
#  -cf confg_file       configuration file (with path if needed)
#                        (defaults to ../.configure)
#  -pc plat_dir         Directory where platforms directory to be found
#                        (defaults to ./)
#  -machine             Check that machine files up-to-date
#  -reverse             Reverse hiding the file
#  -d                   Turn on debugging
#  -v                   Verbose
#
# --------------- End updatemf.sh help
#
# Copyright 2005, by the California Institute of Technology. ALL
# RIGHTS RESERVED. United States Government Sponsorship acknowledged. Any
# commercial use must be negotiated with the Office of Technology Transfer
# at the California Institute of Technology.

# This software may be subject to U.S. export control laws. By accepting this
# software, the user agrees to comply with all applicable U.S. export laws and
# regulations. User has the responsibility to obtain export licenses, or other
# export authority as may be required before exporting such information to
# foreign countries or providing access to foreign persons.

# "$Id: updatemf.sh,v 1.10 2014/01/29 21:03:03 pwagner Exp $"
#----------------------- EchoVerb -----------------------

# Function to echo its argument only if $verbose is true
#

EchoVerb()
{
   if [ "$verbose" = "true" -o "$debugging" = "true" ]
   then
     echo  "$1"
   fi
}

#----------------------- Exclude -----------------------

# Function to temporarily hide a file to exclude it from calculations
# or to reverse the hiding after the calculations
#

Exclude()
{
   if [ "$reverse" = "true" -a -f "$1-x" ]
   then
     #echo mv "$1-x" "$1"
     mv "$1-x" "$1"
   elif [  "$reverse" = "false" -a -f "$1" ]
   then
     #echo mv "$1" "$1-x"
     mv "$1" "$1-x"
   fi
}

#---------------------------- get_unique_name
#
# Function returns a unique name based on arg, PID and HOSTNAME
# e.g.,
#           temp_file_name=`get_unique_name foo`
#           echo $temp_file_name
# might print foo.colossus.21455
# if no arg, defaults to "temp" (very original name)
# if two args present, assumes second is punctuation to
# use in place of "."

get_unique_name()
{

   # How many args?
      if [ $# -gt 1 ]
      then
        pt="$2"
        temp="$1"
      elif [ $# -gt 0 ]
      then
        pt="."
        temp="$1"
      else
        pt="."
        temp="temp"
      fi
   # Is $HOST defined?
      if [ "$HOST" != "" ]
      then
         our_host_name="$HOST"
      elif [ "$HOSTNAME" != "" ]
      then
         our_host_name="$HOSTNAME"
      else
         our_host_name="host"
      fi
    #  echo $our_host_name
   # if in form host.moon.planet.star.. extract host
      our_host_name=`echo $our_host_name | sed 's/\./,/g'`
      our_host_name=`perl -e '@@parts=split(",","$ARGV[0]"); print $parts[0]' $our_host_name`
      echo $temp${pt}$our_host_name${pt}$$
}

#---------------------------- my_dot
#
# Function first replaces the rhs in assignment statements like
# a=b c d
# with
# a="b c d"
# so that they can be safely "dot"ted
# (otherwise the shell will complain: "c": command not found)
# (if a line is already of the form a="b c d", it will be left unchanged)
# use in place of "."

my_dot()
{
   temp1=`get_unique_name updatemf`
   sed 's/\(^[^ ][^ ]*\)=\(.*\)/\1="\2"/; s/\"\"\(.*\)\"\"/\"\1\"/' \
      "$1" > $temp1
   . ./"$temp1"
   rm "$temp1"
}

#------------------------------- Main Program ------------

#****************************************************************
#                                                               *
#                  * * * Main Program  * * *                    *
#                                                               *
#                                                               *
#	The entry point where control is given to the script         *
#****************************************************************

# Set the following to "on" to print degugging info
debugging="off"
me="$0"
me_simple=updatemf.sh
confg_file=../.configure
REECHO="`echo $0 | sed 's/updatemf\.sh/reecho.sh/'`"
MYPATH="`echo $0 | sed 's/updatemf\.sh//'`"
# The following preset some holdovers from when I was part of mlsconfigure
del_exist_dir="false"
mcfg_dir="./"
plat_dir="./"
conf_dir="$MYPATH/.."
m_update="false"
reverse="false"
verbose="false"

while [ "$1" != "" ] ; do

    case "$1" in

	-h | -help )
#	    Help
       sed -n '/'$me_simple' help/,/End '$me_simple' help/ p' $me \
           | sed -n 's/^.//p' | sed '1 d; $ d'
       exit
	;;
	-cf )
	    confg_file=$2
	    shift
	;;
	-d )
	    debugging="true"
	;;
	-pc )
	    plat_dir=$2
	    shift
	;;
	-machine )
	    m_update="true"
	;;
	-reverse )
	    reverse="true"
	;;
	-v )
	    verbose="true"
	;;
    esac
    shift
done
if [ "$debugging" = "on" ] ; then
	echo "configuration file: $confg_file"
	echo "Reconfiguring Makefile in `pwd`"
fi
if [ ! -f "$confg_file" ]
then
	echo "configuration file $confg_file not found"
   exit 1
fi

my_dot "$confg_file"

machines_root=$conf_dir/lib/machines

# Have we been tasked with reversing a previous call where we hid
# one or more files temporarily via Exclude commands?
if [ "$reverse" = "true" ]
then
  if [ "$REECHOMACHOPTS" != "" -a "$MLSCONFG" = "$MLSF95.$MLSPLAT" ]
  then
    the_files=`$REECHO -dir $machines_root/"$MLSCONFG" -escape \*-x`
    if [ "$the_files" = "" ]
    then
      exit 0
    fi
    EchoVerb "About to restore $the_files"
    EchoVerb "in $machines_root/$MLSCONFG"
    for file in $the_files
    do
      argmx=`echo $file | sed 's/-x$//'`
      var=`Exclude $machines_root/$MLSCONFG/$argmx`
      # echo $var
    done
  fi
  exit 0
fi
EchoVerb "Re-create object-file directory for this $MLSCONFG"
EchoVerb "del_exist_dir $del_exist_dir"
#Re-create object-file directory for this MLSCONFG
#unless $del_exist_dir reset to false
#(Because mlsconfigure may be called simply to update $MLSCONFG/Makefile)
made_new_dir="false"

if [ "$MLSCONFG" = "." -o "$MLSCONFG" = "" ] ; then
	echo "MLSCONFG not yet defined--still $MLSCONFG"
	echo "To repair this, enter 'make configure'"
   exit 1
elif [ "$del_exist_dir" != "true" ] ; then
  if [ ! -d $mcfg_dir/$MLSCONFG ] ; then
      mkdir $mcfg_dir/$MLSCONFG
		made_new_dir="true"
   #else
      #rm -f $mcfg_dir/$MLSCONFG/Makefile
  fi
elif [ -d $mcfg_dir/$MLSCONFG ] ; then
	chmod u+w $mcfg_dir/$MLSCONFG/*
        if [ -f $mcfg_dir/$MLSCONFG/Makefile ]
        then
          EchoVerb "Preserving Makefile"
          ls -l $mcfg_dir/$MLSCONFG/Makefile
          mv $mcfg_dir/$MLSCONFG/Makefile $mcfg_dir/$MLSCONFG/.Makefile
	  rm -f $mcfg_dir/$MLSCONFG/*
          mv $mcfg_dir/$MLSCONFG/.Makefile $mcfg_dir/$MLSCONFG/Makefile
        else
          EchoVerb "Makefile not found; so creating it"
	  rm -f $mcfg_dir/$MLSCONFG/*
        fi
else
   mkdir $mcfg_dir/$MLSCONFG   
	made_new_dir="true"        
fi

if [ ! -f $conf_dir/srclib/$MLSF95.$MLSPLAT ] ; then
	echo "File $MLSF95.$MLSPLAT not found in $conf_dir/srclib"
	exit
fi

if [ ! -f $plat_dir/platforms/targets ] ; then
 echo "File targets not found in $plat_dir/platforms"
 exit
fi

# cat $confg_file $plat_dir/platforms/common \
#   $plat_dir/platforms/targets > $mcfg_dir/$MLSCONFG/Makefile

if [ -f $mcfg_dir/$MLSCONFG/Makefile ]
then
  mv $mcfg_dir/$MLSCONFG/Makefile $mcfg_dir/$MLSCONFG/Makefile.1
  cat $confg_file $plat_dir/platforms/targets > $mcfg_dir/$MLSCONFG/Makefile
  n=`diff $mcfg_dir/$MLSCONFG/Makefile $mcfg_dir/$MLSCONFG/Makefile.1 | wc -w`
  EchoVerb "n $n"
  if [ "$n" -lt 1 ]
  then
    mv $mcfg_dir/$MLSCONFG/Makefile.1 $mcfg_dir/$MLSCONFG/Makefile
  fi
else
  cat $confg_file $plat_dir/platforms/targets > $mcfg_dir/$MLSCONFG/Makefile
fi

if [ "$made_new_dir" = "true" ] ; then
	echo "Configured mls to use $mcfg_dir/$MLSCONFG "
	echo "(This is where your object files, .mod files, libraries,"
	echo "and executable programs will be created)"
	echo "To build the software, enter the 'make' command again"
	echo ""
	echo "If you later wish to rebuild for a different compiler"
	echo "or platform, enter 'make configure'"
   if [ "$MLSCONFG" != "$MLSF95.$MLSPLAT" ] ; then
     # Custom configuration name -- create a machines sub-directory for it
     # We will assume that the machines sub-directories live under the path
     # $conf_dir/lib/machines/$MLSCONFG
     if [ ! -d "$machines_root" ] ; then
        echo "Unable to locate root machines directory $machines_root"
        exit
     fi
     machines_base=$machines_root/$MLSF95.$MLSPLAT
     if [ ! -d "$machines_base" ] ; then
        echo "Unable to locate base machines directory $machines_base"
        exit
     fi
     if [ ! -d "$machines_root/$MLSCONFG" ] ; then
        mkdir "$machines_root/$MLSCONFG"
        cp $machines_base/*.f9* $machines_root/$MLSCONFG
        echo "New directory $machines_root/$MLSCONFG based on $machines_base"
     fi
   fi
fi

machines_root=$conf_dir/lib/machines            
machines_base=$machines_root/$MLSF95.$MLSPLAT   
if [ "$MLSCONFG" != "$MLSF95.$MLSPLAT" -a "$m_update" = "true" ] ; then
# In case of a custom configuration name, make sure machine files are up-to-date
  the_files=`$REECHO -dirn $machines_root/"$MLSF95.$MLSPLAT"`
  EchoVerb "About to make sure $the_files"
  EchoVerb "are up-to-date in $machines_root/$MLSCONFG"
  for file in $the_files
  do
    make -f $MYPATH/uptodate.make \
      SOURCE=$machines_base/$file TARGET=$machines_root/$MLSCONFG/$file \
        $machines_root/$MLSCONFG/$file
  done
fi

# In case you're using the REECHOMACHOPTS mechanism
# to exclude certain files from the machines subdirectory, basically
# rename them or remove them
# echo "m_update $m_update REECHOMACHOPTS $REECHOMACHOPTS"
if [ "$m_update" = "true" -a "$REECHOMACHOPTS" != "" ] ; then
  the_files=`$REECHO -dir $machines_root/$MLSCONFG fuzzy $REECHOMACHOPTS`
  if [ "$the_files" = "" ]
  then
    exit 0
  fi
  EchoVerb "About to rename $the_files"
  EchoVerb "in $machines_root/$MLSCONFG"
  for file in $the_files
  do
    var=`Exclude $machines_root/$MLSCONFG/$file`
    # echo $var
  done
fi


exit 0

# $Log: updatemf.sh,v $
# Revision 1.10  2014/01/29 21:03:03  pwagner
# Added -d and -v commandline opts
#
# Revision 1.9  2014/01/28 19:39:00  pwagner
# Create new Makefile only if different
#
# Revision 1.8  2013/06/05 18:42:40  pwagner
# Added ability to reverse hiding of Excluded files
#
# Revision 1.7  2009/12/01 21:32:47  pwagner
# May use the REECHOMACHOPTS mechanism to exclude certain files from machines
#
# Revision 1.6  2007/05/29 17:40:29  pwagner
# compiler-specific settings now in srclib, not platforms
#
# Revision 1.5  2005/06/23 22:20:46  pwagner
# Reworded Copyright statement
#
# Revision 1.4  2004/03/26 23:31:09  pwagner
# A quickie--but fails if we cvs remove from parent
#
# Revision 1.3  2002/09/24 18:10:28  pwagner
# Fixed -h option
#
# Revision 1.2  2002/09/04 18:11:36  pwagner
# my_dot repairs problem of multiple LIB_BLAS libraries
#
# Revision 1.1  2002/07/29 22:59:53  pwagner
# First commit
#
@


1.10
log
@Added -d and -v commandline opts
@
text
@d31 1
a31 1
# "$Id: updatemf.sh,v 1.9 2014/01/28 19:39:00 pwagner Exp $"
d124 1
a124 1
   . "$temp1"
d353 3
@


1.9
log
@Create new Makefile only if different
@
text
@d8 1
a8 1
#  -h[elp]              (if present) Help (a work in progress)
d13 4
a16 2
#  -machine             (if present) Check that machine files up-to-date
#  -reverse             (if present) Reverse hiding the file
d31 14
a44 1
# "$Id: updatemf.sh,v 1.8 2013/06/05 18:42:40 pwagner Exp $"
d152 1
d168 3
d181 3
d212 2
a213 2
    echo "About to restore $the_files"
    echo "in $machines_root/$MLSCONFG"
d223 2
a224 2
echo "Re-create object-file directory for this $MLSCONFG"
echo "del_exist_dir $del_exist_dir"
d245 1
a245 1
          echo "Preserving Makefile"
d251 1
a251 1
          echo "Makefile not found; so creating it"
a263 5
# if [ ! -f $plat_dir/platforms/common ] ; then
# 	echo "File common not found in $plat_dir/platforms"
# 	exit
# fi

d277 1
a277 1
  echo "n $n"
d320 2
a321 2
  echo "About to make sure $the_files"
  echo "are up-to-date in $machines_root/$MLSCONFG"
d340 2
a341 2
  echo "About to rename $the_files"
  echo "in $machines_root/$MLSCONFG"
d353 3
@


1.8
log
@Added ability to reverse hiding of Excluded files
@
text
@d29 1
a29 1
# "$Id: updatemf.sh,v 1.7 2009/12/01 21:32:47 pwagner Exp $"
d201 2
d213 1
a213 1
	if [ ! -d $mcfg_dir/$MLSCONFG ] ; then
d216 3
a218 3
   else
      rm -f $mcfg_dir/$MLSCONFG/Makefile
	fi
d221 11
a231 1
	rm -f $mcfg_dir/$MLSCONFG/*
d255 13
a267 1
cat $confg_file $plat_dir/platforms/targets > $mcfg_dir/$MLSCONFG/Makefile
d336 3
@


1.7
log
@May use the REECHOMACHOPTS mechanism to exclude certain files from machines
@
text
@d14 1
d29 1
a29 1
# "$Id: updatemf.sh,v 1.6 2007/05/29 17:40:29 pwagner Exp $"
d32 2
a33 1
# Function to temporarily hide a file to excclude it from calculations
d38 1
a38 1
	if [ -f "$1" ]
d40 5
d136 1
d159 3
a174 9
# The following fragile stuff was replaced by the more robust function my_dot
# Delete lines such as FOPTS= or LDOPTS= because they may cause shell errors
# (Why not create a new function to do this?)
#temp1=`get_unique_name updatemf`
#sed '/OPTS/d' "$confg_file" > $temp1
#echo ". $temp1"
#. "$temp1"
#echo "Done with . $temp1"
#rm "$temp1"
d177 24
a256 1
     machines_root=$conf_dir/lib/machines
d295 4
d304 1
d312 3
@


1.6
log
@compiler-specific settings now in srclib, not platforms
@
text
@d28 14
a41 1
# "$Id: updatemf.sh,v 1.5 2005/06/23 22:20:46 pwagner Exp $"
d249 2
a252 2
  machines_root=$conf_dir/lib/machines            
  machines_base=$machines_root/$MLSF95.$MLSPLAT   
d264 15
d282 3
@


1.5
log
@Reworded Copyright statement
@
text
@d28 1
a28 1
# "$Id: updatemf.sh,v 1.4 2004/03/26 23:31:09 pwagner Exp $"
d186 2
a187 2
if [ ! -f $plat_dir/platforms/$MLSF95.$MLSPLAT ] ; then
	echo "File $MLSF95.$MLSPLAT not found in $plat_dir/platforms"
d191 5
d197 2
a198 2
	echo "File targets not found in $plat_dir/platforms"
	exit
d201 4
a204 2
cat $confg_file $plat_dir/platforms/$MLSF95.$MLSPLAT \
   $plat_dir/platforms/targets > $mcfg_dir/$MLSCONFG/Makefile
d254 3
@


1.4
log
@A quickie--but fails if we cvs remove from parent
@
text
@d17 10
a26 2
# Copyright (c) 2002, California Institute of Technology.  ALL RIGHTS RESERVED.
# U.S. Government Sponsorship under NASA Contract NAS7-1407 is acknowledged.
d28 1
a28 1
# "$Id: updatemf.sh,v 1.3 2002/09/24 18:10:28 pwagner Exp $"
d247 3
@


1.3
log
@Fixed -h option
@
text
@d20 1
a20 1
# "$Id: updatemf.sh,v 1.2 2002/09/04 18:11:36 pwagner Exp $"
d225 1
a225 1
  the_files=`$REECHO -dirn $machines_root/$MLSCONFG`
d239 3
@


1.2
log
@my_dot repairs problem of multiple LIB_BLAS libraries
@
text
@d20 1
a20 1
# "$Id: updatemf.sh,v 1.1 2002/07/29 22:59:53 pwagner Exp $"
d114 3
a116 1
	    Help
d239 3
@


1.1
log
@First commit
@
text
@d20 1
a20 1
# "$Id: updatemf.sh,v 1.31 2002/07/22 22:08:44 pwagner Exp $"
d30 1
a30 1
# use in pace of "."
d65 20
d141 2
a142 1
# Delete lines such as FOPTS= or LDOPTS= becuase they may cause shell errors
d144 2
a145 2
temp1=`get_unique_name updatemf`
sed '/OPTS/d' "$confg_file" > $temp1
d147 1
a147 1
. "$temp1"
d149 2
a150 1
rm "$temp1"
d237 3
@

